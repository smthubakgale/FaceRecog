!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b((a=a||self).faceapi=a.faceapi||{})}(this,function(b){"use strict";var jK=function(a,b){return(jK=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(a,b){a.__proto__=b}||function(c,a){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b])})(a,b)};function f(b,a){function c(){this.constructor=b}jK(b,a),b.prototype=null===a?Object.create(a):(c.prototype=a.prototype,new c)}function jL(b,c,a,d){return new(a=a||Promise)(function(f,g){function h(a){try{e(d.next(a))}catch(b){g(b)}}function i(a){try{e(d.throw(a))}catch(b){g(b)}}function e(b){b.done?f(b.value):new a(function(a){a(b.value)}).then(h,i)}e((d=d.apply(b,c||[])).next())})}function jM(b,c){var d,e,f,a,g={label:0,sent:function(){if(1&f[0])throw f[1];return f[1]},trys:[],ops:[]};return a={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function h(a){return function(h){return function(a){if(d)throw new TypeError("Generator is already executing.");for(;g;)try{if(d=1,e&&(f=2&a[0]?e.return:a[0]?e.throw||((f=e.return)&&f.call(e),0):e.next)&&!(f=f.call(e,a[1])).done)return f;switch(e=0,f&&(a=[2&a[0],f.value]),a[0]){case 0:case 1:f=a;break;case 4:return g.label++,{value:a[1],done:!1};case 5:g.label++,e=a[1],a=[0];continue;case 7:a=g.ops.pop(),g.trys.pop();continue;default:if(!(f=0<(f=g.trys).length&&f[f.length-1])&&(6===a[0]||2===a[0])){g=0;continue}if(3===a[0]&&(!f||a[1]>f[0]&&a[1]<f[3])){g.label=a[1];break}if(6===a[0]&&g.label<f[1]){g.label=f[1],f=a;break}if(f&&g.label<f[2]){g.label=f[2],g.ops.push(a);break}f[2]&&g.ops.pop(),g.trys.pop();continue}a=c.call(b,g)}catch(h){a=[6,h],e=0}finally{d=f=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,h])}}}var d0=(jN.prototype.setPlatform=function(b,a){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+a+"."),this.platformName=b,this.platform=a},jN.prototype.registerFlag=function(a,c,d){if(this.flagRegistry[a]={evaluationFn:c,setHook:d},null!=this.urlFlags[a]){var b=this.urlFlags[a];console.warn("Setting feature override from URL "+a+": "+b+"."),this.set(a,b)}},jN.prototype.get=function(a){return a in this.flags||(this.flags[a]=this.evaluateFlag(a)),this.flags[a]},jN.prototype.getNumber=function(a){return this.get(a)},jN.prototype.getBool=function(a){return this.get(a)},jN.prototype.getFlags=function(){return this.flags},Object.defineProperty(jN.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),jN.prototype.set=function(a,b){if(null==this.flagRegistry[a])throw new Error("Cannot set flag "+a+" as it has not been registered.");this.flags[a]=b,null!=this.flagRegistry[a].setHook&&this.flagRegistry[a].setHook(b)},jN.prototype.evaluateFlag=function(a){if(null==this.flagRegistry[a])throw new Error("Cannot evaluate flag '"+a+"': no evaluation function found.");return this.flagRegistry[a].evaluationFn()},jN.prototype.setFlags=function(a){this.flags=Object.assign({},a)},jN.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},jN.prototype.populateURLFlags=function(){var d=this;if(void 0!==this.global&& void 0!==this.global.location&& void 0!==this.global.location.search){var a,b,c=(a=this.global.location.search,b={},a.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(g){for(var d,e,f,a=[],c=1;c<arguments.length;c++)a[c-1]=arguments[c];return d=b,e=a[0],f=a[1],d[decodeURIComponent(e)]=decodeURIComponent(f||""),a.join("=")}),b);"tfjsflags"in c&&c.tfjsflags.split(",").forEach(function(c){var a=c.split(":"),b=a[0],e=a[1];d.urlFlags[b]=function(b,a){if("true"===(a=a.toLowerCase())||"false"===a)return"true"===a;if(""+ +a===a)return+a;throw new Error("Could not parse value flag value "+a+" for flag "+b+".")}(b,e)})}},jN);function jN(a){this.global=a,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}function _(){return i}var i=null,jO=new Map,jP=new Map;function d1(b,c){var a,d,e=(a=b,(d=c)+"_"+a);return jO.get(e)}function d2(a){return jP.get(a)}function d3(d){for(var e=jO.entries(),a=[];;){var b=e.next(),f=b.done,c=b.value;if(f)break;var g=c[0],h=c[1];g.split("_")[0]===d&&a.push(h)}return a}function u(a){var b,f,c=a.kernelName,d=a.backendName,e=(b=c,(f=d)+"_"+b);if(jO.has(e))throw new Error("The kernel '"+c+"' for backend '"+d+"' is already registered");jO.set(e,a)}function ab(b){var a=b.kernelName;jP.has(a)&&console.warn("Overriding the gradient for '"+a+"'"),jP.set(a,b)}function d4(a){for(var b=a.length,d=0,c=0;0<b;)c=Math.random()*b|0,d=a[--b],a[b]=a[c],a[c]=d}function d5(a,b,c){return Math.max(a,Math.min(b,c))}function d6(a){return a%2==0?a:a+1}function d7(b){for(var c=0,a=0;a<b.length;a++)c+=b[a];return c}function d8(b,a){if(!b)throw new Error("string"==typeof a?a:a())}function d9(b,c,a){void 0===a&&(a=""),d8(ed(b,c),function(){return a+" Shapes "+b+" and "+c+" must match"})}function ea(a){d8(null!=a,function(){return"The input to the tensor constructor must be a non-null value."})}function eb(b,a,c){if(void 0===a&&(a=[]),void 0===c&&(c=!1),null==a&&(a=[]),Array.isArray(b)||er(b)&&!c)for(var d=0;d<b.length;++d)eb(b[d],a,c);else a.push(b);return a}function ec(a){if(0===a.length)return 1;for(var c=a[0],b=1;b<a.length;b++)c*=a[b];return c}function ed(a,b){if(a===b)return!0;if(null==a||null==b||a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}function ee(a){return a%1==0}function ef(a){if(null!=Math.tanh)return Math.tanh(a);if(a===1/0)return 1;if(a=== -1/0)return -1;var b=Math.exp(2*a);return(b-1)/(b+1)}function eg(a){var b=Math.ceil(Math.sqrt(a));return[b,Math.ceil(a/b)]}function eh(a,b){return b<=a.length?a:a+" ".repeat(b-a.length)}function ei(b,a,c){return void 0===a&&(a=function(a){return 0}),new Promise(function(e,f){var g=0,d=function(){if(b())e();else{var h=a(++g);null!=c&&c<=g?f():setTimeout(d,h)}};d()})}function ej(a,c){for(var d=1,e=-1,b=0;b<a.length;++b)if(0<=a[b])d*=a[b];else if(-1===a[b]){if(-1!==e)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+e+" and dim "+b);e=b}else if(a[b]<0)throw Error("Shapes can not be < 0. Found "+a[b]+" at dim "+b);if(-1===e){if(0<c&&c!==d)throw Error("Size("+c+") must match the product of shape "+a);return a}if(0===d)throw Error("Cannot infer the missing size in ["+a+"] when there are 0 elements");if(c%d!=0)throw Error("The implicit shape can't be a fractional number. Got "+c+" / "+d);var f=a.slice();return f[e]=c/d,f}function ek(a,b){var c=b.length;return d8((a=null==a?b.map(function(b,a){return a}):[].concat(a)).every(function(a){return-c<=a&&a<c}),function(){return"All values in axis param must be in range [-"+c+", "+c+") but got axis "+a}),d8(a.every(function(a){return ee(a)}),function(){return"All values in axis param must be integers but got axis "+a}),a.map(function(a){return a<0?c+a:a})}function el(b,c){for(var f=[],g=[],h=null!=c&&Array.isArray(c)&&0===c.length,d=null==c||h?null:ek(c,b).sort(),e=0,a=0;a<b.length;++a){if(null!=d){if(d[e]===a&&1!==b[a])throw new Error("Can't squeeze axis "+a+" since its dim '"+b[a]+"' is not 1");(null==d[e]||d[e]>a)&&1===b[a]&&(f.push(b[a]),g.push(a)),d[e]<=a&&e++}1!==b[a]&&(f.push(b[a]),g.push(a))}return{newShape:f,keptDims:g}}function em(a,c){var b=null;if(null==a||"float32"===a)b=new Float32Array(c);else if("int32"===a)b=new Int32Array(c);else{if("bool"!==a)throw new Error("Unknown data type "+a);b=new Uint8Array(c)}return b}function en(a,c){var b=null;if(null==a||"float32"===a)b=new Float32Array(c);else if("int32"===a)b=new Int32Array(c);else if("bool"===a)b=new Uint8Array(c);else{if("string"!==a)throw new Error("Unknown data type "+a);b=new Array(c)}return b}function eo(c,d){for(var a=0;a<c.length;a++){var b=c[a];if(isNaN(b)||!isFinite(b))throw Error("A tensor of type "+d+" being uploaded contains "+b+".")}}function ep(a){return"bool"===a||"complex64"===a||"float32"===a||"int32"===a||"string"===a}function eq(a,b){return!("complex64"===b||"float32"===b&&"complex64"!==a||"int32"===b&&"float32"!==a&&"complex64"!==a||"bool"===b&&"bool"===a)}function er(a){return a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array}function es(a){if("float32"===a||"int32"===a)return 4;if("complex64"===a)return 8;if("bool"===a)return 1;throw new Error("Unknown dtype "+a)}function et(a){if(null==a)return 0;var b=0;return a.forEach(function(a){return b+=a.length}),b}function eu(a){return"string"==typeof a||a instanceof String}function ev(a){return"boolean"==typeof a}function ew(a){return"number"==typeof a}function ex(a){return Array.isArray(a)?ex(a[0]):a instanceof Float32Array?"float32":a instanceof Int32Array||a instanceof Uint8Array?"int32":ew(a)?"float32":eu(a)?"string":ev(a)?"bool":"float32"}function ey(a){return!!(a&&a.constructor&&a.call&&a.apply)}function ez(b,c){for(var a=c;a<b;++a)if(b%a==0)return a;return b}function eA(d){var a=d.length;if(a<2)return[];var c=new Array(a-1);c[a-2]=d[a-1];for(var b=a-3;0<=b;--b)c[b]=c[b+1]*d[b+1];return c}function $(a,b,e){if("string"===b)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(a)&&(a=eb(a)),e&&eo(a,b),a instanceof Float32Array&&"float32"===b||a instanceof Int32Array&&"int32"===b||a instanceof Uint8Array&&"bool"===b)return a;if(null==b||"float32"===b||"complex64"===b)return new Float32Array(a);if("int32"===b)return new Int32Array(a);if("bool"!==b)throw new Error("Unknown data type "+b);for(var d=new Uint8Array(a.length),c=0;c<d.length;++c)0!==Math.round(a[c])&&(d[c]=1);return d}function eB(a,b){if(0===a.length)return b[0];var c=a.reduce(function(a,b){return a*b});if(0===c)return[];if(c!==b.length)throw new Error("["+a+"] does not match the input size.");return function h(e,b,f){var c=new Array;if(1===b.length)for(var d=b[0],a=0;a<d;a++)c[a]=f[e+a];else{d=b[0];var g=b.slice(1),i=g.reduce(function(a,b){return a*b});for(a=0;a<d;a++)c[a]=h(e+a*i,g,f)}return c}(0,a,b)}function eC(c,d){for(var a=eD(c,d),b=0;b<a.length;b++)a[b]=1;return a}function eD(b,a){if(null==a||"float32"===a||"complex64"===a)return new Float32Array(b);if("int32"===a)return new Int32Array(b);if("bool"===a)return new Uint8Array(b);throw new Error("Unknown data type "+a)}function eE(){return i.platform.now()}function eF(a){a.forEach(function(b){d8(Number.isInteger(b)&&0<=b,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+a+"]."})})}function eG(b,a){return void 0===a&&(a="utf-8"),a=a||"utf-8",i.platform.encode(b,a)}function eH(b,a){return void 0===a&&(a="utf-8"),a=a||"utf-8",i.platform.decode(b,a)}var eI=Object.freeze({shuffle:d4,clamp:d5,nearestLargerEven:d6,sum:d7,randUniform:function(b,c){var a=Math.random();return c*a+(1-a)*b},distSquared:function(b,e){for(var c=0,a=0;a<b.length;a++){var d=Number(b[a])-Number(e[a]);c+=d*d}return c},assert:d8,assertShapesMatch:d9,assertNonNull:ea,flatten:eb,sizeFromShape:ec,isScalarShape:function(a){return 0===a.length},arraysEqual:ed,isInt:ee,tanh:ef,sizeToSquarishShape:eg,createShuffledIndices:function(c){for(var b=new Uint32Array(c),a=0;a<c;++a)b[a]=a;return d4(b),b},rightPad:eh,repeatedTry:ei,inferFromImplicitShape:ej,parseAxisParam:ek,squeezeShape:el,getTypedArrayFromDType:em,getArrayFromDType:en,checkConversionForErrors:eo,isValidDtype:ep,hasEncodingLoss:eq,isTypedArray:er,bytesPerElement:es,bytesFromStringArray:et,isString:eu,isBoolean:ev,isNumber:ew,inferDtype:ex,isFunction:ey,nearestDivisor:ez,computeStrides:eA,toTypedArray:$,toNestedArray:eB,makeOnesTypedArray:eC,makeZerosTypedArray:eD,now:eE,assertNonNegativeIntegerDimensions:eF,fetch:function(a,b){return i.platform.fetch(a,b)},encodeString:eG,decodeString:eH}),jQ=(jR.prototype.profileKernel=function(b,c,d){var a,e=this,f=this.backendTimer.time(function(){a=d()});return a.forEach(function(a){a.data().then(function(d){(function(c,d,e){if("float32"===d)for(var a=0;a<c.length;a++){var b=c[a];if(isNaN(b)||!isFinite(b))return console.warn("Found "+b+" in the result of '"+e+"'")}})(d,a.dtype,b),f.then(function(f){var g="";null!=f.getExtraProfileInfo&&(g=f.getExtraProfileInfo()),e.logger.logKernelProfile(b,a,d,f.kernelMs,c,g)})})}),a},jR);function jR(a,b){this.backendTimer=a,null==(this.logger=b)&&(this.logger=new jS)}var jS=(jT.prototype.logKernelProfile=function(g,a,o,h,b,i){var j=eh(h+"ms",9),k=eh(g,25),l=a.rank,m=a.size,n=eh(a.shape.toString(),14),c="";for(var d in b){var e=b[d].shape||a.shape,f=e.length;c+=d+": "+f+"D "+(0<f?e:"")+" "}console.log("%c"+k+"	%c"+j+"	%c"+l+"D "+n+"	%c"+m+"	%c"+c+"	%c"+i,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},jT);function jT(){}var jU=7;function jV(a,b,c){return eh(Array.isArray(a)?parseFloat(a[0].toFixed(jU))+" + "+parseFloat(a[1].toFixed(jU))+"j":eu(a)?"'"+a+"'":"bool"===c?jW(a):parseFloat(a.toFixed(jU)).toString(),b)}function jW(a){return 0===a?"false":"true"}function jX(b){for(var c=[],a=0;a<b.length;a+=2)c.push([b[a],b[a+1]]);return c}var eJ=(jZ.prototype.set=function(c){for(var e=this,a=[],b=1;b<arguments.length;b++)a[b-1]=arguments[b];0===a.length&&(a=[0]),d8(a.length===this.rank,function(){return"The number of provided coordinates ("+a.length+") must match the rank ("+e.rank+")"});var d=this.locToIndex(a);this.values[d]=c},jZ.prototype.get=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];0===a.length&&(a=[0]);for(var e=0,d=0,f=a;d<f.length;d++){var g=f[d];if(g<0||g>=this.shape[e]){var i="Requested out of range element at "+a+".   Buffer shape="+this.shape;throw new Error(i)}e++}for(var h=a[a.length-1],c=0;c<a.length-1;++c)h+=this.strides[c]*a[c];return this.values[h]},jZ.prototype.locToIndex=function(a){if(0===this.rank)return 0;if(1===this.rank)return a[0];for(var c=a[a.length-1],b=0;b<a.length-1;++b)c+=this.strides[b]*a[b];return c},jZ.prototype.indexToLoc=function(c){if(0===this.rank)return[];if(1===this.rank)return[c];for(var a=new Array(this.shape.length),b=0;b<a.length-1;++b)a[b]=Math.floor(c/this.strides[b]),c-=a[b]*this.strides[b];return a[a.length-1]=c,a},Object.defineProperty(jZ.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),jZ.prototype.toTensor=function(){return jY().makeTensor(this.values,this.shape,this.dtype)},jZ),jY=null,eK=null,eL=null;function jZ(a,b,c){var e=this;if(this.dtype=b,this.shape=a.slice(),this.size=ec(a),null!=c){var d=c.length;d8(d===this.size,function(){return"Length of values '"+d+"' does not match the size inferred by the shape '"+e.size+"'."})}if("complex64"===b)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=c||en(b,this.size),this.strides=eA(a)}var E=(j$.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},j$.prototype.asScalar=function(){return this.throwIfDisposed(),d8(1===this.size,function(){return"The array must have only 1 element."}),this.reshape([])},j$.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},j$.prototype.as2D=function(a,b){return this.throwIfDisposed(),this.reshape([a,b])},j$.prototype.as3D=function(a,b,c){return this.throwIfDisposed(),this.reshape([a,b,c])},j$.prototype.as4D=function(a,b,c,d){return this.throwIfDisposed(),this.reshape([a,b,c,d])},j$.prototype.as5D=function(a,b,c,d,e){return this.throwIfDisposed(),this.reshape([a,b,c,d,e])},j$.prototype.asType=function(a){return this.throwIfDisposed(),eK.cast(this,a)},Object.defineProperty(j$.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),j$.prototype.buffer=function(){return jL(this,void 0,void 0,function(){var a;return jM(this,function(b){switch(b.label){case 0:return[4,this.data()];case 1:return a=b.sent(),[2,eK.buffer(this.shape,this.dtype,a)]}})})},j$.prototype.bufferSync=function(){return eK.buffer(this.shape,this.dtype,this.dataSync())},j$.prototype.array=function(){return jL(this,void 0,void 0,function(){var a;return jM(this,function(b){switch(b.label){case 0:return[4,this.data()];case 1:return a=b.sent(),[2,eB(this.shape,a)]}})})},j$.prototype.arraySync=function(){return eB(this.shape,this.dataSync())},j$.prototype.data=function(){return jL(this,void 0,void 0,function(){var a,b;return jM(this,function(c){switch(c.label){case 0:return this.throwIfDisposed(),a=jY().read(this.dataId),"string"!==this.dtype?[3,2]:[4,a];case 1:b=c.sent();try{return[2,b.map(function(a){return eH(a)})]}catch(d){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}c.label=2;case 2:return[2,a]}})})},j$.prototype.dataSync=function(){this.throwIfDisposed();var a=jY().readSync(this.dataId);if("string"===this.dtype)try{return a.map(function(a){return eH(a)})}catch(b){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return a},j$.prototype.bytes=function(){return jL(this,void 0,void 0,function(){var a;return jM(this,function(b){switch(b.label){case 0:return this.throwIfDisposed(),[4,jY().read(this.dataId)];case 1:return a=b.sent(),"string"===this.dtype?[2,a]:[2,new Uint8Array(a.buffer)]}})})},j$.prototype.dispose=function(){this.isDisposed||(jY().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(j$.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),j$.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},j$.prototype.toFloat=function(){return this.asType("float32")},j$.prototype.toInt=function(){return this.asType("int32")},j$.prototype.toBool=function(){return this.asType("bool")},j$.prototype.print=function(a){return void 0===a&&(a=!1),eK.print(this,a)},j$.prototype.reshape=function(a){return this.throwIfDisposed(),eK.reshape(this,a)},j$.prototype.reshapeAs=function(a){return this.throwIfDisposed(),this.reshape(a.shape)},j$.prototype.expandDims=function(a){return void 0===a&&(a=0),eK.expandDims(this,a)},j$.prototype.cumsum=function(a,b,c){return void 0===a&&(a=0),void 0===b&&(b=!1),void 0===c&&(c=!1),eK.cumsum(this,a,b,c)},j$.prototype.squeeze=function(a){return this.throwIfDisposed(),eK.squeeze(this,a)},j$.prototype.clone=function(){return this.throwIfDisposed(),eK.clone(this)},j$.prototype.oneHot=function(a,b,c){return this.throwIfDisposed(),eK.oneHot(this,a,b,c)},j$.prototype.toString=function(d){var e,b,c,g,f,h,i,j,a;return void 0===d&&(d=!1),e=this.dataSync(),b=this.shape,c=this.dtype,g=d,f=eA(b),h=function(e,f,g,h){var i=ec(f),b=h[h.length-1],c=new Array(b).fill(0),j=f.length,k="complex64"===g?jX(e):e;if(1<j)for(var d=0;d<i/b;d++)for(var l=d*b,a=0;a<b;a++)c[a]=Math.max(c[a],jV(k[l+a],0,g).length);return c}(e,b,c,f),i=b.length,j=function k(c,l,d,s,m,n){void 0===n&&(n=!0);var f,i="complex64"===d?2:1,e=l[0],j=l.length;if(0===j)return"complex64"===d?[jV(jX(c)[0],0,d)]:"bool"===d?[jW(c[0])]:[c[0].toString()];if(1===j){if(20<e){var v=3*i,o=Array.from(c.slice(0,v)),p=Array.from(c.slice((e-3)*i,e*i));return"complex64"===d&&(o=jX(o),p=jX(p)),["["+o.map(function(a,b){return jV(a,m[b],d)}).join(", ")+", ..., "+p.map(function(a,b){return jV(a,m[e-3+b],d)}).join(", ")+"]"]}return["["+("complex64"===d?jX(c):Array.from(c)).map(function(a,b){return jV(a,m[b],d)}).join(", ")+"]"]}var q=l.slice(1),r=s.slice(1),g=s[0]*i,b=[];if(20<e){for(var a=0;a<3;a++){var h=(f=a*g)+g;b.push.apply(b,k(c.slice(f,h),q,d,r,m,!1))}for(b.push("..."),a=e-3;a<e;a++)h=(f=a*g)+g,b.push.apply(b,k(c.slice(f,h),q,d,r,m,a===e-1))}else for(a=0;a<e;a++)h=(f=a*g)+g,b.push.apply(b,k(c.slice(f,h),q,d,r,m,a===e-1));var t=2===j?",":"";for(b[0]="["+b[0]+t,a=1;a<b.length-1;a++)b[a]=" "+b[a]+t;var u=",\n";for(a=2;a<j;a++)u+="\n";return b[b.length-1]=" "+b[b.length-1]+"]"+(n?"":u),b}(e,b,c,f,h),a=["Tensor"],g&&(a.push("  dtype: "+c),a.push("  rank: "+i),a.push("  shape: ["+b+"]"),a.push("  values:")),a.push(j.map(function(a){return"    "+a}).join("\n")),a.join("\n")},j$.prototype.tile=function(a){return this.throwIfDisposed(),eK.tile(this,a)},j$.prototype.gather=function(b,a){return void 0===a&&(a=0),this.throwIfDisposed(),eK.gather(this,b,a)},j$.prototype.matMul=function(c,a,b){return void 0===a&&(a=!1),void 0===b&&(b=!1),this.throwIfDisposed(),eK.matMul(this,c,a,b)},j$.prototype.dot=function(a){return this.throwIfDisposed(),eK.dot(this,a)},j$.prototype.norm=function(a,b,c){return void 0===a&&(a="euclidean"),void 0===b&&(b=null),void 0===c&&(c=!1),this.throwIfDisposed(),eK.norm(this,a,b,c)},j$.prototype.slice=function(a,b){return this.throwIfDisposed(),eK.slice(this,a,b)},j$.prototype.reverse=function(a){return this.throwIfDisposed(),eK.reverse(this,a)},j$.prototype.concat=function(a,b){return void 0===b&&(b=0),this.throwIfDisposed(),a instanceof j$&&(a=[a]),eK.concat([this].concat(a),b)},j$.prototype.split=function(b,a){return void 0===a&&(a=0),this.throwIfDisposed(),eK.split(this,b,a)},j$.prototype.stack=function(b,a){return void 0===a&&(a=0),eK.stack([this,b],a)},j$.prototype.unstack=function(a){return void 0===a&&(a=0),eK.unstack(this,a)},j$.prototype.pad=function(b,a){return void 0===a&&(a=0),eK.pad(this,b,a)},j$.prototype.batchNormalization=function(b,c,a,d,e){return void 0===a&&(a=.001),eL("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(b,c,e,d,a)},j$.prototype.batchNorm=function(b,c,d,e,a){return void 0===a&&(a=.001),this.throwIfDisposed(),eK.batchNorm(this,b,c,d,e,a)},j$.prototype.all=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),eK.all(this,a,b)},j$.prototype.any=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),eK.any(this,a,b)},j$.prototype.logSumExp=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),eK.logSumExp(this,a,b)},j$.prototype.sum=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),eK.sum(this,a,b)},j$.prototype.prod=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),eK.prod(this,a,b)},j$.prototype.mean=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),eK.mean(this,a,b)},j$.prototype.min=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),eK.min(this,a,b)},j$.prototype.max=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),eK.max(this,a,b)},j$.prototype.argMin=function(a){return void 0===a&&(a=null),this.throwIfDisposed(),eK.argMin(this,a)},j$.prototype.argMax=function(a){return void 0===a&&(a=null),this.throwIfDisposed(),eK.argMax(this,a)},j$.prototype.cast=function(a){return this.throwIfDisposed(),eK.cast(this,a)},j$.prototype.add=function(a){return this.throwIfDisposed(),eK.add(this,a)},j$.prototype.addStrict=function(a){return this.throwIfDisposed(),eK.addStrict(this,a)},j$.prototype.atan2=function(a){return this.throwIfDisposed(),eK.atan2(this,a)},j$.prototype.sub=function(a){return this.throwIfDisposed(),eK.sub(this,a)},j$.prototype.subStrict=function(a){return this.throwIfDisposed(),eK.subStrict(this,a)},j$.prototype.pow=function(a){return this.throwIfDisposed(),eK.pow(this,a)},j$.prototype.powStrict=function(a){return this.throwIfDisposed(),eK.powStrict(this,a)},j$.prototype.mul=function(a){return this.throwIfDisposed(),eK.mul(this,a)},j$.prototype.mulStrict=function(a){return this.throwIfDisposed(),eK.mulStrict(this,a)},j$.prototype.div=function(a){return this.throwIfDisposed(),eK.div(this,a)},j$.prototype.divNoNan=function(a){return this.throwIfDisposed(),eK.divNoNan(this,a)},j$.prototype.floorDiv=function(a){return this.throwIfDisposed(),eK.floorDiv(this,a)},j$.prototype.divStrict=function(a){return this.throwIfDisposed(),eK.divStrict(this,a)},j$.prototype.minimum=function(a){return this.throwIfDisposed(),eK.minimum(this,a)},j$.prototype.minimumStrict=function(a){return this.throwIfDisposed(),eK.minimumStrict(this,a)},j$.prototype.maximum=function(a){return this.throwIfDisposed(),eK.maximum(this,a)},j$.prototype.maximumStrict=function(a){return this.throwIfDisposed(),eK.maximumStrict(this,a)},j$.prototype.mod=function(a){return this.throwIfDisposed(),eK.mod(this,a)},j$.prototype.modStrict=function(a){return this.throwIfDisposed(),eK.modStrict(this,a)},j$.prototype.squaredDifference=function(a){return this.throwIfDisposed(),eK.squaredDifference(this,a)},j$.prototype.squaredDifferenceStrict=function(a){return this.throwIfDisposed(),eK.squaredDifferenceStrict(this,a)},j$.prototype.transpose=function(a){return this.throwIfDisposed(),eK.transpose(this,a)},j$.prototype.notEqual=function(a){return this.throwIfDisposed(),eK.notEqual(this,a)},j$.prototype.notEqualStrict=function(a){return this.throwIfDisposed(),eK.notEqualStrict(this,a)},j$.prototype.less=function(a){return this.throwIfDisposed(),eK.less(this,a)},j$.prototype.lessStrict=function(a){return this.throwIfDisposed(),eK.lessStrict(this,a)},j$.prototype.equal=function(a){return this.throwIfDisposed(),eK.equal(this,a)},j$.prototype.equalStrict=function(a){return this.throwIfDisposed(),eK.equalStrict(this,a)},j$.prototype.lessEqual=function(a){return this.throwIfDisposed(),eK.lessEqual(this,a)},j$.prototype.lessEqualStrict=function(a){return this.throwIfDisposed(),eK.lessEqualStrict(this,a)},j$.prototype.greater=function(a){return this.throwIfDisposed(),eK.greater(this,a)},j$.prototype.greaterStrict=function(a){return this.throwIfDisposed(),eK.greaterStrict(this,a)},j$.prototype.greaterEqual=function(a){return this.throwIfDisposed(),eK.greaterEqual(this,a)},j$.prototype.greaterEqualStrict=function(a){return this.throwIfDisposed(),eK.greaterEqualStrict(this,a)},j$.prototype.logicalAnd=function(a){return this.throwIfDisposed(),eK.logicalAnd(this,a)},j$.prototype.logicalOr=function(a){return this.throwIfDisposed(),eK.logicalOr(this,a)},j$.prototype.logicalNot=function(){return this.throwIfDisposed(),eK.logicalNot(this)},j$.prototype.logicalXor=function(a){return this.throwIfDisposed(),eK.logicalXor(this,a)},j$.prototype.where=function(a,b){return this.throwIfDisposed(),eK.where(a,this,b)},j$.prototype.neg=function(){return this.throwIfDisposed(),eK.neg(this)},j$.prototype.ceil=function(){return this.throwIfDisposed(),eK.ceil(this)},j$.prototype.floor=function(){return this.throwIfDisposed(),eK.floor(this)},j$.prototype.sign=function(){return this.throwIfDisposed(),eK.sign(this)},j$.prototype.isNaN=function(){return this.throwIfDisposed(),eK.isNaN(this)},j$.prototype.isInf=function(){return this.throwIfDisposed(),eK.isInf(this)},j$.prototype.isFinite=function(){return this.throwIfDisposed(),eK.isFinite(this)},j$.prototype.exp=function(){return this.throwIfDisposed(),eK.exp(this)},j$.prototype.expm1=function(){return this.throwIfDisposed(),eK.expm1(this)},j$.prototype.log=function(){return this.throwIfDisposed(),eK.log(this)},j$.prototype.log1p=function(){return this.throwIfDisposed(),eK.log1p(this)},j$.prototype.sqrt=function(){return this.throwIfDisposed(),eK.sqrt(this)},j$.prototype.rsqrt=function(){return this.throwIfDisposed(),eK.rsqrt(this)},j$.prototype.square=function(){return this.throwIfDisposed(),eK.square(this)},j$.prototype.reciprocal=function(){return this.throwIfDisposed(),eK.reciprocal(this)},j$.prototype.abs=function(){return this.throwIfDisposed(),eK.abs(this)},j$.prototype.clipByValue=function(a,b){return this.throwIfDisposed(),eK.clipByValue(this,a,b)},j$.prototype.relu=function(){return this.throwIfDisposed(),eK.relu(this)},j$.prototype.relu6=function(){return this.throwIfDisposed(),eK.relu6(this)},j$.prototype.elu=function(){return this.throwIfDisposed(),eK.elu(this)},j$.prototype.selu=function(){return this.throwIfDisposed(),eK.selu(this)},j$.prototype.leakyRelu=function(a){return void 0===a&&(a=.2),this.throwIfDisposed(),eK.leakyRelu(this,a)},j$.prototype.prelu=function(a){return this.throwIfDisposed(),eK.prelu(this,a)},j$.prototype.sigmoid=function(){return this.throwIfDisposed(),eK.sigmoid(this)},j$.prototype.logSigmoid=function(){return this.throwIfDisposed(),eK.logSigmoid(this)},j$.prototype.softplus=function(){return this.throwIfDisposed(),eK.softplus(this)},j$.prototype.zerosLike=function(){return this.throwIfDisposed(),eK.zerosLike(this)},j$.prototype.onesLike=function(){return this.throwIfDisposed(),eK.onesLike(this)},j$.prototype.sin=function(){return this.throwIfDisposed(),eK.sin(this)},j$.prototype.cos=function(){return this.throwIfDisposed(),eK.cos(this)},j$.prototype.tan=function(){return this.throwIfDisposed(),eK.tan(this)},j$.prototype.asin=function(){return this.throwIfDisposed(),eK.asin(this)},j$.prototype.acos=function(){return this.throwIfDisposed(),eK.acos(this)},j$.prototype.atan=function(){return this.throwIfDisposed(),eK.atan(this)},j$.prototype.sinh=function(){return this.throwIfDisposed(),eK.sinh(this)},j$.prototype.cosh=function(){return this.throwIfDisposed(),eK.cosh(this)},j$.prototype.tanh=function(){return this.throwIfDisposed(),eK.tanh(this)},j$.prototype.asinh=function(){return this.throwIfDisposed(),eK.asinh(this)},j$.prototype.acosh=function(){return this.throwIfDisposed(),eK.acosh(this)},j$.prototype.atanh=function(){return this.throwIfDisposed(),eK.atanh(this)},j$.prototype.erf=function(){return this.throwIfDisposed(),eK.erf(this)},j$.prototype.round=function(){return this.throwIfDisposed(),eK.round(this)},j$.prototype.step=function(a){return void 0===a&&(a=0),this.throwIfDisposed(),eK.step(this,a)},j$.prototype.softmax=function(a){return void 0===a&&(a=-1),this.throwIfDisposed(),eK.softmax(this,a)},j$.prototype.logSoftmax=function(a){return void 0===a&&(a=-1),this.throwIfDisposed(),eK.logSoftmax(this,a)},j$.prototype.resizeBilinear=function(b,a){return void 0===a&&(a=!1),this.throwIfDisposed(),eK.image.resizeBilinear(this,b,a)},j$.prototype.resizeNearestNeighbor=function(b,a){return void 0===a&&(a=!1),this.throwIfDisposed(),eK.image.resizeNearestNeighbor(this,b,a)},j$.prototype.conv1d=function(c,d,e,a,b,f){return void 0===a&&(a="NWC"),void 0===b&&(b=1),this.throwIfDisposed(),eK.conv1d(this,c,d,e,a,b,f)},j$.prototype.conv2d=function(c,d,e,a,b,f){return void 0===a&&(a="NHWC"),void 0===b&&(b=[1,1]),this.throwIfDisposed(),eK.conv2d(this,c,d,e,a,b,f)},j$.prototype.conv2dTranspose=function(a,b,c,d,e){return this.throwIfDisposed(),eK.conv2dTranspose(this,a,b,c,d,e)},j$.prototype.depthwiseConv2D=function(c,d,e,a,b,f){return void 0===a&&(a="NHWC"),void 0===b&&(b=[1,1]),this.throwIfDisposed(),eK.depthwiseConv2d(this,c,d,e,a,b,f)},j$.prototype.separableConv2d=function(c,d,e,f,a,b){return void 0===a&&(a=[1,1]),void 0===b&&(b="NHWC"),this.throwIfDisposed(),eK.separableConv2d(this,c,d,e,f,a,b)},j$.prototype.avgPool=function(a,b,c,d){return this.throwIfDisposed(),eK.avgPool(this,a,b,c,d)},j$.prototype.maxPool=function(a,b,c,d){return this.throwIfDisposed(),eK.maxPool(this,a,b,c,d)},j$.prototype.localResponseNormalization=function(a,b,c,d){return void 0===a&&(a=5),void 0===b&&(b=1),void 0===c&&(c=1),void 0===d&&(d=.5),eK.localResponseNormalization(this,a,b,c,d)},j$.prototype.pool=function(a,b,c,d,e){return this.throwIfDisposed(),eK.pool(this,a,b,c,d,e)},j$.prototype.variable=function(a,b,c){return void 0===a&&(a=!0),this.throwIfDisposed(),jY().makeVariable(this,a,b,c)},j$.prototype.unsortedSegmentSum=function(a,b){return this.throwIfDisposed(),eK.unsortedSegmentSum(this,a,b)},j$.prototype.batchToSpaceND=function(a,b){return this.throwIfDisposed(),eK.batchToSpaceND(this,a,b)},j$.prototype.spaceToBatchND=function(a,b){return this.throwIfDisposed(),eK.spaceToBatchND(this,a,b)},j$.prototype.topk=function(a,b){return void 0===a&&(a=1),void 0===b&&(b=!0),this.throwIfDisposed(),eK.topk(this,a,b)},j$.prototype.stridedSlice=function(f,g,h,a,b,c,d,e){return void 0===a&&(a=0),void 0===b&&(b=0),void 0===c&&(c=0),void 0===d&&(d=0),void 0===e&&(e=0),this.throwIfDisposed(),eK.stridedSlice(this,f,g,h,a,b,c,d,e)},j$.prototype.depthToSpace=function(a,b){return this.throwIfDisposed(),eK.depthToSpace(this,a,b)},j$.prototype.fft=function(){return this.throwIfDisposed(),eK.spectral.fft(this)},j$.prototype.ifft=function(){return this.throwIfDisposed(),eK.spectral.ifft(this)},j$.prototype.rfft=function(){return this.throwIfDisposed(),eK.spectral.rfft(this)},j$.prototype.irfft=function(){return this.throwIfDisposed(),eK.spectral.irfft(this)},j$);function j$(a,b,c,d){this.kept=!1,this.isDisposedInternal=!1,this.shape=a.slice(),this.dtype=b||"float32",this.size=ec(a),this.strides=eA(a),this.dataId=c,this.id=d,this.rankType=this.rank<5?this.rank.toString():"higher"}Object.defineProperty(E,Symbol.hasInstance,{value:function(a){return!!a&&null!=a.dataId&&null!=a.shape&&null!=a.dtype}});var F,G,H,I,J,eM,x,y,z,A,p,ac=(f(j_,eM=E),j_.prototype.assign=function(a){if(a.dtype!==this.dtype)throw new Error("dtype of the new value ("+a.dtype+") and previous value ("+this.dtype+") must match");if(!ed(a.shape,this.shape))throw new Error("shape of the new value ("+a.shape+") and previous value ("+this.shape+") must match");jY().disposeTensor(this),this.dataId=a.dataId,jY().incRef(this,null)},j_.prototype.dispose=function(){jY().disposeVariable(this),this.isDisposedInternal=!0},j_);function j_(a,c,d,e){var b=eM.call(this,a.shape,a.dtype,a.dataId,e)||this;return b.trainable=c,b.name=d,b}Object.defineProperty(ac,Symbol.hasInstance,{value:function(a){return a instanceof E&&null!=a.assign&&a.assign instanceof Function}}),(p=F=F||{}).R0="R0",p.R1="R1",p.R2="R2",p.R3="R3",p.R4="R4",p.R5="R5",p.R6="R6",(A=G=G||{}).float32="float32",A.int32="int32",A.bool="int32",A.complex64="complex64",(z=H=H||{}).float32="float32",z.int32="int32",z.bool="bool",z.complex64="complex64",(y=I=I||{}).float32="float32",y.int32="float32",y.bool="float32",y.complex64="complex64",(x=J=J||{}).float32="complex64",x.int32="complex64",x.bool="complex64",x.complex64="complex64";var j0={float32:I,int32:G,bool:H,complex64:J};function eN(a,b){if("string"!==a&&"string"!==b)return j0[a][b];if("string"===a&&"string"===b)return"string";throw new Error("Can not upcast "+a+" with "+b)}function eO(a){return eN(a,"int32")}function eP(a,b){if(a.dtype===b.dtype)return[a,b];var c=eN(a.dtype,b.dtype);return[a.cast(c),b.cast(c)]}function eQ(a,b){d8(a.dtype===b.dtype,function(){return"The dtypes of the first("+a.dtype+") and second("+b.dtype+") input must match"})}function eR(b){var a=[];return function f(a,d,b){if(null!=a){if(a instanceof E)d.push(a);else if(h=a,Array.isArray(h)||"object"==typeof h){var h,e=a;for(var g in e){var c=e[g];b.has(c)||(b.add(c),f(c,d,b))}}}}(b,a,new Set),a}var j1,eS=Object.freeze({makeTypesMatch:eP,assertTypesMatch:eQ,isTensorInList:function(c,b){for(var a=0;a<b.length;a++)if(b[a].id===c.id)return!0;return!1},getTensorsInContainer:eR}),j2=(j5.prototype.dispose=function(){for(var a in this.registeredVariables)this.registeredVariables[a].dispose()},j5),j3=(j4.prototype.ready=function(){return jL(this,void 0,void 0,function(){var a,b,c;return jM(this,function(d){switch(d.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then(function(){})];if(null!=this.backendInstance)return[2];a=this.getSortedBackends(),b=0,d.label=1;case 1:return b<a.length?(c=a[b],[4,this.initializeBackend(c).success]):[3,5];case 2:return d.sent()?[4,this.setBackend(c)]:[3,4];case 3:return d.sent(),[2];case 4:return b++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(j4.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");if(null==this.backendInstance){var a=this.initializeBackendsAndReturnBest(),b=a.name;if(a.asyncInit)throw new Error("The highest priority backend '"+b+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");this.setBackend(b)}return this.backendInstance},enumerable:!0,configurable:!0}),j4.prototype.backendNames=function(){return Object.keys(this.registryFactory)},j4.prototype.findBackend=function(a){return a in this.registry||a in this.registryFactory&&!this.initializeBackend(a).asyncInit?this.registry[a]:null},j4.prototype.findBackendFactory=function(a){return a in this.registryFactory?this.registryFactory[a].factory:null},j4.prototype.registerBackend=function(a,c,b){return void 0===b&&(b=1),a in this.registryFactory?(console.warn(a+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[a]={factory:c,priority:b},!0)},j4.prototype.setBackend=function(a){return jL(this,void 0,void 0,function(){var b,c,d;return jM(this,function(e){switch(e.label){case 0:if(null==this.registryFactory[a])throw new Error("Backend name '"+a+"' not found in registry");return this.backendName=a,null!=this.registry[a]?[3,4]:(this.backendInstance=null,c=(b=this.initializeBackend(a)).success,b.asyncInit?[4,c]:[3,2]);case 1:return d=e.sent(),[3,3];case 2:d=c,e.label=3;case 3:if(!d)return[2,!1];e.label=4;case 4:return this.backendInstance=this.registry[a],this.setupRegisteredKernels(),this.profiler=new jQ(this.backendInstance),[2,!0]}})})},j4.prototype.setupRegisteredKernels=function(){var a=this;d3(this.backendName).forEach(function(b){null!=b.setupFunc&&b.setupFunc(a.backendInstance)})},j4.prototype.disposeRegisteredKernels=function(a){var b=this;d3(a).forEach(function(c){null!=c.disposeFunc&&c.disposeFunc(b.registry[a])})},j4.prototype.initializeBackend=function(a){var f=this,c=this.registryFactory[a];if(null==c)throw new Error("Cannot initialize backend "+a+", no registration found.");try{var b=c.factory();if(Promise.resolve(b)!==b)return this.registry[a]=b,{success:!0,asyncInit:!1};var g=++this.pendingBackendInitId,e=b.then(function(b){return!(g<f.pendingBackendInitId||(f.registry[a]=b,f.pendingBackendInit=null))}).catch(function(b){return f.pendingBackendInitId,f.pendingBackendInit=null,console.warn("Initialization of backend "+a+" failed"),console.warn(b.stack||b.message),!1});return{success:this.pendingBackendInit=e,asyncInit:!0}}catch(d){return console.warn("Initialization of backend "+a+" failed"),console.warn(d.stack||d.message),{success:!1,asyncInit:!1}}},j4.prototype.removeBackend=function(a){if(!(a in this.registryFactory))throw new Error(a+" backend not found in registry");this.backendName===a&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,a in this.registry&&(this.disposeRegisteredKernels(a),this.registry[a].dispose(),delete this.registry[a]),delete this.registryFactory[a],this.backendName===a&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},j4.prototype.getSortedBackends=function(){var a=this;if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(b,c){return a.registryFactory[c].priority-a.registryFactory[b].priority})},j4.prototype.initializeBackendsAndReturnBest=function(){for(var b=this.getSortedBackends(),a=0;a<b.length;a++){var c=b[a],d=this.initializeBackend(c),f=d.success,e=d.asyncInit;if(e||f)return{name:c,asyncInit:e}}throw new Error("Could not initialize any backends, all backend initializations failed.")},j4.prototype.moveData=function(c,a){var b=this.state.tensorInfo.get(a),d=b.backend,e=this.readSync(a);d.disposeData(a),(b.backend=c).move(a,e,b.shape,b.dtype),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++},j4.prototype.tidy=function(a,b){var d,e=this,c=null;if(null==b){if("function"!=typeof a)throw new Error("Please provide a function to tidy()");b=a}else{if("string"!=typeof a&&!(a instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof b)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");c=a}return this.scopedRun(function(){return e.startScope(c)},function(){return e.endScope(d)},function(){return(d=b())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),d})},j4.prototype.scopedRun=function(b,a,c){b();try{var d=c();return a(),d}catch(e){throw a(),e}},j4.prototype.nextTensorId=function(){return j4.nextTensorId++},j4.prototype.nextVariableId=function(){return j4.nextVariableId++},j4.prototype.clone=function(a){var b=this.makeTensorFromDataId(a.dataId,a.shape,a.dtype);return this.addTapeNode(this.state.activeScope.name,{x:a},[b],function(a){return{x:function(){return a.toFloat()}}},[]),b},j4.prototype.runKernel=function(a,b,c,d,e){return this.runKernelFunc(null,b,null,a,c,d,e)},j4.prototype.shouldCheckForMemLeaks=function(){return this.ENV.getBool("IS_TEST")},j4.prototype.checkKernelForMemLeak=function(b,c,d){var e=this.backend.numDataIds(),f=0;d.forEach(function(a){f+="complex64"===a.dtype?3:1});var a=e-c-f-this.state.numDataMovesStack[this.state.numDataMovesStack.length-1];if(0<a)throw new Error("Backend '"+this.backendName+"' has an internal memory leak ("+a+" data ids) after running '"+b+"'")},j4.prototype.runKernelFunc=function(n,c,f,a,o,d,e){var b,p=this;void 0===d&&(d=[]),void 0===e&&(e=[]);var g=[],h=this.isTapeOn();function q(a){h&&(g=a.map(function(a){return p.keep(p.clone(a))}))}null==a&&(a=null!=this.state.activeScope?this.state.activeScope.name:"");var i,j=this.state.numBytes,k=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0);var l,m=d1(a,this.backendName);return i=null!=m?function(){var g=p.backend.numDataIds();l=m.kernelFunc({inputs:c,attrs:o,backend:p.backend});var b=Array.isArray(l)?l:[l];p.shouldCheckForMemLeaks()&&p.checkKernelForMemLeak(a,g,b);var f=b.map(function(a){var b=a.dataId,c=a.shape,d=a.dtype;return p.makeTensorFromDataId(b,c,d)}),h=f.filter(function(b,a){return e[a]});return q((d||[]).slice().concat(h)),f}:function(){var c=p.backend.numDataIds();l=p.tidy(function(){return n(p.backend,q)});var b=Array.isArray(l)?l:[l];return p.shouldCheckForMemLeaks()&&p.checkKernelForMemLeak(a,c,b),b},this.scopedRun(function(){return p.state.kernelDepth++},function(){return p.state.kernelDepth--},function(){b=p.ENV.getBool("DEBUG")?p.profiler.profileKernel(a,c,function(){return i()}):i()}),h&&this.addTapeNode(a,c,b,f,g),this.state.profiling&&this.state.activeProfile.kernels.push({name:a,bytesAdded:this.state.numBytes-j,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-k,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(c).map(function(a){return c[a].shape}),outputShapes:b.map(function(a){return a.shape})}),Array.isArray(l)?b:b[0]},j4.prototype.makeTensor=function(b,e,a,c){if(null==b)throw new Error("Values passed to engine.makeTensor() are null");a=a||"float32",c=c||this.backend;var d=b;"string"===a&&eu(b[0])&&(d=b.map(function(a){return eG(a)}));var f=c.write(d,e,a),g=new E(e,a,f,this.nextTensorId());if(this.incRef(g,c),"string"===a){var h=this.state.tensorInfo.get(f),i=et(d);this.state.numBytes+=i-h.bytes,h.bytes=i}return g},j4.prototype.makeTensorFromDataId=function(c,d,a,e){var b=new E(d,a=a||"float32",c,this.nextTensorId());return this.incRef(b,e),b},j4.prototype.makeVariable=function(b,c,d,e){void 0===c&&(c=!0),d=d||this.nextVariableId().toString(),null!=e&&e!==b.dtype&&(b=b.asType(e));var a=new ac(b,c,d,this.nextTensorId());if(null!=this.state.registeredVariables[a.name])throw new Error("Variable with name "+a.name+" was already registered");return this.state.registeredVariables[a.name]=a,this.incRef(a,this.backend),a},j4.prototype.incRef=function(a,c){var d=this.state.tensorInfo.has(a.dataId)?this.state.tensorInfo.get(a.dataId).refCount:0;if(this.state.numTensors++,"string"===a.dtype&&this.state.numStringTensors++,0===d){this.state.numDataBuffers++;var b=0;"complex64"!==a.dtype&&"string"!==a.dtype&&(b=a.size*es(a.dtype)),this.state.tensorInfo.set(a.dataId,{backend:c||this.backend,dtype:a.dtype,shape:a.shape,bytes:b,refCount:0}),this.state.numBytes+=b}this.state.tensorInfo.get(a.dataId).refCount++,a instanceof ac||this.track(a)},j4.prototype.disposeTensor=function(a){if(this.state.tensorInfo.has(a.dataId)){this.state.numTensors--,"string"===a.dtype&&this.state.numStringTensors--;var b=this.state.tensorInfo.get(a.dataId);b.refCount<=1?("complex64"!==a.dtype&&(this.state.numBytes-=b.bytes),this.state.numDataBuffers--,b.backend.disposeData(a.dataId),this.state.tensorInfo.delete(a.dataId)):this.state.tensorInfo.get(a.dataId).refCount--}},j4.prototype.disposeVariables=function(){for(var a in this.state.registeredVariables){var b=this.state.registeredVariables[a];this.disposeVariable(b)}},j4.prototype.disposeVariable=function(a){this.disposeTensor(a),null!=this.state.registeredVariables[a.name]&&delete this.state.registeredVariables[a.name]},j4.prototype.memory=function(){var a=this.backend.memory();return a.numTensors=this.state.numTensors,a.numDataBuffers=this.state.numDataBuffers,a.numBytes=this.state.numBytes,0<this.state.numStringTensors&&(a.unreliable=!0,null==a.reasons&&(a.reasons=[]),a.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),a},j4.prototype.profile=function(a){return jL(this,void 0,void 0,function(){var b,c;return jM(this,function(d){return this.state.profiling=!0,b=this.state.numBytes,c=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=a(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(a){return a.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-b,this.state.activeProfile.newTensors=this.state.numTensors-c,[2,this.state.activeProfile]})})},j4.prototype.isTapeOn=function(){return 0<this.state.gradientDepth&&0===this.state.kernelDepth},j4.prototype.addTapeNode=function(a,e,f,b,g){var h=this,c={id:this.state.nextTapeNodeId++,kernelName:a,inputs:e,outputs:f,saved:g},d=d2(a);null!=d&&(b=d.gradFunc),null!=b&&(c.gradient=function(a){return a=a.map(function(b,c){if(null!=b)return b;var a=f[c],d=eD(a.size,a.dtype);return h.makeTensor(d,a.shape,a.dtype)}),b(1<a.length?a:a[0],g)}),this.state.activeTape.push(c)},j4.prototype.keep=function(a){return a.kept=!0,a},j4.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},j4.prototype.endTape=function(){this.state.gradientDepth--},j4.prototype.startScope=function(b){var a={track:[],name:"unnamed scope",id:this.state.nextScopeId++};b&&(a.name=b),this.state.scopeStack.push(a),this.state.activeScope=a},j4.prototype.endScope=function(d){for(var f=this,c=eR(d),e=new Set(c.map(function(a){return a.id})),a=0;a<this.state.activeScope.track.length;a++){var b=this.state.activeScope.track[a];b.kept||e.has(b.id)||b.dispose()}var g=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],c.forEach(function(a){a.kept||a.scopeId!==g.id||f.track(a)})},j4.prototype.gradients=function(f,a,b,c){var g=this;if(void 0===c&&(c=!1),d8(0<a.length,function(){return"gradients() received an empty list of xs."}),null!=b&&"float32"!==b.dtype)throw new Error("dy must have 'float32' dtype, but has '"+b.dtype+"'");var d=this.scopedRun(function(){return g.startTape()},function(){return g.endTape()},function(){return g.tidy("forward",f)});d8(d instanceof E,function(){return"The result y returned by f() must be a tensor."});var e=function(c,g,q){for(var b,h={},k={},a=0;a<g.length;a++)h[g[a].id]=!0;for(a=0;a<c.length;a++){var f=(b=c[a]).inputs;for(var d in f){for(var r=f[d],l=!1,e=0;e<g.length;e++)if(h[r.id]){b.outputs.forEach(function(a){return h[a.id]=!0}),l=!0,k[b.id]=!0;break}if(l)break}}var i={};i[q.id]=!0;var m={};for(a=c.length-1;0<=a;a--)for(f=(b=c[a]).inputs,e=0;e<b.outputs.length;e++)if(i[b.outputs[e].id]){for(var d in f)i[f[d].id]=!0,m[b.id]=!0;break}var n=[];for(a=0;a<c.length;a++)if(k[(b=c[a]).id]&&m[b.id]){var o={};for(var d in b.inputs){var p=b.inputs[d];h[p.id]&&(o[d]=p)}var j=Object.assign({},b);j.inputs=o,j.outputs=b.outputs,n.push(j)}return n}(this.state.activeTape,a,d);if(!c&&0===e.length&&0<a.length)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var c,f,h={};h[d.id]=null==b?(f=eC(ec(c=d.shape),"float32"),ad.makeTensor(f,c,"float32")):b,function(d,b){for(var c=function(c){var a=b[c],e=[];if(a.outputs.forEach(function(b){var a=d[b.id];null!=a?e.push(a):e.push(null)}),null==a.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+a.kernelName+".");function f(e){if(!(e in i))throw new Error("Cannot backprop through input "+e+". Available gradients found: "+Object.keys(i)+".");var b=function(a){return g.tidy(a)}(function(){return i[e]()});if("float32"!==b.dtype)throw new Error("Error in gradient for op "+a.kernelName+". The gradient of input "+e+" must have 'float32' dtype, but has '"+b.dtype+"'");var c=a.inputs[e];if(!ed(b.shape,c.shape))throw new Error("Error in gradient for op "+a.kernelName+". The gradient of input '"+e+"' has shape '"+b.shape+"', which does not match the shape of the input '"+c.shape+"'");if(null==d[c.id])d[c.id]=b;else{var f=d[c.id];d[c.id]=f.add(b),f.dispose()}}var i=a.gradient(e);for(var h in a.inputs)f(h)},a=b.length-1;0<=a;a--)c(a)}(h,e);var i=a.map(function(a){return h[a.id]});return 0===g.state.gradientDepth&&(g.state.activeTape.forEach(function(c){for(var a=0,b=c.saved;a<b.length;a++)b[a].dispose()}),g.state.activeTape=null),{value:d,grads:i}})},j4.prototype.customGrad=function(a){var b=this;return d8(ey(a),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var f,d=[],c=0;c<arguments.length;c++)d[c]=arguments[c];d8(d.every(function(a){return a instanceof E}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var e={};return d.forEach(function(a,b){e[b]=a}),b.runKernelFunc(function(c,b){return d8((f=a.apply(void 0,d.concat([b]))).value instanceof E,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),d8(ey(f.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),f.value},e,function(c,e){var a=f.gradFunc(c,e),b=Array.isArray(a)?a:[a];d8(b.length===d.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),d8(b.every(function(a){return a instanceof E}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var g={};return b.forEach(function(b,a){g[a]=function(){return b}}),g})}},j4.prototype.readSync=function(a){return this.state.tensorInfo.get(a).backend.readSync(a)},j4.prototype.read=function(a){return this.state.tensorInfo.get(a).backend.read(a)},j4.prototype.time=function(a){return jL(this,void 0,void 0,function(){var b,c;return jM(this,function(d){switch(d.label){case 0:return b=eE(),[4,this.backend.time(a)];case 1:return(c=d.sent()).wallMs=eE()-b,[2,c]}})})},j4.prototype.track=function(a){return null!=this.state.activeScope&&(a.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(a)),a},Object.defineProperty(j4.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),j4.prototype.reset=function(){for(var a in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new j2,this.registry)this.disposeRegisteredKernels(a),this.registry[a].dispose(),delete this.registry[a];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},j4.nextTensorId=0,j4.nextVariableId=0,j4);function j4(a){this.ENV=a,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new j2}function j5(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}var ad=function(){var a=function(){if(null==j1){var a=void 0;if("undefined"!=typeof window)a=window;else if("undefined"!=typeof global)a=global;else if("undefined"!=typeof process)a=process;else{if("undefined"==typeof self)throw new Error("Could not find a global object");a=self}j1=a}return j1}();if(null==a._tfengine){var b=new d0(a);a._tfengine=new j3(b)}return i=a._tfengine.ENV,jY=function(){return a._tfengine},a._tfengine}();function eT(){return"undefined"!=typeof window&&null!=window.document||"undefined"!=typeof WorkerGlobalScope}var j=i;j.registerFlag("DEBUG",function(){return!1},function(a){a&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),j.registerFlag("IS_BROWSER",function(){return eT()}),j.registerFlag("IS_NODE",function(){return"undefined"!=typeof process&& void 0!==process.versions&& void 0!==process.versions.node}),j.registerFlag("IS_CHROME",function(){return"undefined"!=typeof navigator&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),j.registerFlag("PROD",function(){return!1}),j.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return j.getBool("DEBUG")}),j.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),j.registerFlag("IS_TEST",function(){return!1});var ae,af,ag,g,k,B,j6={},j7={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function eU(a,b){j6[a]=b}function j8(b){b in j6||(j6[b]=function(b){if(1!==b&&2!==b)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var a=function(){if("undefined"!=typeof OffscreenCanvas&&2===b)return new OffscreenCanvas(300,150);if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}();return a.addEventListener("webglcontextlost",function(a){a.preventDefault(),delete j6[b]},!1),1===b?a.getContext("webgl",j7)||a.getContext("experimental-webgl",j7):a.getContext("webgl2",j7)}(b));var a=j6[b];return a.isContextLost()?(delete j6[b],j8(b)):(a.disable(a.DEPTH_TEST),a.disable(a.STENCIL_TEST),a.disable(a.BLEND),a.disable(a.DITHER),a.disable(a.POLYGON_OFFSET_FILL),a.disable(a.SAMPLE_COVERAGE),a.enable(a.SCISSOR_TEST),a.enable(a.CULL_FACE),a.cullFace(a.BACK),j6[b])}function j9(a,b){return[b,a]}function ka(a){var b=ec(a);return eg(Math.ceil(b/4))}function kb(a,b){return[Math.max(1,Math.ceil(b/2)),Math.max(1,Math.ceil(a/2))]}function kc(b,l){var c,d,e,f,g,h,j,k,m,a=b;return m=2===i.getNumber("WEBGL_VERSION")?(c=a.R32F,d=a.R16F,e=a.RGBA16F,f=a.RGBA32F,g=a.RED,h=4,j=1,k=a.HALF_FLOAT,a.FLOAT):(c=b.RGBA,d=b.RGBA,e=b.RGBA,f=a.RGBA,g=b.RGBA,j=h=4,k=null!=l?l.HALF_FLOAT_OES:null,b.FLOAT),{internalFormatFloat:c,internalFormatHalfFloat:d,internalFormatPackedHalfFloat:e,internalFormatPackedFloat:f,textureFormatFloat:g,downloadTextureFormat:b.RGBA,downloadUnpackNumChannels:h,defaultNumChannels:j,textureTypeHalfFloat:k,textureTypeFloat:m}}function eV(a,b,c){var d=c();return b&&function(a){var b=a.getError();if(b!==a.NO_ERROR)throw new Error("WebGL Error: "+eX(a,b))}(a),d}function eW(a){return!!(i.getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===a||596e-10<Math.abs(a)&&65504>Math.abs(a))}function eX(a,b){switch(b){case a.NO_ERROR:return"NO_ERROR";case a.INVALID_ENUM:return"INVALID_ENUM";case a.INVALID_VALUE:return"INVALID_VALUE";case a.INVALID_OPERATION:return"INVALID_OPERATION";case a.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case a.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case a.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+b}}function eY(a,b,c){return kg(a,b,function(){return a.getExtension(c)},'Extension "'+c+'" not supported on this browser.')}function eZ(a,b,d){var c=kg(a,b,function(){return a.createShader(a.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(eV(a,b,function(){return a.shaderSource(c,d)}),eV(a,b,function(){return a.compileShader(c)}),!1===a.getShaderParameter(c,a.COMPILE_STATUS))throw console.log(a.getShaderInfoLog(c)),new Error("Failed to compile vertex shader.");return c}function e$(a,b,d){var c=kg(a,b,function(){return a.createShader(a.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(eV(a,b,function(){return a.shaderSource(c,d)}),eV(a,b,function(){return a.compileShader(c)}),!1===a.getShaderParameter(c,a.COMPILE_STATUS))throw function(f,c){var g=kf.exec(c);if(null==g)return console.log("Couldn't parse line number in error: "+c),console.log(f);for(var b=+g[1],h=f.split("\n"),l=h.length.toString().length+2,a=h.map(function(a,b){return eh((b+1).toString(),l)+a}),d=0,e=0;e<a.length;e++)d=Math.max(a[e].length,d);var i=a.slice(0,b-1),j=a.slice(b-1,b),k=a.slice(b);console.log(i.join("\n")),console.log(c.split("\n")[0]),console.log("%c "+eh(j[0],d),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(k.join("\n"))}(d,a.getShaderInfoLog(c)),new Error("Failed to compile fragment shader.");return c}(B=ae=ae||{})[B.DENSE=0]="DENSE",B[B.SHARED_BATCH=1]="SHARED_BATCH",(k=af=af||{})[k.RENDER=0]="RENDER",k[k.UPLOAD=1]="UPLOAD",k[k.PIXELS=2]="PIXELS",k[k.DOWNLOAD=3]="DOWNLOAD",(g=ag=ag||{})[g.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",g[g.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",g[g.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",g[g.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",g[g.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16";var kd,ke,kf=/ERROR: [0-9]+:([0-9]+):/g;function e_(a,b){return kg(a,b,function(){return a.createProgram()},"Unable to create WebGLProgram.")}function e0(a,c,b){if(eV(a,c,function(){return a.linkProgram(b)}),!1===a.getProgramParameter(b,a.LINK_STATUS))throw console.log(a.getProgramInfoLog(b)),new Error("Failed to link vertex and fragment shaders.")}function e1(a,c,b){if(eV(a,c,function(){return a.validateProgram(b)}),!1===a.getProgramParameter(b,a.VALIDATE_STATUS))throw console.log(a.getProgramInfoLog(b)),new Error("Shader program validation failed.")}function e2(a,b,d){var c=kg(a,b,function(){return a.createBuffer()},"Unable to create WebGLBuffer");return eV(a,b,function(){return a.bindBuffer(a.ARRAY_BUFFER,c)}),eV(a,b,function(){return a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW)}),c}function e3(a,b,d){var c=kg(a,b,function(){return a.createBuffer()},"Unable to create WebGLBuffer");return eV(a,b,function(){return a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c)}),eV(a,b,function(){return a.bufferData(a.ELEMENT_ARRAY_BUFFER,d,a.STATIC_DRAW)}),c}function e4(a,b){return kg(a,b,function(){return a.createTexture()},"Unable to create WebGLTexture.")}function e5(a,b){var c=i.getNumber("WEBGL_MAX_TEXTURE_SIZE");if(a<=0||b<=0){var d="["+a+"x"+b+"]";throw new Error("Requested texture size "+d+" is invalid.")}if(c<a||c<b)throw d="["+a+"x"+b+"]",new Error("Requested texture size "+d+" greater than WebGL maximum on this browser / GPU ["+c+"x"+c+"].")}function e6(a,b){return kg(a,b,function(){return a.createFramebuffer()},"Unable to create WebGLFramebuffer.")}function e7(a,b,c,d,f,g,h,i){var e=a.getAttribLocation(c,d);return -1!==e&&(eV(a,b,function(){return a.bindBuffer(a.ARRAY_BUFFER,f)}),eV(a,b,function(){return a.vertexAttribPointer(e,g,a.FLOAT,!1,h,i)}),eV(a,b,function(){return a.enableVertexAttribArray(e)}),!0)}function e8(a,b,d,c){kh(a,c),eV(a,b,function(){return a.activeTexture(a.TEXTURE0+c)}),eV(a,b,function(){return a.bindTexture(a.TEXTURE_2D,d)})}function e9(a,b,d,c){return kg(a,b,function(){return a.getUniformLocation(d,c)},'uniform "'+c+'" not present in program.')}function fa(a,b,c){return a.getUniformLocation(b,c)}function fb(a,b,c,d,e,f){eV(a,b,function(){return e8(a,b,d,f)}),eV(a,b,function(){return a.uniform1i(e,f)})}function fc(a,b,c,d){eV(a,b,function(){return a.bindFramebuffer(a.FRAMEBUFFER,d)}),eV(a,b,function(){return a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,c,0)})}function fd(a,b,c){eV(a,b,function(){return a.bindFramebuffer(a.FRAMEBUFFER,c)}),eV(a,b,function(){return a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,null,0)})}function fe(a){var b=a.checkFramebufferStatus(a.FRAMEBUFFER);if(b!==a.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+ff(a,b))}function ff(a,b){switch(b){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case a.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+b}}function kg(b,c,e,d){var a=eV(b,c,function(){return e()});if(null==a)throw new Error(d);return a}function kh(a,d){var b=a.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,c=d+a.TEXTURE0;if(c<a.TEXTURE0||b<c)throw new Error("textureUnit must be in [gl.TEXTURE0, gl.TEXTURE"+b+"].")}function fg(b,a){return void 0===a&&(a=2),ec(b.slice(0,b.length-a))}function fh(a){if(0===a.length)throw Error("Cannot get rows and columns of an empty shape array.");return[1<a.length?a[a.length-2]:1,a[a.length-1]]}function fi(a){var b=[1,1,1];return 0===a.length||1===a.length&&1===a[0]||(b=[fg(a)].concat(fh(a))),b}function fj(a,c){void 0===c&&(c=!1);var e,b=i.getNumber("WEBGL_MAX_TEXTURE_SIZE");c&&(b*=2,1===(a=a.map(function(c,b){return b>=a.length-2?d6(a[b]):a[b]})).length&&(a=[2,a[0]])),2!==a.length&&(a=el(a).newShape);var d=ec(a);if(a.length<=1&&d<=b)return[1,d];if(2===a.length&&a[0]<=b&&a[1]<=b)return a;if(3===a.length&&a[0]*a[1]<=b&&a[2]<=b)return[a[0]*a[1],a[2]];if(3===a.length&&a[0]<=b&&a[1]*a[2]<=b)return[a[0],a[1]*a[2]];if(4===a.length&&a[0]*a[1]*a[2]<=b&&a[3]<=b)return[a[0]*a[1]*a[2],a[3]];if(4===a.length&&a[0]<=b&&a[1]*a[2]*a[3]<=b)return[a[0],a[1]*a[2]*a[3]];if(c){var h=fg(a),f=2,g=2;return a.length&&(f=(e=fh(a))[0],g=e[1]),eg(d=h*(f/2)*(g/2)).map(function(a){return 2*a})}return eg(d)}function ki(a){return a%2==0}function fk(a,b){if(ed(a=a.slice(-2),b=b.slice(-2))|| !a.length||!b.length||0===a[0]||0===a[1]||0===b[0]||0===b[1])return!0;if(a.length!==b.length){var c=a.slice(-1)[0],d=b.slice(-1)[0];if(c===d||ki(c)&&ki(d)&&(1===a[0]||1===b[0]))return!0}return a[1]===b[1]&&ki(a[0])&&ki(b[0])}function fl(b){if(null==kd){var a=j8(b);kd=a.getParameter(a.MAX_TEXTURE_SIZE)}return kd}function fm(b){if(null==ke){var a=j8(b);ke=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,ke)}function fn(a){if(0===a)return 0;var b=j8(a);return fo(b,"EXT_disjoint_timer_query_webgl2")&&2===a?2:fo(b,"EXT_disjoint_timer_query")?1:0}function fo(a,b){return null!=a.getExtension(b)}function fp(a){try{if(null!=j8(a))return!0}catch(b){}return!1}function fq(a){if(0===a)return!1;var b=j8(a);if(1===a){if(!fo(b,"OES_texture_float"))return!1}else if(!fo(b,"EXT_color_buffer_float"))return!1;return kj(b)}function fr(e){if(0===e)return!1;var b=j8(e);if(1===e)return!!fo(b,"OES_texture_float")&&!!fo(b,"WEBGL_color_buffer_float")&&kj(b);if(fo(b,"EXT_color_buffer_float"))return kj(b);if(fo(b,"EXT_color_buffer_half_float")){var a,c,d,f,g,h=b.getExtension("EXT_color_buffer_half_float");return c=kc(a=b,h),d=a.createTexture(),a.bindTexture(a.TEXTURE_2D,d),a.texImage2D(a.TEXTURE_2D,0,c.internalFormatHalfFloat,1,1,0,c.textureFormatFloat,c.textureTypeHalfFloat,null),f=a.createFramebuffer(),a.bindFramebuffer(a.FRAMEBUFFER,f),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0),g=a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE,a.bindTexture(a.TEXTURE_2D,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.deleteTexture(d),a.deleteFramebuffer(f),g}return!1}function kj(a){var b=kc(a),c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c),a.texImage2D(a.TEXTURE_2D,0,b.internalFormatFloat,1,1,0,b.textureFormatFloat,b.textureTypeFloat,null);var d=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,d),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,c,0);var e=a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE;return a.bindTexture(a.TEXTURE_2D,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.deleteTexture(c),a.deleteFramebuffer(d),e}function fs(a){return 2===a&&null!=j8(a).fenceSync}var ft=Object.freeze({callAndCheck:eV,canBeRepresented:eW,getWebGLErrorMessage:eX,getExtensionOrThrow:eY,createVertexShader:eZ,createFragmentShader:e$,createProgram:e_,linkProgram:e0,validateProgram:e1,createStaticVertexBuffer:e2,createStaticIndexBuffer:e3,getNumChannels:function(){return 2===i.getNumber("WEBGL_VERSION")?1:4},createTexture:e4,validateTextureSize:e5,createFramebuffer:e6,bindVertexBufferToProgramAttribute:e7,bindTextureUnit:e8,unbindTextureUnit:function(a,b,c){kh(a,c),eV(a,b,function(){return a.activeTexture(a.TEXTURE0+c)}),eV(a,b,function(){return a.bindTexture(a.TEXTURE_2D,null)})},getProgramUniformLocationOrThrow:e9,getProgramUniformLocation:fa,bindTextureToProgramUniformSampler:fb,bindCanvasToFramebuffer:function(a,b){eV(a,b,function(){return a.bindFramebuffer(a.FRAMEBUFFER,null)}),eV(a,b,function(){return a.viewport(0,0,a.canvas.width,a.canvas.height)}),eV(a,b,function(){return a.scissor(0,0,a.canvas.width,a.canvas.height)})},bindColorTextureToFramebuffer:fc,unbindColorTextureFromFramebuffer:fd,validateFramebuffer:fe,getFramebufferErrorMessage:ff,getBatchDim:fg,getRowsCols:fh,getShapeAs3D:fi,getTextureShapeFromLogicalShape:fj,isReshapeFree:fk,getWebGLMaxTextureSize:fl,resetMaxTextureSize:function(){kd=null},resetMaxTexturesInShader:function(){ke=null},getMaxTexturesInShader:fm,getWebGLDisjointQueryTimerVersion:fn,hasExtension:fo,isWebGLVersionEnabled:fp,isCapableOfRenderingToFloatTexture:fq,isDownloadFloatTextureEnabled:fr,isWebGLFenceEnabled:fs}),d=i;function ah(a){i.getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(a+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}function fu(a,b){return ad.tidy(a,b)}function fv(a){eR(a).forEach(function(a){return a.dispose()})}function fw(a){return ad.keep(a)}function kk(){for(var b=[],a=0;a<arguments.length;a++)b[a]=arguments[a];i.getBool("IS_TEST")||console.warn.apply(console,b)}function kl(a,d){var b=a;if(er(a))return"string"===d?[]:[a.length];if(!Array.isArray(a))return[];for(var c=[];Array.isArray(b)||er(b)&&"string"!==d;)c.push(b.length),b=b[0];return Array.isArray(a)&&i.getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function e(a,b,d){if(d=d||[],Array.isArray(a)||er(a)){d8(0<b.length,function(){return"Element arr["+d.join("][")+"] should be a primitive, but is an array of "+a.length+" elements"}),d8(a.length===b[0],function(){return"Element arr["+d.join("][")+"] should have "+b[0]+" elements, but has "+a.length+" elements"});for(var f=b.slice(1),c=0;c<a.length;++c)e(a[c],f,d.concat(c))}else d8(0===b.length,function(){return"Element arr["+d.join("][")+"] is a primitive, but should be an array/TypedArray of "+b[0]+" elements"})}(a,c,[]),c}function km(a,b,c,d){if(null!=a&&("numeric"!==a&&a!==b||"numeric"===a&&"string"===b))throw new Error("Argument '"+c+"' passed to '"+d+"' must be "+a+" tensor, but got "+b+" tensor")}function kn(a,d,e,c){if(void 0===c&&(c="numeric"),a instanceof E)return km(c,a.dtype,d,e),a;var b=ex(a);if("string"!==b&&0<=["bool","int32","float32"].indexOf(c)&&(b=c),km(c,b,d,e),null==a|| !er(a)&&!Array.isArray(a)&&"number"!=typeof a&&"boolean"!=typeof a&&"string"!=typeof a){var f=null==a?"null":a.constructor.name;throw new Error("Argument '"+d+"' passed to '"+e+"' must be a Tensor or TensorLike, but got '"+f+"'")}var g=kl(a,b);er(a)||Array.isArray(a)||(a=[a]);var h="string"!==b?$(a,b,i.getBool("DEBUG")):eb(a,[],!0);return ad.makeTensor(h,g,b)}function ko(b,c,d,a){if(void 0===a&&(a="numeric"),!Array.isArray(b))throw new Error("Argument "+c+" passed to "+d+" must be a `Tensor[]` or `TensorLike[]`");return b.map(function(a,b){return kn(a,c+"["+b+"]",d)},a)}function fx(b,c){for(var a=0;a<b.length;++a)if(b[b.length-a-1]!==c-1-a)return!1;return!0}function fy(c,d,e){for(var f=c.length+d.length,a=[],g=0,h=0,b=0;b<f;b++)-1===e.indexOf(b)?a.push(c[g++]):a.push(d[h++]);return a}function fz(b,c){for(var d=[],e=b.length,a=0;a<e;a++)-1===c.indexOf(a)&&d.push(b[a]);return[d,c.map(function(a){return b[a]})]}function fA(b,a){return fy(b,a.map(function(a){return 1}),a)}function fB(c,a,b){d8(fx(a,b),function(){return c+" supports only inner-most axes for now. Got axes "+a+" and rank-"+b+" input."})}function fC(b,c){if(fx(b,c))return null;for(var d=[],a=0;a<c;++a)-1===b.indexOf(a)&&d.push(a);return b.forEach(function(a){return d.push(a)}),d}function fD(a){return a.map(function(a,b){return[b,a]}).sort(function(a,b){return a[1]-b[1]}).map(function(a){return a[0]})}function fE(d,b){for(var c=[],a=b-d;a<b;++a)c.push(a);return c}function fF(a,b){var c=a[0].length;a.forEach(function(a,b){d8(a.length===c,function(){return"Error in concat"+c+"D: rank of tensors["+b+"] must be the same as the rank of the rest ("+c+")"})}),d8(0<=b&&b<c,function(){return"Error in concat"+c+"D: axis must be between 0 and "+(c-1)+"."});var d=a[0];a.forEach(function(e,f){for(var a=0;a<c;a++)d8(a===b||e[a]===d[a],function(){return"Error in concat"+c+"D: Shape of tensors["+f+"] ("+e+") does not match the shape of the rest ("+d+") along the non-concatenated axis "+f+"."})})}function fG(a,c){for(var d=a[0].slice(),b=1;b<a.length;b++)d[c]+=a[b][c];return d}function a(c){var b=Object.keys(c);if(1!==b.length)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+b.length+" keys.");var a=b[0],e=c[a];function d(){for(var d=[],b=0;b<arguments.length;b++)d[b]=arguments[b];ad.startScope(a);try{var c=e.apply(void 0,d);return c instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),ad.endScope(c),c}catch(f){throw ad.endScope(null),f}}return a.endsWith("_")&&(a=a.substring(0,a.length-1)),Object.defineProperty(d,"name",{value:a,configurable:!0}),d}d.registerFlag("HAS_WEBGL",function(){return 0<d.getNumber("WEBGL_VERSION")}),d.registerFlag("WEBGL_VERSION",function(){return fp(2)?2:fp(1)?1:0}),d.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return 2===d.get("WEBGL_VERSION")}),d.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),d.registerFlag("WEBGL_FORCE_F16_TEXTURES",function(){return!1}),d.registerFlag("WEBGL_PACK",function(){return d.getBool("HAS_WEBGL")}),d.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return d.getBool("WEBGL_PACK")}),d.registerFlag("WEBGL_PACK_CLIP",function(){return d.getBool("WEBGL_PACK")}),d.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),d.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return d.getBool("WEBGL_PACK")}),d.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",function(){return d.getBool("WEBGL_PACK")}),d.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return d.getBool("WEBGL_PACK")}),d.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return d.getBool("WEBGL_PACK")}),d.registerFlag("WEBGL_PACK_REDUCE",function(){return d.getBool("WEBGL_PACK")}),d.registerFlag("WEBGL_LAZILY_UNPACK",function(){return d.getBool("WEBGL_PACK")}),d.registerFlag("WEBGL_CONV_IM2COL",function(){return d.getBool("WEBGL_PACK")}),d.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return fl(d.getNumber("WEBGL_VERSION"))}),d.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return fm(d.getNumber("WEBGL_VERSION"))}),d.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var a=d.getNumber("WEBGL_VERSION");return 0===a?0:fn(a)}),d.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){var a;return 0<d.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")&&(a=navigator.userAgent||navigator.vendor||window.opera,!(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))))}),d.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",function(){return fq(d.getNumber("WEBGL_VERSION"))}),d.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return!d.getBool("WEBGL_FORCE_F16_TEXTURES")&&d.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")}),d.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return fr(d.getNumber("WEBGL_VERSION"))}),d.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return fs(d.getNumber("WEBGL_VERSION"))}),d.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return d.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0}),eL=ah;var ai=a({complex_:function(c,d){var a=kn(c,"real","complex"),b=kn(d,"imag","complex");return d9(a.shape,b.shape,"real and imag shapes, "+a.shape+" and "+b.shape+", must match in call to tf.complex()."),ad.runKernelFunc(function(c){return c.complex(a,b)},{$real:a,$imag:b})}}),aj=a({real_:function(a){var b=kn(a,"input","real");return ad.runKernelFunc(function(a){return a.real(b)},{$input:b})}}),ak=a({imag_:function(a){var b=kn(a,"input","imag");return ad.runKernelFunc(function(a){return a.imag(b)},{$input:b})}});function al(a,c,b){return kp(a,c,kl(a,b),b)}function kp(a,b,d,e){if(null==e&&(e=ex(a)),"complex64"===e)throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!er(a)&&!Array.isArray(a)&&"number"!=typeof a&&"boolean"!=typeof a&&"string"!=typeof a)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=b){eF(b);var f=ec(b),g=ec(d);d8(f===g,function(){return"Based on the provided shape, ["+b+"], the tensor should have "+f+" values but has "+g});for(var c=0;c<d.length;++c){var h=d[c],j=c!==d.length-1||h!==ec(b.slice(c));d8(d[c]===b[c]||!j,function(){return"Error creating a new Tensor. Inferred shape ("+d+") does not match the provided shape ("+b+"). "})}}return er(a)||Array.isArray(a)||(a=[a]),b=b||d,a="string"!==e?$(a,e,i.getBool("DEBUG")):eb(a,[],!0),ad.makeTensor(a,b,e)}function am(a,b){if((er(a)&&"string"!==b||Array.isArray(a))&&"complex64"!==b)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===b&&er(a)&&!(a instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return kp(a,[],[],b)}function an(a,b){ea(a);var c=kl(a,b);if(1!==c.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return kp(a,null,c,b)}function ao(c,a,d){if(ea(c),null!=a&&2!==a.length)throw new Error("tensor2d() requires shape to have two numbers");var b=kl(c,d);if(2!==b.length&&1!==b.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===b.length&&null==a)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return kp(c,a,b,d)}function ap(c,a,d){if(ea(c),null!=a&&3!==a.length)throw new Error("tensor3d() requires shape to have three numbers");var b=kl(c,d);if(3!==b.length&&1!==b.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===b.length&&null==a)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return kp(c,a,b,d)}function aq(c,a,d){if(ea(c),null!=a&&4!==a.length)throw new Error("tensor4d() requires shape to have four numbers");var b=kl(c,d);if(4!==b.length&&1!==b.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===b.length&&null==a)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return kp(c,a,b,d)}function ar(c,a,d){if(ea(c),null!=a&&5!==a.length)throw new Error("tensor5d() requires shape to have five numbers");var b=kl(c,d);if(5!==b.length&&1!==b.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===b.length&&null==a)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return kp(c,a,b,d)}function as(c,a,d){if(ea(c),null!=a&&6!==a.length)throw new Error("tensor6d() requires shape to have six numbers");var b=kl(c,d);if(6!==b.length&&1!==b.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===b.length&&null==a)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return kp(c,a=a||b,b,d)}function at(b,a,c,d){return void 0===a&&(a=!0),ad.makeVariable(b,a,c,d)}function au(b,a){if(void 0===a&&(a="float32"),"complex64"===a){var c=au(b,"float32"),d=av(b,"float32");return ai(c,d)}var e=eC(ec(b),a);return ad.makeTensor(e,b,a)}function av(b,a){if(void 0===a&&(a="float32"),"complex64"===a){var c=av(b,"float32"),d=av(b,"float32");return ai(c,d)}var e=eD(ec(b),a);return ad.makeTensor(e,b,a)}function aw(a,b,c){return ad.runKernelFunc(function(d){return d.fill(a,b,c)},{})}function ax(b,c,a){if(a<=0)throw new Error("The number of values should be positive.");return ad.runKernelFunc(function(d){return d.linspace(b,c,a)},{})}function ay(b,c,a,d){if(void 0===a&&(a=1),void 0===d&&(d="float32"),0===a)throw new Error("Cannot have a step of zero");if(b===c||b<c&&a<0||c<b&&1<a)return av([0],d);var e=eD(Math.abs(Math.ceil((c-b)/a)),d);c<b&&1===a&&(a=-1),e[0]=b;for(var f=1;f<e.length;f++)e[f]=e[f-1]+a;return an(e,d)}var az=a({onesLike_:function(b){var a=kn(b,"x","onesLike");if("complex64"!==a.dtype)return ad.runKernelFunc(function(b){return b.onesLike(a)},{$x:a},function(a,b){return{$x:function(){return aA(a)}}});var c=az(aj(a)),d=aA(ak(a));return ai(c,d)}}),aA=a({zerosLike_:function(a){var b=kn(a,"x","zerosLike");return ad.runKernelFunc(function(a){return a.zerosLike(b)},{$x:b},function(a,b){return{$x:function(){return aA(a)}}})}}),aB=a({concat_:function(c,b){void 0===b&&(b=0),d8(1<=c.length,function(){return"Pass at least one tensor to concat"});var a=ko(c,"tensors","concat");"complex64"===a[0].dtype&&a.forEach(function(a){if("complex64"!==a.dtype)throw new Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+a.dtype+". ")}),b=ek(b,a[0].shape)[0];var d=fG(a.map(function(a){return a.shape}),b);if(0===ec(d))return al([],d);if(1===(a=a.filter(function(a){return 0<a.size})).length)return a[0];var e=a.map(function(a){return a.shape});fF(e,b);var f=a,g={axis:b};return ad.runKernelFunc(function(c){return c.concat(a,b)},f,function(a){return aG(a,e.map(function(a){return a[b]}),b).map(function(a){return function(){return a}})},"Concat",g)}}),aC=a({concat1d_:function(a){return aB(a,0)}}),aD=a({concat2d_:function(a,b){return aB(a,b)}}),aE=a({concat3d_:function(a,b){return aB(a,b)}}),aF=a({concat4d_:function(a,b){return aB(a,b)}}),aG=a({split_:function(d,b,a){void 0===a&&(a=0);var e,c=kn(d,"x","split");return a=ek(a,c.shape)[0],e="number"==typeof b?(d8(c.shape[a]%b==0,function(){return"Number of splits must evenly divide the axis."}),new Array(b).fill(c.shape[a]/b)):(d8(c.shape[a]===b.reduce(function(a,b){return a+b}),function(){return"The sum of sizes must match the size of the axis dimension."}),b),ad.runKernelFunc(function(b){return b.split(c,e,a)},{$x:c},function(b){return{$x:function(){return aB(b,a)}}})}});function q(b,a){return b(a={exports:{}},a.exports),a.exports}var fH=q(function(a){!function(c,a){function d(c){var d,a=this,b=(d=4022871197,function(a){a=a.toString();for(var c=0;c<a.length;c++){var b=.02519603282416938*(d+=a.charCodeAt(c));b-=d=b>>>0,d=(b*=d)>>>0,d+=4294967296*(b-=d)}return 23283064365386963e-26*(d>>>0)});a.next=function(){var b=2091639*a.s0+23283064365386963e-26*a.c;return a.s0=a.s1,a.s1=a.s2,a.s2=b-(a.c=0|b)},a.c=1,a.s0=b(" "),a.s1=b(" "),a.s2=b(" "),a.s0-=b(c),a.s0<0&&(a.s0+=1),a.s1-=b(c),a.s1<0&&(a.s1+=1),a.s2-=b(c),a.s2<0&&(a.s2+=1),b=null}function e(b,a){return a.c=b.c,a.s0=b.s0,a.s1=b.s1,a.s2=b.s2,a}function b(g,c){var f=new d(g),b=c&&c.state,a=f.next;return a.int32=function(){return 4294967296*f.next()|0},a.double=function(){return a()+11102230246251565e-32*(2097152*a()|0)},a.quick=a,b&&("object"==typeof b&&e(b,f),a.state=function(){return e(f,{})}),a}a&&a.exports?a.exports=b:this.alea=b}(0,a)}),fI=q(function(a){!function(c,a){function d(b){var a=this,c="";a.x=0,a.y=0,a.z=0,a.w=0,a.next=function(){var b=a.x^a.x<<11;return a.x=a.y,a.y=a.z,a.z=a.w,a.w^=a.w>>>19^b^b>>>8},b===(0|b)?a.x=b:c+=b;for(var d=0;d<c.length+64;d++)a.x^=0|c.charCodeAt(d),a.next()}function e(b,a){return a.x=b.x,a.y=b.y,a.z=b.z,a.w=b.w,a}function b(g,c){function a(){return(f.next()>>>0)/4294967296}var f=new d(g),b=c&&c.state;return a.double=function(){do var a=((f.next()>>>11)+(f.next()>>>0)/4294967296)/2097152;while(0===a)return a},a.int32=f.next,a.quick=a,b&&("object"==typeof b&&e(b,f),a.state=function(){return e(f,{})}),a}a&&a.exports?a.exports=b:this.xor128=b}(0,a)}),fJ=q(function(a){!function(c,a){function d(b){var a=this,c="";a.next=function(){var b=a.x^a.x>>>2;return a.x=a.y,a.y=a.z,a.z=a.w,a.w=a.v,(a.d=a.d+362437|0)+(a.v=a.v^a.v<<4^b^b<<1)|0},a.x=0,a.y=0,a.z=0,a.w=0,b===((a.v=0)|b)?a.x=b:c+=b;for(var d=0;d<c.length+64;d++)a.x^=0|c.charCodeAt(d),d==c.length&&(a.d=a.x<<10^a.x>>>4),a.next()}function e(b,a){return a.x=b.x,a.y=b.y,a.z=b.z,a.w=b.w,a.v=b.v,a.d=b.d,a}function b(g,c){function a(){return(f.next()>>>0)/4294967296}var f=new d(g),b=c&&c.state;return a.double=function(){do var a=((f.next()>>>11)+(f.next()>>>0)/4294967296)/2097152;while(0===a)return a},a.int32=f.next,a.quick=a,b&&("object"==typeof b&&e(b,f),a.state=function(){return e(f,{})}),a}a&&a.exports?a.exports=b:this.xorwow=b}(0,a)}),fK=q(function(a){!function(c,a){function d(b){var a=this;a.next=function(){var b,c,e=a.x,d=a.i;return b=e[d],c=(b^=b>>>7)^b<<24,c^=(b=e[d+1&7])^b>>>10,c^=(b=e[d+3&7])^b>>>3,c^=(b=e[d+4&7])^b<<7,b=e[d+7&7],c^=(b^=b<<13)^b<<9,e[d]=c,a.i=d+1&7,c},function(d,c){var a,b=[];if(c===(0|c))b[0]=c;else for(c=""+c,a=0;a<c.length;++a)b[7&a]=b[7&a]<<15^c.charCodeAt(a)+b[a+1&7]<<13;for(;b.length<8;)b.push(0);for(a=0;a<8&&0===b[a];++a);for(8==a?b[7]=-1:b[a],d.x=b,d.i=0,a=256;0<a;--a)d.next()}(a,b)}function e(b,a){return a.x=b.x.slice(),a.i=b.i,a}function b(b,f){function a(){return(g.next()>>>0)/4294967296}null==b&&(b=+new Date);var g=new d(b),c=f&&f.state;return a.double=function(){do var a=((g.next()>>>11)+(g.next()>>>0)/4294967296)/2097152;while(0===a)return a},a.int32=g.next,a.quick=a,c&&(c.x&&e(c,g),a.state=function(){return e(g,{})}),a}a&&a.exports?a.exports=b:this.xorshift7=b}(0,a)}),fL=q(function(a){!function(c,a){function d(b){var a=this;a.next=function(){var c,b,e=a.w,f=a.X,d=a.i;return a.w=e=e+1640531527|0,b=f[d+34&127],c=f[d=d+1&127],b^=b<<13,c^=c<<17,b^=b>>>15,c^=c>>>12,b=f[d]=b^c,a.i=d,b+(e^e>>>16)|0},function(h,b){var e,a,c,d,g,f=[],i=128;for(b===(0|b)?(a=b,b=null):(b+="\0",a=0,i=Math.max(i,b.length)),c=0,d=-32;d<i;++d)b&&(a^=b.charCodeAt((d+32)%b.length)),0===d&&(g=a),a^=a<<10,a^=a>>>15,a^=a<<4,a^=a>>>13,0<=d&&(g=g+1640531527|0,c=0==(e=f[127&d]^=a+g)?c+1:0);for(128<=c&&(f[127&(b&&b.length||0)]=-1),c=127,d=512;0<d;--d)a=f[c+34&127],e=f[c=c+1&127],a^=a<<13,e^=e<<17,a^=a>>>15,e^=e>>>12,f[c]=a^e;h.w=g,h.X=f,h.i=c}(a,b)}function e(b,a){return a.i=b.i,a.w=b.w,a.X=b.X.slice(),a}function b(b,f){function a(){return(g.next()>>>0)/4294967296}null==b&&(b=+new Date);var g=new d(b),c=f&&f.state;return a.double=function(){do var a=((g.next()>>>11)+(g.next()>>>0)/4294967296)/2097152;while(0===a)return a},a.int32=g.next,a.quick=a,c&&(c.X&&e(c,g),a.state=function(){return e(g,{})}),a}a&&a.exports?a.exports=b:this.xor4096=b}(0,a)}),fM=q(function(a){!function(c,a){function d(b){var a=this,c="";a.next=function(){var b=a.b,c=a.c,d=a.d,e=a.a;return b=b<<25^b>>>7^c,c=c-d|0,d=d<<24^d>>>8^e,e=e-b|0,a.b=b=b<<20^b>>>12^c,a.c=c=c-d|0,a.d=d<<16^c>>>16^e,a.a=e-b|0},a.a=0,a.b=0,a.c=-1640531527,a.d=1367130551,b===Math.floor(b)?(a.a=b/4294967296|0,a.b=0|b):c+=b;for(var d=0;d<c.length+20;d++)a.b^=0|c.charCodeAt(d),a.next()}function e(b,a){return a.a=b.a,a.b=b.b,a.c=b.c,a.d=b.d,a}function b(g,c){function a(){return(f.next()>>>0)/4294967296}var f=new d(g),b=c&&c.state;return a.double=function(){do var a=((f.next()>>>11)+(f.next()>>>0)/4294967296)/2097152;while(0===a)return a},a.int32=f.next,a.quick=a,b&&("object"==typeof b&&e(b,f),a.state=function(){return e(f,{})}),a}a&&a.exports?a.exports=b:this.tychei=b}(0,a)}),r=q(function(a){!function(e,b){var f,k=this,c=256,g=6,h="random",l=b.pow(c,g),i=b.pow(2,52),m=2*i,n=c-1;function d(n,a,s){function d(){for(var a=u.g(g),d=l,b=0;a<i;)a=(a+b)*c,d*=c,b=u.g(1);for(;m<=a;)a/=2,d/=2,b>>>=1;return(a+b)/d}var r=[],t=j(function f(a,c){var d,b=[],e=typeof a;if(c&&"object"==e)for(d in a)try{b.push(f(a[d],c-1))}catch(g){}return b.length?b:"string"==e?a:a+"\0"}((a=1==a?{entropy:!0}:a||{}).entropy?[n,q(e)]:null==n?function(){try{var a;return f&&(a=f.randomBytes)?a=a(c):(a=new Uint8Array(c),(k.crypto||k.msCrypto).getRandomValues(a)),q(a)}catch(g){var b=k.navigator,d=b&&b.plugins;return[+new Date,k,d,k.screen,q(e)]}}():n,3),r),u=new o(r);return d.int32=function(){return 0|u.g(4)},d.quick=function(){return u.g(4)/4294967296},d.double=d,j(q(u.S),e),(a.pass||s||function(a,d,e,c){return c&&(c.S&&p(c,u),a.state=function(){return p(u,{})}),e?(b[h]=a,d):a})(d,t,"global"in a?a.global:this==b,a.state)}function o(e){var h,f=e.length,d=this,a=0,g=d.i=d.j=0,b=d.S=[];for(f||(e=[f++]);a<c;)b[a]=a++;for(a=0;a<c;a++)b[a]=b[g=n&g+e[a%f]+(h=b[a])],b[g]=h;(d.g=function(h){for(var f,g=0,b=d.i,e=d.j,a=d.S;h--;)f=a[b=n&b+1],g=g*c+a[n&(a[b]=a[e=n&e+f])+(a[e]=f)];return d.i=b,d.j=e,g})(c)}function p(b,a){return a.i=b.i,a.j=b.j,a.S=b.S.slice(),a}function j(d,b){for(var e,c=d+"",a=0;a<c.length;)b[n&a]=n&(e^=19*b[n&a])+c.charCodeAt(a++);return q(b)}function q(a){return String.fromCharCode.apply(0,a)}if(b["seed"+h]=d,j(b.random(),e),a.exports){a.exports=d;try{f=require("crypto")}catch(r){}}}([],Math)});r.alea=fH,r.xor128=fI,r.xorwow=fJ,r.xorshift7=fK,r.xor4096=fL,r.tychei=fM;var kq=r.alea,kr=(kw.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var h=this.nextVal;return this.nextVal=NaN,h}for(var b,c,f=!1;!f;){for(var d=void 0,e=void 0,a=void 0;1<=(a=(d=2*this.random()-1)*d+(e=2*this.random()-1)*e)||0===a;);var g=Math.sqrt(-2*Math.log(a)/a);b=this.mean+this.stdDev*d*g,c=this.mean+this.stdDev*e*g,this.truncated&&!this.isValidTruncated(b)||(f=!0)}return this.truncated&&!this.isValidTruncated(c)||(this.nextVal=this.convertValue(c)),this.convertValue(b)},kw.prototype.convertValue=function(a){return null==this.dtype||"float32"===this.dtype?a:Math.round(a)},kw.prototype.isValidTruncated=function(a){return a<=this.upper&&a>=this.lower},kw),ks=(kv.prototype.nextValue=function(){for(var c,d,e,b,f,a;;){for(;b=this.randn.nextValue(),(a=1+this.c*b)<=0;);if(a*=a*a,d=1-.331*(c=b*b)*c,e=.5*c+this.d*(1-a+Math.log(a)),(f=this.randu())<d||Math.log(f)<e)break}return a=1/this.beta*this.d*a,this.alpha<1&&(a*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(a)},kv.prototype.convertValue=function(a){return"float32"===this.dtype?a:Math.round(a)},kv),kt=(ku.prototype.convertValue=function(a){return this.canReturnFloat()?a:Math.round(a)},ku.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},ku);function ku(b,c,d,a){var e=this;if(void 0===b&&(b=0),void 0===c&&(c=1),this.canReturnFloat=function(){return null==e.dtype||"float32"===e.dtype},this.min=b,this.range=c-b,this.dtype=d,null==a&&(a=Math.random()),"number"==typeof a&&(a=a.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+b+" - "+c+" <= 1 and dtype is not float");this.random=kq(a)}function kv(a,c,b,d){this.alpha=a,this.beta=1/c,this.dtype=b;var e=d||Math.random();this.randu=kq(e.toString()),this.randn=new kr(0,1,b,!1,this.randu()),this.d=a<1?a+2/3:a-1/3,this.c=1/Math.sqrt(9*this.d)}function kw(a,b,c,d,e){this.mean=a,this.stdDev=b,this.dtype=c,this.nextVal=NaN,this.truncated=d,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var f=e||Math.random();this.random=kq(f.toString())}function aH(b,a,c){return void 0===a&&(a="float32"),a=a||"float32",eF(b),new eJ(b,a,c)}function aI(b,a){void 0===a&&(a=!1),console.log(b.toString(a))}function aJ(a,b){return jL(this,void 0,void 0,function(){var c,d,e,f,g,h,i,j,k,l;return jM(this,function(m){switch(m.label){case 0:return c=kn(a,"x","setdiff1d"),d=kn(b,"y","setdiff1d"),d8(c.dtype===d.dtype,function(){return"x and y should have the same dtype, but got x ("+c.dtype+") and y ("+d.dtype+")."}),d8(1===c.rank,function(){return"x should be 1D tensor, but got x ("+c.shape+")."}),d8(1===d.rank,function(){return"y should be 1D tensor, but got y ("+d.shape+")."}),[4,c.data()];case 1:return e=m.sent(),[4,d.data()];case 2:for(f=m.sent(),g=new Set(f),k=h=0;k<e.length;k++)g.has(e[k])||h++;for(i=new eJ([h],c.dtype),j=new eJ([h],"int32"),l=k=0;k<e.length;k++)g.has(e[k])||(i.values[l]=e[k],j.values[l]=k,l++);return[2,[i.toTensor(),j.toTensor()]]}})})}var aK=a({batchToSpaceND_:function(c,a,d){var b=kn(c,"x","batchToSpaceND"),e=a.reduce(function(a,b){return a*b});return d8(b.rank>=1+a.length,function(){return"input rank is "+b.rank+" but should be > than blockShape.length "+a.length}),d8(d.length===a.length,function(){return"crops.length is "+d.length+" but should be equal to blockShape.length  "+a.length}),d8(b.shape[0]%e==0,function(){return"input tensor batch is "+b.shape[0]+" but is not divisible by the product of the elements of blockShape "+a.join(" * ")+" === "+e}),ad.runKernelFunc(function(c){return c.batchToSpaceND(b,a,d)},{$x:b},function(b){return{$x:function(){return b.spaceToBatchND(a,d)}}})}}),aL=a({broadcastTo_:function(f,b){var a=kn(f,"broadcastTo","x"),g=a.shape;if(b.some(function(a){return!(0<a)||a%1!=0}))throw new Error("broadcastTo(): Invalid broadcast shape ["+b+"].");if(b.length<a.rank)throw new Error("broadcastTo(): shape.length="+b.length+" < input.rank="+a.rank+".");if(b.length>a.rank){for(var d=a.shape.slice();d.length<b.length;)d.unshift(1);a=a.reshape(d)}for(var e=Array.from(b),c=b.length-1;0<=c;c--)if(a.shape[c]===b[c])e[c]=1;else if(1!==a.shape[c])throw new Error("broadcastTo(): ["+g+"] cannot be broadcast to ["+b+"].");var h=e.map(function(a,b){return 1<a?b:-1}).filter(function(a){return 0<=a});return 0===h.length?a.clone():ad.runKernelFunc(function(b){return b.tile(a,e)},{input:a},function(a){return{input:function(){return a.sum(h,!0)}}})}}),aM=a({cast_:function(c,a){var b=kn(c,"x","cast");if(!ep(a))throw new Error("Failed to cast to unknown dtype "+a);if("string"===a&&"string"!==b.dtype||"string"!==a&&"string"===b.dtype)throw new Error("Only strings can be casted to strings");return ad.runKernelFunc(function(c){return c.cast(b,a)},{x:b},function(a){return{x:function(){return a.clone()}}},"Cast",{dtype:a})}}),aN=a({clone_:function(a){var b=kn(a,"x","clone",null);return ad.runKernelFunc(function(){return ad.makeTensorFromDataId(b.dataId,b.shape,b.dtype)},{$x:b},function(a){return{$x:function(){return a.toFloat()}}})}}),aO=a({cumsum_:function(h,c,e,f){void 0===c&&(c=0),void 0===e&&(e=!1),void 0===f&&(f=!1);var a=kn(h,"x","cumsum"),b=fC([c|=0],a.rank),g=a;null!=b&&(g=a.transpose(b));var i=fE(1,a.rank)[0],d=ad.runKernelFunc(function(a){return a.cumsum(g,i,e,f)},{permutedX:g},function(a){return{permutedX:function(){return a.cumsum(c,e,!f)}}});return null!=b&&(d=d.transpose(b)),d}}),aP=a({depthToSpace_:function(d,c,b){void 0===b&&(b="NHWC");var a=kn(d,"x","depthToSpace"),e="NHWC"===b?a.shape[1]:a.shape[2],f="NHWC"===b?a.shape[2]:a.shape[3],g="NHWC"===b?a.shape[3]:a.shape[1];return d8(0<=e*c,function(){return"Negative dimension size caused by overflow when multiplying\n      "+e+" and "+c+"  for depthToSpace with input shape\n      "+a.shape}),d8(0<=f*c,function(){return"Negative dimension size caused by overflow when multiplying\n      "+f+" and "+c+" for depthToSpace with input shape\n          "+a.shape}),d8(g%(c*c)==0,function(){return"Dimension size must be evenly divisible by "+c*c+" but is "+g+" for depthToSpace with input shape "+a.shape}),ad.runKernelFunc(function(d){return d.depthToSpace(a,c,b)},{$x:a})}}),aQ=a({expandDims_:function(d,a){void 0===a&&(a=0);var b=kn(d,"x","expandDims",null);d8(a<=b.rank,function(){return"Axis must be <= rank of the tensor"});var c=b.shape.slice();return a<0&&(d8(-(b.rank+1)<=a,function(){return"Axis must be in the interval ["+ -(b.rank+1)+", "+b.rank+"]"}),a=b.rank+a+1),c.splice(a,0,1),a1(b,c)}}),aR=a({eye_:function(c,b,a,f){void 0===f&&(f="float32"),null==b&&(b=c);for(var g=aH([c,b],f),h=c<=b?c:b,d=0;d<h;++d)g.set(1,d,d);var e=g.toTensor().as2D(c,b);if(null==a)return e;if(1===a.length)return a5(aQ(e,0),[a[0],1,1]);if(2===a.length)return a5(aQ(aQ(e,0),0),[a[0],a[1],1,1]);if(3===a.length)return a5(aQ(aQ(aQ(e,0),0),0),[a[0],a[1],a[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+a.length+"D.")}}),aS=a({multinomial_:function(g,i,c,d){void 0===d&&(d=!1);var a=kn(g,"logits","multinomial"),e=a.size,b=a.rank;if(e<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+e+".");if(2<b)throw new Error("Rank of probabilities must be 1 or 2, but is "+b);c=c||Math.random();var h=1===b?a.as2D(1,-1):a,f=ad.runKernelFunc(function(a){return a.multinomial(h,d,i,c)},{logits2D:h});return 1===b?f.as1D():f}}),aT=a({oneHot_:function(e,b,c,d){if(void 0===c&&(c=1),void 0===d&&(d=0),b<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+b);var a=kn(e,"indices","oneHot","int32"),f=a.shape.concat([b]);return a=a.flatten(),ad.runKernelFunc(function(e){return e.oneHot(a,b,c,d)},{$indices:a},function(b){return{$indices:function(){return av(a.shape,"float32")}}}).reshape(f)}}),aU=a({pad_:function(c,d,a){void 0===a&&(a=0);var b=kn(c,"x","pad");if(0===b.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");return ad.runKernelFunc(function(c){return c.pad(b,d,a)},{x:b},function(a){var c=d.map(function(a){return a[0]});return{x:function(){return a.slice(c,b.shape)}}},"PadV2",{paddings:d,constantValue:a})}}),aV=a({pad1d_:function(c,b,a){return void 0===a&&(a=0),d8(2===b.length,function(){return"Invalid number of paddings. Must be length of 2."}),aU(c,[b],a)}}),aW=a({pad2d_:function(c,a,b){return void 0===b&&(b=0),d8(2===a.length&&2===a[0].length&&2===a[1].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),aU(c,a,b)}}),aX=a({pad3d_:function(c,a,b){return void 0===b&&(b=0),d8(3===a.length&&2===a[0].length&&2===a[1].length&&2===a[2].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),aU(c,a,b)}}),aY=a({pad4d_:function(c,a,b){return void 0===b&&(b=0),d8(4===a.length&&2===a[0].length&&2===a[1].length&&2===a[2].length&&2===a[3].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),aU(c,a,b)}}),aZ=a({rand_:function(e,f,a){var c=ec(e),b=null;if(null==a||"float32"===a)b=new Float32Array(c);else if("int32"===a)b=new Int32Array(c);else{if("bool"!==a)throw new Error("Unknown data type "+a);b=new Uint8Array(c)}for(var d=0;d<c;d++)b[d]=f();return ad.makeTensor(b,e,a)}}),a$=a({randomNormal_:function(f,b,c,a,g){if(void 0===b&&(b=0),void 0===c&&(c=1),null!=a&&"bool"===a)throw new Error("Unsupported data type "+a);for(var h=new kr(b,c,a,!1,g),d=aH(f,a),e=0;e<d.values.length;e++)d.values[e]=h.nextValue();return d.toTensor()}}),a_=a({randomGamma_:function(e,f,b,a,g){if(void 0===b&&(b=1),void 0===a&&(a="float32"),null==b&&(b=1),null==a&&(a="float32"),"float32"!==a&&"int32"!==a)throw new Error("Unsupported data type "+a);for(var h=new ks(f,b,a,g),c=aH(e,a),d=0;d<c.values.length;d++)c.values[d]=h.nextValue();return c.toTensor()}}),a0=a({randomUniform_:function(f,a,b,c,g){void 0===a&&(a=0),void 0===b&&(b=1),void 0===c&&(c="float32");for(var d=aH(f,c),h=new kt(a,b,null,g),e=0;e<d.values.length;e++)d.values[e]=h.nextValue();return d.toTensor()}}),a1=a({reshape_:function(c,a){var b=kn(c,"x","reshape",null);return a=ej(a,b.size),d8(b.size===ec(a),function(){return"new shape and old shape must have the same number of elements."}),ad.runKernelFunc(function(c){return c.reshape(b,a)},{x:b},function(a){return{x:function(){return a.reshape(b.shape)}}},"Reshape",{shape:a})}}),a2=a({spaceToBatchND_:function(c,b,d){var a=kn(c,"x","spaceToBatchND");return d8(a.rank>=1+b.length,function(){return"input rank "+a.rank+" should be > than [blockShape] "+b.length}),d8(d.length===b.length,function(){return"paddings.shape[0] "+d.length+" must be equal to [blockShape] "+b.length}),d8(a.shape.reduce(function(c,e,a){return 0<a&&a<=b.length?c&&(e+d[a-1][0]+d[a-1][1])%b[a-1]==0:c},!0),function(){return"input spatial dimensions "+a.shape.slice(1)+" with paddings "+d.toString()+" must be divisible by blockShapes "+b.toString()}),ad.runKernelFunc(function(c){return c.spaceToBatchND(a,b,d)},{$x:a},function(a){return{$x:function(){return a.batchToSpaceND(b,d)}}})}}),a3=a({squeeze_:function(b,c){var a=kn(b,"x","squeeze");return a1(a,el(a.shape,c).newShape)}}),a4=a({stack_:function(c,b){void 0===b&&(b=0);var a=ko(c,"tensors","stack");if(d8(1<=a.length,function(){return"Pass at least one tensor to tf.stack"}),1===a.length)return a[0].expandDims(b);var d=a[0].rank,f=a[0].shape,g=a[0].dtype;d8(b<=d,function(){return"Axis must be <= rank of the tensor"}),a.forEach(function(a){d9(f,a.shape,"All tensors passed to stack must have matching shapes")}),a.forEach(function(a){d8(g===a.dtype,function(){return"All tensors passed to stack must have matching dtypes"})});var e=a.map(function(a){return a.expandDims(b)});return aB(e,b)}}),a5=a({tile_:function(c,b){var a=kn(c,"x","tile",null);d8(a.rank===b.length,function(){return"Error in transpose: rank of input "+a.rank+" must match length of reps "+b+"."});var d=[a],e={reps:b};return ad.runKernelFunc(function(c,d){var e=c.tile(a,b);return d([a]),e},{x:a},function(c,a){var d=a[0];return{x:function(){var f=aA(d);if(1===d.rank)for(var a=0;a<b[0];++a)f=f.add(c.slice([a*d.shape[0]],[d.shape[0]]));else if(2===d.rank)for(a=0;a<b[0];++a)for(var e=0;e<b[1];++e)f=f.add(c.slice([a*d.shape[0],e*d.shape[1]],[d.shape[0],d.shape[1]]));else if(3===d.rank)for(a=0;a<b[0];++a)for(e=0;e<b[1];++e)for(var g=0;g<b[2];++g)f=f.add(c.slice([a*d.shape[0],e*d.shape[1],g*d.shape[2]],[d.shape[0],d.shape[1],d.shape[2]]));else{if(4!==d.rank)throw new Error("Gradient for tile operation is not implemented for rank-"+d.rank+" tensors yet.");for(a=0;a<b[0];++a)for(e=0;e<b[1];++e)for(g=0;g<b[2];++g)for(var h=0;h<b[3];++h)f=f.add(c.slice([a*d.shape[0],e*d.shape[1],g*d.shape[2],h*d.shape[3]],[d.shape[0],d.shape[1],d.shape[2],d.shape[3]]))}return f}}},"Tile",e,d)}}),a6=a({truncatedNormal_:function(f,b,c,a,g){if(void 0===b&&(b=0),void 0===c&&(c=1),null!=a&&"bool"===a)throw new Error("Unsupported data type "+a);for(var h=new kr(b,c,a,!0,g),d=aH(f,a),e=0;e<d.values.length;e++)d.values[e]=h.nextValue();return d.toTensor()}}),a7=a({unstack_:function(c,a){void 0===a&&(a=0),a=a||0;var b=kn(c,"x","unstack");return d8(a>= -b.shape.length&&a<b.shape.length,function(){return"Axis = "+a+" is not in [-"+b.shape.length+", "+b.shape.length+")"}),a<0&&(a+=b.shape.length),ad.runKernelFunc(function(c){return c.unstack(b,a)},{x:b},function(b){return{x:function(){return a4(b,a)}}},"Unpack",{axis:a})}});function kx(b,d,g,e){void 0===e&&(e=!0);var a=[];if(e)(a=a.concat(d.slice(0))).push(b[0]/g),a=a.concat(b.slice(1));else{a=a.concat(b[0]);for(var f=d.length,c=0;c<f;++c)a=a.concat([b[c+1]/d[c],d[c]]);a=a.concat(b.slice(f+1))}return a}function ky(e,c,d){void 0===d&&(d=!0);var b=[];if(d){b.push(c);for(var a=c+1;a<e;++a)a<=2*c?(b.push(a),b.push(a-(c+1))):b.push(a)}else{var f=[],g=[];for(a=1;a<e;++a)2*c+1<=a||a%2==1?g.push(a):f.push(a);b.push.apply(b,f),b.push(0),b.push.apply(b,g)}return b}function kz(b,e,f,d){void 0===d&&(d=!0);var c=[];d?c.push(b[0]/f):c.push(b[0]*f);for(var a=1;a<b.length;++a)a<=e.length?d?c.push(e[a-1]*b[a]):c.push(b[a]/e[a-1]):c.push(b[a]);return c}function kA(c,d){for(var b=[0],a=0;a<d;++a)b.push(c[a][0]);return b}function kB(b,c,e){for(var d=b.slice(0,1),a=0;a<e;++a)d.push(b[a+1]-c[a][0]-c[a][1]);return d}function fN(a,b){if(a.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+a.rank+".");if(b.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+b.rank+".");if("int32"!==b.dtype)throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+b.dtype+".");if(b.shape[b.rank-1]>a.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+b.shape[b.rank-1]+" vs. "+a.rank);if(0===a.size)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+a.shape+".");for(var d=b.shape,f=d[d.length-1],g=1,c=0;c<d.length-1;++c)g*=d[c];var h=a.shape,e=d.slice();e.pop();var i=1;for(c=f;c<a.rank;++c)i*=h[c],e.push(h[c]);var j=eA(a.shape).map(function(a){return a/i}).concat([1]).slice(0,f);return[e,g,i,j]}var fO=Object.freeze({prepareAndValidate:fN});function fP(a){return a<=30?a:ez(a,Math.floor(Math.sqrt(a)))}function fQ(e,d,c){var f=1<d.rank?d.shape[d.rank-1]:1,b=1<d.rank?d.rank-1:1,g="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+c.shape+", indices.shape: "+d.shape+", shape: "+e+", sliceDim: "+f+", and batchDim: "+b+".";if(c.rank<b)throw new Error(g+" update.rank < "+b+". ");if(e.length<f+(c.rank-b))throw new Error(g+" Output shape length < "+(f+(c.rank-b)));if(c.rank!==b+e.length-f)throw new Error(g+" update.rank != "+(b+e.length-f));for(var a=0;a<b;++a)if(c.shape[a]!==d.shape[a])throw new Error(g+" updates.shape["+a+"] ("+c.shape[a]+") != indices.shape["+a+"] ("+d.shape[a]+").");for(a=0;a<c.rank-b;++a)if(c.shape[a+b]!==e[a+f])throw new Error(g+" updates.shape["+(a+b)+"] ("+c.shape[a+b]+") != shape["+(a+b)+"] ("+e[a+b]+")")}function fR(b,a,c){if(a.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+a.rank+".");if(b.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+b.rank+".");if("int32"!==a.dtype)throw new Error("The dtype of 'indices' should be int32, but got dtype: "+a.dtype);if(c.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+c);if(0===c.length){if(0===a.size)throw new Error("Indices specified for empty output. indices shape: "+a.shape);if(0===b.size)throw new Error("Updates specified for empty output. updates shape: "+b.shape)}fQ(c,a,b)}function fS(h,c,b){for(var e=c.shape.length,a=1<e?c.shape[e-1]:1,g=b.length,f=1,d=a;d<g;++d)f*=b[d];return{sliceRank:a,numUpdates:ec(c.shape)/(a<1?1:a),sliceSize:f,strides:eA(b.slice(0,a)).concat([1]),outputSize:ec(b)}}var fT=Object.freeze({validateUpdateShape:fQ,validateInput:fR,calculateShapes:fS});function fU(a,c,d){d8(a.rank===c.length,function(){return"Error in slice"+a.rank+"D: Length of begin "+c+" must match the rank of the array ("+a.rank+")."}),d8(a.rank===d.length,function(){return"Error in slice"+a.rank+"D: Length of size "+d+" must match the rank of the array ("+a.rank+")."});for(var e=function(b){d8(c[b]+d[b]<=a.shape[b],function(){return"Error in slice"+a.rank+"D: begin["+b+"] + size["+b+"] ("+(c[b]+d[b])+") would overflow input.shape["+b+"] ("+a.shape[b]+")"})},b=0;b<a.rank;++b)e(b)}function fV(a){for(var b=[],c=0;0<a;)1&a&&b.push(c),a/=2,c++;return b}function fW(b,d,e){for(var c=[],a=0;a<b.length;a++)c[a]=Math.ceil((d[a]-b[a])/e[a]);return c}function fX(d,e,f,g,b){var a=e[b],h=f[b]||1;(d&1<<b||null==a)&&(a=0<h?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var c=g[b];return a<0&&(a+=c),d5(0,a,c-1)}function fY(e,f,g,h,b){var a=f[b],d=g[b]||1;(e&1<<b||null==a)&&(a=0<d?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var c=h[b];return a<0&&(a+=c),0<d?d5(0,a,c):d5(-1,a,c-1)}function fZ(d,e,b){for(var c=b.length,a=0;a<b.length;a++)if(1<b[a]){c=a;break}for(a=c+1;a<b.length;a++)if(0<e[a]||b[a]!==d[a])return!1;return!0}function f$(a,d){for(var c=0<a.length?a[a.length-1]:1,b=0;b<a.length-1;b++)c+=a[b]*d[b];return c}var f_=Object.freeze({assertParamsValid:fU,maskToAxes:fV,computeOutShape:fW,startForAxis:fX,stopForAxis:fY,isSliceContinous:fZ,computeFlatOffset:f$});function f0(b,a){d8(ey(b),function(){return"The f passed in variableGrads(f) must be a function"}),d8(null==a||Array.isArray(a)&&a.every(function(a){return a instanceof ac}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var c=null!=a;if(!c)for(var g in a=[],ad.registeredVariables)a.push(ad.registeredVariables[g]);var d=c?a.filter(function(a){return!a.trainable}):null,j=a.length;d8(0<(a=a.filter(function(a){return a.trainable})).length,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+j+" variables is trainable."});var e=ad.gradients(b,a,null,!0),f=e.value,h=e.grads;d8(h.some(function(a){return null!=a}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),d8(0===f.rank,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+f.rank+" tensor"});var i={};return a.forEach(function(b,a){null!=h[a]&&(i[b.name]=h[a])}),null!=d&&d.forEach(function(a){return i[a.name]=null}),{value:f,grads:i}}function f1(a){return ad.customGrad(a)}function kC(a){if(0<a.filter(function(a){return null==a}).length)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that\n    the f you passed encloses all operations that lead from x to y.")}var a8=a({softmax_:function(c,a){void 0===a&&(a=-1);var b=kn(c,"logits","softmax");if(-1===a&&(a=b.rank-1),a!==b.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+b.rank+" and dim was "+a);return f1(function(b,d){var e=b.logSumExp([a],!0),c=b.toFloat().sub(e).exp();return d([c]),{value:c,gradFunc:function(d,e){var b=e[0],c=d.mul(b);return c.sub(c.sum([a],!0).mul(b))}}})(b)}}),a9=a({logSoftmax_:function(c,a){void 0===a&&(a=-1);var b=kn(c,"logits","logSoftmax");if(-1===a&&(a=b.rank-1),a!==b.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+b.rank+" and axis was "+a);return f1(function(b,e){var f=b.max(a,!0),c=b.sub(f),d=c.toFloat().sub(c.exp().sum(a,!0).log());return e([d]),{value:d,gradFunc:function(b,c){var d=c[0].exp();return b.sub(b.sum(a,!0).mul(d))}}})(b)}}),f2=(kE.prototype.get=function(a){return this.data.has(a)||this.dataMover.moveData(this.backend,a),this.data.get(a)},kE.prototype.set=function(a,b){this.dataIdsCount++,this.data.set(a,b)},kE.prototype.has=function(a){return this.data.has(a)},kE.prototype.delete=function(a){return this.dataIdsCount--,this.data.delete(a)},kE.prototype.numDataIds=function(){return this.dataIdsCount},kE),K=(kD.prototype.time=function(a){return kF("time")},kD.prototype.read=function(a){return kF("read")},kD.prototype.readSync=function(a){return kF("readSync")},kD.prototype.numDataIds=function(){return kF("numDataIds")},kD.prototype.disposeData=function(a){return kF("disposeData")},kD.prototype.write=function(a,b,c){return kF("write")},kD.prototype.move=function(a,b,c,d){return kF("move")},kD.prototype.memory=function(){return kF("memory")},kD.prototype.floatPrecision=function(){return kF("floatPrecision")},kD.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},kD.prototype.batchMatMul=function(a,b,c,d){return kF("batchMatMul")},kD.prototype.fusedBatchMatMul=function(a){return a.a,a.b,a.transposeA,a.transposeB,a.bias,a.activation,a.preluActivationWeights,kF("fusedBatchMatMul")},kD.prototype.slice=function(a,b,c){return kF("slice")},kD.prototype.stridedSlice=function(a,b,c,d){return kF("stridedSlice")},kD.prototype.unstack=function(a,b){return kF("unstack")},kD.prototype.reverse=function(a,b){return kF("reverse")},kD.prototype.concat=function(a,b){return kF("concat")},kD.prototype.neg=function(a){return kF("neg")},kD.prototype.add=function(a,b){return kF("add")},kD.prototype.addN=function(a){return kF("addN")},kD.prototype.subtract=function(a,b){return kF("subtract")},kD.prototype.multiply=function(a,b){return kF("multiply")},kD.prototype.realDivide=function(a,b){return kF("realDivide")},kD.prototype.floorDiv=function(a,b){return kF("floorDiv")},kD.prototype.sum=function(a,b){return kF("sum")},kD.prototype.prod=function(a,b){return kF("prod")},kD.prototype.unsortedSegmentSum=function(a,b,c){return kF("unsortedSegmentSum")},kD.prototype.argMin=function(a,b){return kF("argMin")},kD.prototype.argMax=function(a,b){return kF("argMax")},kD.prototype.equal=function(a,b){return kF("equal")},kD.prototype.notEqual=function(a,b){return kF("notEqual")},kD.prototype.less=function(a,b){return kF("less")},kD.prototype.lessEqual=function(a,b){return kF("lessEqual")},kD.prototype.greater=function(a,b){return kF("greater")},kD.prototype.greaterEqual=function(a,b){return kF("greaterEqual")},kD.prototype.logicalNot=function(a){return kF("logicalNot")},kD.prototype.logicalAnd=function(a,b){return kF("logicalAnd")},kD.prototype.logicalOr=function(a,b){return kF("logicalOr")},kD.prototype.where=function(a){return kF("where")},kD.prototype.select=function(a,b,c){return kF("select")},kD.prototype.topk=function(a,b,c){return kF("topk")},kD.prototype.min=function(a,b){return kF("min")},kD.prototype.minimum=function(a,b){return kF("minimum")},kD.prototype.mod=function(a,b){return kF("mod")},kD.prototype.max=function(a,b){return kF("max")},kD.prototype.maximum=function(a,b){return kF("maximum")},kD.prototype.all=function(a,b){return kF("all")},kD.prototype.any=function(a,b){return kF("any")},kD.prototype.squaredDifference=function(a,b){return kF("squaredDifference")},kD.prototype.ceil=function(a){return kF("ceil")},kD.prototype.floor=function(a){return kF("floor")},kD.prototype.round=function(a){return kF("round")},kD.prototype.sign=function(a){return kF("sign")},kD.prototype.isNaN=function(a){return kF("isNaN")},kD.prototype.isInf=function(a){return kF("isInf")},kD.prototype.isFinite=function(a){return kF("isFinite")},kD.prototype.pow=function(a,b){return kF("pow")},kD.prototype.exp=function(a){return kF("exp")},kD.prototype.expm1=function(a){return kF("expm1")},kD.prototype.log=function(a){return kF("log")},kD.prototype.log1p=function(a){return kF("log1p")},kD.prototype.sqrt=function(a){return kF("sqrt")},kD.prototype.rsqrt=function(a){return kF("rsqrt")},kD.prototype.square=function(a){return kF("square")},kD.prototype.reciprocal=function(a){return kF("reciprocal")},kD.prototype.relu=function(a){return kF("relu")},kD.prototype.relu6=function(a){return kF("relu6")},kD.prototype.prelu=function(a,b){return kF("prelu")},kD.prototype.elu=function(a){return kF("elu")},kD.prototype.eluDer=function(a,b){return kF("eluDer")},kD.prototype.selu=function(a){return kF("selu")},kD.prototype.int=function(a){return kF("int")},kD.prototype.clip=function(a,b,c){return kF("clip")},kD.prototype.abs=function(a){return kF("abs")},kD.prototype.complexAbs=function(a){return kF("complexAbs")},kD.prototype.sigmoid=function(a){return kF("sigmoid")},kD.prototype.softplus=function(a){return kF("softplus")},kD.prototype.sin=function(a){return kF("sin")},kD.prototype.cos=function(a){return kF("cos")},kD.prototype.tan=function(a){return kF("tan")},kD.prototype.asin=function(a){return kF("asin")},kD.prototype.acos=function(a){return kF("acos")},kD.prototype.atan=function(a){return kF("atan")},kD.prototype.atan2=function(a,b){return kF("atan2")},kD.prototype.sinh=function(a){return kF("sinh")},kD.prototype.cosh=function(a){return kF("cosh")},kD.prototype.tanh=function(a){return kF("tanh")},kD.prototype.asinh=function(a){return kF("asinh")},kD.prototype.acosh=function(a){return kF("acosh")},kD.prototype.atanh=function(a){return kF("atanh")},kD.prototype.erf=function(a){return kF("erf")},kD.prototype.step=function(a,b){return kF("step")},kD.prototype.fusedConv2d=function(a){return a.input,a.filter,a.convInfo,a.bias,a.activation,a.preluActivationWeights,kF("fusedConv2d")},kD.prototype.conv2d=function(a,b,c){return kF("conv2d")},kD.prototype.conv2dDerInput=function(a,b,c){return kF("conv2dDerInput")},kD.prototype.conv2dDerFilter=function(a,b,c){return kF("conv2dDerFilter")},kD.prototype.fusedDepthwiseConv2D=function(a){return a.input,a.filter,a.convInfo,a.bias,a.activation,a.preluActivationWeights,kF("fusedDepthwiseConv2D")},kD.prototype.depthwiseConv2D=function(a,b,c){return kF("depthwiseConv2D")},kD.prototype.depthwiseConv2DDerInput=function(a,b,c){return kF("depthwiseConv2DDerInput")},kD.prototype.depthwiseConv2DDerFilter=function(a,b,c){return kF("depthwiseConv2DDerFilter")},kD.prototype.conv3d=function(a,b,c){return kF("conv3d")},kD.prototype.conv3dDerInput=function(a,b,c){return kF("conv3dDerInput")},kD.prototype.conv3dDerFilter=function(a,b,c){return kF("conv3dDerFilter")},kD.prototype.maxPool=function(a,b){return kF("maxPool")},kD.prototype.maxPoolBackprop=function(a,b,c,d){return kF("maxPoolBackprop")},kD.prototype.avgPool=function(a,b){return kF("avgPool")},kD.prototype.avgPoolBackprop=function(a,b,c){return kF("avgPoolBackprop")},kD.prototype.avgPool3d=function(a,b){return kF("avgPool3d")},kD.prototype.avgPool3dBackprop=function(a,b,c){return kF("avgPool3dBackprop")},kD.prototype.maxPool3d=function(a,b){return kF("maxPool3d")},kD.prototype.maxPool3dBackprop=function(a,b,c,d){return kF("maxPool3dBackprop")},kD.prototype.reshape=function(a,b){return kF("reshape")},kD.prototype.cast=function(a,b){return kF("cast")},kD.prototype.tile=function(a,b){return kF("tile")},kD.prototype.pad=function(a,b,c){return kF("pad")},kD.prototype.transpose=function(a,b){return kF("transpose")},kD.prototype.gather=function(a,b,c){return kF("gather")},kD.prototype.gatherND=function(a,b){return kF("gatherND")},kD.prototype.scatterND=function(a,b,c){return kF("scatterND")},kD.prototype.batchToSpaceND=function(a,b,c){return kF("batchToSpaceND")},kD.prototype.spaceToBatchND=function(a,b,c){return kF("spaceToBatchND")},kD.prototype.resizeBilinear=function(a,b,c,d){return kF("resizeBilinear")},kD.prototype.resizeBilinearBackprop=function(a,b,c){return kF("resizeBilinearBackprop")},kD.prototype.resizeNearestNeighbor=function(a,b,c,d){return kF("resizeNearestNeighbor")},kD.prototype.resizeNearestNeighborBackprop=function(a,b,c){return kF("resizeNearestNeighborBackprop")},kD.prototype.batchNormalization=function(a,b,c,d,e,f){return kF("batchNormalization")},kD.prototype.localResponseNormalization4D=function(a,b,c,d,e){return kF("localResponseNormalization4D")},kD.prototype.LRNGrad=function(a,b,c,d,e,f,g){return kF("LRNGrad")},kD.prototype.multinomial=function(a,b,c,d){return kF("multinomial")},kD.prototype.oneHot=function(a,b,c,d){return kF("oneHot")},kD.prototype.cumsum=function(a,b,c,d){return kF("cumsum")},kD.prototype.nonMaxSuppression=function(a,b,c,d,e){return kF("nonMaxSuppression")},kD.prototype.fft=function(a){return kF("fft")},kD.prototype.ifft=function(a){return kF("ifft")},kD.prototype.complex=function(a,b){return kF("complex")},kD.prototype.real=function(a){return kF("real")},kD.prototype.imag=function(a){return kF("imag")},kD.prototype.cropAndResize=function(a,b,c,d,e,f){return kF("cropAndResize")},kD.prototype.depthToSpace=function(a,b,c){return kF("depthToSpace")},kD.prototype.split=function(a,b,c){return kF("split")},kD.prototype.sparseToDense=function(a,b,c,d){return kF("sparseToDense")},kD.prototype.diag=function(a){return kF("diag")},kD.prototype.fill=function(a,b,c){return kF("fill")},kD.prototype.onesLike=function(a){return kF("onesLike")},kD.prototype.zerosLike=function(a){return kF("zerosLike")},kD.prototype.linspace=function(a,b,c){return kF("linspace")},kD.prototype.dispose=function(){return kF("dispose")},kD);function kD(){}function kE(a,b){this.backend=a,this.dataMover=b,this.data=new WeakMap,this.dataIdsCount=0}function kF(a){throw new Error("'"+a+"' not yet implemented or not found in the registry. Did you forget to import the kernel?")}function f3(b,c){for(var d=b.length,e=[],a=0;a<d;a++){var f=d-1-a,g=b[f]||1;1<(c[c.length-1-a]||1)&&1===g&&e.unshift(f)}return e}function f4(c,b){for(var d=[],a=0;a<b.length;a++){var e=c[c.length-a-1],f=b.length-a-1,g=b[f];(null==e||1===e&&1<g)&&d.unshift(f)}return d}function f5(c,d){for(var e=[],g=Math.max(c.length,d.length),f=0;f<g;f++){var a=c[c.length-f-1];null==a&&(a=1);var b=d[d.length-f-1];if(null==b&&(b=1),1===a)e.unshift(b);else if(1===b)e.unshift(a);else{if(a!==b)throw Error("Operands could not be broadcast together with shapes "+c+" and "+d+".");e.unshift(a)}}return e}function f6(b,g,h,i,j,k,a){void 0===a&&(a="channelsLast");var c,d=kG(g),e=d[0],f=d[1];if("channelsLast"===a)c=[e,f,b[3],b[3]];else{if("channelsFirst"!==a)throw new Error("Unknown dataFormat "+a);c=[e,f,b[1],b[1]]}return f8(b,c,h,i,j,k,!1,a)}function f7(a,i,j,k,l,m,b){void 0===b&&(b="NDHWC");var c,d,e=kH(i),f=e[0],g=e[1],h=e[2];if("NDHWC"===b)d="channelsLast",c=[f,g,h,a[4],a[4]];else{if("NCDHW"!==b)throw new Error("Unknown dataFormat "+b);d="channelsFirst",c=[f,g,h,a[1],a[1]]}return f9(a,c,j,k,l,!1,d,m)}function f8(a,d,y,z,A,C,i,b){void 0===i&&(i=!1),void 0===b&&(b="channelsLast");var e=[-1,-1,-1,-1],c=e[0],f=e[1],g=e[2],h=e[3];if("channelsLast"===b)c=a[0],f=a[1],g=a[2],h=a[3];else{if("channelsFirst"!==b)throw new Error("Unknown dataFormat "+b);c=a[0],h=a[1],f=a[2],g=a[3]}var j,o=d[0],p=d[1],q=d[3],r=kG(y),s=r[0],t=r[1],u=kG(z),v=u[0],w=u[1],x=kI(o,v),_=kI(p,w),k=function(a,e,f,g,l,m,q){var h,b,c;if("number"==typeof a){h={top:a,bottom:a,left:a,right:a,type:0===a?"VALID":"NUMBER"};var i,j,k,d,n,r,o,p,s=(i=[e,f],j=m,k=g,d=a,n=C,null==d&&(d=ga(i,j,k)),r=i[1],o=kJ((i[0]-j+2*d)/k+1,n),d8(ee(o),function(){return"The output # of rows ("+o+") must be an integer. Change the stride and/or zero pad parameters"}),p=kJ((r-j+2*d)/k+1,n),d8(ee(p),function(){return"The output # of columns ("+p+") must be an integer. Change the stride and/or zero pad parameters"}),[o,p]);b=s[0],c=s[1]}else if("same"===a){b=Math.ceil(e/g),c=Math.ceil(f/l);var t=Math.max(0,(b-1)*g+m-e),u=Math.max(0,(c-1)*l+q-f),v=Math.floor(t/2),x=t-v,w=Math.floor(u/2);h={top:v,bottom:x,left:w,right:u-w,type:"SAME"}}else{if("valid"!==a)throw Error("Unknown padding parameter: "+a);h={top:0,bottom:0,left:0,right:0,type:"VALID"},b=Math.ceil((e-m+1)/g),c=Math.ceil((f-q+1)/l)}return{padInfo:h,outHeight:b,outWidth:c}}(A,f,g,s,t,x,_),B=k.padInfo,l=k.outHeight,m=k.outWidth,n=i?q*h:q;return"channelsFirst"===b?j=[c,n,l,m]:"channelsLast"===b&&(j=[c,l,m,n]),{batchSize:c,dataFormat:b,inHeight:f,inWidth:g,inChannels:h,outHeight:l,outWidth:m,outChannels:n,padInfo:B,strideHeight:s,strideWidth:t,filterHeight:o,filterWidth:p,effectiveFilterHeight:x,effectiveFilterWidth:_,dilationHeight:v,dilationWidth:w,inShape:a,outShape:j,filterShape:d}}function f9(a,c,E,F,G,k,b,I){void 0===k&&(k=!1),void 0===b&&(b="channelsLast");var d=[-1,-1,-1,-1,-1],e=d[0],f=d[1],g=d[2],h=d[3],i=d[4];if("channelsLast"===b)e=a[0],f=a[1],g=a[2],h=a[3],i=a[4];else{if("channelsFirst"!==b)throw new Error("Unknown dataFormat "+b);e=a[0],i=a[1],f=a[2],g=a[3],h=a[4]}var l,s=c[0],t=c[1],u=c[2],v=c[4],m=kH(E),w=m[0],x=m[1],y=m[2],n=kH(F),_=n[0],z=n[1],A=n[2],B=kI(s,_),C=kI(t,z),D=kI(u,A),j=function(a,f,g,h,i,o,p,q,v,w){var j,k,l,m;if("number"==typeof a){j={top:a,bottom:a,left:a,right:a,front:a,back:a,type:0===a?"VALID":"NUMBER"};var c,d,e,b,n,x,y,r,s,t,u=(c=[f,g,h,1],d=q,e=i,b=a,n=I,null==b&&(b=ga(c,d,e)),x=c[1],y=c[2],r=kJ((c[0]-d+2*b)/e+1,n),d8(ee(r),function(){return"The output # of depths ("+r+") must be an integer. Change the stride and/or zero pad parameters"}),s=kJ((x-d+2*b)/e+1,n),d8(ee(s),function(){return"The output # of rows ("+s+") must be an integer. Change the stride and/or zero pad parameters"}),t=kJ((y-d+2*b)/e+1,n),d8(ee(t),function(){return"The output # of columns ("+t+") must be an integer. Change the stride and/or zero pad parameters"}),[r,s,t,1]);k=u[0],l=u[1],m=u[2]}else if("same"===a){var z=((k=Math.ceil(f/i))-1)*i+q-f,A=((l=Math.ceil(g/o))-1)*o+v-g,B=((m=Math.ceil(h/p))-1)*p+w-h,C=Math.floor(z/2),F=z-C,D=Math.floor(A/2),G=A-D,E=Math.floor(B/2);j={top:D,bottom:G,left:E,right:B-E,front:C,back:F,type:"SAME"}}else{if("valid"!==a)throw Error("Unknown padding parameter: "+a);j={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},k=Math.ceil((f-q+1)/i),l=Math.ceil((g-v+1)/o),m=Math.ceil((h-w+1)/p)}return{padInfo:j,outDepth:k,outHeight:l,outWidth:m}}(G,f,g,h,w,x,y,B,C,D),H=j.padInfo,o=j.outDepth,p=j.outHeight,q=j.outWidth,r=k?v*i:v;return"channelsFirst"===b?l=[e,r,o,p,q]:"channelsLast"===b&&(l=[e,o,p,q,r]),{batchSize:e,dataFormat:b,inDepth:f,inHeight:g,inWidth:h,inChannels:i,outDepth:o,outHeight:p,outWidth:q,outChannels:r,padInfo:H,strideDepth:w,strideHeight:x,strideWidth:y,filterDepth:s,filterHeight:t,filterWidth:u,effectiveFilterDepth:B,effectiveFilterHeight:C,effectiveFilterWidth:D,dilationDepth:_,dilationHeight:z,dilationWidth:A,inShape:a,outShape:l,filterShape:c}}function ga(c,d,b,a){void 0===a&&(a=1);var e=kI(d,a);return Math.floor((c[0]*(b-1)-b+e)/2)}function kG(a){return"number"==typeof a?[a,a,a]:2===a.length?[a[0],a[1],1]:a}function kH(a){return"number"==typeof a?[a,a,a]:a}function kI(a,b){return b<=1?a:a+(a-1)*(b-1)}function kJ(a,b){if(!b)return a;switch(b){case"round":return Math.round(a);case"ceil":return Math.ceil(a);case"floor":return Math.floor(a);default:throw new Error("Unknown roundingMode "+b)}}function gb(b){var a=kG(b),c=a[0],d=a[1],e=a[2];return 1===c&&1===d&&1===e}function gc(a,b){return gb(a)||gb(b)}function gd(a){if("NHWC"===a)return"channelsLast";if("NCHW"===a)return"channelsFirst";throw new Error("Unknown dataFormat "+a)}function ge(a,b,d){if("complex64"===b){if("complex64"===a.dtype)return a.clone();var e=av(a.shape),f=a.toFloat(),c=d.complex(f,e);return e.dispose(),f.dispose(),c}if(!eq(a.dtype,b))return ad.makeTensorFromDataId(a.dataId,a.shape,b);if("complex64"===a.dtype){var g=d.real(a);return c=g.cast(b),g.dispose(),c}if("int32"===b)return d.int(a);if("bool"!==b)throw new Error("Error in Cast: failed to cast "+a.dtype+" to "+b);var h=am(0,a.dtype);return c=d.notEqual(a,h),h.dispose(),c}function gf(a,b){return ad.makeTensorFromDataId(a.dataId,b,a.dtype)}function gg(c,e,d){var f=(e-c)/(d-1),a=eD(d,"float32");a[0]=c;for(var b=1;b<a.length;b++)a[b]=a[b-1]+f;return an(a,"float32")}var gh=Object.freeze({castTensor:ge,reshapeTensor:gf,linspaceImpl:gg,upcastType:eN,axesAreInnerMostDims:fx,combineLocations:fy,computeOutAndReduceShapes:fz,expandShapeToKeepDim:fA,assertAxesAreInnerMostDims:fB,getAxesPermutation:fC,getUndoAxesPermutation:fD,getInnerMostAxes:fE,getBroadcastDims:f3,getReductionAxes:f4,assertAndGetBroadcastShape:f5,assertParamsConsistent:fF,computeOutShape:fG,computePool2DInfo:f6,computePool3DInfo:f7,computeConv2DInfo:f8,computeConv3DInfo:f9,computeDefaultPad:ga,tupleValuesAreOne:gb,eitherStridesOrDilationsAreOne:gc,convertConv2DDataFormat:gd,PARALLELIZE_THRESHOLD:30,computeOptimalWindowSize:fP});function kK(b,d){if(b.length!==d.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+b.length+", imag: "+d.length+".");for(var c=new Float32Array(2*b.length),a=0;a<c.length;a+=2)c[a]=b[a/2],c[a+1]=d[a/2];return c}function kL(a,b){return{real:a[2*b],imag:a[2*b+1]}}function kM(a,b){return b<a?1:a<b?-1:0}function kN(a,b,c,d,e){return kP(a,b,c,d,e,0).selectedIndices}function kO(b,c,d,e,f,g){var a=kP(b,c,d,e,f,g);return a.numValidOutputs.dispose(),{selectedIndices:a.selectedIndices,selectedScores:a.selectedScores}}function kP(o,p,q,i,c,j,t,d){void 0===d&&(d=!1);for(var e=Array.from(p).map(function(a,b){return{score:a,boxIndex:b,suppressBeginIndex:0}}).filter(function(a){return a.score>c}).sort(kR),r=0<j?-0.5/j:0,b=[],f=[];b.length<q&&0<e.length;){var a=e.pop(),k=a.score,l=a.boxIndex,s=a.suppressBeginIndex;if(k<c)break;for(var m=!1,g=b.length-1;s<=g;--g){var n=kQ(o,l,b[g]);if(i<=n){m=!0;break}if(a.score=a.score*(y=i,A=Math.exp(r*(z=n)*z),z<=y?A:0),a.score<=c)break}a.suppressBeginIndex=b.length,m||(a.score===k?(b.push(l),f.push(a.score)):a.score>c&&(x=(w=function(d,g,h){for(var a=0,b=d.length,c=0,e=!1;a<b;){var f=h(g,d[c=a+(b-a>>>1)]);0<f?a=c+1:(b=c,e=!f)}return e?a:-a-1}(u=e,v=a,kR||kM))<0?-(w+1):w,u.splice(x,0,v)))}var u,v,w,x,y,_,z,A,h=b.length;return d&&(b.fill(0,h),f.fill(0,h)),{selectedIndices:an(b,"int32"),selectedScores:an(f,"float32"),numValidOutputs:am(h,"int32")}}function kQ(c,d,e){var a=c.subarray(4*d,4*d+4),b=c.subarray(4*e,4*e+4),f=Math.min(a[0],a[2]),g=Math.min(a[1],a[3]),h=Math.max(a[0],a[2]),i=Math.max(a[1],a[3]),j=Math.min(b[0],b[2]),k=Math.min(b[1],b[3]),l=Math.max(b[0],b[2]),m=Math.max(b[1],b[3]),n=(h-f)*(i-g),o=(l-j)*(m-k);if(n<=0||o<=0)return 0;var q=Math.max(f,j),r=Math.max(g,k),s=Math.min(h,l),t=Math.min(i,m),p=Math.max(s-q,0)*Math.max(t-r,0);return p/(n+o-p)}function kR(a,b){return a.score-b.score||a.score===b.score&&b.boxIndex-a.boxIndex}function kS(a,b,c){var d=new Array(a.rank).fill(0),e=a.shape.slice();return b.map(function(b){e[c]=b;var f=a.slice(d,e);return d[c]+=b,f})}function kT(b,g){for(var e=new Array(b.rank),a=0;a<e.length;a++)e[a]=b.shape[a]*g[a];var d=aH(e,b.dtype);for(a=0;a<d.values.length;++a){for(var h=d.indexToLoc(a),f=new Array(b.rank),c=0;c<f.length;c++)f[c]=h[c]%b.shape[c];var i=b.locToIndex(f);d.values[a]=b.values[i]}return d.toTensor()}function kU(i,g,j,b){for(var k=g[g.length-1],l=[i.length/k,k],h=l[0],m=l[1],n=em(j,h*b),o=em("int32",h*b),c=0;c<h;c++){for(var p=c*m,q=i.subarray(p,p+m),d=[],a=0;a<q.length;a++)d.push({value:q[a],index:a});d.sort(function(a,b){return b.value-a.value});var e=c*b,r=n.subarray(e,e+b),s=o.subarray(e,e+b);for(a=0;a<b;a++)r[a]=d[a].value,s[a]=d[a].index}var f=g.slice();return f[f.length-1]=b,[al(n,f,j),al(o,f,"int32")]}function kV(c,d){for(var b=[],a=0;a<d.length;a++)d[a]&&b.push(a);var f=aH(c,"int32"),e=aH([b.length,c.length],"int32");for(a=0;a<b.length;a++){var g=f.indexToLoc(b[a]),h=a*c.length;e.values.set(g,h)}return e.toTensor()}function kW(a,b){this.outputShape=[],this.outputShape=a,this.variableNames=b.map(function(b,a){return"T"+a});var c=[];this.variableNames.forEach(function(a){c.push("float v"+a+" = get"+a+"AtOutCoords();")});var d=this.variableNames.map(function(a){return"v"+a}).join(" + ");this.userCode="\n      void main() {\n        "+c.join("\n        ")+"\n\n        float result = "+d+";\n        setOutput(result);\n      }\n    "}function kX(a,b){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a,this.variableNames=b.map(function(b,a){return"T"+a});var c=[];this.variableNames.forEach(function(a){c.push("vec4 v"+a+" = get"+a+"AtOutCoords();")});var d=this.variableNames.map(function(a){return"v"+a}).join(" + ");this.userCode="\n      void main() {\n        "+c.join("\n        ")+"\n\n        vec4 result = "+d+";\n        setOutput(result);\n      }\n    "}function kY(a,d,c){this.variableNames=["A"];var b=a.windowSize,e=a.batchSize,f=a.inSize,g=Math.ceil(f/b);c||this.variableNames.push("bestIndicesA"),this.outputShape=[e,g],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+b+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+b+"; i++) {\n          int inIdx = "+(c?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));")+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+("max"===d?">":"<")+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "}function kZ(b,a){return["x","y","z","w","u","v"].slice(0,a).map(function(a){return b+"."+a})}function k$(a,b){return 1===b?[a]:kZ(a,b)}function k_(){var a,b,c,d,e,f,g,h,j,k;return k=2===i.getNumber("WEBGL_VERSION")?(a="#version 300 es",c="out",d=b="in",e="texture",f="outputColor",g="out vec4 outputColor;",h="\n      bool isnan_custom(float val) {\n        return (val > 0.0 || val < 0.0) ? false : val != 0.0;\n      }\n\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan_custom(val.x),\n          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));\n      }\n\n      #define isnan(value) isnan_custom(value)\n    ",j="","\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(b="attribute",d=c="varying",e="texture2D",f="gl_FragColor",g=a="",h="\n      #define isnan(value) isnan_custom(value)\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n      }\n    ",j="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ","\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:a,attribute:b,varyingVs:c,varyingFs:d,texture2D:e,output:f,defineOutput:g,defineSpecialNaN:h,defineSpecialInf:j,defineRound:k}}function k0(d,b,a){void 0===a&&(a="index");var c=eA(b);return c.map(function(e,b){return"int "+d[b]+" = "+a+" / "+e+"; "+(b===c.length-1?"int "+d[b+1]+" = "+a+" - "+d[b]+" * "+e:"index -= "+d[b]+" * "+e)+";"}).join("")}function k1(b){var a=eA(b).map(function(a){return a.toString()});return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+a[0]+" + coords.y * "+a[1]+" + coords.z;\n  }\n"}var k2="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n";function k3(a){var b=a.name,c=ec(a.shapeInfo.logicalShape);return c<2?"return "+b+";":"\n    for (int i = 0; i < "+c+"; i++) {\n      if (i == index) {\n        return "+b+"[i];\n      }\n    }\n  "}function k4(a){if(a<=1)return"int";if(2===a)return"ivec2";if(3===a)return"ivec3";if(4===a)return"ivec4";if(5===a)return"ivec5";if(6===a)return"ivec6";throw Error("GPU for rank "+a+" is not yet supported")}function k5(b,c){var a=JSON.parse(JSON.stringify(b));return a.shapeInfo.logicalShape=c,a}function k6(b,a){return a.map(function(a){return b[a]}).join(", ")}function k7(g,i,t,j){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,d8(2<g.length,function(){return"Packed arg"+(t.charAt(0).toUpperCase()+t.slice(1))+" supports only inputs with rank above 2."});var k=Math.ceil(g[g.length-1]/i);this.outputShape=g.slice(0,-1),1<k&&this.outputShape.push(k),j||this.variableNames.push("bestIndicesA");var l,c,m=this.outputShape,a=m.length,f=k4(a),b=k$("coords",a);if(1===k){var d=k4(c=a+1);l="\n        "+d+" sourceLocR = "+d+"("+b.join()+", 0);\n        ++"+b[a-1]+";\n        "+d+" sourceLocG = "+d+"("+b.join()+", 0);\n        ++"+b[a-2]+";\n        "+d+" sourceLocA = "+d+"("+b.join()+", 0);\n        --"+b[a-1]+";\n        "+d+" sourceLocB = "+d+"("+b.join()+", 0);\n        --"+b[a-2]+";"}else l="\n        "+f+" sourceLocR = coords;\n        ++"+b[(c=a)-1]+";\n        "+f+" sourceLocG = coords;\n        ++"+b[a-2]+";\n        "+f+" sourceLocA = coords;\n        --"+b[a-1]+";\n        "+f+" sourceLocB = coords;\n        --"+b[a-2]+";";var e=["x","y","z","w","u","v"].slice(0,c),h="."+e[c-1],n=e.map(function(a){return"int "+a}),o=k$("sourceLocR",c-1).concat("inIdx.r"),p=k$("sourceLocG",c-1).concat("inIdx.g"),q=k$("sourceLocB",c-1).concat("inIdx.b"),r=k$("sourceLocA",c-1).concat("inIdx.a"),u=j?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+o.join()+"),\n                             getBestIndicesAChannel("+p.join()+"),\n                             getBestIndicesAChannel("+q.join()+"),\n                             getBestIndicesAChannel("+r.join()+")));",s="vec4(\n            getAChannel("+o.join()+"),\n            hasNextCol ? getAChannel("+p.join()+") : 0.,\n            hasNextRow ? getAChannel("+q.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+r.join()+") : 0.)",v=j?"":"\n      float getBestIndicesAChannel("+n.join()+") {\n        return getChannel(getBestIndicesA("+e.join()+"),\n                                          vec2("+e.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+n.join()+") {\n        return getChannel(getA("+e.join()+"),\n                               vec2("+e.slice(-2).join()+"));\n      }\n      "+v+"\n      void main() {\n        "+f+" coords = getOutputCoords();\n        bool hasNextCol = "+b[a-1]+" < "+(m[a-1]-1)+";\n        bool hasNextRow = "+b[a-2]+" < "+(m[a-2]-1)+";\n        "+l+"\n        ivec4 srcIdx = ivec4(sourceLocR"+h+", sourceLocG"+h+",\n          sourceLocB"+h+", sourceLocA"+h+") * "+i+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+s+";\n\n        for (int i = 0; i < "+i+"; i++) {\n          inIdx = srcIdx;\n          "+u+"\n          vec4 candidate = "+s+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+("max"===t?"greaterThan":"lessThan")+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "}function k8(a){this.variableNames=["dy"],this.outputShape=a.inShape;var d=a.filterHeight,e=a.filterWidth,f=a.strideHeight,g=a.strideWidth,h=a.dilationHeight,i=a.dilationWidth,b=a.effectiveFilterHeight,c=a.effectiveFilterWidth,j=b-1-a.padInfo.top,k=c-1-a.padInfo.left;this.userCode="\n      const ivec2 pads = ivec2("+j+", "+k+");\n      const float avgMultiplier = float("+1/(d*e)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+b+";\n            wR += "+h+") {\n          float dyR = float(dyRCorner + wR) / "+f+".0;\n\n          if (dyR < 0.0 || dyR >= "+a.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+c+";\n            wC+= "+i+") {\n            float dyC = float(dyCCorner + wC) / "+g+".0;\n\n            if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function k9(a){this.variableNames=["dy"],this.outputShape=a.inShape;var e=a.filterDepth,f=a.filterHeight,g=a.filterWidth,h=a.strideDepth,i=a.strideHeight,j=a.strideWidth,k=a.dilationDepth,l=a.dilationHeight,m=a.dilationWidth,b=a.effectiveFilterDepth,c=a.effectiveFilterHeight,d=a.effectiveFilterWidth,n=b-1-a.padInfo.front,o=c-1-a.padInfo.top,p=d-1-a.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+n+", "+o+", "+p+");\n      const float avgMultiplier = float("+1/(e*f*g)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+b+";\n            wD += "+k+") {\n          float dyD = float(dyDCorner + wD) / "+h+".0;\n\n          if (dyD < 0.0 || dyD >= "+a.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+c+";\n              wR += "+l+") {\n            float dyR = float(dyRCorner + wR) / "+i+".0;\n\n            if (dyR < 0.0 || dyR >= "+a.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+d+";\n                wC += "+m+") {\n              float dyC = float(dyCCorner + wC) / "+j+".0;\n\n              if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function la(a,f,g,b,c,h){this.outputShape=[],this.variableNames=["x","mean","variance"],f5(a,f),f5(a,g);var d="0.0";null!=b&&(f5(a,b),this.variableNames.push("offset"),d="getOffsetAtOutCoords()");var e="1.0";null!=c&&(f5(a,c),this.variableNames.push("scale"),e="getScaleAtOutCoords()"),this.outputShape=a,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+d+";\n        float scale = "+e+";\n        float inv = scale * inversesqrt(variance + float("+h+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "}function lb(a,f,g,b,c,h){this.packedInputs=!0,this.packedOutput=!0,this.variableNames=["x","mean","variance"],f5(a,f),f5(a,g);var d="vec4(0.0)";null!=b&&(f5(a,b),this.variableNames.push("offset"),d="getOffsetAtOutCoords()");var e="vec4(1.0)";null!=c&&(f5(a,c),this.variableNames.push("scale"),e="getScaleAtOutCoords()"),this.outputShape=a,this.userCode="\n      void main() {\n        vec4 offset = "+d+";\n        vec4 scale = "+e+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+h+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "}function lc(a,b,c){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=f5(b,c),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+a+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "}function ld(a,b,c){this.variableNames=["A","B"],this.outputShape=f5(b,c),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+a+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "}function le(e,f,g,c){void 0===c&&(c=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=f5(f,g);var a=this.outputShape.length,b="";if(c){if(0===a||1===ec(this.outputShape))b="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(b="\n          "+k4(a)+" coords = getOutputCoords();\n        ",1===a)b+="\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ";else{var d=k$("coords",a);b+="\n            bool nextRowOutOfBounds =\n              ("+d[a-2]+" + 1) >= "+this.outputShape[a-2]+";\n            bool nextColOutOfBounds =\n              ("+d[a-1]+" + 1) >= "+this.outputShape[a-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          "}}this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+e+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+b+"\n\n        setOutput(result);\n      }\n    "}function lf(a){this.variableNames=["real","imag"],this.outputShape=a,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "}function lg(c){this.outputShape=[],this.outputShape=fG(c,1),this.variableNames=c.map(function(b,a){return"T"+a});var a=new Array(c.length-1);a[0]=c[0][1];for(var b=1;b<a.length;b++)a[b]=a[b-1]+c[b][1];var d=["if (yC < "+a[0]+") setOutput(getT0(yR, yC));"];for(b=1;b<a.length;b++){var e=a[b-1];d.push("else if (yC < "+a[b]+") setOutput(getT"+b+"(yR, yC-"+e+"));")}var f=a.length,g=a[a.length-1];d.push("else setOutput(getT"+f+"(yR, yC-"+g+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+d.join("\n        ")+"\n      }\n    "}function lh(g,i){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=fG(g,i);var h=this.outputShape,a=h.length,n=k4(a),b=k$("coords",a),f=["x","y","z","w","u","v"].slice(0,a);this.variableNames=g.map(function(b,a){return"T"+a});var c=new Array(g.length-1);c[0]=g[0][i];for(var d=1;d<c.length;d++)c[d]=c[d-1]+g[d][i];var e=f[i],j=f.slice(-2),o=f.join(),k="if ("+e+" < "+c[0]+") {\n        return getChannel(\n            getT0("+o+"), vec2("+j.join()+"));\n        }";for(d=1;d<c.length;d++){var l=c[d-1];k+="\n        if ("+e+" < "+c[d]+"  && "+e+" >= "+c[d-1]+") {\n          return getChannel(\n            getT"+d+"("+lr(f,e,l)+"),\n            vec2("+lr(j,e,l)+"));\n        }"}var p=c.length,m=c[c.length-1];k+="\n        return getChannel(\n          getT"+p+"("+lr(f,e,m)+"),\n          vec2("+lr(j,e,m)+"));",this.userCode="\n      float getValue("+f.map(function(a){return"int "+a})+") {\n        "+k+"\n      }\n\n      void main() {\n        "+n+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+b+"), 0., 0., 0.);\n\n        "+b[a-1]+" = "+b[a-1]+" + 1;\n        if ("+b[a-1]+" < "+h[a-1]+") {\n          result.g = getValue("+b+");\n        }\n\n        "+b[a-2]+" = "+b[a-2]+" + 1;\n        if ("+b[a-2]+" < "+h[a-2]+") {\n          result.a = getValue("+b+");\n        }\n\n        "+b[a-1]+" = "+b[a-1]+" - 1;\n        if ("+b[a-2]+" < "+h[a-2]+" &&\n            "+b[a-1]+" < "+h[a-1]+") {\n          result.b = getValue("+b+");\n        }\n        setOutput(result);\n      }\n    "}var li="return a + b;",lj="return a - b;",lk="return a * b;",ll="return (a < 0.) ? b * a : a;",lm="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",ln=(lq.prototype.getCustomSetupFunc=function(a,b){var c=this;return function(d,e){null==c.minLoc&&(c.minLoc=d.getUniformLocationNoThrow(e,"minVal"),c.maxLoc=d.getUniformLocationNoThrow(e,"maxVal")),d.gl.uniform1f(c.minLoc,a),d.gl.uniform1f(c.maxLoc,b)}},lq),lo=(lp.prototype.getCustomSetupFunc=function(a,b){var c=this;return function(d,e){null==c.minLoc&&(c.minLoc=d.getUniformLocationNoThrow(e,"minVal"),c.maxLoc=d.getUniformLocationNoThrow(e,"maxVal")),d.gl.uniform1f(c.minLoc,a),d.gl.uniform1f(c.maxLoc,b)}},lp);function lp(a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}function lq(a){this.variableNames=["A"],this.outputShape=a,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}function lr(a,b,c){var d=a.indexOf(b);return a.map(function(a,b){return b===d?a+" - "+c:a}).join()}function ls(a){this.variableNames=["x","dy"],this.outputShape=a.filterShape;var b=a.strideHeight,c=a.strideWidth,d=a.padInfo.top,e=a.padInfo.left,f="channelsLast"===a.dataFormat;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+a.batchSize+"; b++) {\n          for (int yR = 0; yR < "+a.outHeight+"; yR++) {\n            int xR = wR + yR * "+b+" - "+d+";\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+a.outWidth+"; yC++) {\n              int xC = wC + yC * "+c+" - "+e+";\n\n              if (xC < 0 || xC >= "+a.inWidth+") {\n                continue;\n              }\n\n              if ("+f+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function lt(a){this.variableNames=["dy","W"],this.outputShape=a.inShape;var c=a.filterHeight,d=a.filterWidth,e=a.strideHeight,f=a.strideWidth,b="channelsLast"===a.dataFormat,g=c-1-a.padInfo.top,h=d-1-a.padInfo.left;this.userCode="\n      const ivec2 pads = ivec2("+g+", "+h+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+(b?3:1)+"];\n\n        ivec2 dyCorner = ivec2(coords["+(b?1:2)+"], coords["+(b?2:3)+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+c+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+e+".0;\n\n          if (dyR < 0.0 || dyR >= "+a.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+c+" - 1 - wR;\n\n          for (int wC = 0; wC < "+d+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+f+".0;\n\n            if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+d+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+a.outChannels+"; d2++) {\n\n              if ("+b+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function lu(a){this.variableNames=["x","dy"],this.outputShape=a.filterShape;var b=a.strideDepth,c=a.strideHeight,d=a.strideWidth,e=a.padInfo.front,f=a.padInfo.top,g=a.padInfo.left;this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+a.batchSize+"; b++) {\n          for (int yF = 0; yF < "+a.outDepth+"; yF++) {\n            int xF = wF + yF * "+b+" - "+e+";\n\n            if (xF < 0 || xF >= "+a.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+a.outHeight+"; yR++) {\n              int xR = wR + yR * "+c+" - "+f+";\n\n              if (xR < 0 || xR >= "+a.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+a.outWidth+"; yC++) {\n                int xC = wC + yC * "+d+" - "+g+";\n\n                if (xC < 0 || xC >= "+a.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function lv(a){this.variableNames=["dy","W"],this.outputShape=a.inShape;var b=a.filterDepth,c=a.filterHeight,d=a.filterWidth,e=a.strideDepth,f=a.strideHeight,g=a.strideWidth,h=b-1-a.padInfo.front,i=c-1-a.padInfo.top,j=d-1-a.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+h+", "+i+", "+j+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+b+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+e+".0;\n\n          if (dyF < 0.0 || dyF >= "+a.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+b+" - 1 - wF;\n\n          for (int wR = 0; wR < "+c+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+f+".0;\n\n            if (dyR < 0.0 || dyR >= "+a.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+c+" - 1 - wR;\n\n            for (int wC = 0; wC < "+d+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+g+".0;\n\n              if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+d+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+a.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function lw(a){this.variableNames=["x","dy"],this.outputShape=a.filterShape;var b=a.strideHeight,c=a.strideWidth,d=a.padInfo.top,e=a.padInfo.left,f=a.outChannels/a.inChannels;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+f+" + dm;\n\n        float dotProd = 0.0;\n\n        // TO DO: Vec4 over the batch size\n        for (int b = 0; b < "+a.batchSize+"; b++) {\n          for (int yR = 0; yR < "+a.outHeight+"; yR++) {\n            int xR = wR + yR * "+b+" - "+d+";\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+a.outWidth+"; yC++) {\n              int xC = wC + yC * "+c+" - "+e+";\n\n              if (xC < 0 || xC >= "+a.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function lx(a){this.variableNames=["dy","W"],this.outputShape=a.inShape;var b=a.filterHeight,c=a.filterWidth,e=a.strideHeight,f=a.strideWidth,g=b-1-a.padInfo.top,h=c-1-a.padInfo.left,d=a.outChannels/a.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+g+", "+h+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+b+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+e+".0;\n\n          if (dyR < 0.0 || dyR >= "+a.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+b+" - 1 - wR;\n\n          for (int wC = 0; wC < "+c+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+f+".0;\n\n            if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+c+" - 1 - wC;\n\n            // TO DO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+d+"; dm++) {\n              int d2 = d1 * "+d+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function ly(b,e,d,f){void 0===e&&(e=!1),void 0===d&&(d=null),void 0===f&&(f=!1),this.variableNames=["x","W"],this.outputShape=b.outShape;var j=b.padInfo.top,k=b.padInfo.left,l=b.strideHeight,m=b.strideWidth,n=b.dilationHeight,o=b.dilationWidth,p=b.filterHeight,q=b.filterWidth,a=4*Math.floor(b.inChannels/4),g=b.inChannels%4,c="channelsLast"===b.dataFormat,r=c?1:2,s=c?2:3,t=c?3:1,h="",i="";d&&(h=f?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+d+"\n        }":"\n          float activation(float x) {\n            "+d+"\n          }\n        ",i="result = activation(result);"),e&&this.variableNames.push("bias"),f&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+h+"\n\n      const ivec2 strides = ivec2("+l+", "+m+");\n      const ivec2 pads = ivec2("+j+", "+k+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+t+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+r+"], coords["+s+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+p+"; wR++) {\n          int xR = xRCorner + wR * "+n+";\n\n          if (xR < 0 || xR >= "+b.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+q+"; wC++) {\n            int xC = xCCorner + wC * "+o+";\n\n            if (xC < 0 || xC >= "+b.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+a+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+c+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1==g)+") {\n\n              if ("+c+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+a+") *\n                    getW(wR, wC, "+a+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+a+", xR, xC) *\n                    getW(wR, wC, "+a+", d2);\n              }\n\n            } else if ("+(2==g)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+a+", d2),\n                getW(wR, wC, "+a+" + 1, d2)\n              );\n\n              if ("+c+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+a+"),\n                  getX(batch, xR, xC, "+a+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+a+", xR, xC),\n                  getX(batch, "+a+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3==g)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+a+", d2),\n                getW(wR, wC, "+a+" + 1, d2),\n                getW(wR, wC, "+a+" + 2, d2)\n              );\n\n              if ("+c+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+a+"),\n                  getX(batch, xR, xC, "+a+" + 1),\n                  getX(batch, xR, xC, "+a+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+a+", xR, xC),\n                  getX(batch, "+a+" + 1, xR, xC),\n                  getX(batch, "+a+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+(e?"result += getBiasAtOutCoords();":"")+"\n        "+i+"\n        setOutput(result);\n      }\n    "}function lz(a){this.variableNames=["x","W"],this.outputShape=a.outShape;var d=a.padInfo.front,e=a.padInfo.top,f=a.padInfo.left,g=a.strideDepth,h=a.strideHeight,i=a.strideWidth,j=a.dilationDepth,k=a.dilationHeight,l=a.dilationWidth,m=a.filterDepth,n=a.filterHeight,o=a.filterWidth,b=4*Math.floor(a.inChannels/4),c=a.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+g+", "+h+", "+i+");\n      const ivec3 pads = ivec3("+d+", "+e+", "+f+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+m+"; wF++) {\n          int xF = xFCorner + wF * "+j+";\n\n          if (xF < 0 || xF >= "+a.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+n+"; wR++) {\n            int xR = xRCorner + wR * "+k+";\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+o+"; wC++) {\n              int xC = xCCorner + wC * "+l+";\n\n              if (xC < 0 || xC >= "+a.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+b+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1==c)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+b+") *\n                  getW(wF, wR, wC, "+b+", d2);\n              } else if ("+(2==c)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+b+"),\n                  getX(batch, xF, xR, xC, "+b+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+b+", d2),\n                  getW(wF, wR, wC, "+b+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3==c)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+b+"),\n                  getX(batch, xF, xR, xC, "+b+" + 1),\n                  getX(batch, xF, xR, xC, "+b+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+b+", d2),\n                  getW(wF, wR, wC, "+b+" + 1, d2),\n                  getW(wF, wR, wC, "+b+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function lA(a,c,b,d){void 0===c&&(c=!1),void 0===b&&(b=null),void 0===d&&(d=!1),this.variableNames=["x","W"],this.outputShape=a.outShape;var h=a.inHeight,i=a.inWidth,j=a.padInfo.top,k=a.padInfo.left,l=a.strideHeight,m=a.strideWidth,n=a.dilationHeight,o=a.dilationWidth,p=a.filterHeight,q=a.filterWidth,e=a.outChannels/a.inChannels,f="",g="";b&&(f=d?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+b+"\n        }":"\n          float activation(float x) {\n            "+b+"\n          }\n        ",g="result = activation(result);"),c&&this.variableNames.push("bias"),d&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+f+"\n\n      const ivec2 strides = ivec2("+l+", "+m+");\n      const ivec2 pads = ivec2("+j+", "+k+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+e+";\n        int q = d2 - d1 * "+e+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+p+"; wR++) {\n          int xR = xRCorner + wR * "+n+";\n\n          if (xR < 0 || xR >= "+h+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+q+"; wC++) {\n            int xC = xCCorner + wC * "+o+";\n\n            if (xC < 0 || xC >= "+i+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n\n        float result = dotProd;\n        "+(c?"result += getBiasAtOutCoords();":"")+"\n        "+g+"\n        setOutput(result);\n      }\n    "}function lB(d,l,j,m){void 0===l&&(l=!1),void 0===j&&(j=null),void 0===m&&(m=!1),this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=d.outShape;for(var g=d.inHeight,e=d.inWidth,s=d.padInfo.top,h=d.padInfo.left,t=d.strideHeight,k=d.strideWidth,u=d.dilationHeight,i=d.dilationWidth,n=d.filterHeight,f=d.filterWidth,v=f,c="int xR; int xC; int xCOffset;",b=0;b<n;b++)for(var a=0;a<f;a++)c+="\n          vec4 xTexelR"+b+"C"+2*a+" = vec4(0.);\n          vec4 wR"+b+"C"+a+" = vec4(0.);\n          vec4 xR"+b+"C"+a+" = vec4(0.);";for(b=0;b<n;b++)for(var o=0;o<v;o++){if(c+="\n          xR = xRCorner + "+b*u+";\n          xC = xCCorner + "+(a=2*o)*i+";\n        ",1===k){if(a<f&&(c+=h%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+g+" && xCOffset >= 0 && xCOffset < "+e+") {\n                  xTexelR"+b+"C"+a+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+b+"C"+a+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+g+" && xCOffset >= 0 && xCOffset < "+e+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n                  xR"+b+"C"+a+" = vec4(previous.zw, xTexelR"+b+"C"+a+".xy);\n                } else {\n                  xR"+b+"C"+a+" = vec4(0, 0, xTexelR"+b+"C"+a+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+g+" && xC >= 0 && xC < "+e+") {\n                  xTexelR"+b+"C"+a+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+b+"C"+a+" = vec4(0.);\n                }\n\n                xR"+b+"C"+a+" = xTexelR"+b+"C"+a+";\n              ",a+1<f)){var p=h%2==0?d6(i):i;i%2==0&&h%2==1||i%2!=0&&h%2!=1?(c+="\n                  xCOffset = xC + "+h%2+" + "+p+";\n\n                  if(xR >= 0 && xR < "+g+" &&\n                    xCOffset >= 0 && xCOffset < "+e+") {\n                    xTexelR"+b+"C"+(a+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",1<i&&(c+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+g+" &&\n                      xCOffset >= 0 && xCOffset < "+e+") {\n                      xTexelR"+b+"C"+a+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+b+"C"+a+" = vec4(0.);\n                    }\n                  "),c+="\n                  xR"+b+"C"+(a+1)+" = vec4(\n                    xTexelR"+b+"C"+a+".zw, xTexelR"+b+"C"+(a+2)+".xy);\n                "):c+="\n                  xCOffset = xC + "+p+";\n\n                  if(xR >= 0 && xR < "+g+" &&\n                    xCOffset >= 0 && xCOffset < "+e+") {\n                    xTexelR"+b+"C"+(a+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+b+"C"+(a+1)+" = xTexelR"+b+"C"+(a+2)+";\n                "}}else a<f&&(c+="\n              if(xR >= 0 && xR < "+g+") {\n            ",h%2==1?(c+="\n                xCOffset = xC + 1 - "+k+";\n                if(xCOffset >= 0 && xCOffset < "+e+") {\n                  xTexelR"+b+"C"+a+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+b+"C"+a+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+e+") {\n                  xTexelR"+b+"C"+(a+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+b+"C"+(a+2)+" = vec4(0.);\n                }\n\n                xR"+b+"C"+a+" = vec4(\n                  xTexelR"+b+"C"+a+".zw, xTexelR"+b+"C"+(a+2)+".zw);\n              ",a+1<f&&(c+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+k+";\n                  if(xCOffset >= 0 && xCOffset < "+e+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+b+"C"+(a+1)+" = vec4(xTexelR"+b+"C"+(a+2)+".xy, final.xy);\n                ")):(c+="\n                if(xC >= 0 && xC < "+e+") {\n                  xTexelR"+b+"C"+a+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+b+"C"+a+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+k+";\n                if(xCOffset >= 0 && xCOffset < "+e+") {\n                  xTexelR"+b+"C"+(a+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+b+"C"+(a+2)+" = vec4(0.);\n                }\n\n                xR"+b+"C"+a+" = vec4(\n                  xTexelR"+b+"C"+a+".xy, xTexelR"+b+"C"+(a+2)+".xy);\n              ",a+1<f&&(c+="\n                  xR"+b+"C"+(a+1)+" = vec4(\n                    xTexelR"+b+"C"+a+".zw, xTexelR"+b+"C"+(a+2)+".zw);\n                ")),c+="}");a<f&&(c+="\n            vec4 wTexelR"+b+"C"+a+" = getW("+b+", "+a+", d1, q);\n            wR"+b+"C"+a+" = vec4(wTexelR"+b+"C"+a+".xz, wTexelR"+b+"C"+a+".xz);\n          ",a+1<f&&(c+="\n              vec4 wTexelR"+b+"C"+(a+1)+" = getW("+b+", "+(a+1)+", d1, q);\n              wR"+b+"C"+(a+1)+" =\n                vec4(wTexelR"+b+"C"+(a+1)+".xz, wTexelR"+b+"C"+(a+1)+".xz);"))}for(b=0;b<n;b++)for(a=0;a<f;a++)c+="dotProd += xR"+b+"C"+a+" * wR"+b+"C"+a+";";var q="",r="";j&&(q=m?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+j+"\n        }":"vec4 activation(vec4 x) {\n          "+j+"\n        }",r="result = activation(result);"),l&&this.variableNames.push("bias"),m&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+q+"\n\n      const ivec2 strides = ivec2("+t+", "+k+");\n      const ivec2 pads = ivec2("+s+", "+h+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 dotProd = vec4(0.);\n\n        "+c+"\n\n        vec4 result = dotProd;\n        "+(l?"result += getBiasAtOutCoords();":"")+"\n        "+r+"\n        setOutput(result);\n      }\n    "}function lC(a,m,h,n,i){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var o=a[0],j=a[1],k=a[2],p=a[3],q=m[0],b=h[0],c=h[1];this.outputShape=[q,b,c,p];var l=[j-1+".0",k-1+".0"],d=l[0],e=l[1],f=1<b?[""+(j-1)/(b-1),"(y2-y1) * height_ratio","y1*"+d+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+d],r=f[0],s=f[1],t=f[2],g=1<c?[""+(k-1)/(c-1),"(x2-x1) * width_ratio","x1*"+e+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+e],u=g[0],v=g[1],w=g[2];this.userCode="\n      const float height_ratio = float("+r+");\n      const float width_ratio = float("+u+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+o+") {\n          return;\n        }\n\n        float height_scale = "+s+";\n        float width_scale = "+v+";\n\n        float in_y = "+t+";\n        if( in_y < 0.0 || in_y > "+d+" ) {\n          setOutput(float("+i+"));\n          return;\n        }\n        float in_x = "+w+";\n        if( in_x < 0.0 || in_x > "+e+" ) {\n          setOutput(float("+i+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+("bilinear"===n?1:0)+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "}function lD(a,e,c){this.variableNames=["x"];var b=(this.outputShape=a).length,d=a[a.length-1];this.userCode="\n      int getIndex(int i) {\n        "+(c?"return "+d+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+k4(b)+" coords = getOutputCoords();\n        int end = "+lE(b,"coords")+";\n        float val = 0.0;\n        for (int i = "+d+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+(c?"<":">")+" end) {\n            continue;\n          }\n          if (idx == end && "+e+") {\n            continue;\n          }\n          "+lE(b,"coords")+" = idx;\n          val += getX("+function(c,a){if(1===b)return a;if(2===b)return a+".x, "+a+".y";if(3===b)return"coords.x, coords.y, coords.z";if(4===b)return"coords.x, coords.y, coords.z, coords.w";throw Error("Cumulative sum for rank "+b+" is not yet supported")}(0,"coords")+");\n        }\n        setOutput(val);\n      }\n    "}function lE(a,b){if(1===a)return""+b;if(2===a)return b+".y";if(3===a)return b+".z";if(4===a)return b+".w";throw Error("Cumulative sum for rank "+a+" is not yet supported")}function lF(a){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=ae.DENSE;var b=ka(a),c=k_();this.outputShape=a,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+k0(["r","c","d"],a)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+b[0]+", "+b[1]+"));\n        int index = 4 * (resTexRC.x * "+b[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+c.output+" = result;\n      }\n    "}function lG(a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=ae.DENSE;var b=ka(a),c=k_();this.outputShape=a,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+k0(["r","c","d"],a)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+b[0]+", "+b[1]+"));\n        int index = 4 * (resTexRC.x * "+b[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+c.output+" = result;\n      }\n    "}function lH(a){this.variableNames=["X"],this.outputShape=[a,a],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "}function lI(a){this.variableNames=["A"],this.outTexUsage=af.DOWNLOAD;var b=k_();this.outputShape=a,this.userCode="\n      "+k2+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+b.output+" = encode_float(x);\n      }\n    "}function lJ(a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=af.DOWNLOAD;var b=k_();this.outputShape=a,this.userCode="\n      "+k2+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+b.output+" = encode_float(x);\n      }\n    "}function lK(c,d,a){void 0===a&&(a=!1),this.variableNames=["A"];var e=k_(),g=d[0],b=d[1];this.outputShape=c;var f="result";a&&(f="floor(result * 255. + 0.5)"),this.userCode="\n      "+k1(c)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+b+";\n        int c = imod(flatIndex, "+b+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+b+".0, "+g+".0);\n        vec4 values = "+e.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+e.output+" = vec4("+f+", 0., 0., 0.);\n      }\n    "}function lL(c,g,e){void 0===e&&(e=!1),this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var h=k_(),k=g[0],f=g[1];this.outputShape=c;var i="",j="result";e&&(j="floor(result * 255. + 0.5)");for(var a=0;a<=1;a++)for(var b=0;b<=1;b++){var d=2*a+b;i+="\n          localCoords = coords;\n          if(localCoords[2] + "+b+" < "+c[2]+") {\n            localCoords[2] += "+b+";\n            if(localCoords[1] + "+a+" < "+c[1]+") {\n              localCoords[1] += "+a+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n\n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+f+";\n              c = imod(flatIndex, "+f+");\n              uv = (vec2(c, r) + halfCR) / vec2("+f+".0, "+k+".0);\n              values = "+h.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+d+"] = values[0];\n              } else if(offset == 1) {\n                result["+d+"] = values[1];\n              } else if(offset == 2) {\n                result["+d+"] = values[2];\n              } else {\n                result["+d+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+k1(c)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n\n        "+i+"\n\n        "+h.output+" = "+j+";\n      }\n    "}function lM(d,b,c){this.variableNames=["real","imag"];var a=b[1];this.outputShape=b;var e=c?"2.0 * "+Math.PI:"-2.0 * "+Math.PI,f=c?a+".0":"1.0";this.userCode="\n      const float exponentMultiplier = "+e+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+d+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+a+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+a+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+f+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "}function lN(b,d,c){this.variableNames=["A","indices"];var a=b.slice();a[c]=d,this.outputShape=a,this.rank=a.length;var e=k4(this.rank),f=function(d,f){var b=d.length;if(4<b)throw Error("Gather for rank "+b+" is not yet supported");if(1===b)return"int(getIndices(resRC))";for(var e=["resRC.x","resRC.y","resRC.z","resRC.w"],c=[],a=0;a<d.length;a++)a===f?c.push("int(getIndices("+e[a]+"))"):c.push(""+e[a]);return c.join()}(b,c);this.userCode="\n      void main() {\n        "+e+" resRC = getOutputCoords();\n        setOutput(getA("+f+"));\n      }\n    "}var lO=(lR.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},lR.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},lR.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},lR.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},lR.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},lR),lP=(lQ.prototype.getCustomSetupFunc=function(a){var b=this;return function(c,d){null==b.valueLoc&&(b.valueLoc=c.getUniformLocationNoThrow(d,"value")),c.gl.uniform1f(b.valueLoc,a)}},lQ);function lQ(a,b){this.outputShape=[],this.variableNames=["x"],this.outputShape=a,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}function lR(b,a,c){this.variableNames=["x"],this.outputShape=[],this.outputShape=b,this.blockSize=a,this.dataFormat=c,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+a+";\n      int offset_h = imod(h, "+a+");\n      int in_w = w / "+a+";\n      int offset_w = imod(w, "+a+");\n      int offset_d = (offset_h * "+a+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}function lS(d,a,b){this.sliceDim=d,this.strides=a,this.variableNames=["x","indices"],this.outputShape=b;var c=k4(a.length),e=k4(b.length),f=1<this.sliceDim?"strides[j]":"strides";this.userCode="\n        "+c+" strides = "+c+"("+this.strides+");\n         void main() {\n          "+e+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+f+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "}function gi(b,c){var a=k_();return eZ(b,c,a.version+"\n    precision highp float;\n    "+a.attribute+" vec3 clipSpacePos;\n    "+a.attribute+" vec2 uv;\n    "+a.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }")}function gj(a,b){return e2(a,b,new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]))}function gk(a,b){return e3(a,b,new Uint16Array([0,1,2,2,1,3]))}function lT(a,b,c,d,f,g,h){e5(c,d);var e=e4(a,b),i=a.TEXTURE_2D;return eV(a,b,function(){return a.bindTexture(i,e)}),eV(a,b,function(){return a.texParameteri(i,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE)}),eV(a,b,function(){return a.texParameteri(i,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)}),eV(a,b,function(){return a.texParameteri(i,a.TEXTURE_MIN_FILTER,a.NEAREST)}),eV(a,b,function(){return a.texParameteri(i,a.TEXTURE_MAG_FILTER,a.NEAREST)}),eV(a,b,function(){return a.texImage2D(i,0,f,c,d,0,g,h,null)}),eV(a,b,function(){return a.bindTexture(a.TEXTURE_2D,null)}),e}function gl(a,d,e,f,b){var c=j9(e,f);return lT(a,d,c[0],c[1],b.internalFormatFloat,b.textureFormatFloat,a.FLOAT)}function gm(c,d,e,f,a){var b=j9(e,f);return lT(c,d,b[0],b[1],a.internalFormatHalfFloat,a.textureFormatFloat,a.textureTypeHalfFloat)}function gn(a,c,d,e,f){var b=j9(d,e);return lT(a,c,b[0],b[1],a.RGBA,a.RGBA,a.UNSIGNED_BYTE)}function go(a,c,d,e,f){var b=kb(d,e);return lT(a,c,b[0],b[1],f.internalFormatPackedFloat,a.RGBA,a.FLOAT)}function gp(a,d,e,f,b){var c=kb(e,f);return lT(a,d,c[0],c[1],b.internalFormatPackedHalfFloat,a.RGBA,b.textureTypeHalfFloat)}function gq(a,b,c,d){return eV(a,b,function(){return a.bindBuffer(a.ARRAY_BUFFER,d)}),e7(a,b,c,"clipSpacePos",d,3,20,0)&&e7(a,b,c,"uv",d,2,20,12)}function gr(a,b,j,d,e,f,h){var c,g,i;eV(a,b,function(){return a.bindTexture(a.TEXTURE_2D,j)}),i=f instanceof Uint8Array?(c=new Uint8Array(d*e*4),g=a.UNSIGNED_BYTE,a.RGBA):(c=new Float32Array(d*e*4),g=a.FLOAT,h.internalFormatPackedFloat),c.set(f),eV(a,b,function(){return a.texImage2D(a.TEXTURE_2D,0,i,d,e,0,a.RGBA,g,c)}),eV(a,b,function(){return a.bindTexture(a.TEXTURE_2D,null)})}function gs(a,b,d,c){eV(a,b,function(){return a.bindTexture(a.TEXTURE_2D,d)}),c.data instanceof Uint8Array?eV(a,b,function(){return a.texImage2D(a.TEXTURE_2D,0,a.RGBA,c.width,c.height,0,a.RGBA,a.UNSIGNED_BYTE,c.data)}):eV(a,b,function(){return a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,c)}),eV(a,b,function(){return a.bindTexture(a.TEXTURE_2D,null)})}function gt(a,b,c,d,f){var e=a.createBuffer();eV(a,b,function(){return a.bindBuffer(a.PIXEL_PACK_BUFFER,e)});var g=16*c*d;return eV(a,b,function(){return a.bufferData(a.PIXEL_PACK_BUFFER,g,a.STREAM_READ)}),eV(a,b,function(){return a.readPixels(0,0,d,c,a.RGBA,a.FLOAT,0)}),eV(a,b,function(){return a.bindBuffer(a.PIXEL_PACK_BUFFER,null)}),e}function gu(c,d,e){var a=c,b=new Float32Array(e);return a.bindBuffer(a.PIXEL_PACK_BUFFER,d),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,b),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),b}function gv(d,e,a,b,g){var c=j9(a,b),h=c[0],i=c[1],f=new Uint8Array(a*b*4);return eV(d,e,function(){return d.readPixels(0,0,h,i,g.downloadTextureFormat,d.UNSIGNED_BYTE,f)}),new Float32Array(f.buffer)}function gw(d,e,h,i,j,f,g,k){var b,a=d,c=new Float32Array((b=kb(f,g))[0]*b[1]*4);return a.bindBuffer(a.PIXEL_PACK_BUFFER,e),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,c),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),c}function gx(a,b,c,d){var e=new Float32Array(c*d*4);return eV(a,b,function(){return a.readPixels(0,0,d,c,a.RGBA,a.FLOAT,e)}),e}var gy=Object.freeze({createVertexShader:gi,createVertexBuffer:gj,createIndexBuffer:gk,createFloat32MatrixTexture:gl,createFloat16MatrixTexture:gm,createUnsignedBytesMatrixTexture:gn,createPackedMatrixTexture:go,createFloat16PackedMatrixTexture:gp,bindVertexProgramAttributeStreams:gq,uploadDenseMatrixToTexture:gr,uploadPixelDataToTexture:gs,createBufferFromOutputTexture:gt,downloadFloat32MatrixFromBuffer:gu,downloadByteEncodedFloatMatrixFromOutputTexture:gv,downloadPackedMatrixFromBuffer:gw,downloadMatrixFromPackedOutputTexture:gx}),gz=(Object.defineProperty(lU.prototype,"debug",{get:function(){return i.getBool("DEBUG")},enumerable:!0,configurable:!0}),lU.prototype.dispose=function(){var b=this;if(!this.disposed){null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var a=this.gl;eV(a,this.debug,function(){return a.finish()}),eV(a,this.debug,function(){return a.bindFramebuffer(a.FRAMEBUFFER,null)}),eV(a,this.debug,function(){return a.deleteFramebuffer(b.framebuffer)}),eV(a,this.debug,function(){return a.bindBuffer(a.ARRAY_BUFFER,null)}),eV(a,this.debug,function(){return a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null)}),eV(a,this.debug,function(){return a.deleteBuffer(b.indexBuffer)}),this.disposed=!0}},lU.prototype.createFloat32MatrixTexture=function(a,b){return this.throwIfDisposed(),gl(this.gl,this.debug,a,b,this.textureConfig)},lU.prototype.createFloat16MatrixTexture=function(a,b){return this.throwIfDisposed(),gm(this.gl,this.debug,a,b,this.textureConfig)},lU.prototype.createUnsignedBytesMatrixTexture=function(a,b){return this.throwIfDisposed(),gn(this.gl,this.debug,a,b,this.textureConfig)},lU.prototype.uploadPixelDataToTexture=function(a,b){this.throwIfDisposed(),gs(this.gl,this.debug,a,b)},lU.prototype.uploadDenseMatrixToTexture=function(a,b,c,d){this.throwIfDisposed(),gr(this.gl,this.debug,a,b,c,d,this.textureConfig)},lU.prototype.createFloat16PackedMatrixTexture=function(a,b){return this.throwIfDisposed(),gp(this.gl,this.debug,a,b,this.textureConfig)},lU.prototype.createPackedMatrixTexture=function(a,b){return this.throwIfDisposed(),go(this.gl,this.debug,a,b,this.textureConfig)},lU.prototype.deleteMatrixTexture=function(a){var b=this;this.throwIfDisposed(),this.outputTexture===a&&(fd(this.gl,this.debug,this.framebuffer),this.outputTexture=null),eV(this.gl,this.debug,function(){return b.gl.deleteTexture(a)})},lU.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(a,b,c){var d=this;return this.downloadMatrixDriver(a,function(){return gv(d.gl,d.debug,b,c,d.textureConfig)})},lU.prototype.downloadPackedMatrixFromBuffer=function(a,d,e,f,b,c){return gw(this.gl,a,0,0,0,b,c,this.textureConfig)},lU.prototype.downloadFloat32MatrixFromBuffer=function(a,b){return gu(this.gl,a,b)},lU.prototype.createBufferFromTexture=function(a,b,c){this.bindTextureToFrameBuffer(a);var d=gt(this.gl,this.debug,b,c,this.textureConfig);return this.unbindTextureToFrameBuffer(),d},lU.prototype.createAndWaitForFence=function(){var a=this.createFence(this.gl);return this.pollFence(a)},lU.prototype.createFence=function(c){var a,b,f=this;if(i.getBool("WEBGL_FENCE_API_ENABLED")){var d=c,e=d.fenceSync(d.SYNC_GPU_COMMANDS_COMPLETE,0);c.flush(),b=function(){var a=d.clientWaitSync(e,0,0);return a===d.ALREADY_SIGNALED||a===d.CONDITION_SATISFIED},a=e}else b=0<i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?(a=this.beginQuery(),this.endQuery(),function(){return f.isQueryAvailable(a,i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):function(){return!0};return{query:a,isFencePassed:b}},lU.prototype.downloadMatrixFromPackedTexture=function(a,b,c){var d=this;return this.downloadMatrixDriver(a,function(){return gx(d.gl,d.debug,b,c)})},lU.prototype.createProgram=function(c){this.throwIfDisposed();var a=this.gl,d=e$(a,this.debug,c),e=gi(a,this.debug),b=e_(a,this.debug);return eV(a,this.debug,function(){return a.attachShader(b,e)}),eV(a,this.debug,function(){return a.attachShader(b,d)}),e0(a,this.debug,b),this.debug&&e1(a,this.debug,b),this.vertexAttrsAreBound||(this.setProgram(b),this.vertexAttrsAreBound=gq(a,this.debug,this.program,this.vertexBuffer)),b},lU.prototype.deleteProgram=function(a){var b=this;this.throwIfDisposed(),a===this.program&&(this.program=null),null!=a&&eV(this.gl,this.debug,function(){return b.gl.deleteProgram(a)})},lU.prototype.setProgram=function(a){var b=this;this.throwIfDisposed(),this.program=a,null!=this.program&&this.debug&&e1(this.gl,this.debug,this.program),eV(this.gl,this.debug,function(){return b.gl.useProgram(a)})},lU.prototype.getUniformLocation=function(b,c,a){return void 0===a&&(a=!0),this.throwIfDisposed(),a?e9(this.gl,this.debug,b,c):fa(this.gl,b,c)},lU.prototype.getAttributeLocation=function(a,b){var c=this;return this.throwIfDisposed(),eV(this.gl,this.debug,function(){return c.gl.getAttribLocation(a,b)})},lU.prototype.getUniformLocationNoThrow=function(a,b){return this.throwIfDisposed(),this.gl.getUniformLocation(a,b)},lU.prototype.setInputMatrixTexture=function(a,b,c){this.throwIfDisposed(),this.throwIfNoProgram(),fb(this.gl,this.debug,this.program,a,b,c)},lU.prototype.setOutputMatrixTexture=function(a,b,c){this.setOutputMatrixTextureDriver(a,c,b)},lU.prototype.setOutputPackedMatrixTexture=function(b,c,d){this.throwIfDisposed();var a=kb(c,d),e=a[0],f=a[1];this.setOutputMatrixTextureDriver(b,e,f)},lU.prototype.setOutputMatrixWriteRegion=function(a,b,c,d){this.setOutputMatrixWriteRegionDriver(c,a,d,b)},lU.prototype.setOutputPackedMatrixWriteRegion=function(a,b,c,d){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},lU.prototype.debugValidate=function(){null!=this.program&&e1(this.gl,this.debug,this.program),fe(this.gl)},lU.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var a=this.gl;this.debug&&this.debugValidate(),eV(a,this.debug,function(){return a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,0)})},lU.prototype.blockUntilAllProgramsCompleted=function(){var a=this;this.throwIfDisposed(),eV(this.gl,this.debug,function(){return a.gl.finish()})},lU.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=eY(this.gl,this.debug,2===i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},lU.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},lU.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},lU.prototype.beginQuery=function(){if(2===i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var b=this.gl,e=this.getQueryTimerExtensionWebGL2(),c=b.createQuery();return b.beginQuery(e.TIME_ELAPSED_EXT,c),c}var a=this.getQueryTimerExtensionWebGL1(),d=a.createQueryEXT();return a.beginQueryEXT(a.TIME_ELAPSED_EXT,d),d},lU.prototype.endQuery=function(){if(2!==i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var a=this.getQueryTimerExtensionWebGL1();a.endQueryEXT(a.TIME_ELAPSED_EXT)}else{var b=this.gl,c=this.getQueryTimerExtensionWebGL2();b.endQuery(c.TIME_ELAPSED_EXT)}},lU.prototype.waitForQueryAndGetTime=function(a){return jL(this,void 0,void 0,function(){var b=this;return jM(this,function(c){switch(c.label){case 0:return[4,ei(function(){return b.disposed||b.isQueryAvailable(a,i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return c.sent(),[2,this.getQueryTime(a,i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},lU.prototype.getQueryTime=function(a,b){if(0===b)return null;if(2===b){var c=this.gl;return c.getQueryParameter(a,c.QUERY_RESULT)/1e6}var d=this.getQueryTimerExtensionWebGL1();return d.getQueryObjectEXT(a,d.QUERY_RESULT_EXT)/1e6},lU.prototype.isQueryAvailable=function(a,b){if(0===b)return!0;if(2!==b)return e=(d=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(a,d.QUERY_RESULT_AVAILABLE_EXT),null==this.disjoint&&(this.disjoint=this.gl.getParameter(d.GPU_DISJOINT_EXT)),e&&!this.disjoint;var c=this.gl,d=this.getQueryTimerExtensionWebGL2(),e=c.getQueryParameter(a,c.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(d.GPU_DISJOINT_EXT)),e&&!this.disjoint},lU.prototype.pollFence=function(a){var b=this;return new Promise(function(c){b.addItemToPoll(function(){return a.isFencePassed()},function(){return c()})})},lU.prototype.pollItems=function(){for(var b=function(b){for(var a=0;a<b.length&&b[a]();++a);return a-1}(this.itemsToPoll.map(function(a){return a.isDoneFn})),a=0;a<=b;++a)(0,this.itemsToPoll[a].resolveFn)();this.itemsToPoll=this.itemsToPoll.slice(b+1)},lU.prototype.addItemToPoll=function(a,b){var c=this;this.itemsToPoll.push({isDoneFn:a,resolveFn:b}),1<this.itemsToPoll.length||ei(function(){return c.pollItems(),0===c.itemsToPoll.length})},lU.prototype.bindTextureToFrameBuffer=function(a){this.throwIfDisposed(),fc(this.gl,this.debug,a,this.framebuffer),this.debug&&fe(this.gl)},lU.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(fc(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&fe(this.gl)):fd(this.gl,this.debug,this.framebuffer)},lU.prototype.downloadMatrixDriver=function(a,b){this.bindTextureToFrameBuffer(a);var c=b();return this.unbindTextureToFrameBuffer(),c},lU.prototype.setOutputMatrixTextureDriver=function(b,c,d){this.throwIfDisposed();var a=this.gl;fc(a,this.debug,b,this.framebuffer),this.debug&&fe(a),this.outputTexture=b,eV(a,this.debug,function(){return a.viewport(0,0,c,d)}),eV(a,this.debug,function(){return a.scissor(0,0,c,d)})},lU.prototype.setOutputMatrixWriteRegionDriver=function(a,b,c,d){var e=this;this.throwIfDisposed(),eV(this.gl,this.debug,function(){return e.gl.scissor(a,b,c,d)})},lU.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},lU.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},lU);function lU(b){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var c=i.getNumber("WEBGL_VERSION");null!=b?eU(c,this.gl=b):this.gl=j8(c);var a="WEBGL_color_buffer_float";if(1===i.getNumber("WEBGL_VERSION")){if(this.textureFloatExtension=eY(this.gl,this.debug,"OES_texture_float"),fo(this.gl,"OES_texture_half_float"))this.textureHalfFloatExtension=eY(this.gl,this.debug,"OES_texture_half_float");else if(i.get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(a),fo(this.gl,"EXT_color_buffer_half_float"))this.colorBufferHalfFloatExtension=eY(this.gl,this.debug,"EXT_color_buffer_half_float");else if(i.get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(a="EXT_color_buffer_float",fo(this.gl,a))this.colorBufferFloatExtension=this.gl.getExtension(a);else{if(!fo(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}this.vertexBuffer=gj(this.gl,this.debug),this.indexBuffer=gk(this.gl,this.debug),this.framebuffer=e6(this.gl,this.debug),this.textureConfig=kc(this.gl,this.textureHalfFloatExtension)}function lV(a,b){if(a.length!==b.length)throw Error("Binary was compiled with "+a.length+" inputs, but was executed with "+b.length+" inputs");a.forEach(function(c,h){var d=c.logicalShape,a=b[h],e=a.shape;if(!ed(d,e))throw Error("Binary was compiled with different shapes than the current args. Shapes "+d+" and "+e+" must match");if(!c.isUniform||!a.isUniform){var f=c.texShape,g=a.isUniform?null:a.texData.texShape;if(!ed(f,g))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+f+" and "+g+" must match")}})}function lW(d,g,a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=d;for(var l=a.filterWidth,e=a.inChannels,m=a.strideWidth,n=a.strideHeight,h=a.padInfo,i=a.outWidth,o=a.dilationWidth,p=a.dilationHeight,q=a.dataFormat,r=h.left,s=h.top,j=e*l,t=k_(),f="channelsLast"===q,u=f?0:1,v=f?1:2,k="",b=0;b<=1;b++)for(var c=0;c<=1;c++)k+="\n          blockIndex = rc.y + "+c+";\n          pos = rc.x + "+b+";\n\n          if(blockIndex < "+d[1]+" && pos < "+d[0]+") {\n            offsetY = int(blockIndex / ("+i+")) * "+n+" - "+s+";\n            d0 = offsetY + "+p+" * (pos / "+j+");\n\n            if(d0 < "+g[u]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+i+".) * "+m+". - "+r+".);\n              d1 = offsetX + "+o+" * (int(mod(float(pos), "+j+".) / "+e+".));\n\n              if(d1 < "+g[v]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+e+".));\n\n                if ("+f+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*b+c)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*b+c)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+k+"\n\n        "+t.output+" = result;\n      }\n    "}function lX(c,f,g,h,a){this.variableNames=["x"],this.outputShape=[];var d,e=f,i=c[3]-1;this.outputShape=c;var b="float("+g+") + float("+h+") * sum";d=.5===a?"inversesqrt("+b+")":1===a?"1.0/("+b+")":"exp(log("+b+") * float(-"+a+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+e+"; j <= "+e+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+i+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+d+";\n        setOutput(val);\n      }\n    "}function lY(d,a,e,b,c){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=d,this.depth=d[3],this.depthRadius=a,this.bias=e,this.alpha=b,this.beta=c,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+a+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+a+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+b+") * norm + float("+e+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+b+")\n                * float("+c+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+c+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "}function lZ(d,f,g,h,a){this.variableNames=["x"],this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0;var e,b=f,i=d[3]-1;this.outputShape=d;var c="float("+g+") + float("+h+") * sum";e=.5===a?"inversesqrt("+c+")":1===a?"1.0/("+c+")":"exp(log("+c+") * float(-"+a+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+b+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+b+"; j <= "+b+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+i+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+e+";\n        setOutput(result);\n      }\n    "}function l$(a){this.variableNames=["dy","maxPos"],this.outputShape=a.inShape;var d=a.strideHeight,e=a.strideWidth,f=a.dilationHeight,c=a.effectiveFilterHeight,b=a.effectiveFilterWidth,g=c-1-a.padInfo.top,h=b-1-a.padInfo.left;this.userCode="\n      const ivec2 pads = ivec2("+g+", "+h+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+c+";\n          wR += "+f+") {\n          float dyR = float(dyRCorner + wR) / "+d+".0;\n\n          if (dyR < 0.0 || dyR >= "+a.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+b+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+e+".0;\n\n            if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+(c*b-1)+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+b+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function l_(a){this.variableNames=["dy","maxPos"],this.outputShape=a.inShape;var e=a.strideDepth,f=a.strideHeight,g=a.strideWidth,h=a.dilationDepth,i=a.dilationHeight,j=a.dilationWidth,d=a.effectiveFilterDepth,c=a.effectiveFilterHeight,b=a.effectiveFilterWidth,k=d-1-a.padInfo.front,l=c-1-a.padInfo.top,m=b-1-a.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+k+", "+l+", "+m+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+d+";\n           wD += "+h+") {\n          float dyD = float(dyDCorner + wD) / "+e+".0;\n\n          if (dyD < 0.0 || dyD >= "+a.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+c+";\n              wR += "+i+") {\n            float dyR = float(dyRCorner + wR) / "+f+".0;\n\n            if (dyR < 0.0 || dyR >= "+a.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+b+";\n                wC += "+j+") {\n              float dyC = float(dyCCorner + wC) / "+g+".0;\n\n              if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+(d*c*b-1)+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+c+" * "+b+" +\n                  wR * "+b+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function l0(f,l,a,c,d,b,e){void 0===a&&(a=!1),void 0===c&&(c=!1),void 0===d&&(d=!1),void 0===b&&(b=null),void 0===e&&(e=!1),this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=l;var g=Math.ceil((a?f[1]:f[2])/2),m=a?"i * 2, rc.y":"rc.y, i * 2",h=a?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],i=c?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],j="",k="";b&&(j=e?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+b+"\n        }":"vec4 activation(vec4 x) {\n          "+b+"\n        }",k="result = activation(result);"),d&&this.variableNames.push("bias"),e&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+j+"\n\n      const float sharedDimension = "+g+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+g+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+m+");\n          vec4 b = getMatrixB(rc.x, "+(c?"rc.z, i * 2":"i * 2, rc.z")+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+h[0]+" * "+i[0]+");\n          result += ("+h[1]+" * "+i[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+(d?"result += getBiasAtOutCoords();":"")+"\n\n        "+k+"\n\n        setOutput(result);\n      }\n    "}function l1(a,b,c,d){this.variableNames=["indices"],this.outputShape=[a,b],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+d+"), float("+c+"),\n                      float(index == coords.y)));\n      }\n    "}function l2(a){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var d,e,f,b,c=(this.outputShape=a).length;if(0===c)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{var g=k$("rc",c),h=k4(c),i=function(b,d,e){if(1===b)return"rc > "+d[0];for(var c="",a=b-2;a<b;a++)c+=e[a]+" >= "+d[a],a<b-1&&(c+="||");return c}(c,a,g),j=function(b,c,d){if(1===b)return"";var a=g.slice(-2);return"\n    int r = "+a[0]+";\n    int c = "+a[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+c+";\n    bool rEdge = rp1 >= "+d+";\n  "}(c,a[a.length-1],a[a.length-2]),k=(e=g,b=function(g,e){for(var f=[],a=0;a<=1;a++)for(var b=0;b<=1;b++){for(var c=(0===a?"r":"rp1")+", "+(0===b?"c":"cp1"),d=2;d<g;d++)c=e[e.length-1-d]+","+c;f.push(c)}return f}(f=(d=a).length,e),1===f?"getA(rc),\n            rc + 1 >= "+d[0]+" ? 0. : getA(rc + 1),\n            0, 0":"getA("+b[0]+"),\n          cEdge ? 0. : getA("+b[1]+"),\n          rEdge ? 0. : getA("+b[2]+"),\n          rEdge || cEdge ? 0. : getA("+b[3]+")");this.userCode="\n        void main() {\n          "+h+" rc = getOutputCoords();\n\n          if("+i+") {\n            setOutput(vec4(0));\n          } else {\n            "+j+"\n\n            setOutput(vec4("+k+"));\n          }\n        }\n      "}}var l3=(l4.prototype.getCustomSetupFunc=function(a){var b=this;return function(c,d){null==b.seedLoc&&(b.seedLoc=c.getUniformLocation(d,"seed")),c.gl.uniform1f(b.seedLoc,a)}},l4);function l4(b,a,c){this.variableNames=["probs"],this.outputShape=[b,c],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(a-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(a-1)+"));\n      }\n    "}function l5(g,b,d){this.variableNames=["x"],this.outputShape=b.map(function(a,b){return a[0]+g[b]+a[1]});var c=g.length,a=k4(c),e=b.map(function(a){return a[0]}).join(","),f=b.map(function(a,b){return a[0]+g[b]}).join(","),h=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,c);this.userCode=1!==c?"\n      "+a+" start = "+a+"("+e+");\n      "+a+" end = "+a+"("+f+");\n\n      void main() {\n        "+a+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+d+"));\n        } else {\n          "+a+" coords = outC - start;\n          setOutput(getX("+h+"));\n        }\n      }\n    ":"\n        int start = "+e+";\n        int end = "+f+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+d+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "}function l6(i,e,j){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e.map(function(a,b){return a[0]+i[b]+a[1]});for(var a=i.length,b=k4(a),k=e.map(function(a){return a[0]}).join(","),l=e.map(function(a,b){return a[0]+i[b]}).join(","),c=k$("rc",a),g=k$("source",a),h=c[a-1]+" < "+this.outputShape[a-1],m=1===a?"source":"vec2("+g.slice(-2).join()+")",n=[b+" rc = outputLoc;",c[a-1]+" += 1;\n       if("+h+") {\n      ",1===a?"":"}\n       rc = outputLoc;\n       "+c[a-2]+" += 1;\n       if("+c[a-2]+" < "+this.outputShape[a-2]+") {",1===a?"":"  "+c[a-1]+" += 1;\n         if("+h+") {"],o=1===a?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",f="",d=0,p=1===a?2:4;d<p;d++)f+="\n        "+n[d]+"\n        if ("+o+") {\n          result["+d+"] = float("+j+");\n        } else {\n          "+b+" source = rc - start;\n          result["+d+"] = getChannel(getX("+g.join()+"), "+m+");\n        }\n      ";f+=1===a?"} ":"}}",this.userCode="\n      const "+b+" start = "+b+"("+k+");\n      const "+b+" end = "+b+"("+l+");\n\n      void main() {\n        "+b+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+f+"\n        setOutput(result);\n      }\n    "}function l7(a,c,g){if(this.variableNames=["x"],"avg"===c&&g)throw new Error("Cannot compute positions for average pool.");var h=a.filterWidth,i=a.strideHeight,j=a.strideWidth,k=a.dilationHeight,b=a.dilationWidth,l=a.effectiveFilterHeight,m=a.effectiveFilterWidth,n=a.padInfo.top,o=a.padInfo.left;this.outputShape=a.outShape;var p="avg"===c,e="0.0";if(p||(e="-1.0 / 1e-20"),g)this.userCode="\n        const ivec2 strides = ivec2("+i+", "+j+");\n        const ivec2 pads = ivec2("+n+", "+o+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+l+";\n              wR += "+k+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+m+";\n                wC += "+b+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+a.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+m+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var q=c+"("+c+"("+c+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===c&&(q="avgValue / count");var r=4*Math.floor(h/4),f=h%4,d="\n      if ("+p+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+i+", "+j+");\n      const ivec2 pads = ivec2("+n+", "+o+");\n      const float initializationValue = "+e+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+a.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+e+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+l+";\n            wR += "+k+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+a.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+r+"; wC += 4) {\n            int xC = xCCorner + wC * "+b+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+b+", d),\n              getValue(batch, xR, xC + 2 * "+b+", d),\n              getValue(batch, xR, xC + 3 * "+b+", d)\n            );\n\n            "+d+"\n          }\n\n          int xC = xCCorner + "+r+";\n          if ("+(1==f)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+d+"\n          } else if ("+(2==f)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+b+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+d+"\n          } else if ("+(3==f)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+b+", d),\n              getValue(batch, xR, xC + 2 * "+b+", d),\n              initializationValue\n            );\n\n            "+d+"\n          }\n        }\n        setOutput("+q+");\n      }\n    "}}function l8(a,c,i){if(this.variableNames=["x"],"avg"===c&&i)throw new Error("Cannot compute positions for average pool.");var j=a.filterWidth,k=a.strideDepth,l=a.strideHeight,m=a.strideWidth,n=a.dilationDepth,o=a.dilationHeight,b=a.dilationWidth,p=a.effectiveFilterDepth,e=a.effectiveFilterHeight,f=a.effectiveFilterWidth,q=a.padInfo.front,r=a.padInfo.top,s=a.padInfo.left;this.outputShape=a.outShape;var t="avg"===c,g="0.0";if(t||(g="-1.0 / 1e-20"),i)this.userCode="\n        const ivec3 strides =\n            ivec3("+k+", "+l+", "+m+");\n        const ivec3 pads = ivec3("+q+", "+r+", "+s+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+p+";\n              wD += "+n+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+a.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+e+";\n                wR += "+o+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+a.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+f+";\n                  wC += "+b+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+a.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+e+" * "+f+" +\n                      wR * "+f+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var u=c+"("+c+"("+c+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===c&&(u="avgValue / count");var v=4*Math.floor(j/4),h=j%4,d="\n      if ("+t+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec3 strides =\n        ivec3("+k+", "+l+", "+m+");\n      const ivec3 pads = ivec3("+q+", "+r+", "+s+");\n      const float initializationValue = "+g+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+a.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+g+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+p+";\n            wD += "+n+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+a.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+e+";\n            wR += "+o+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+v+"; wC += 4) {\n              int xC = xCCorner + wC * "+b+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+b+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+b+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+b+", ch)\n              );\n\n              "+d+"\n            }\n\n            int xC = xCCorner + "+v+";\n            if ("+(1==h)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+d+"\n            } else if ("+(2==h)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+b+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+d+"\n            } else if ("+(3==h)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+b+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+b+", ch),\n                initializationValue\n              );\n\n              "+d+"\n            }\n          }\n          setOutput("+u+");\n        }\n      }\n    "}}function l9(g,a){this.variableNames=["x"];var e=g.windowSize,m=g.batchSize,h=g.inSize,n=Math.ceil(h/e);this.outputShape=[m,n];var c="0.0",i="";"prod"===a?c="1.0":"min"===a?(c="1.0 / 1e-20",i="min"):"max"===a&&(c="-1.0 / 1e-20",i="max");var f=a+"("+a+"("+a+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===a?f="sumValue":"prod"===a?f="prodValue":"all"===a?f="allValue":"any"===a&&(f="anyValue");var k=4*Math.floor(e/4),j=e%4,d="\n      if ("+("sum"===a)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===a)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+i+"(values, minMaxValue);\n      }\n    ",b="vec4";"all"===a?(c="1.0",d="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",b="bvec4"):"any"===a&&(c="0.0",d="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",b="bvec4");var l="";0<h%e&&(l="\n        if (inIdx < 0 || inIdx >= "+h+") {\n          return initializationValue;\n        }\n      "),this.userCode="\n      const float initializationValue = "+c+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+l+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+e+";\n\n        vec4 minMaxValue = vec4("+c+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+k+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+b+" values = "+b+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+d+"\n        }\n\n        int inIdx = inOffset + "+k+";\n        if ("+(1==j)+") {\n          "+b+" values = "+b+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+d+"\n        } else if ("+(2==j)+") {\n          "+b+" values = "+b+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+d+"\n        } else if ("+(3==j)+") {\n          "+b+" values = "+b+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+d+"\n        }\n        setOutput("+f+");\n      }\n    "}function ma(b,e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=b;for(var d="",a=0;a<4;a++){var c="thisRC = rc;";a%2==1&&(c+="thisRC.z += 1;"),1<a&&(c+="thisRC.y += 1;"),d+="\n        "+c+"\n        "+(0<a?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+a+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(0<a?"}":"")+"\n      "}this.userCode="\n      \n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+k0(["r","c","d"],e)+"\n      return ivec3(r, c, d);\n    }\n  \n      "+k1(b)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+b[1]+";\n        int cols = "+b[2]+";\n\n        "+d+"\n\n        setOutput(result);\n      }\n    "}function mb(o,f,c){this.variableNames=["dy"],this.outputShape=[],this.outputShape=f.shape;var g=f.shape,d=g[1],e=g[2],h=o.shape,a=h[1],b=h[2],i=[c&&1<a?d-1:d,c&&1<b?e-1:e],j=[c&&1<a?a-1:a,c&&1<b?b-1:b],k=i[0]/j[0],l=i[1]/j[1],m=1/k,n=1/l,p=2*Math.ceil(m)+2,q=2*Math.ceil(n)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+k+");\n        const float widthScale = float("+l+");\n\n        const float invHeightScale = float("+m+");\n        const float invWidthScale = float("+n+");\n\n        const int winHeight = int("+p+");\n        const int winWidth = int("+q+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+a+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+b+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(d-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(e-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "}function mc(c,a,b,d){this.variableNames=["A"],this.outputShape=[];var i=c[0],e=c[1],f=c[2],j=c[3];this.outputShape=[i,a,b,j];var g=[d&&1<a?e-1:e,d&&1<b?f-1:f],h=[d&&1<a?a-1:a,d&&1<b?b-1:b];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+g[0]/h[0]+",\n          "+g[1]/h[1]+");\n      const vec2 inputShapeRC = vec2("+e+".0, "+f+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "}function md(c,b,a,d){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];var j=c[0],f=c[1],e=c[2],i=c[3];this.outputShape=[j,b,a,i];var g=[d&&1<b?f-1:f,d&&1<a?e-1:e],h=[d&&1<b?b-1:b,d&&1<a?a-1:a];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+g[0]/h[0]+",\n          "+g[1]/h[1]+",\n          "+g[1]/h[1]+");\n      const vec3 inputShapeRC = vec3("+f+".0, "+e+".0,\n                                     "+e+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(i-1)+";\n        bool hasNextRow = coords.z < "+(a-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "}function me(o,h,a){this.variableNames=["dy"],this.outputShape=[],this.outputShape=h.shape;var i=h.shape,f=i[1],g=i[2],j=o.shape,b=j[1],c=j[2],d=[a&&1<b?f-1:f,a&&1<c?g-1:g],e=[a&&1<b?b-1:b,a&&1<c?c-1:c],k=d[0]/e[0],l=d[1]/e[1],m=1/k,n=1/l,p=2*Math.ceil(m)+2,q=2*Math.ceil(n)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+k+");\n        const float widthScale = float("+l+");\n\n        const float invHeightScale = float("+m+");\n        const float invWidthScale = float("+n+");\n\n        const int winHeight = int("+p+");\n        const int winWidth = int("+q+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+b+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+c+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+d[0]+") *\n                (float(dyR) / float("+e[0]+"));\n\n            float sourceFracCol =\n                float("+d[1]+") *\n                  (float(dyC) / float("+e[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+f+") - 1),\n                "+a+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+g+") - 1),\n                "+a+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "}function mf(d,a,b,c){this.variableNames=["A"],this.outputShape=[];var i=d[0],e=d[1],f=d[2],j=d[3];this.outputShape=[i,a,b,j];var g=[c&&1<a?e-1:e,c&&1<b?f-1:f],h=[c&&1<a?a-1:a,c&&1<b?b-1:b];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+g[0]/h[0]+",\n          "+g[1]/h[1]+");\n      const vec2 inputShapeRC = vec2("+e+".0, "+f+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+(c?"0.5":"0.0")+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "}function mg(a,e){this.variableNames=["x"];var b=a.length;if(4<b)throw new Error("WebGL backend: Reverse of rank-"+b+" tensor is not yet supported");if(this.outputShape=a,1!==b){var c=a.map(function(d,c){var b;return b=c,-1!==e.indexOf(b)&&1!==a[b]?a[b]+" - coords["+b+"] - 1":"coords["+b+"]"}).join(","),d=k4(b);this.userCode="\n      void main() {\n        "+d+" coords = getOutputCoords();\n        setOutput(getX("+c+"));\n      }\n    "}else this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+a[0]+" - coord - 1));\n        }\n      "}function mh(b,k){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0;var a=b.length;if(4<a)throw new Error("WebGL backend: Reverse of rank-"+a+" tensor is not yet supported");this.outputShape=b;var d,f,g,c=k$("rc",a),h=c[a-1]+" + 1 < "+this.outputShape[a-1],i=c[a-2]+" + 1 < "+this.outputShape[a-2],j=k4(a);function e(c){var a=b.map(function(f,e){var a,d;return a=e,d=c,-1!==k.indexOf(a)&&1!==b[a]?b[a]+" - "+d[a]+" - 1":""+d[a]});return"getChannel(getX("+a.join(",")+"), vec2("+a.slice(-2).join(",")+"))"}this.userCode=1===a?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+b[0]+" - rc - 1),\n            "+b[0]+" - rc - 1);\n          if("+h+"){\n              result.g = getChannel(getX("+b[0]+" - (rc  + 1) - 1),\n                "+b[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+j+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+e(c.slice())+";\n          if("+h+"){\n            result.g = "+((g=c.slice())[a-1]="("+g[a-1]+" + 1)",e(g))+";\n          }\n          if("+i+") {\n            result.b = "+((f=c.slice())[a-2]="("+f[a-2]+" + 1)",e(f))+";\n            if("+h+") {\n              result.a = "+((d=c.slice())[a-1]="("+d[a-1]+" + 1)",d[a-2]="("+d[a-2]+" + 1)",e(d))+";\n            }\n          }\n          setOutput(result);\n        }\n    "}function mi(i,c,d,e,f,g,k){this.variableNames=["updates","indices","defaultValue"],this.outputShape=g;var h=k4(f.length),j=k4(g.length),a="";1===d?a="i":2===d&&(a="i, j");var b="";1===e?b="i":2===e&&(b="i, coords[1]"),this.userCode="\n        "+h+" strides = "+h+"("+f+");\n\n        void main() {\n          "+j+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+i+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+c+"; j++) {\n              int index = round("+("getIndices("+a+")")+");\n              flattenedIndex += index * "+(1<c?"strides[j]":"strides")+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += "+("getUpdates("+b+")")+";\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "}function mj(c,l){this.variableNames=["x","segmentIds"];var a=c.windowSize,j=c.batchSize,b=c.inSize,e=c.numSegments,k=e*Math.ceil(b/a);this.outputShape=[j,k];var g=4*Math.floor(a/4),f=a%4,d="\n        sumValue += dot(values, segFilter);\n    ",h="";0<b%a&&(h="\n        if (inIdx < 0 || inIdx >= "+b+") {\n          return initializationValue;\n        }\n      ");var i="";0<b%a&&(i="\n        if (inIdx < 0 || inIdx >= "+b+") {\n          return -1.0;\n        }\n      "),this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+h+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+i+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+e+")) * float("+a+"));\n        int currentSeg = int(mod(float(outIdx), float("+e+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+g+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+d+"\n        }\n\n        int inIdx = inOffset + "+g+";\n        if ("+(1==f)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+d+"\n        } else if ("+(2==f)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+d+"\n        } else if ("+(3==f)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+d+"\n        }\n        setOutput(sumValue);\n      }\n    "}function mk(i,d,b){if(this.variableNames=["c","a","b"],this.outputShape=d,4<b)throw Error("Where for rank "+b+" is not yet supported");if(1===b)e=c="resRC";else{for(var e,c,f=["resRC.x","resRC.y","resRC.z","resRC.w"],g=[],h=[],a=0;a<d.length;a++)h.push(""+f[a]),a<i&&g.push(""+f[a]);e=g.join(),c=h.join()}var j=k4(b);this.userCode="\n      void main() {\n        "+j+" resRC = getOutputCoords();\n        float cVal = getC("+e+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+c+"));\n        } else {\n          setOutput(getB("+c+"));\n        }\n      }\n    "}var ml=(mn.prototype.getCustomSetupFunc=function(a){var b=this;if(a.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+a.length+")");return function(c,d){null==b.startLoc&&(b.startLoc=c.getUniformLocationNoThrow(d,"start"),null==b.startLoc)||c.gl.uniform1iv(b.startLoc,a)}},mn),mm=["x","y","z","w","u","v"];function mn(a){this.variableNames=["source"],this.outputShape=a,this.rank=a.length;var b,c=k4(this.rank),d="uniform int start["+this.rank+"];",e=function(a){if(1===a)return"sourceLoc";if(a<=6)return mm.slice(0,a).map(function(a){return"sourceLoc."+a}).join(",");throw Error("Slicing for rank "+a+" is not yet supported")}(this.rank);b="\n        "+c+" sourceLoc;\n        "+c+" coords = getOutputCoords();\n        "+a.map(function(b,a){return"sourceLoc."+mm[a]+" = start["+a+"] + coords."+mm[a]+";"}).join("\n")+"\n      ",this.userCode="\n      "+d+"\n      void main() {\n        "+b+"\n        setOutput(getSource("+e+"));\n      }\n    "}function mo(d,e,a){this.variableNames=["x"];var f=(this.outputShape=a).length,b=k4(a.length),g=k4(a.length),c="";if(1===f)c="coords * strides + begin";else{var h=0;c=a.map(function(c,b){return h++,1===a.length?"coords * strides["+b+"] + begin["+b+"]":"coords["+(h-1)+"] * strides["+b+"] + begin["+b+"]"}).join(",")}this.userCode="\n      "+b+" begin = "+b+"("+d+");\n      "+b+" strides = "+b+"("+e+");\n\n      void main() {\n        "+g+" coords = getOutputCoords();\n        setOutput(getX("+c+"));\n      }\n    "}var mp=(ms.prototype.getCustomSetupFunc=function(a){var b=this;if(a.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+a.length+")");return function(c,d){null==b.startLoc&&(b.startLoc=c.getUniformLocationNoThrow(d,"start"),null==b.startLoc)||c.gl.uniform1iv(b.startLoc,a)}},ms),mq=(mr.prototype.acquireTexture=function(a,g,e){var c,d=mt(g,e),b=mu(a,d,e);if(b in this.freeTextures||(this.freeTextures[b]=[]),b in this.usedTextures||(this.usedTextures[b]=[]),0<this.freeTextures[b].length){this.numFreeTextures--,this.numUsedTextures++,this.log();var f=this.freeTextures[b].shift();return this.usedTextures[b].push(f),f}return this.numUsedTextures++,this.log(),d===ag.PACKED_2X2_FLOAT32?c=this.gpgpu.createPackedMatrixTexture(a[0],a[1]):d===ag.PACKED_2X2_FLOAT16?c=this.gpgpu.createFloat16PackedMatrixTexture(a[0],a[1]):d===ag.UNPACKED_FLOAT32?c=this.gpgpu.createFloat32MatrixTexture(a[0],a[1]):d===ag.UNPACKED_FLOAT16?c=this.gpgpu.createFloat16MatrixTexture(a[0],a[1]):d===ag.PACKED_4X1_UNSIGNED_BYTE&&(c=this.gpgpu.createUnsignedBytesMatrixTexture(a[0],a[1])),this.usedTextures[b].push(c),c},mr.prototype.releaseTexture=function(b,f,g,c){if(null!=this.freeTextures){var a=mu(f,mt(g,c),c);a in this.freeTextures||(this.freeTextures[a]=[]),this.freeTextures[a].push(b),this.numFreeTextures++,this.numUsedTextures--;var d=this.usedTextures[a],e=d.indexOf(b);if(e<0)throw new Error("Cannot release a texture that was never provided by this texture manager");d.splice(e,1),this.log()}},mr.prototype.log=function(){if(this.logEnabled){var a=this.numFreeTextures+this.numUsedTextures;console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+a+")")}},mr.prototype.getNumUsedTextures=function(){return this.numUsedTextures},mr.prototype.getNumFreeTextures=function(){return this.numFreeTextures},mr.prototype.dispose=function(){var b=this;if(null!=this.freeTextures){for(var a in this.freeTextures)this.freeTextures[a].forEach(function(a){b.gpgpu.deleteMatrixTexture(a)});for(var a in this.usedTextures)this.usedTextures[a].forEach(function(a){b.gpgpu.deleteMatrixTexture(a)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},mr);function mr(a){this.gpgpu=a,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}function ms(a){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a,this.rank=a.length;var e=k4(this.rank),c=k$("coords",this.rank),b=k$("sourceLoc",this.rank),f=1===this.rank?"sourceLoc":"vec2("+b.slice(-2).join()+")",d="getChannel(getSource("+b.join()+"), "+f+")",g="\n      result.x = "+d+";\n      if (++"+c[this.rank-1]+" < "+a[this.rank-1]+") {\n        ++"+b[this.rank-1]+";\n        result.y = "+d+";\n        --"+b[this.rank-1]+";\n      }\n    ",h=1===this.rank?"":"\n      --"+c[this.rank-1]+";\n      if (++"+c[this.rank-2]+" < "+a[this.rank-2]+") {\n        ++"+b[this.rank-2]+";\n        result.z = "+d+";\n        if (++"+c[this.rank-1]+" < "+a[this.rank-1]+") {\n          ++"+b[this.rank-1]+";\n          result.w = "+d+";\n        }\n      }\n    ",i=this.rank<=4?"sourceLoc = coords +\n            "+e+"("+a.map(function(b,a){return"start["+a+"]"}).join()+");":a.map(function(d,a){return b[a]+" = "+c[a]+" + start["+a+"];"}).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+e+" coords = getOutputCoords();\n        "+e+" sourceLoc;\n        "+i+"\n        vec4 result = vec4(0.);\n        "+g+"\n        "+h+"\n        setOutput(result);\n      }\n    "}function mt(a,c){var b;if(a===af.UPLOAD)return ag.PACKED_2X2_FLOAT32;if(a===af.RENDER||null==a)return b=c,i.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?b?ag.PACKED_2X2_FLOAT32:ag.UNPACKED_FLOAT32:b?ag.PACKED_2X2_FLOAT16:ag.UNPACKED_FLOAT16;if(a===af.DOWNLOAD||a===af.PIXELS)return ag.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+a)}function mu(a,b,c){return a[0]+"_"+a[1]+"_"+b+"_"+c}function mv(c,d){this.variableNames=["A"];for(var b=new Array(c.length),a=0;a<b.length;a++)b[a]=c[a]*d[a];this.outputShape=b,this.rank=b.length;var e=k4(this.rank),f=function(a){var c=a.length;if(5<c)throw Error("Tile for rank "+c+" is not yet supported");if(1===c)return"imod(resRC, "+a[0]+")";for(var e=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],d=[],b=0;b<a.length;b++)d.push("imod("+e[b]+", "+a[b]+")");return d.join()}(c);this.userCode="\n      void main() {\n        "+e+" resRC = getOutputCoords();\n        setOutput(getA("+f+"));\n      }\n    "}function mw(c,d){this.variableNames=["A"];for(var a=new Array(c.length),b=0;b<a.length;b++)a[b]=c[d[b]];this.outputShape=a,this.rank=a.length;var e=k4(this.rank),f=function(b){var c=b.length;if(6<c)throw Error("Transpose for rank "+c+" is not yet supported");for(var e=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],d=new Array(c),a=0;a<b.length;a++)d[b[a]]=e[a];return d.join()}(d);this.userCode="\n    void main() {\n      "+e+" resRC = getOutputCoords();\n      setOutput(getA("+f+"));\n    }\n    "}function mx(g,e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;for(var b=new Array(g.length),a=0;a<b.length;a++)b[a]=g[e[a]];if(this.outputShape=b,this.rank=b.length,6<this.rank)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var i=k4(this.rank),c=kZ("rc",this.rank),f=new Array(this.rank);for(a=0;a<e.length;a++)f[e[a]]=c[a];var j="vec2("+f.slice(-2).join()+")",h="++"+c[this.rank-1]+" < "+b[this.rank-1],d="getChannel(getA("+f.join()+"), "+j+")";this.userCode="\n    void main() {\n      "+i+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+d+";\n      if("+h+") {\n        result[1] = "+d+";\n      }\n      --"+c[this.rank-1]+";\n      if(++"+c[this.rank-2]+" < "+b[this.rank-2]+") {\n        result[2] = "+d+";\n        if("+h+") {\n          result[3] = "+d+";\n        }\n      }\n      setOutput(result);\n    }\n    "}function my(a,b){this.variableNames=["A"],this.outputShape=a,this.userCode="\n      float unaryOperation(float x) {\n        "+b+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "}function mz(a,b){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+b+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "}function mA(c){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1;var a=(this.outputShape=c).length,b=k$("rc",a),d=k4(a),e=function(b,d){if(1===b)return"rc";for(var c="",a=0;a<b;a++)c+=d[a],a<b-1&&(c+=",");return c}(a,b),f=b.slice(-2),g=a<=1?"rc":"vec2("+f.join(",")+")";this.userCode="\n      void main() {\n        "+d+" rc = getOutputCoords();\n        vec4 packedInput = getA("+e+");\n\n        setOutput(getChannel(packedInput, "+g+"));\n      }\n    "}var mB=1.7580993408473768,mC=1.0507009873554805,ba="if (isnan(x)) return x;",mD="return abs(x);",mE=ba+"\n  return (x < 0.0) ? 0.0 : x;\n",mF=ba+"\n  return (x < 0.0) ? 0.0 : min(6.0, x);\n",mG="return (x >= 0.0) ? x : (exp(x) - 1.0);",mH="return -x;",mI="return ceil(x);",mJ="return floor(x);",mK="return exp(x);",mL="return exp(x) - 1.0;",mM="return x;",mN="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",mO="\n  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",mP="\n  vec4 result;\n\n  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);\n  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);\n  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);\n  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);\n\n  return result;\n",mQ={};function mR(a,b){if(void 0===b&&(b=!1),"linear"===a)return"return x;";if("relu"===a)return b?mN:mE;if("elu"===a)return b?mP:mG;if("relu6"===a)return b?mO:mF;if("prelu"===a)return b?lm:ll;throw new Error("Activation "+a+" has not been implemented for the WebGL backend.")}var gA,gB=(f(mS,gA=K),mS.prototype.numDataIds=function(){return this.texData.numDataIds()+(this.cpuBackend?this.cpuBackend.numDataIds():0)-this.pendingDeletes},mS.prototype.write=function(a,d,b){if(i.getBool("DEBUG")&&this.checkNumericalProblems(a),"complex64"===b&&null!=a)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");var c={};return this.texData.set(c,{shape:d,dtype:b,values:a,usage:af.UPLOAD}),c},mS.prototype.move=function(c,a,d,b){if(i.getBool("DEBUG")&&this.checkNumericalProblems(a),"complex64"===b)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(c,{shape:d,dtype:b,values:a,usage:af.UPLOAD})},mS.prototype.readSync=function(b){var a=this.texData.get(b),e=a.values,c=a.dtype,f=a.complexTensors,k=a.slice,d=a.shape,l=a.isPacked;if(null!=k){m=l?new mz(d,mM):new my(d,mM);var m,g=this.runWebGLProgram(m,[{dataId:b,shape:d,dtype:c}],c),n=this.readSync(g.dataId);return this.disposeData(g.dataId),n}if(null!=e)return this.convertAndCacheOnCPU(b);if("string"===c)return e;var h,i,j=null!=this.activeTimers;return j&&(h=eE()),i="complex64"===c?kK(f.real.dataSync(),f.imag.dataSync()):this.getValuesFromTexture(b),j&&(this.downloadWaitMs+=eE()-h),this.convertAndCacheOnCPU(b,i)},mS.prototype.read=function(a){return jL(this,void 0,void 0,function(){var b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;return jM(this,function(y){switch(y.label){case 0:if(this.pendingRead.has(a))return b=this.pendingRead.get(a),[2,new Promise(function(a){return b.push(a)})];if(d=(c=this.texData.get(a)).values,e=c.shape,f=c.slice,g=c.dtype,h=c.complexTensors,j=c.isPacked,null!=f)return k=j?new mz(e,mM):new my(e,mM),l=this.runWebGLProgram(k,[{dataId:a,shape:e,dtype:g}],g),m=this.read(l.dataId),this.disposeData(l.dataId),[2,m];if(null!=d)return[2,this.convertAndCacheOnCPU(a)];if(!i.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===i.getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return n=null,"complex64"!==g&&i.get("WEBGL_BUFFER_SUPPORTED")&&(o=this.decode(a),p=this.texData.get(o.dataId),n=(x=this.gpgpu).createBufferFromTexture.apply(x,[p.texture].concat(ka(e)))),this.pendingRead.set(a,[]),"complex64"===g?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:y.sent(),y.label=2;case 2:return"complex64"!==g?[3,4]:[4,Promise.all([h.real.data(),h.imag.data()])];case 3:return s=(r=y.sent())[0],t=r[1],q=kK(s,t),[3,5];case 4:q=null==n?this.getValuesFromTexture(a):(u=ec(e),this.gpgpu.downloadFloat32MatrixFromBuffer(n,u)),y.label=5;case 5:return null!=o&&this.disposeData(o.dataId),v=this.convertAndCacheOnCPU(a,q),w=this.pendingRead.get(a),this.pendingRead.delete(a),w.forEach(function(a){return a(v)}),this.pendingDisposal.has(a)&&(this.pendingDisposal.delete(a),this.disposeData(a),this.pendingDeletes--),[2,v]}})})},mS.prototype.checkNumericalProblems=function(a){if(null!=a)for(var b=0;b<a.length;b++){var c=a[b];if(!eW(c)){if(i.getBool("WEBGL_RENDER_FLOAT32_CAPABLE"))throw Error("The value "+c+" cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'");throw Error("The value "+c+" cannot be represented on this device.")}}},mS.prototype.getValuesFromTexture=function(b){var f,c=this.texData.get(b),a=c.shape,l=c.dtype,m=c.isPacked,g=ec(a);if(i.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var h=this.decode(b),n=this.texData.get(h.dataId),o=(f=this.gpgpu).downloadMatrixFromPackedTexture.apply(f,[n.texture].concat(ka(a))).subarray(0,g);return this.disposeData(h.dataId),o}var j=i.getBool("WEBGL_PACK")&& !0===m,d=j?fi(a):a,p=j?new lJ(d):new lI(d),k=this.runWebGLProgram(p,[{shape:d,dtype:l,dataId:b}],"float32"),e=this.texData.get(k.dataId),q=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(e.texture,e.texShape[0],e.texShape[1]).subarray(0,g);return this.disposeData(k.dataId),q},mS.prototype.time=function(a){return jL(this,void 0,void 0,function(){var b,c,d,e,f,g,h;return jM(this,function(i){switch(i.label){case 0:return b=this.activeTimers,d=(c=[],!1),null==this.programTimersStack?(this.programTimersStack=c,d=!0):this.activeTimers.push(c),this.activeTimers=c,a(),e=eb(this.activeTimers.map(function(a){return a.query})).filter(function(a){return null!=a}),f=eb(this.activeTimers.map(function(a){return a.name})).filter(function(a){return null!=a}),this.activeTimers=b,d&&(this.programTimersStack=null),[4,Promise.all(e)];case 1:return g=i.sent(),h={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:d7(g),getExtraProfileInfo:function(){return g.map(function(a,b){return{name:f[b],ms:a}}).map(function(a){return a.name+": "+a.ms}).join(", ")},wallMs:null},this.uploadWaitMs=0,this.downloadWaitMs=0,[2,h]}})})},mS.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},mS.prototype.startTimer=function(){return 0<i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?this.gpgpu.beginQuery():{startMs:eE(),endMs:null}},mS.prototype.endTimer=function(a){return 0<i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?this.gpgpu.endQuery():a.endMs=eE(),a},mS.prototype.getQueryTime=function(a){return jL(this,void 0,void 0,function(){var b;return jM(this,function(c){return 0<i.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?[2,this.gpgpu.waitForQueryAndGetTime(a)]:[2,(b=a).endMs-b.startMs]})})},mS.prototype.disposeData=function(a){if(!this.pendingDisposal.has(a)){if(this.pendingRead.has(a))return this.pendingDisposal.add(a),void this.pendingDeletes++;if(this.texData.has(a)){this.releaseGPUData(a);var b=this.texData.get(a).complexTensors;null!=b&&(b.real.dispose(),b.imag.dispose()),this.texData.delete(a)}}},mS.prototype.releaseGPUData=function(c){var a=this.texData.get(c),e=a.texture,i=a.dtype,f=a.texShape,j=a.usage,k=a.isPacked,g=a.slice,d=g&&g.origDataId||c,h=this.dataRefCount.get(d);1<h?this.dataRefCount.set(d,h-1):(this.dataRefCount.delete(d),null!=e&&(this.numBytesInGPU-=this.computeBytes(f,i),this.textureManager.releaseTexture(e,f,j,k)));var b=this.texData.get(c);b.texture=null,b.texShape=null,b.isPacked=!1,b.slice=null},mS.prototype.getTexture=function(a){return this.uploadToGPU(a),this.texData.get(a).texture},mS.prototype.getDataInfo=function(a){return this.texData.get(a)},mS.prototype.getCPUBackend=function(){return i.getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=ad.findBackend("cpu")),this.cpuBackend):null},mS.prototype.shouldExecuteOnCPU=function(b,a){var c=this;return void 0===a&&(a=128),null!=this.getCPUBackend()&&b.every(function(b){return null==c.texData.get(b.dataId).texture&&b.size<a})},mS.prototype.getGPGPUContext=function(){return this.gpgpu},mS.prototype.complex=function(a,c){var b=this.makeOutput(a.shape,"complex64");return this.texData.get(b.dataId).complexTensors={real:ad.keep(a.clone()),imag:ad.keep(c.clone())},b},mS.prototype.real=function(a){return this.texData.get(a.dataId).complexTensors.real.clone()},mS.prototype.imag=function(a){return this.texData.get(a.dataId).complexTensors.imag.clone()},mS.prototype.slice=function(a,c,b){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.slice(a,c,b);if(0===ec(b))return al([],b,a.dtype);var e=this.texData.get(a.dataId).isPacked,f=fZ(a.shape,c,b);if(!e&&f)return this.uploadToGPU(a.dataId),this.shallowSlice(a,c,b);var d=i.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new mp(b):new ml(b),g=d.getCustomSetupFunc(c);return this.compileAndRun(d,[a],null,g)},mS.prototype.shallowSlice=function(b,g,d){var c=this.texData.get(b.dataId),e=this.makeOutput(d,b.dtype),a=this.texData.get(e.dataId);Object.assign(a,c),a.shape=d,a.dtype=b.dtype;var f=f$(g,b.strides);c.slice&&(f+=c.slice.flatOffset),a.slice={flatOffset:f,origDataId:c.slice&&c.slice.origDataId||b.dataId};var h=this.dataRefCount.get(a.slice.origDataId)||1;return this.dataRefCount.set(a.slice.origDataId,h+1),e},mS.prototype.stridedSlice=function(a,b,e,c){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.stridedSlice(a,b,e,c);var d=fW(b,e,c);if(d.some(function(a){return 0===a}))return al([],d);var f=new mo(b,c,d);return this.compileAndRun(f,[a])},mS.prototype.reverse=function(a,b){var c=i.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new mh(a.shape,b):new mg(a.shape,b);return this.compileAndRun(c,[a])},mS.prototype.concat=function(a,b){if("complex64"===a[0].dtype){var e=a.map(function(a){return aj(a)}),f=a.map(function(a){return ak(a)});return ai(this.concat(e,b),this.concat(f,b))}if(this.shouldExecuteOnCPU(a))return this.cpuBackend.concat(a,b);if(1===a.length)return a[0];if(a.length>i.getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var c=Math.floor(a.length/2),g=this.concat(a.slice(0,c),b),h=this.concat(a.slice(c),b);return this.concat([g,h],b)}if(i.getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&1<a[0].rank){var j=new lh(a.map(function(a){return a.shape}),b);return this.compileAndRun(j,a)}var k=fG(a.map(function(a){return a.shape}),b),d=a.map(function(a){return a.as2D(-1,ec(a.shape.slice(b)))}),l=new lg(d.map(function(a){return a.shape}));return this.compileAndRun(l,d).reshape(k)},mS.prototype.neg=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.neg(a);if(i.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,mH,a.dtype);var b=new my(a.shape,mH);return this.compileAndRun(b,[a])},mS.prototype.batchMatMul=function(a,b,d,e){var h=d?a.shape[2]:a.shape[1],c=e?b.shape[1]:b.shape[2],f=d?a.shape[1]:a.shape[2],g=a.shape[0];if((1===h||1===c)&&1e3<f){d&&(a=a.transpose([0,2,1])),e&&(b=b.transpose([0,2,1]));var i=1===c?a:a.as3D(g,f,1),j=1===c?2:1,k=1===c?b.as3D(g,1,f):b;return this.multiply(i,k).sum(j,!0)}var l=eN(a.dtype,b.dtype),m=new l0(a.shape,[g,h,c],d,e);return this.compileAndRun(m,[a,b],l)},mS.prototype.fusedBatchMatMul=function(a){var b=a.a,c=a.b,g=a.transposeA,h=a.transposeB,d=a.bias,i=a.activation,e=a.preluActivationWeights,j=g?b.shape[2]:b.shape[1],k=h?c.shape[1]:c.shape[2],l=b.shape[0],m=eN(b.dtype,c.dtype),n=null!=d,o=null!=e,p=i?mR(i,!0):null,q=new l0(b.shape,[l,j,k],g,h,n,p,o),f=[b,c];return d&&f.push(d),e&&f.push(e),this.compileAndRun(q,f,m)},mS.prototype.multiply=function(a,b){if("complex64"===a.dtype){var c=this.texData.get(a.dataId),d=this.texData.get(b.dataId),h=new lc("return areal * breal - aimag * bimag;",a.shape,b.shape),j=new lc("return areal * bimag + aimag * breal;",a.shape,b.shape),e=[this.makeComplexComponentTensorInfo(a,c.complexTensors.real),this.makeComplexComponentTensorInfo(a,c.complexTensors.imag),this.makeComplexComponentTensorInfo(b,d.complexTensors.real),this.makeComplexComponentTensorInfo(b,d.complexTensors.imag)],f=this.compileAndRun(h,e),g=this.compileAndRun(j,e),k=this.complex(f,g);return f.dispose(),g.dispose(),k}if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.multiply(a,b);if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,lk,a.dtype);var l=new ld(lk,a.shape,b.shape);return this.compileAndRun(l,[a,b],a.dtype)},mS.prototype.batchNormalization=function(b,c,d,j,e,f){var a=[b,c,d],g=null;null!=f&&(g=f.shape,a.push(f));var h=null;if(null!=e&&(h=e.shape,a.push(e)),i.getBool("WEBGL_PACK_NORMALIZATION")){var k=new lb(b.shape,c.shape,d.shape,g,h,j);return this.compileAndRun(k,a)}var l=new la(b.shape,c.shape,d.shape,g,h,j);return this.compileAndRun(l,a)},mS.prototype.localResponseNormalization4D=function(a,b,c,d,e){var f=i.getBool("WEBGL_PACK_NORMALIZATION")?new lZ(a.shape,b,c,d,e):new lX(a.shape,b,c,d,e);return this.compileAndRun(f,[a])},mS.prototype.LRNGrad=function(b,a,c,d,e,f,g){var h=new lY(a.shape,d,e,f,g);return this.compileAndRun(h,[a,c,b])},mS.prototype.tile=function(a,b){if("string"===a.dtype){var c=this.readSync(a.dataId).map(function(a){return eH(a)});return kT(aH(a.shape,a.dtype,c),b)}var d=new mv(a.shape,b);return this.compileAndRun(d,[a])},mS.prototype.pad=function(a,b,c){var d=i.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new l6(a.shape,b,c):new l5(a.shape,b,c);return this.compileAndRun(d,[a])},mS.prototype.transpose=function(a,b){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.transpose(a,b);var c=i.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new mx(a.shape,b):new mw(a.shape,b);return this.compileAndRun(c,[a])},mS.prototype.gather=function(a,b,c){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.gather(a,b,c);var d=new lN(a.shape,b.size,c);return this.compileAndRun(d,[a,b])},mS.prototype.batchToSpaceND=function(b,a,c){d8(b.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var d=a.reduce(function(a,b){return a*b}),e=kx(b.shape,a,d),g=ky(e.length,a.length),f=kz(b.shape,a,d),h=kA(c,a.length),i=kB(f,c,a.length);return b.reshape(e).transpose(g).reshape(f).slice(h,i)},mS.prototype.spaceToBatchND=function(c,a,h){d8(c.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var e=a.reduce(function(a,b){return a*b}),b=[[0,0]];b.push.apply(b,h);for(var f=1+a.length;f<c.shape.length;++f)b.push([0,0]);var d=c.pad(b),g=kx(d.shape,a,e,!1),i=ky(g.length,a.length,!1),j=kz(d.shape,a,e,!1);return d.reshape(g).transpose(i).reshape(j)},mS.prototype.reduce=function(a,c,d){var f=a.shape[0],e=a.shape[1],g=fP(e),h=new l9({windowSize:g,inSize:e,batchSize:f},c),b=this.compileAndRun(h,[a],d);return 1===b.shape[1]?b:this.reduce(b,c,d)},mS.prototype.argReduce=function(b,e,a){void 0===a&&(a=null);var f=b.shape[0],c=b.shape[1];null!=a&&(f=a.shape[0],c=a.shape[1]);var h=fP(c),i=new kY({windowSize:h,inSize:c,batchSize:f},e,null==a),g=[b];null!=a&&g.push(a);var d=this.compileAndRun(i,g,"int32");return 1===d.shape[1]?d:this.argReduce(b,e,d)},mS.prototype.argReducePacked=function(b,e,a){void 0===a&&(a=null);var c=null!=a?a.shape:b.shape,f=fP(c[c.length-1]),g=new k7(c,f,e,null==a),h=null==a?[b]:[b,a],d=this.compileAndRun(g,h,"int32");return d.rank===b.rank?this.argReducePacked(b,e,d):d},mS.prototype.sum=function(a,b){fB("sum",b,a.rank);var c=fz(a.shape,b),d=c[0],e=ec(c[1]),f=a.as2D(-1,e),g=eO(a.dtype);return this.reduce(f,"sum",g).reshape(d)},mS.prototype.prod=function(a,b){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.prod(a,b);var c=fz(a.shape,b),d=c[0],e=ec(c[1]),f=a.as2D(-1,e),g=eO(a.dtype);return this.reduce(f,"prod",g).reshape(d)},mS.prototype.unsortedSegmentSum=function(a,g,f){var b=0,c=fC([b],a.rank),d=a;null!=c&&(d=a.transpose(c),b=fE(1,a.rank)[0]);var h=function(c,d,e){for(var b=[],f=c.length,a=0;a<f;a++)a!==d?b.push(c[a]):b.push(e);return b}(d.shape,b,f),i=ec([d.shape[b]]),j=d.as2D(-1,i),k=eO(a.dtype),e=this.segOpCompute(j,"unsortedSegmentSum",g,k,f).reshape(h);return null!=c&&(e=e.transpose(fD(c))),e},mS.prototype.segOpCompute=function(b,f,c,g,a){var i=b.shape[0],d=b.shape[1],h=function(b,d){var a,c=!1;for(b<=30?(a=b,c=!0):a=ez(b,Math.floor(Math.sqrt(b)));!c;)d<a||a===b?c=!0:a=ez(b,a+1);return a}(d,a),j=new mj({windowSize:h,inSize:d,batchSize:i,numSegments:a},f),e=this.compileAndRun(j,[b,c],g);return e.shape[1]===a?e:(c=ay(0,a).tile([d/h]),this.segOpCompute(e,f,c,g,a))},mS.prototype.argMinMaxReduce=function(a,e,b){var c=[e];if(fB("arg"+b.charAt(0).toUpperCase()+b.slice(1),c,a.rank),!i.getBool("WEBGL_PACK_REDUCE")||a.rank<=2){var d=fz(a.shape,c),f=d[0],g=ec(d[1]),h=a.as2D(-1,g);return this.argReduce(h,b).reshape(f)}return this.argReducePacked(a,b)},mS.prototype.argMin=function(a,b){return this.argMinMaxReduce(a,b,"min")},mS.prototype.argMax=function(a,b){return this.argMinMaxReduce(a,b,"max")},mS.prototype.cumsum=function(a,b,c,d){if(b!==a.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(a.rank-1)+" but got axis="+b);var e=new lD(a.shape,c,d);return this.compileAndRun(e,[a])},mS.prototype.equal=function(a,b){if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(equal(a, b));\n","bool");var c=new ld("return float(a == b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},mS.prototype.notEqual=function(a,b){if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(notEqual(a, b));\n","bool");var c=new ld("return float(a != b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},mS.prototype.less=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.less(a,b);if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(lessThan(a, b));\n","bool");var c=new ld("return float(a < b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},mS.prototype.lessEqual=function(a,b){if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(lessThanEqual(a, b));\n","bool");var c=new ld("return float(a <= b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},mS.prototype.greater=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.greater(a,b);if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(greaterThan(a, b));\n","bool");var c=new ld("return float(a > b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},mS.prototype.greaterEqual=function(a,b){if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(greaterThanEqual(a, b));\n","bool");var c=new ld("return float(a >= b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},mS.prototype.logicalNot=function(a){var b=new my(a.shape,"return float(!(x >= 1.0));");return this.compileAndRun(b,[a])},mS.prototype.logicalAnd=function(a,b){if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n","bool");var c=new ld("return float(a >= 1.0 && b >= 1.0);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},mS.prototype.logicalOr=function(a,b){if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n","bool");var c=new ld("return float(a >= 1.0 || b >= 1.0);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},mS.prototype.select=function(b,a,c){var d=new mk(b.rank,a.shape,a.rank);return this.compileAndRun(d,[b,a,c],eN(a.dtype,c.dtype))},mS.prototype.where=function(a){kk("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var b=a.dataSync();return kV(a.shape,b)},mS.prototype.topk=function(a,b,c){return kU(a.dataSync(),a.shape,a.dtype,b)},mS.prototype.min=function(a,b){fB("min",b,a.rank);var c=fz(a.shape,b),e=c[0],f=ec(c[1]),d=a.as2D(-1,f);return this.reduce(d,"min",d.dtype).reshape(e)},mS.prototype.minimum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.minimum(a,b);var c=i.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new le("\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new ld("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return min(a, b);\n",a.shape,b.shape);return this.compileAndRun(c,[a,b])},mS.prototype.mod=function(a,b){var c=i.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new le("\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new ld("if (b == 0.0) return NAN;\n  return mod(a, b);",a.shape,b.shape);return this.compileAndRun(c,[a,b])},mS.prototype.max=function(a,b){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.max(a,b);fB("max",b,a.rank);var c=fz(a.shape,b),e=c[0],f=ec(c[1]),d=a.as2D(-1,f);return this.reduce(d,"max",d.dtype).reshape(e)},mS.prototype.maximum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.maximum(a,b);var c=i.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new le("\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new ld("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return max(a, b);\n",a.shape,b.shape);return this.compileAndRun(c,[a,b])},mS.prototype.all=function(a,b){fB("all",b,a.rank);var c=fz(a.shape,b),e=c[0],f=ec(c[1]),d=a.as2D(-1,f);return this.reduce(d,"all",d.dtype).reshape(e)},mS.prototype.any=function(a,b){fB("any",b,a.rank);var c=fz(a.shape,b),e=c[0],f=ec(c[1]),d=a.as2D(-1,f);return this.reduce(d,"any",d.dtype).reshape(e)},mS.prototype.squaredDifference=function(a,b){var c=i.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new le("return (a - b) * (a - b);",a.shape,b.shape):new ld("return (a - b) * (a - b);",a.shape,b.shape);return this.compileAndRun(c,[a,b])},mS.prototype.realDivide=function(a,b){if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n","float32",!0);var c=new ld("\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",a.shape,b.shape);return this.compileAndRun(c,[a,b],"float32")},mS.prototype.floorDiv=function(a,b){if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n","int32");var c=new ld("\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",a.shape,b.shape);return this.compileAndRun(c,[a,b],"int32")},mS.prototype.add=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,li);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.add(a,b);var c=eN(a.dtype,b.dtype);if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,li,c);var d=new ld(li,a.shape,b.shape);return this.compileAndRun(d,[a,b],c)},mS.prototype.packedUnaryOp=function(a,b,c){var d=new mz(a.shape,b);return this.compileAndRun(d,[a],c)},mS.prototype.packedBinaryOp=function(b,c,d,e,a){void 0===a&&(a=!1);var f=new le(d,b.shape,c.shape,a);return this.compileAndRun(f,[b,c],e)},mS.prototype.complexSeparableBinaryOp=function(f,g,i){var j=this,a=this.texData.get(f.dataId),b=this.texData.get(g.dataId),c=[[a.complexTensors.real,b.complexTensors.real],[a.complexTensors.imag,b.complexTensors.imag]].map(function(a){var b=a[0],c=a[1],d=j.makeComplexComponentTensorInfo(f,b),e=j.makeComplexComponentTensorInfo(g,c),h=new ld(i,f.shape,g.shape);return j.compileAndRun(h,[d,e],eN(b.dtype,c.dtype))}),d=c[0],e=c[1],h=this.complex(d,e);return d.dispose(),e.dispose(),h},mS.prototype.makeComplexComponentTensorInfo=function(b,a){return{dataId:a.dataId,dtype:a.dtype,shape:b.shape}},mS.prototype.addN=function(a){if(1===a.length)return a[0];if(a.length>i.get("WEBGL_MAX_TEXTURES_IN_SHADER")){var b=Math.floor(a.length/2),d=this.addN(a.slice(0,b)),e=this.addN(a.slice(b));return this.addN([d,e])}var f=a.map(function(a){return a.dtype}).reduce(function(a,b){return eN(a,b)}),c=a.map(function(a){return a.shape}),g=i.getBool("WEBGL_PACK")?new kX(a[0].shape,c):new kW(a[0].shape,c);return this.compileAndRun(g,a,f)},mS.prototype.subtract=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,lj);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.subtract(a,b);var c=eN(a.dtype,b.dtype);if(i.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,lj,a.dtype);var d=new ld(lj,a.shape,b.shape);return this.compileAndRun(d,[a,b],c)},mS.prototype.pow=function(a,b){var c=i.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new le("\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new ld("\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",a.shape,b.shape),d=eN(a.dtype,b.dtype);return this.compileAndRun(c,[a,b],d)},mS.prototype.ceil=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.ceil(a);if(i.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,mI,a.dtype);var b=new my(a.shape,mI);return this.compileAndRun(b,[a])},mS.prototype.floor=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.floor(a);if(i.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,mJ,a.dtype);var b=new my(a.shape,mJ);return this.compileAndRun(b,[a])},mS.prototype.sign=function(a){var b=new my(a.shape,"\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n");return this.compileAndRun(b,[a])},mS.prototype.isNaN=function(a){var b=new my(a.shape,"return float(isnan(x));");return this.compileAndRun(b,[a],"bool")},mS.prototype.isInf=function(a){var b=new my(a.shape,"return float(isinf(x));");return this.compileAndRun(b,[a],"bool")},mS.prototype.isFinite=function(a){var b=new my(a.shape,"return float(!isnan(x) && !isinf(x));");return this.compileAndRun(b,[a],"bool")},mS.prototype.round=function(a){var b=new my(a.shape,"\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n");return this.compileAndRun(b,[a])},mS.prototype.exp=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.exp(a);if(i.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,mK,a.dtype);var b=new my(a.shape,mK);return this.compileAndRun(b,[a])},mS.prototype.expm1=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.expm1(a);if(i.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,mL,a.dtype);var b=new my(a.shape,mL);return this.compileAndRun(b,[a])},mS.prototype.log=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.log(a);if(i.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,"\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n",a.dtype);var b=new my(a.shape,"if (x < 0.0) return NAN;\n  return log(x);");return this.compileAndRun(b,[a])},mS.prototype.log1p=function(a){var b=new my(a.shape,"return log(1.0 + x);");return this.compileAndRun(b,[a])},mS.prototype.sqrt=function(a){var b=new my(a.shape,"return sqrt(x);");return this.compileAndRun(b,[a])},mS.prototype.rsqrt=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.rsqrt(a);var b=new my(a.shape,"return inversesqrt(x);");return this.compileAndRun(b,[a])},mS.prototype.reciprocal=function(a){var b=new my(a.shape,"return 1.0 / x;");return this.compileAndRun(b,[a])},mS.prototype.relu=function(a){var b;return b=i.getBool("WEBGL_PACK")?new mz(a.shape,mN):new my(a.shape,mE),this.compileAndRun(b,[a])},mS.prototype.relu6=function(a){var b;return b=i.getBool("WEBGL_PACK")?new mz(a.shape,mO):new my(a.shape,mF),this.compileAndRun(b,[a])},mS.prototype.prelu=function(a,b){var c=i.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new le(lm,a.shape,b.shape):new ld(ll,a.shape,b.shape);return this.compileAndRun(c,[a,b])},mS.prototype.elu=function(a){if(i.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,mP,a.dtype);var b=new my(a.shape,mG);return this.compileAndRun(b,[a])},mS.prototype.eluDer=function(a,b){var c=i.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new le("\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",a.shape,b.shape):new ld("return (b >= 1.0) ? a : a * (b + 1.0);",a.shape,b.shape);return this.compileAndRun(c,[a,b])},mS.prototype.selu=function(a){var b=new my(a.shape,"\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = 1.7580993408473768;\n  float scale = 1.0507009873554805;\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n");return this.compileAndRun(b,[a])},mS.prototype.int=function(a){var b=new my(a.shape,"return float(int(x));");return this.compileAndRun(b,[a],"int32")},mS.prototype.clip=function(a,c,d){var b,e=(b=i.getBool("WEBGL_PACK_CLIP")?new lo(a.shape):new ln(a.shape)).getCustomSetupFunc(c,d);return this.compileAndRun(b,[a],null,e)},mS.prototype.abs=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.abs(a);if(i.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,mD,a.dtype);var b=new my(a.shape,mD);return this.compileAndRun(b,[a])},mS.prototype.complexAbs=function(a){var b=this.texData.get(a.dataId),c=new lf(a.shape),d=[this.makeComplexComponentTensorInfo(a,b.complexTensors.real),this.makeComplexComponentTensorInfo(a,b.complexTensors.imag)];return this.compileAndRun(c,d)},mS.prototype.sigmoid=function(a){var b=new my(a.shape,"return 1.0 / (1.0 + exp(-1.0 * x));");return this.compileAndRun(b,[a])},mS.prototype.softplus=function(a){var b=new my(a.shape,"\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n");return this.compileAndRun(b,[a])},mS.prototype.sin=function(a){var b=new my(a.shape,"if (isnan(x)) return x;\n  return sin(x);\n");return this.compileAndRun(b,[a])},mS.prototype.cos=function(a){var b=new my(a.shape,"if (isnan(x)) return x;\n  return cos(x);\n");return this.compileAndRun(b,[a])},mS.prototype.tan=function(a){var b=new my(a.shape,"return tan(x);");return this.compileAndRun(b,[a])},mS.prototype.asin=function(a){var b=new my(a.shape,"if (isnan(x)) return x;\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return asin(x);\n");return this.compileAndRun(b,[a])},mS.prototype.acos=function(a){var b=new my(a.shape,"if (isnan(x)) return x;\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return acos(x);\n");return this.compileAndRun(b,[a])},mS.prototype.atan=function(a){var b=new my(a.shape,"if (isnan(x)) return x;\n  return atan(x);\n");return this.compileAndRun(b,[a])},mS.prototype.atan2=function(a,b){var c=i.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new le("\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new ld("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return atan(a, b);\n",a.shape,b.shape);return this.compileAndRun(c,[a,b])},mS.prototype.sinh=function(a){var b=new my(a.shape,"\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n");return this.compileAndRun(b,[a])},mS.prototype.cosh=function(a){var b=new my(a.shape,"\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n");return this.compileAndRun(b,[a])},mS.prototype.tanh=function(a){var b=new my(a.shape,"\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n");return this.compileAndRun(b,[a])},mS.prototype.asinh=function(a){var b=new my(a.shape,"if (isnan(x)) return x;return log(x + sqrt(x * x + 1.0));");return this.compileAndRun(b,[a])},mS.prototype.acosh=function(a){var b=new my(a.shape,"if (isnan(x)) return x;\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));");return this.compileAndRun(b,[a])},mS.prototype.atanh=function(a){var b=new my(a.shape,"if (isnan(x)) return x;\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;");return this.compileAndRun(b,[a])},mS.prototype.erf=function(a){var b=new my(a.shape,'\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = 0.3275911;\n  float a1 = 0.254829592;\n  float a2 = -0.284496736;\n  float a3 = 1.421413741;\n  float a4 = -1.453152027;\n  float a5 = 1.061405429;\n\n  float sign = sign(x);\n  x = abs(x);\n  float t = 1.0 / (1.0 + p * x);\n  return sign * (1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x));\n');return this.compileAndRun(b,[a])},mS.prototype.step=function(b,c){var a,d=new my(b.shape,(void 0===(a=c)&&(a=0),ba+"\n    return x > 0.0 ? 1.0 : float("+a+");\n  "));return this.compileAndRun(d,[b])},mS.prototype.conv2dByMatMul=function(d,f,b,g,h,j){var a=d.shape,c=this.texData.get(d.dataId),n=b.inChannels,o=a[0]*a[1]*a[2],p=b.outChannels,k="channelsLast"===b.dataFormat,q=a[2]%2!=0&&!!c.isPacked;if((1==o||1===p)&&1e3<n||!i.getBool("WEBGL_LAZILY_UNPACK")||!i.getBool("WEBGL_PACK_BINARY_OPERATIONS")||!q){var r=k?a[0]*a[1]*a[2]:a[0]*a[2]*a[3],s=this.reshape(d,[1,r,b.inChannels]),t=this.reshape(f,[1,b.inChannels,b.outChannels]);return this.reshape(this.fusedBatchMatMul({a:s,b:t,transposeA:!1,transposeB:!1,bias:g,activation:h,preluActivationWeights:j}),b.outShape)}var u=k?a[0]*a[1]*(a[2]+1):a[0]*a[2]*(a[3]+1),l={dataId:d.dataId,shape:[1,u,b.inChannels],dtype:d.dtype},v=c.shape;c.shape=c.shape.slice(),c.shape[c.shape.length-2]++,d8(fk(c.shape,l.shape),function(){return"packed reshape "+c.shape+" to "+l.shape+" isn't free"});var w=this.reshape(f,[1,b.inChannels,b.outChannels]),e=this.fusedBatchMatMul({a:l,b:w,transposeA:!1,transposeB:!1,bias:g,activation:h,preluActivationWeights:j}),m=this.texData.get(e.dataId);return d8(m.isPacked,function(){return"batchMatMul result is expected to be packed"}),c.shape=v,m.shape=b.outShape,ad.makeTensorFromDataId(e.dataId,b.outShape,e.dtype)},mS.prototype.conv2dWithIm2Row=function(n,o,a,b,g,h){var p=a.filterWidth,q=a.filterHeight,r=a.inChannels,c=a.outWidth,d=a.outHeight,s="channelsLast"===a.dataFormat,i=p*q*r,j=d*c,e=[i,j],k=n.squeeze([0]),t=o.reshape([1,i,-1]),u=new lW(e,k.shape,a),l=this.compileAndRun(u,[k]).reshape([1,e[0],e[1]]),v=null!=b,m=null!=h,w=g?mR(g,!0):null,x=new l0(l.shape,[1,j,a.outChannels],!0,!1,v,w,m),f=[l,t];b&&f.push(b),m&&f.push(h);var _=this.compileAndRun(x,f);return s?_.reshape([1,d,c,a.outChannels]):_.reshape([1,a.outChannels,d,c])},mS.prototype.fusedConv2d=function(b){var e=b.input,g=b.filter,a=b.convInfo,c=b.bias,f=b.activation,d=b.preluActivationWeights;if(1===a.filterHeight&&1===a.filterWidth&&1===a.dilationHeight&&1===a.dilationWidth&&1===a.strideHeight&&1===a.strideWidth&&("SAME"===a.padInfo.type||"VALID"===a.padInfo.type))return this.conv2dByMatMul(e,g,a,c,f,d);if(i.getBool("WEBGL_CONV_IM2COL")&&1===e.shape[0])return this.conv2dWithIm2Row(e,g,a,c,f,d);var j=null!=c,k=null!=d,l=f?mR(f,!1):null,m=new ly(a,j,l,k),h=[e,g];return c&&h.push(c),d&&h.push(d),this.compileAndRun(m,h)},mS.prototype.conv2d=function(b,c,a){if(1===a.filterHeight&&1===a.filterWidth&&1===a.dilationHeight&&1===a.dilationWidth&&1===a.strideHeight&&1===a.strideWidth&&("SAME"===a.padInfo.type||"VALID"===a.padInfo.type))return this.conv2dByMatMul(b,c,a);if(i.getBool("WEBGL_CONV_IM2COL")&&1===b.shape[0])return this.conv2dWithIm2Row(b,c,a);var d=new ly(a);return this.compileAndRun(d,[b,c])},mS.prototype.conv2dDerInput=function(a,b,c){var d=new lt(c);return this.compileAndRun(d,[a,b])},mS.prototype.conv2dDerFilter=function(a,b,c){var d=new ls(c);return this.compileAndRun(d,[a,b])},mS.prototype.fusedDepthwiseConv2D=function(a){var f,m=a.input,n=a.filter,b=a.convInfo,g=a.bias,h=a.activation,j=a.preluActivationWeights,k=i.getBool("WEBGL_PACK_DEPTHWISECONV")&&b.strideWidth<=2&&b.outChannels/b.inChannels==1,l=h?mR(h,k):null,c=[m,n],d=null!=g,e=null!=j;return d&&c.push(g),e&&c.push(j),f=k?new lB(b,d,l,e):new lA(b,d,l,e),this.compileAndRun(f,c)},mS.prototype.depthwiseConv2D=function(c,d,a){var b;return b=i.getBool("WEBGL_PACK_DEPTHWISECONV")&&a.strideWidth<=2&&a.outChannels/a.inChannels==1?new lB(a):new lA(a),this.compileAndRun(b,[c,d])},mS.prototype.depthwiseConv2DDerInput=function(a,b,c){var d=new lx(c);return this.compileAndRun(d,[a,b])},mS.prototype.depthwiseConv2DDerFilter=function(a,b,c){var d=new lw(c);return this.compileAndRun(d,[a,b])},mS.prototype.conv3d=function(a,b,c){var d=new lz(c);return this.compileAndRun(d,[a,b])},mS.prototype.conv3dDerInput=function(a,b,c){var d=new lv(c);return this.compileAndRun(d,[a,b])},mS.prototype.conv3dDerFilter=function(a,b,c){var d=new lu(c);return this.compileAndRun(d,[a,b])},mS.prototype.maxPool=function(a,b){var c=new l7(b,"max",!1);return this.compileAndRun(c,[a])},mS.prototype.avgPool=function(a,b){var c=new l7(b,"avg",!1);return this.compileAndRun(c,[a],"float32")},mS.prototype.maxPoolBackprop=function(d,a,h,b){var e=new l7(b,"max",!0),c=this.compileAndRun(e,[a]),f=new l$(b),g=this.compileAndRun(f,[d,c],a.dtype);return c.dispose(),g},mS.prototype.avgPoolBackprop=function(a,b,c){var d=new k8(c);return this.compileAndRun(d,[a],b.dtype)},mS.prototype.cast=function(a,b){return ge(a,b,this)},mS.prototype.unstack=function(b,c){for(var h=b.shape[c],e=new Array(b.rank-1),i=0,a=0;a<b.rank;a++)a!==c&&(e[i++]=b.shape[a]);var f=new Array(b.rank).fill(0),g=b.shape.slice();g[c]=1;var d=new Array(h);for(a=0;a<d.length;a++)d[f[c]=a]=this.slice(b,f,g).reshape(e);return d},mS.prototype.avgPool3d=function(a,b){var c=new l8(b,"avg",!1);return this.compileAndRun(c,[a],"float32")},mS.prototype.avgPool3dBackprop=function(a,b,c){var d=new k9(c);return this.compileAndRun(d,[a],b.dtype)},mS.prototype.maxPool3d=function(a,b){var c=new l8(b,"max",!1);return this.compileAndRun(c,[a],"float32")},mS.prototype.maxPool3dBackprop=function(d,a,h,b){var e=new l8(b,"max",!0),c=this.compileAndRun(e,[a]),f=new l_(b),g=this.compileAndRun(f,[d,c],a.dtype);return c.dispose(),g},mS.prototype.reshape=function(a,b){var c=this.texData.get(a.dataId);if(!c.isPacked||fk(a.shape,b)||null!==c.texture&&fk(c.shape,b))return gf(a,b);var d=this.packedReshape(a,b);return ad.makeTensorFromDataId(d.dataId,d.shape,d.dtype)},mS.prototype.resizeBilinear=function(a,b,c,d){var e=i.getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new md(a.shape,b,c,d):new mc(a.shape,b,c,d);return this.compileAndRun(e,[a],"float32")},mS.prototype.resizeBilinearBackprop=function(a,b,c){var d=new mb(a,b,c);return this.compileAndRun(d,[a])},mS.prototype.resizeNearestNeighbor=function(a,b,c,d){var e=new mf(a.shape,b,c,d);return this.compileAndRun(e,[a])},mS.prototype.resizeNearestNeighborBackprop=function(a,b,c){var d=new me(a,b,c);return this.compileAndRun(d,[a])},mS.prototype.multinomial=function(b,d,e,f){var a=d?b:a8(b),g=a.shape[0],h=a.shape[1],c=new l3(g,h,e),i=c.getCustomSetupFunc(f);return this.compileAndRun(c,[a],"int32",i)},mS.prototype.oneHot=function(a,b,c,d){var e=new l1(a.size,b,c,d);return this.compileAndRun(e,[a])},mS.prototype.diag=function(a){var b=new lH(a.size);return this.compileAndRun(b,[a])},mS.prototype.nonMaxSuppression=function(a,b,c,d,e){return kk("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead"),kN(a.dataSync(),b.dataSync(),c,d,e)},mS.prototype.cropAndResize=function(a,b,c,d,e,f){var g=new lC(a.shape,b.shape,d,e,f);return this.compileAndRun(g,[a,b,c],"float32")},mS.prototype.depthToSpace=function(a,b,c){d8(1<b,function(){return"blockSize should be > 1 for depthToSpace, but was: "+b});var d=a.shape[0],h="NHWC"===c?a.shape[1]:a.shape[2],i="NHWC"===c?a.shape[2]:a.shape[3],j="NHWC"===c?a.shape[3]:a.shape[1],e=h*b,f=i*b,g=j/(b*b),k=new lO("NHWC"===c?[d,e,f,g]:[d,g,e,f],b,c);return this.compileAndRun(k,[a])},mS.prototype.split=function(a,b,c){return kS(a,b,c)},mS.prototype.scatterND=function(e,j,b){var a=fS(0,e,b),f=a.sliceRank,c=a.numUpdates,d=a.sliceSize,k=a.strides,g=a.outputSize,l=[g/d,d],h=e.reshape([c,f]),i=j.reshape([c,d]);if(0===g)return gf(al([]),b);var m=am(0),n=new mi(c,f,h.rank,i.rank,k,l);return this.compileAndRun(n,[i,h,m]).reshape(b)},mS.prototype.sparseToDense=function(b,c,d,e){var a=fS(0,b,d),f=a.sliceRank,g=a.numUpdates,h=a.strides,i=a.outputSize,j=new mi(g,f,b.rank,c.rank,h,[i,1],!1);return this.compileAndRun(j,[c,b,e]).reshape(d)},mS.prototype.fft=function(a){return this.fftImpl(a,!1)},mS.prototype.ifft=function(a){return this.fftImpl(a,!0)},mS.prototype.fftImpl=function(a,b){var c=this.texData.get(a.dataId),g=new lM("return real * expR - imag * expI;",a.shape,b),h=new lM("return real * expI + imag * expR;",a.shape,b),d=[this.makeComplexComponentTensorInfo(a,c.complexTensors.real),this.makeComplexComponentTensorInfo(a,c.complexTensors.imag)],e=this.compileAndRun(g,d),f=this.compileAndRun(h,d),i=this.complex(e,f).as2D(a.shape[0],a.shape[1]);return e.dispose(),f.dispose(),i},mS.prototype.gatherND=function(b,c){var e=c.shape,f=e[e.length-1],a=fN(b,c),h=a[0],g=a[1],d=a[2],i=a[3],j=c.reshape([g,f]),k=b.reshape([b.size/d,d]),l=new lS(f,i,[g,d]);return this.compileAndRun(l,[k,j]).reshape(h)},mS.prototype.fill=function(c,b,a){if("string"===(a=a||ex(b))){var d=en(a,ec(c));return d.fill(b),ad.makeTensor(d,c,a,this)}var e=new lP(c,b),f=e.getCustomSetupFunc(b);return this.compileAndRun(e,[],a,f)},mS.prototype.onesLike=function(a){if("string"===a.dtype)throw new Error("onesLike is not supported under string dtype");return this.fill(a.shape,1,a.dtype)},mS.prototype.zerosLike=function(a){return this.fill(a.shape,"string"===a.dtype?"":0,a.dtype)},mS.prototype.linspace=function(a,b,c){return gg(a,b,c)},mS.prototype.makeTensorInfo=function(a,b){var c=this.write(null,a,b);return this.texData.get(c).usage=null,{dataId:c,shape:a,dtype:b}},mS.prototype.makeOutput=function(a,b){var c=this.makeTensorInfo(a,b).dataId;return ad.makeTensorFromDataId(c,a,b,this)},mS.prototype.unpackTensor=function(a){var b=new mA(a.shape);return this.runWebGLProgram(b,[a],a.dtype)},mS.prototype.packTensor=function(a){var b=new l2(a.shape);return this.runWebGLProgram(b,[a],a.dtype,null,!0)},mS.prototype.packedReshape=function(a,b){var c=[fg(a.shape)].concat(fh(a.shape)),e={dtype:a.dtype,shape:c,dataId:a.dataId},f=[fg(b)].concat(fh(b)),g=new ma(f,c),d=this.runWebGLProgram(g,[e],a.dtype,null,!0);return{dataId:d.dataId,shape:b,dtype:d.dtype}},mS.prototype.decode=function(d){var e,a=this.texData.get(d),g=a.isPacked,f=a.shape,b=a.dtype,c=fi(f);return e=g?new lG(c):new lF(c),{dtype:b,shape:f,dataId:this.runWebGLProgram(e,[{shape:c,dtype:b,dataId:d}],b,null,!0).dataId}},mS.prototype.runWebGLProgram=function(c,p,q,r,j){var y=this;void 0===j&&(j=!1);var a=this.makeTensorInfo(c.outputShape,q),e=this.texData.get(a.dataId);if(c.packedOutput&&(e.isPacked=!0),c.outPackingScheme===ae.DENSE){var s=ka(c.outputShape);e.texShape=s.map(function(a){return 2*a})}if(null!=c.outTexUsage&&(e.usage=c.outTexUsage),0===ec(a.shape))return e.values=em(a.dtype,0),a;var t=[],u=p.map(function(a){if("complex64"===a.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var b=y.texData.get(a.dataId);if(null==b.texture){if(!c.packedInputs&&ec(a.shape)<=i.getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:a.shape,texData:null,isUniform:!0,uniformValues:b.values};c.packedInputs&&(b.isPacked=!0,b.shape=a.shape)}else if(!!b.isPacked!= !!c.packedInputs)a=b.isPacked?y.unpackTensor(a):y.packTensor(a),t.push(a),b=y.texData.get(a.dataId);else if(b.isPacked&&!fk(b.shape,a.shape)){var e=a,d=a.shape;a.shape=b.shape,a=y.packedReshape(a,d),t.push(a),b=y.texData.get(a.dataId),e.shape=d}return y.uploadToGPU(a.dataId),{shape:a.shape,texData:b,isUniform:!1}});this.uploadToGPU(a.dataId);var h,d,b,k,f,l,m,g,n={shape:a.shape,texData:e,isUniform:!1},v=function(a,e,b){var c="";u.concat(b).forEach(function(a){var b=null!=a.texData&&null!=a.texData.slice&&0<a.texData.slice.flatOffset,d=a.isUniform?"uniform":a.texData.texShape;c+=a.shape+"_"+d+"_"+b});var d=a.userCode;return a.constructor.name+"_"+c+"_"+d}(c,0,n),w=this.getAndSaveBinary(v,function(){return function(a,b,m,e){var n=b.userCode,h=m.map(function(a,d){var c={logicalShape:a.shape,texShape:a.isUniform?null:a.texData.texShape,isUniform:a.isUniform,isPacked:!a.isUniform&&a.texData.isPacked,flatOffset:null};return null!=a.texData&&null!=a.texData.slice&&0<a.texData.slice.flatOffset&&(c.flatOffset=a.texData.slice.flatOffset),{name:b.variableNames[d],shapeInfo:c}}),o=h.map(function(a){return a.shapeInfo}),j={logicalShape:e.shape,texShape:e.texData.texShape,isUniform:!1,isPacked:e.texData.isPacked,flatOffset:null},k=function(e,b,i,j){var k=[];e.forEach(function(a){var b=ec(a.shapeInfo.logicalShape);a.shapeInfo.isUniform?k.push("uniform float "+a.name+(1<b?"["+b+"]":"")+";"):(k.push("uniform sampler2D "+a.name+";"),k.push("uniform int offset"+a.name+";"))});var d,f,a,l=k.join("\n"),m=e.map(function(h){var a,c,d,e,f,g;return a=h,c=b,void 0===(d=j)&&(d=!1),e="",e+=d?function k(a){var b,f,g,h,c,i,d,e,j;switch(a.shapeInfo.logicalShape.length){case 0:return f="get"+(b=a.name).charAt(0).toUpperCase()+b.slice(1),g=k_(),"\n    vec4 "+f+"() {\n      return "+g.texture2D+"("+b+", halfCR);\n    }\n  ";case 1:return i="get"+(c=(h=a).name).charAt(0).toUpperCase()+c.slice(1),d=h.shapeInfo.texShape,e=[Math.ceil(d[0]/2),Math.ceil(d[1]/2)],j=k_(),"\n    vec4 "+i+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+e[0]+", "+e[1]+", index);\n      return "+j.texture2D+"("+c+", uv);\n    }\n  ";case 2:return function(c){var d=c.shapeInfo.logicalShape,b=c.name,e="get"+b.charAt(0).toUpperCase()+b.slice(1),a=c.shapeInfo.texShape,h=a[0],i=a[1],f=k_();if(null!=a&&ed(d,a))return"\n      vec4 "+e+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+i+".0, "+h+".0);\n\n        return "+f.texture2D+"("+b+", uv);\n      }\n    ";var g=[Math.ceil(a[0]/2),Math.ceil(a[1]/2)];return"\n    vec4 "+e+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+Math.ceil(d[1]/2)+", "+g[0]+", "+g[1]+", row, col);\n      return "+f.texture2D+"("+b+", uv);\n    }\n  "}(a);case 3:return function(a){var b=a.shapeInfo.logicalShape,c=a.name,d="get"+c.charAt(0).toUpperCase()+c.slice(1),e=a.shapeInfo.texShape,f=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)];if(1===b[0]){var h=k5(a,b.slice(1));return"\n        "+k(h)+"\n        vec4 "+d+"(int b, int row, int col) {\n          return "+d+"("+k6(["b","row","col"],[1,2])+");\n        }\n      "}var i=f[0],j=f[1],g=Math.ceil(b[2]/2),l=g*Math.ceil(b[1]/2),m=k_();return"\n    vec4 "+d+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+i+", "+j+", "+l+", "+g+", b, row, col);\n      return "+m.texture2D+"("+c+", uv);\n    }\n  "}(a);default:return function(d){for(var b=d.shapeInfo.logicalShape,c=b.length,e=d.name,m="get"+e.charAt(0).toUpperCase()+e.slice(1),j=d.shapeInfo.texShape,k=[Math.ceil(j[0]/2),Math.ceil(j[1]/2)],n=k[0],f=k[1],l=Math.ceil(b[c-1]/2),g=l*Math.ceil(b[c-2]/2),h="int b, int row, int col",i="b * "+g+" + (row / 2) * "+l+" + (col / 2)",a=2;a<c-1;a++)h="int b"+a+", "+h,g*=b[c-a-1],i="b"+a+" * "+g+" + "+i;var o=k_();return"\n    vec4 "+m+"("+h+") {\n      int index = "+i+";\n      int texR = index / "+f+";\n      int texC = index - texR * "+f+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+f+", "+n+");\n      return "+o.texture2D+"("+e+", uv);\n    }\n  "}(a)}}(a):function c(a){var b=a.shapeInfo.logicalShape;switch(b.length){case 0:return function(b){var a=b.name,c="get"+a.charAt(0).toUpperCase()+a.slice(1);if(b.shapeInfo.isUniform)return"float "+c+"() {return "+a+";}";var d=b.shapeInfo.texShape,f=d[0],g=d[1];if(1===f&&1===g)return"\n      float "+c+"() {\n        return sampleTexture("+a+", halfCR);\n      }\n    ";var h,e=b.shapeInfo.texShape,i=e[0],j=e[1],k="offset"+(h=a);return"\n    float "+c+"() {\n      vec2 uv = uvFromFlat("+i+", "+j+", "+k+");\n      return sampleTexture("+a+", uv);\n    }\n  "}(a);case 1:return function(c){var a=c.name,b="get"+a.charAt(0).toUpperCase()+a.slice(1);if(c.shapeInfo.isUniform)return"\n      float "+b+"(int index) {\n        "+k3(c)+"\n      }\n    ";var g=c.shapeInfo.texShape,d=g[0],e=g[1];if(1===e&&1===d)return"\n      float "+b+"(int index) {\n        return sampleTexture("+a+", halfCR);\n      }\n    ";var h,f="offset"+(h=a);return 1===e?"\n      float "+b+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+f+") + 0.5) / "+d+".0);\n        return sampleTexture("+a+", uv);\n      }\n    ":1===d?"\n      float "+b+"(int index) {\n        vec2 uv = vec2((float(index + "+f+") + 0.5) / "+e+".0, 0.5);\n        return sampleTexture("+a+", uv);\n      }\n    ":"\n    float "+b+"(int index) {\n      vec2 uv = uvFromFlat("+d+", "+e+", index + "+f+");\n      return sampleTexture("+a+", uv);\n    }\n  "}(a);case 2:return function(e){var a=e.shapeInfo.logicalShape,b=e.name,d="get"+b.charAt(0).toUpperCase()+b.slice(1),f=e.shapeInfo.texShape;if(null!=f&&ed(a,f)){var l=f[0],m=f[1];return"\n    float "+d+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+m+".0, "+l+".0);\n      return sampleTexture("+b+", uv);\n    }\n  "}var j=el(a),n=j.newShape,o=j.keptDims,k=n;if(k.length<a.length){var p=k5(e,k);return"\n      "+c(p)+"\n      float "+d+"(int row, int col) {\n        return "+d+"("+k6(["row","col"],o)+");\n      }\n    "}if(e.shapeInfo.isUniform)return"\n      float "+d+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+a[1]+", 1)));\n        "+k3(e)+"\n      }\n    ";var q,g=f[0],h=f[1],i="offset"+(q=b);return 1===h?"\n    float "+d+"(int row, int col) {\n      float index = dot(vec3(row, col, "+i+"), vec3("+a[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+g+".0);\n      return sampleTexture("+b+", uv);\n    }\n  ":1===g?"\n    float "+d+"(int row, int col) {\n      float index = dot(vec3(row, col, "+i+"), vec3("+a[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+h+".0, 0.5);\n      return sampleTexture("+b+", uv);\n    }\n  ":"\n  float "+d+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+a[1]+" + col + "+i+";\n    vec2 uv = uvFromFlat("+g+", "+h+", index);\n    return sampleTexture("+b+", uv);\n  }\n"}(a);case 3:return function(a){var b=a.shapeInfo.logicalShape,d=a.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),h=b[1]*b[2],g=b[2],j=el(b),n=j.newShape,o=j.keptDims,k=n;if(k.length<b.length){var p=k5(a,k);return"\n        "+c(p)+"\n        float "+e+"(int row, int col, int depth) {\n          return "+e+"("+k6(["row","col","depth"],o)+");\n        }\n      "}if(a.shapeInfo.isUniform)return"\n      float "+e+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+h+", "+g+", 1)));\n        "+k3(a)+"\n      }\n    ";var l=a.shapeInfo.texShape,i=l[0],f=l[1],m=a.shapeInfo.flatOffset;if(f===h&&null==m)return"\n        float "+e+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+g+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+f+".0, "+i+".0);\n          return sampleTexture("+d+", uv);\n        }\n      ";if(f===g&&null==m)return"\n    float "+e+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+b[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+f+".0, "+i+".0);\n      return sampleTexture("+d+", uv);\n    }\n  ";var q,r="offset"+(q=d);return"\n      float "+e+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+h+" + col * "+g+" + depth + "+r+";\n        vec2 uv = uvFromFlat("+i+", "+f+", index);\n        return sampleTexture("+d+", uv);\n      }\n  "}(a);case 4:return function(b){var a=b.shapeInfo.logicalShape,d=b.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),f=a[3],h=a[2]*f,i=a[1]*h,k=el(a),l=k.newShape,o=k.keptDims;if(l.length<a.length){var p=k5(b,l);return"\n      "+c(p)+"\n      float "+e+"(int row, int col, int depth, int depth2) {\n        return "+e+"("+k6(["row","col","depth","depth2"],o)+");\n      }\n    "}if(b.shapeInfo.isUniform)return"\n      float "+e+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+i+", "+h+", "+f+", 1)));\n        "+k3(b)+"\n      }\n    ";var m=b.shapeInfo.flatOffset,n=b.shapeInfo.texShape,j=n[0],g=n[1];if(g===i&&null==m)return"\n      float "+e+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+h+", "+f+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+g+".0, "+j+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ";if(g===f&&null==m)return"\n      float "+e+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+a[1]*a[2]+", "+a[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+g+".0, "+j+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ";var q,r="offset"+(q=d);return"\n    float "+e+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+i+" + col * "+h+" +\n          depth * "+f+" + depth2;\n      vec2 uv = uvFromFlat("+j+", "+g+", index + "+r+");\n      return sampleTexture("+d+", uv);\n    }\n  "}(a);case 5:return function(b){var a=b.shapeInfo.logicalShape,d=b.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),f=a[4],h=a[3]*f,i=a[2]*h,j=a[1]*i,l=el(a),m=l.newShape,p=l.keptDims;if(m.length<a.length){var q=k5(b,m);return"\n      "+c(q)+"\n      float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+e+"("+k6(["row","col","depth","depth2","depth3"],p)+");\n      }\n    "}if(b.shapeInfo.isUniform)return"\n      float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+j+", "+i+", "+h+", "+f+")) +\n          depth3;\n        "+k3(b)+"\n      }\n    ";var n=b.shapeInfo.flatOffset,o=b.shapeInfo.texShape,k=o[0],g=o[1];if(g===j&&null==n)return"\n      float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+i+", "+h+", "+f+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+g+".0, "+k+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ";if(g===f&&null==n)return"\n      float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+a[1]*a[2]*a[3]+",\n               "+a[2]*a[3]+", "+a[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+g+".0, "+k+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ";var r,s="offset"+(r=d);return"\n    float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+j+" + col * "+i+" + depth * "+h+" +\n          depth2 * "+f+" + depth3 + "+s+";\n      vec2 uv = uvFromFlat("+k+", "+g+", index);\n      return sampleTexture("+d+", uv);\n    }\n  "}(a);case 6:return function(b){var a=b.shapeInfo.logicalShape,d=b.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),m=el(a),n=m.newShape,q=m.keptDims;if(n.length<a.length){var r=k5(b,n);return"\n      "+c(r)+"\n      float "+e+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+e+"("+k6(["row","col","depth","depth2","depth3","depth4"],q)+");\n      }\n    "}var f=a[5],h=a[4]*f,i=a[3]*h,j=a[2]*i,k=a[1]*j;if(b.shapeInfo.isUniform)return"\n      float "+e+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+k+", "+j+", "+i+", "+h+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+f+", 1)));\n        "+k3(b)+"\n      }\n    ";var o=b.shapeInfo.flatOffset,p=b.shapeInfo.texShape,l=p[0],g=p[1];if(g===k&&null==o)return"\n      float "+e+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+j+", "+i+", "+h+", "+f+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+g+".0, "+l+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ";if(g===f&&null==o)return"\n      float "+e+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+a[1]*a[2]*a[3]*a[4]+",\n               "+a[2]*a[3]*a[4]+",\n               "+a[3]*a[4]+",\n               "+a[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+g+".0, "+l+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ";var s,t="offset"+(s=d);return"\n    float "+e+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+k+" + col * "+j+" + depth * "+i+" +\n          depth2 * "+h+" + depth3 * "+f+" + depth4 + "+t+";\n      vec2 uv = uvFromFlat("+l+", "+g+", index);\n      return sampleTexture("+d+", uv);\n    }\n  "}(a);default:throw new Error(b.length+"-D input sampling is not yet supported")}}(a),f=a.shapeInfo.logicalShape,g=c.logicalShape,f.length<=g.length&&(e+=d?function(d,f){var g,h,i=d.name,j=i.charAt(0).toUpperCase()+i.slice(1),o="get"+j+"AtOutCoords",b=d.shapeInfo.logicalShape.length,e=f.logicalShape.length,a=f3(d.shapeInfo.logicalShape,f.logicalShape),p=k4(e),q=e-b,r=["x","y","z","w","u","v"];h=0===b?"":e<2&&1<=a.length?"coords = 0;":a.map(function(a){return"coords."+r[a+q]+" = 0;"}).join("\n"),g=e<2&&0<b?"coords":d.shapeInfo.logicalShape.map(function(b,a){return"coords."+r[a+q]}).join(", ");var c="return outputValue;",k=1===ec(d.shapeInfo.logicalShape),l=1===ec(f.logicalShape);if(1!==b||k||l){if(k&&!l)c=1===e?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(a.length){var m=b-2,n=b-1;-1<a.indexOf(m)&& -1<a.indexOf(n)?c="return vec4(outputValue.x);":-1<a.indexOf(m)?c="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":-1<a.indexOf(n)&&(c="return vec4(outputValue.xx, outputValue.zz);")}}else c="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return"\n    vec4 "+o+"() {\n      "+p+" coords = getOutputCoords();\n      "+h+"\n      vec4 outputValue = get"+j+"("+g+");\n      "+c+"\n    }\n  "}(a,c):function(a,d){var e=a.name,f=e.charAt(0).toUpperCase()+e.slice(1),g="get"+f+"AtOutCoords",i=d.texShape,j=a.shapeInfo.texShape,c=a.shapeInfo.logicalShape.length,b=d.logicalShape.length;if(!a.shapeInfo.isUniform&&c===b&&null==a.shapeInfo.flatOffset&&ed(j,i))return"\n      float "+g+"() {\n        return sampleTexture("+e+", resultUV);\n      }\n    ";var k=k4(b),h=f3(a.shapeInfo.logicalShape,d.logicalShape),l=b-c,m=["x","y","z","w","u","v"];return"\n    float "+g+"() {\n      "+k+" coords = getOutputCoords();\n      "+(0===c?"":b<2&&1<=h.length?"coords = 0;":h.map(function(a){return"coords."+m[a+l]+" = 0;"}).join("\n"))+"\n      return get"+f+"("+(b<2&&0<c?"coords":a.shapeInfo.logicalShape.map(function(b,a){return"coords."+m[a+l]}).join(", "))+");\n    }\n  "}(a,c)),e}).join("\n"),g=b.texShape,c=k_(),n="\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+c.texture2D+"(textureSampler, uv).r;\n    }\n  ",h=(a=c).version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+a.varyingFs+" vec2 resultUV;\n    "+a.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    "+a.defineSpecialNaN+"\n    "+a.defineSpecialInf+"\n    "+a.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    \nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n    \nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n    \nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n  ";return f=b.isPacked?(d=function(b,c){var h,a,e,i,d,f,g;switch(b.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return 1===(a=[Math.ceil((h=c)[0]/2),Math.ceil(h[1]/2)])[0]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+a[1]+".0);\n      }\n    ":1===a[1]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+a[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+a[0]+", "+a[1]+"));\n      return 2 * (resTexRC.x * "+a[1]+" + resTexRC.y);\n    }\n  ";case 2:return function(c,b){var a=[Math.ceil(b[0]/2),Math.ceil(b[1]/2)];if(ed(c,b))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+a[0]+", "+a[1]+"));\n      }\n    ";var d=Math.ceil(c[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+a[0]+", "+a[1]+"));\n\n      int index = resTexRC.x * "+a[1]+" + resTexRC.y;\n      int r = 2 * (index / "+d+");\n      int c = imod(index, "+d+") * 2;\n\n      return ivec2(r, c);\n    }\n  "}(b,c);case 3:return e=b,d=[Math.ceil((i=c)[0]/2),Math.ceil(i[1]/2)],g=(f=Math.ceil(e[2]/2))*Math.ceil(e[1]/2),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+d[0]+", "+d[1]+"));\n      int index = resTexRC.x * "+d[1]+" + resTexRC.y;\n\n      int b = index / "+g+";\n      index -= b * "+g+";\n\n      int r = 2 * (index / "+f+");\n      int c = imod(index, "+f+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  ";default:return function(a,h){for(var c=[Math.ceil(h[0]/2),Math.ceil(h[1]/2)],d=Math.ceil(a[a.length-1]/2),e=d*Math.ceil(a[a.length-2]/2),i=e,f="",g="b, r, c",b=2;b<a.length-1;b++)f="\n      int b"+b+" = index / "+(i*=a[a.length-b-1])+";\n      index -= b"+b+" * "+i+";\n    "+f,g="b"+b+", "+g;return"\n    ivec"+a.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+c[0]+", "+c[1]+"));\n      int index = resTexRC.x * "+c[1]+" + resTexRC.y;\n\n      "+f+"\n\n      int b = index / "+e+";\n      index -= b * "+e+";\n\n      int r = 2 * (index / "+d+");\n      int c = imod(index, "+d+") * 2;\n\n      return ivec"+a.length+"("+g+");\n    }\n  "}(b,c)}}(b.logicalShape,g),"\n    void setOutput(vec4 val) {\n      "+c.output+" = val;\n    }\n  "):(d=function(b,d){var f,j,g,k,h,l,e,a,c,i,m;switch(b.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return 1===(c=d)[0]?"\n      int getOutputCoords() {\n        return int(resultUV.x * "+c[1]+".0);\n      }\n    ":1===c[1]?"\n      int getOutputCoords() {\n        return int(resultUV.y * "+c[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+c[0]+", "+c[1]+"));\n      return resTexRC.x * "+c[1]+" + resTexRC.y;\n    }\n  ";case 2:return ed(e=b,a=d)?"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+a[0]+", "+a[1]+"));\n      }\n    ":1===e[1]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+a[0]+", "+a[1]+"));\n        int index = resTexRC.x * "+a[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ":1===e[0]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+a[0]+", "+a[1]+"));\n        int index = resTexRC.x * "+a[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+a[0]+", "+a[1]+"));\n      int index = resTexRC.x * "+a[1]+" + resTexRC.y;\n      int r = index / "+e[1]+";\n      int c = index - r * "+e[1]+";\n      return ivec2(r, c);\n    }\n  ";case 3:return i=d,m=k0(["r","c","d"],b),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+i[0]+", "+i[1]+"));\n      int index = resTexRC.x * "+i[1]+" + resTexRC.y;\n      "+m+"\n      return ivec3(r, c, d);\n    }\n  ";case 4:return h=d,l=k0(["r","c","d","d2"],b),"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+h[0]+", "+h[1]+"));\n      int index = resTexRC.x * "+h[1]+" + resTexRC.y;\n      "+l+"\n      return ivec4(r, c, d, d2);\n    }\n  ";case 5:return g=d,k=k0(["r","c","d","d2","d3"],b),"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+g[0]+",\n                             "+g[1]+"));\n\n      int index = resTexRC.x * "+g[1]+" + resTexRC.y;\n\n      "+k+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  ";case 6:return f=d,j=k0(["r","c","d","d2","d3","d4"],b),"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+f[0]+", "+f[1]+"));\n      int index = resTexRC.x * "+f[1]+" + resTexRC.y;\n\n      "+j+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  ";default:throw new Error(b.length+"-D output sampling is not yet supported")}}(b.logicalShape,g),"\n    void setOutput(float val) {\n      "+c.output+" = vec4(val, 0, 0, 0);\n    }\n  "),j&&(h+="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n"),[h,n,f,l,d,m,i].join("\n")}(h,j,n,b.packedInputs),c=a.createProgram(k),l=null,p=a.getUniformLocation(c,"NAN",!1);1===i.getNumber("WEBGL_VERSION")&&(l=a.getUniformLocation(c,"INFINITY",!1));for(var f={},g=0;g<b.variableNames.length;g++){var d=b.variableNames[g];f[d]=a.getUniformLocation(c,d,!1),f["offset"+d]=a.getUniformLocation(c,"offset"+d,!1)}return{program:b,source:k,webGLProgram:c,uniformLocations:f,inShapeInfos:o,outShapeInfo:j,infLoc:l,nanLoc:p}}(y.gpgpu,c,u,n)}),o=null!=this.activeTimers;if(o&&(h=this.startTimer()),d=this.gpgpu,b=w,k=u,f=n,l=r,lV(b.inShapeInfos,k),lV([b.outShapeInfo],[f]),m=f.texData.texture,g=f.texData.texShape,f.texData.isPacked?d.setOutputPackedMatrixTexture(m,g[0],g[1]):d.setOutputMatrixTexture(m,g[0],g[1]),d.setProgram(b.webGLProgram),1===i.getNumber("WEBGL_VERSION")&&null!==b.infLoc&&d.gl.uniform1f(b.infLoc,1/0),null!==b.nanLoc&&d.gl.uniform1f(b.nanLoc,NaN),k.forEach(function(a,f){var g=b.program.variableNames[f],c=b.uniformLocations[g],h=b.uniformLocations["offset"+g];if(null!=c){if(a.isUniform){if(2>ec(a.shape))d.gl.uniform1f(c,a.uniformValues[0]);else{var e=a.uniformValues;e instanceof Float32Array||(e=new Float32Array(e)),d.gl.uniform1fv(c,e)}}else null!=a.texData.slice&&null!=h&&d.gl.uniform1i(h,a.texData.slice.flatOffset),d.setInputMatrixTexture(a.texData.texture,c,f)}}),null!=l&&l(d,b.webGLProgram),d.executeProgram(),t.forEach(function(a){return y.disposeData(a.dataId)}),o&&(h=this.endTimer(h),this.activeTimers.push({name:c.constructor.name,query:this.getQueryTime(h)})),i.getBool("WEBGL_LAZILY_UNPACK")||!e.isPacked|| !1!==j)return a;var x=this.unpackTensor(a);return this.disposeData(a.dataId),x},mS.prototype.compileAndRun=function(e,d,a,f,b){void 0===b&&(b=!1),a=a||d[0].dtype;var c=this.runWebGLProgram(e,d,a,f,b);return ad.makeTensorFromDataId(c.dataId,c.shape,c.dtype)},mS.prototype.getAndSaveBinary=function(a,b){return a in this.binaryCache||(this.binaryCache[a]=b()),this.binaryCache[a]},mS.prototype.getTextureManager=function(){return this.textureManager},mS.prototype.dispose=function(){var a=this;this.disposed||(i.getBool("IS_TEST")||Object.keys(this.binaryCache).forEach(function(b){a.gpgpu.deleteProgram(a.binaryCache[b].webGLProgram),delete a.binaryCache[b]}),this.textureManager.dispose(),null!=this.canvas&&"undefined"!=typeof HTMLCanvasElement&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},mS.prototype.floatPrecision=function(){var a=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=fu(function(){if(!i.get("WEBGL_RENDER_FLOAT32_ENABLED")){var b=i.getBool("DEBUG");i.set("DEBUG",!1);var c=a.abs(am(1e-8)).dataSync()[0];if(i.set("DEBUG",b),0<c)return 32}return 16})),this.floatPrecisionValue},mS.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},mS.prototype.uploadToGPU=function(r){var k,a=this.texData.get(r),l=a.shape,g=a.dtype,h=a.values,s=a.texture,t=a.usage,i=a.isPacked;if(null==s){var m,n=null!=this.activeTimers;n&&(m=eE());var b=a.texShape;if(null==b&&(b=fj(l,i),a.texShape=b),null!=h){var o=fi(l),p=void 0,c=b[1],d=b[0],j=h instanceof Uint8Array;p=i?(c=(k=kb(b[0],b[1]))[0],d=k[1],new lL(o,[d,c],j)):new lK(o,[d,c],j);var e=this.makeTensorInfo([d,c],g);this.texData.get(e.dataId).usage=j?af.PIXELS:af.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(e.dataId),c,d,h);var q=this.runWebGLProgram(p,[e],g,null,!0),f=this.texData.get(q.dataId);a.texture=f.texture,a.texShape=f.texShape,a.isPacked=f.isPacked,a.usage=f.usage,this.disposeData(e.dataId),this.texData.delete(q.dataId),a.values=null,n&&(this.uploadWaitMs+=eE()-m)}else{var u=this.acquireTexture(b,t,g,i);a.texture=u}}},mS.prototype.convertAndCacheOnCPU=function(b,c){var a=this.texData.get(b),d=a.dtype;return this.releaseGPUData(b),null!=c&&(a.values=function(b,a){if("float32"===a||"complex64"===a)return b;if("int32"!==a&&"bool"!==a)throw new Error("Unknown dtype "+a);for(var d="int32"===a?new Int32Array(b.length):new Uint8Array(b.length),c=0;c<d.length;++c)d[c]=Math.round(b[c]);return d}(c,d)),a.values},mS.prototype.acquireTexture=function(a,b,c,d){if(this.numBytesInGPU+=this.computeBytes(a,c),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var e=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+e+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(a,b,d)},mS.prototype.computeBytes=function(a,b){return a[0]*a[1]*es(b)},mS);function mS(b){var c,a=gA.call(this)||this;if(a.pendingRead=new WeakMap,a.pendingDisposal=new WeakSet,a.dataRefCount=new WeakMap,a.numBytesInGPU=0,a.uploadWaitMs=0,a.downloadWaitMs=0,a.warnedAboutMemory=!1,a.pendingDeletes=0,a.disposed=!1,!i.getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");if(null==b){var d=j8(i.getNumber("WEBGL_VERSION"));a.binaryCache=((c=i.getNumber("WEBGL_VERSION"))in mQ||(mQ[c]={}),mQ[c]),a.gpgpu=new gz(d),a.canvas=d.canvas,a.gpgpuCreatedLocally=!0}else a.gpgpu=b,a.binaryCache={},a.gpgpuCreatedLocally=!1,a.canvas=b.gl.canvas;return a.textureManager=new mq(a.gpgpu),a.numMBBeforeWarning=null==i.global.screen?1024:i.global.screen.height*i.global.screen.width*window.devicePixelRatio*600/1024/1024,a.texData=new f2(a,ad),a}eT()&&ad.registerBackend("webgl",function(){return new gB},2),ab({kernelName:"Square",gradFunc:function(b,a){var c=a[0];return{x:function(){return b.mul(c.toFloat().mul(2))}}}});var bb=a({square_:function(b){var a=kn(b,"x","square"),c=[a];return ad.runKernelFunc(function(b,c){return c([a]),b.square(a)},{x:a},null,"Square",{},c,[])}}),bc=a({abs_:function(b){var a=kn(b,"x","abs");return"complex64"===a.dtype?ad.runKernelFunc(function(b){return b.complexAbs(a)},{$x:a}):ad.runKernelFunc(function(b,c){var d=b.abs(a);return c([a]),d},{x:a},function(b,a){var c=a[0];return{x:function(){return b.mul(c.toFloat().step(-1))}}},"Abs")}}),bd=a({acos_:function(a){var b=kn(a,"x","acos");return ad.runKernelFunc(function(a,c){var d=a.acos(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.divStrict(am(1).sub(c.toFloat().square()).sqrt()).neg()}}})}}),be=a({acosh_:function(a){var b=kn(a,"x","acosh");return ad.runKernelFunc(function(a,c){var d=a.acosh(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.divStrict(c.toFloat().square().sub(1).sqrt())}}})}}),bf=a({asin_:function(a){var b=kn(a,"x","asin");return ad.runKernelFunc(function(a,c){var d=a.asin(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.divStrict(am(1).sub(c.toFloat().square()).sqrt())}}})}}),bg=a({asinh_:function(a){var b=kn(a,"x","asinh");return ad.runKernelFunc(function(a,c){var d=a.asinh(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.divStrict(am(1).add(c.toFloat().square()).sqrt())}}})}}),bh=a({atan_:function(a){var b=kn(a,"x","atan");return ad.runKernelFunc(function(a,c){var d=a.atan(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.div(c.toFloat().square().add(1))}}})}}),bi=a({atanh_:function(a){var b=kn(a,"x","atanh");return ad.runKernelFunc(function(a,c){var d=a.atanh(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.div(am(1).sub(c.toFloat().square()))}}})}}),bj=a({ceil_:function(a){var b=kn(a,"x","ceil");return ad.runKernelFunc(function(a){return a.ceil(b)},{$x:b},function(a){return{$x:function(){return aA(a)}}})}}),bk=a({clipByValue_:function(d,a,b){var c=kn(d,"x","clipByValue");d8(a<=b,function(){return"Error in clip: min ("+a+") must be less than or equal to max ("+b+")."});var e=[c],f={min:a,max:b};return ad.runKernelFunc(function(d,e){var f=d.clip(c,a,b);return e([c]),f},{x:c},function(d,c){var e=c[0];return{x:function(){return d.where(e.greaterEqual(a).logicalAnd(e.lessEqual(b)),aA(d))}}},"ClipByValue",f,e)}}),bl=a({cos_:function(b){var a=kn(b,"x","cos"),c=[a];return ad.runKernelFunc(function(b,c){var d=b.cos(a);return c([a]),d},{x:a},function(b,a){var c=a[0];return{x:function(){return c.toFloat().sin().neg().mul(b)}}},"Cos",{},c)}}),bm=a({cosh_:function(a){var b=kn(a,"x","cosh");return ad.runKernelFunc(function(a,c){var d=a.cosh(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return c.toFloat().sinh().mulStrict(b)}}})}}),bn=a({erf_:function(b){var a=kn(b,"x","erf");return d8("int32"===a.dtype||"float32"===a.dtype,function(){return"Input dtype must be `int32` or `float32`."}),"int32"===a.dtype&&(a=a.toFloat()),ad.runKernelFunc(function(b,c){var d=b.erf(a);return c([a]),d},{$x:a},function(b,a){var c=a[0];return{$x:function(){return b.mul(c.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),bo=a({exp_:function(a){var b=kn(a,"x","exp");return ad.runKernelFunc(function(c,d){var a=c.exp(b);return d([a]),a},{x:b},function(a,b){return{x:function(){return a.mulStrict(b[0])}}},"Exp",{},[],[!0])}}),bp=a({expm1_:function(a){var b=kn(a,"x","expm1");return ad.runKernelFunc(function(a,c){var d=a.expm1(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.mul(c.exp())}}})}}),bq=a({floor_:function(a){var b=kn(a,"x","floor");return ad.runKernelFunc(function(a){return a.floor(b)},{$x:b},function(a){return{$x:function(){return aA(a)}}})}}),br=a({log_:function(b){var a=kn(b,"x","log"),c=[a];return ad.runKernelFunc(function(b,c){var d=b.log(a);return c([a]),d},{x:a},function(b,a){var c=a[0];return{x:function(){return b.div(c.toFloat())}}},"Log",{},c)}}),bs=a({log1p_:function(a){var b=kn(a,"x","log1p");return ad.runKernelFunc(function(a,c){var d=a.log1p(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.div(c.add(1))}}})}}),bt=a({logSigmoid_:function(a){var b=kn(a,"x","logSigmoid");return ad.runKernelFunc(function(a,c){var d=a.softplus(b.neg()).neg();return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.mul(c.neg().sigmoid())}}})}}),bu=a({neg_:function(a){var b=kn(a,"x","neg");return ad.runKernelFunc(function(a){return a.neg(b)},{$x:b},function(a){return{$x:function(){return a.neg()}}})}}),bv=a({reciprocal_:function(a){var b=kn(a,"x","reciprocal");return ad.runKernelFunc(function(a,c){var d=a.reciprocal(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.div(c.square().neg())}}})}}),bw=a({round_:function(a){var b=kn(a,"x","round");return ad.runKernelFunc(function(a){return a.round(b)},{$x:b},function(a){return{$x:function(){return aA(a)}}})}}),bx=a({rsqrt_:function(b){var a=kn(b,"x","rsqrt"),c=[a];return ad.runKernelFunc(function(b,c){var d=b.rsqrt(a);return c([a]),d},{x:a},function(b,a){var c=a[0];return{x:function(){return b.div(c.pow(1.5).mul(2)).neg()}}},"Rsqrt",{},c)}}),by=a({sigmoid_:function(a){var b=kn(a,"x","sigmoid");return ad.runKernelFunc(function(c,d){var a=c.sigmoid(b);return d([a]),a},{x:b},function(b,a){var c=a[0];return{x:function(){return b.mul(c.mul(am(1).sub(c)))}}},"Sigmoid")}}),bz=a({sign_:function(a){var b=kn(a,"x","sign");return ad.runKernelFunc(function(a){return a.sign(b)},{$x:b},function(a){return{$x:function(){return aA(a)}}})}}),bA=a({isNaN_:function(a){var b=kn(a,"x","isNaN");return ad.runKernelFunc(function(a){return a.isNaN(b)},{$x:b},function(a){return{$x:function(){return aA(a)}}})}}),bB=a({isInf_:function(a){var b=kn(a,"x","isInf");return ad.runKernelFunc(function(a){return a.isInf(b)},{$x:b},function(a){return{$x:function(){return aA(a)}}})}}),bC=a({isFinite_:function(a){var b=kn(a,"x","isFinite");return ad.runKernelFunc(function(a){return a.isFinite(b)},{$x:b},function(a){return{$x:function(){return aA(a)}}})}}),bD=a({sin_:function(b){var a=kn(b,"x","sin"),c=[a];return ad.runKernelFunc(function(b,c){var d=b.sin(a);return c([a]),d},{x:a},function(b,a){var c=a[0];return{x:function(){return c.toFloat().cos().mul(b)}}},"Sin",{},c)}}),bE=a({sinh_:function(a){var b=kn(a,"x","sinh");return ad.runKernelFunc(function(a,c){var d=a.sinh(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return c.toFloat().cosh().mulStrict(b)}}})}}),bF=a({softplus_:function(a){var b=kn(a,"x","softplus");return ad.runKernelFunc(function(a,c){var d=a.softplus(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.mul(c.sigmoid())}}})}}),bG=a({sqrt_:function(a){var b=kn(a,"x","sqrt");return ad.runKernelFunc(function(a,c){var d=a.sqrt(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.div(c.toFloat().sqrt().mul(2))}}})}}),bH=a({step_:function(b,a){void 0===a&&(a=0);var c=kn(b,"x","step");return ad.runKernelFunc(function(b){return b.step(c,a)},{$x:c},function(a){return{$x:function(){return aA(a)}}})}}),bI=a({tan_:function(a){var b=kn(a,"x","tan");return ad.runKernelFunc(function(a,c){var d=a.tan(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){return b.div(c.cos().square())}}})}}),bJ=a({tanh_:function(a){var b=kn(a,"x","tanh");return ad.runKernelFunc(function(c,d){var a=c.tanh(b);return d([a]),a},{x:b},function(b,a){var c=a[0];return{x:function(){return am(1).sub(c.square()).mulStrict(b)}}},"Tanh",{},null,[!0])}});function gC(h,i,j,e,f,k){var a,b,g=kn(h,"x","batchNorm"),c=kn(i,"mean","batchNorm"),d=kn(j,"variance","batchNorm");return null!=f&&(a=kn(f,"scale","batchNorm")),null!=e&&(b=kn(e,"offset","batchNorm")),d8(2===g.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+g.rank+"."}),d8(2===c.rank||1===c.rank,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+c.rank+"."}),d8(2===d.rank||1===d.rank,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+d.rank+"."}),null!=a&&d8(2===a.rank||1===a.rank,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+a.rank+"."}),null!=b&&d8(2===b.rank||1===b.rank,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+b.rank+"."}),gF(g,c,d,b,a,k)}function gD(h,i,j,e,f,k){var a,b,g=kn(h,"x","batchNorm"),c=kn(i,"mean","batchNorm"),d=kn(j,"variance","batchNorm");return null!=f&&(a=kn(f,"scale","batchNorm")),null!=e&&(b=kn(e,"offset","batchNorm")),d8(3===g.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+g.rank+"."}),d8(3===c.rank||1===c.rank,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+c.rank+"."}),d8(3===d.rank||1===d.rank,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+d.rank+"."}),null!=a&&d8(3===a.rank||1===a.rank,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+a.rank+"."}),null!=b&&d8(3===b.rank||1===b.rank,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+b.rank+"."}),gF(g,c,d,b,a,k)}function gE(h,i,j,e,f,k){var a,b,g=kn(h,"x","batchNorm"),c=kn(i,"mean","batchNorm"),d=kn(j,"variance","batchNorm");return null!=f&&(a=kn(f,"scale","batchNorm")),null!=e&&(b=kn(e,"offset","batchNorm")),d8(4===g.rank,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+g.rank+"."}),d8(4===c.rank||1===c.rank,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+c.rank+"."}),d8(4===d.rank||1===d.rank,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+d.rank+"."}),null!=a&&d8(4===a.rank||1===a.rank,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+a.rank+"."}),null!=b&&d8(4===b.rank||1===b.rank,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+b.rank+"."}),gF(g,c,d,b,a,k)}function gF(i,j,k,g,h,e){null==e&&(e=.001);var b,d,l,a=kn(i,"x","batchNorm"),c=kn(j,"mean","batchNorm"),f=kn(k,"variance","batchNorm");null!=h&&(b=kn(h,"scale","batchNorm")),null!=g&&(d=kn(g,"offset","batchNorm")),d8(c.rank===f.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),d8(null==d||c.rank===d.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),d8(null==b||c.rank===b.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."}),l=0===a.rank||1===a.rank?a.as4D(1,1,1,a.size):2===a.rank?a.as4D(1,1,a.shape[0],a.shape[1]):3===a.rank?a.as4D(1,a.shape[0],a.shape[1],a.shape[2]):a;var m=[a,c,f,b];return ad.runKernelFunc(function(g,h){var i=g.batchNormalization(l,mT(c),mT(f),e,mT(b),mT(d));return h([a,c,f,b]),i},{x:a,mean:c,variance:f,scale:b,offset:d},function(h,i){var a=i,j=a[0],b=a[1],k=a[2],f=a[3],m=null==f?am(1):f,n=f4(b.shape,l.shape),g=[];if(1===b.rank){for(var c=0;c<l.shape.length-1;++c)g.push(l.shape[c]);g.push(1)}var o=j.sub(b),p=h.mul(m),d=bx(k.add(am(e))),q=d.mul(d).mul(d).mul(am(-0.5));return{x:function(){return 1===b.rank?h.mul(a5(d.as4D(1,1,1,b.shape[0]),g)).mul(m).reshape(j.shape):h.mul(d).mul(m).reshape(j.shape)},mean:function(){var a=d.mul(am(-1)).mul(p);return 1===b.rank&&(a=a.sum(n)),a.reshape(b.shape)},variance:function(){var a=q.mul(o).mul(p);return 1===b.rank&&(a=a.sum(n)),a.reshape(b.shape)},scale:function(){var c=o.mul(d),a=h.mul(c);return 1===b.rank&&(a=a.sum(n)),a.reshape(b.shape)},offset:function(){var a=h;return 1===b.rank&&(a=a.sum(n)),a.reshape(b.shape)}}},"BatchNormalization",{varianceEpsilon:e},m).reshape(a.shape)}function mT(a){return null==a?null:0===a.rank?a.as1D():1===a.rank?a:2===a.rank?a.as4D(1,1,a.shape[0],a.shape[1]):3===a.rank?a.as4D(1,a.shape[0],a.shape[1],a.shape[2]):a}function mU(){ah("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}function bK(a){return jL(this,void 0,void 0,function(){var b,c,d;return jM(this,function(e){switch(e.label){case 0:return[4,(b=kn(a,"condition","whereAsync","bool")).data()];case 1:return c=e.sent(),d=kV(b.shape,c),a!==b&&b.dispose(),[2,d]}})})}var bL=a({batchNormalization2d_:function(b,c,d,a,e,f){return void 0===a&&(a=.001),mU(),gC(b,c,d,f,e,a)}}),bM=a({batchNormalization3d_:function(b,c,d,a,e,f){return void 0===a&&(a=.001),mU(),gD(b,c,d,f,e,a)}}),bN=a({batchNormalization4d_:function(b,c,d,a,e,f){return void 0===a&&(a=.001),mU(),gE(b,c,d,f,e,a)}}),bO=a({batchNormalization_:function(b,c,d,a,e,f){return void 0===a&&(a=.001),mU(),gF(b,c,d,f,e,a)}}),bP=a({batchNorm_:gF}),bQ=a({batchNorm2d_:gC}),bR=a({batchNorm3d_:gD}),bS=a({batchNorm4d_:gE}),bT=a({logicalAnd_:function(c,d){var a=kn(c,"a","logicalAnd","bool"),b=kn(d,"b","logicalAnd","bool");return f5(a.shape,b.shape),ad.runKernelFunc(function(c){return c.logicalAnd(a,b)},{a:a,b:b},null,"LogicalAnd")}}),bU=a({logicalNot_:function(a){var b=kn(a,"x","logicalNot","bool");return ad.runKernelFunc(function(a){return a.logicalNot(b)},{$x:b})}}),bV=a({logicalOr_:function(c,d){var a=kn(c,"a","logicalOr","bool"),b=kn(d,"b","logicalOr","bool");return f5(a.shape,b.shape),ad.runKernelFunc(function(c){return c.logicalOr(a,b)},{$a:a,$b:b})}}),bW=a({logicalXor_:function(a,b){var c=kn(a,"a","logicalXor","bool"),d=kn(b,"b","logicalXor","bool");return f5(c.shape,d.shape),bV(a,b).logicalAnd(bT(a,b).logicalNot())}}),bX=a({where_:function(d,e,f){var b=kn(e,"a","where"),c=kn(f,"b","where"),a=kn(d,"condition","where","bool");return d9(b.shape,c.shape,"Error in where: "),1===a.rank?d8(a.shape[0]===b.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):d9(a.shape,c.shape,"Error in where: "),ad.runKernelFunc(function(d,e){var f=d.select(a,b,c);return e([a]),f},{$condition:a,$a:b,$b:c},function(b,a){var c=a[0];return{$condition:function(){return aA(c).toFloat()},$a:function(){return b.mul(c.cast(b.dtype))},$b:function(){return b.mul(c.logicalNot().cast(b.dtype))}}})}}),bY=a({add_:function(d,e){var c,a=kn(d,"a","add"),b=kn(e,"b","add");a=(c=eP(a,b))[0],b=c[1];var f=f5(a.shape,b.shape);return ad.runKernelFunc(function(c){return c.add(a,b)},{a:a,b:b},function(c){return{a:function(){var b=c,d=f4(a.shape,f);return 0<d.length&&(b=b.sum(d)),b.reshape(a.shape)},b:function(){var a=c,d=f4(b.shape,f);return 0<d.length&&(a=a.sum(d)),a.reshape(b.shape)}}},"Add")}}),bZ=a({addN_:function(b){d8(Array.isArray(b),function(){return"The argument passed to tf.addN() must be a list of tensors"}),d8(1<=b.length,function(){return"Must pass at least one tensor to tf.addN(), but got "+b.length});var a=b.map(function(a,b){return kn(a,"tensors"+b,"addN")}),d=a[0];a.forEach(function(a){if(a.dtype!==d.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),a.forEach(function(a){if(!ed(a.shape,d.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")});var c=a;return ad.runKernelFunc(function(b){return b.addN(a)},c,function(c){var b={};return a.forEach(function(d,a){b[a]=function(){return c.clone()}}),b},"AddN")}}),b$=a({addStrict_:function(c,d){var a=kn(c,"a","addStrict"),b=kn(d,"b","addStrict");return d9(a.shape,b.shape,"Error in addStrict: "),a.add(b)}}),b_=a({atan2_:function(d,e){var c,a=kn(d,"a","atan2"),b=kn(e,"b","atan2");a=(c=eP(a,b))[0],b=c[1];var f=f5(a.shape,b.shape);return ad.runKernelFunc(function(c,d){var e=c.atan2(a,b);return d([a,b]),e},{$a:a,$b:b},function(b,a){var c=a[0],d=a[1];return{$a:function(){var g=bY(c.square(),d.square()),a=b.mul(d.div(g)),e=f4(c.shape,f);return 0<e.length&&(a=a.sum(e)),a.reshape(c.shape)},$b:function(){var g=bY(c.square(),d.square()),a=bu(b.mul(c.div(g))),e=f4(d.shape,f);return 0<e.length&&(a=a.sum(e)),a.reshape(d.shape)}}})}}),b0=a({div_:function(d,e){var c,a=kn(d,"a","div"),b=kn(e,"b","div");if(a=(c=eP(a,b))[0],b=c[1],"int32"===a.dtype&&"int32"===b.dtype)return b3(a,b);var f=f5(a.shape,b.shape);return ad.runKernelFunc(function(c,d){var e=c.realDivide(a,b);return d([a,b]),e},{a:a,b:b},function(b,a){var c=a[0],d=a[1];return{a:function(){var a=b.div(d.toFloat()),e=f4(c.shape,f);return 0<e.length?a.sum(e).reshape(c.shape):a},b:function(){var a=b.mul(c.toFloat()),e=f4(d.shape,f);0<e.length&&(a=a.sum(e).reshape(d.shape));var g=d.square();return a.div(g.toFloat()).neg()}}},"Div")}}),b1=a({divNoNan_:function(f,g){var c,a=kn(f,"a","div"),b=kn(g,"b","div");a=(c=eP(a,b))[0];var d=b0(a,b=c[1]),e=aA(d),h=b.equal(e);return bX(h,e,d)}}),b2=a({divStrict_:function(c,d){var a=kn(c,"a","div"),b=kn(d,"b","div");return d9(a.shape,b.shape,"Error in divideStrict: "),a.div(b)}}),b3=a({floorDiv_:function(d,e){var c,a=kn(d,"a","floorDiv"),b=kn(e,"b","floorDiv");a=(c=eP(a,b))[0],b=c[1];var f=f5(a.shape,b.shape);return ad.runKernelFunc(function(c,d){var e=c.floorDiv(a,b);return d([a,b]),e},{a:a,b:b},function(b,a){var c=a[0],d=a[1];return{a:function(){var a=b.div(d.toFloat()),e=f4(c.shape,f);return 0<e.length?a.sum(e).reshape(c.shape):a},b:function(){var a=b.mul(c.toFloat()),e=f4(d.shape,f);0<e.length&&(a=a.sum(e).reshape(d.shape));var g=d.square();return a.div(g.toFloat()).neg()}}},"FloorDiv")}}),b4=a({maximum_:function(d,e){var c,a=kn(d,"a","maximum"),b=kn(e,"b","maximum");return a=(c=eP(a,b))[0],b=c[1],"bool"===a.dtype&&(a=a.toInt(),b=b.toInt()),f5(a.shape,b.shape),ad.runKernelFunc(function(c,d){var e=c.maximum(a,b);return d([a,b]),e},{a:a,b:b},function(b,a){var c=a[0],d=a[1];return{a:function(){return b.mul(c.greaterEqual(d).toFloat())},b:function(){return b.mul(c.less(d).toFloat())}}},"Maximum")}}),b5=a({maximumStrict_:function(c,d){var a=kn(c,"a","maximumStrict"),b=kn(d,"b","maximumStrict");return d9(a.shape,b.shape,"Error in maximumStrict: "),a.maximum(b)}}),b6=a({minimum_:function(d,e){var c,a=kn(d,"a","minimum"),b=kn(e,"b","minimum");return a=(c=eP(a,b))[0],b=c[1],"bool"===a.dtype&&(a=a.toInt(),b=b.toInt()),f5(a.shape,b.shape),ad.runKernelFunc(function(c,d){var e=c.minimum(a,b);return d([a,b]),e},{a:a,b:b},function(b,a){var c=a[0],d=a[1];return{a:function(){return b.mul(c.lessEqual(d).toFloat())},b:function(){return b.mul(c.greater(d).toFloat())}}},"Minimum")}}),b7=a({minimumStrict_:function(c,d){var a=kn(c,"a","minimumStrict"),b=kn(d,"b","minimumStrict");return d9(a.shape,b.shape,"Error in minimumStrict: "),a.minimum(b)}}),b8=a({mod_:function(d,e){var c,a=kn(d,"a","mod"),b=kn(e,"b","mod");a=(c=eP(a,b))[0],b=c[1];var f=f5(a.shape,b.shape);return ad.runKernelFunc(function(c,d){var e=c.mod(a,b);return d([a,b]),e},{$a:a,$b:b},function(b,a){var c=a[0],d=a[1];return{$a:function(){var a=f4(c.shape,f);return 0<a.length?b.sum(a).reshape(c.shape):b},$b:function(){var a=b.mul(c.div(d).floor().neg()),e=f4(d.shape,f);return 0<e.length?a.sum(e).reshape(d.shape):a}}})}}),b9=a({modStrict_:function(c,d){var a=kn(c,"a","modStrict"),b=kn(d,"b","modStrict");return d9(a.shape,b.shape,"Error in modStrict: "),a.mod(b)}}),ca=a({mul_:function(d,e){var c,a=kn(d,"a","mul"),b=kn(e,"b","mul");a=(c=eP(a,b))[0],b=c[1];var f=f5(a.shape,b.shape);return ad.runKernelFunc(function(c,d){var e=c.multiply(a,b);return d([a,b]),e},{a:a,b:b},function(b,a){var c=a[0],d=a[1];return{a:function(){var a=b.mul(d.toFloat()),e=f4(c.shape,f);return 0<e.length?a.sum(e).reshape(c.shape):a},b:function(){var a=b.mul(c.toFloat()),e=f4(d.shape,f);return 0<e.length?a.sum(e).reshape(d.shape):a}}},"Mul")}}),cb=a({mulStrict_:function(c,d){var a=kn(c,"a","mul"),b=kn(d,"b","mul");return d9(a.shape,b.shape,"Error in multiplyStrict: "),a.mul(b)}}),cc=a({pow_:function(c,d){var a=kn(c,"base","pow"),b=kn(d,"exp","pow"),e=f5(a.shape,b.shape);return c=a.cast(eN(a.dtype,b.dtype)),d=b.cast(eN(a.dtype,b.dtype)),ad.runKernelFunc(function(d,e){var c=d.pow(a,b);return e([a,b,c]),c},{$base:a,$exp:b},function(b,a){var c=a[0],d=a[1],f=a[2];return{$base:function(){var f=d.toFloat(),a=b.mul(f.mul(c.pow(f.sub(am(1))))),g=f4(c.shape,e);return 0<g.length&&(a=a.sum(g)),a.reshape(c.shape)},$exp:function(){var h=c.greater(0),i=c.log().where(h,aA(c)),a=b.mul(f.mul(i)),g=f4(d.shape,e);return 0<g.length&&(a=a.sum(g)),a.reshape(d.shape)}}})}}),cd=a({powStrict_:function(a,b){return d9(a.shape,b.shape,"Error in powStrict: "),a.pow(b)}}),ce=a({squaredDifference_:function(d,e){var c,a=kn(d,"a","squaredDifference"),b=kn(e,"b","squaredDifference");return a=(c=eP(a,b))[0],b=c[1],f5(a.shape,b.shape),ad.runKernelFunc(function(c,d){var e=c.squaredDifference(a,b);return d([a,b]),e},{$a:a,$b:b},function(b,a){var c=a[0],d=a[1],e=am(2);return{$a:function(){return b.mul(c.sub(d).mul(e))},$b:function(){return b.mul(d.sub(c).mul(e))}}})}}),cf=a({squaredDifferenceStrict_:function(c,d){var a=kn(c,"a","squaredDifferenceStrict"),b=kn(d,"b","squaredDifferenceStrict");return d9(a.shape,b.shape,"Error in squaredDifferenceStrict: "),a.squaredDifference(b)}}),cg=a({sub_:function(d,e){var c,a=kn(d,"a","sub"),b=kn(e,"b","sub");a=(c=eP(a,b))[0],b=c[1];var f=f5(a.shape,b.shape);return ad.runKernelFunc(function(c){return c.subtract(a,b)},{a:a,b:b},function(c){return{a:function(){var b=c,d=f4(a.shape,f);return 0<d.length&&(b=b.sum(d)),b.reshape(a.shape)},b:function(){var a=c,d=f4(b.shape,f);return 0<d.length&&(a=a.sum(d)),a.neg().reshape(b.shape)}}},"Sub")}}),ch=a({subStrict_:function(c,d){var a=kn(c,"a","subStrict"),b=kn(d,"b","subStrict");return d9(a.shape,b.shape,"Error in subStrict: "),a.sub(b)}}),ci=a({equal_:function(d,e){var c,a=kn(d,"a","equal"),b=kn(e,"b","equal");return a=(c=eP(a,b))[0],b=c[1],f5(a.shape,b.shape),ad.runKernelFunc(function(c){return c.equal(a,b)},{$a:a,$b:b})}}),cj=a({equalStrict_:function(c,d){var a=kn(c,"a","equalStrict"),b=kn(d,"b","equalStrict");return d9(a.shape,b.shape,"Error in equalStrict: "),a.equal(b)}}),ck=a({greater_:function(d,e){var c,a=kn(d,"a","greater"),b=kn(e,"b","greater");return a=(c=eP(a,b))[0],b=c[1],f5(a.shape,b.shape),ad.runKernelFunc(function(c){return c.greater(a,b)},{a:a,b:b},null,"Greater")}}),cl=a({greaterEqual_:function(d,e){var c,a=kn(d,"a","greaterEqual"),b=kn(e,"b","greaterEqual");return a=(c=eP(a,b))[0],b=c[1],f5(a.shape,b.shape),ad.runKernelFunc(function(c,d){var e=c.greaterEqual(a,b);return d([a,b]),e},{a:a,b:b},function(b,a){var c=a[0],d=a[1];return{a:function(){return aA(c)},b:function(){return aA(d)}}},"GreaterEqual")}}),cm=a({greaterEqualStrict_:function(c,d){var a=kn(c,"a","greaterEqualStrict"),b=kn(d,"b","greaterEqualStrict");return d9(a.shape,b.shape,"Error in greaterEqualStrict: "),a.greaterEqual(b)}}),cn=a({greaterStrict_:function(c,d){var a=kn(c,"a","greaterStrict"),b=kn(d,"b","greaterStrict");return d9(a.shape,b.shape,"Error in greaterStrict: "),a.greater(b)}}),co=a({less_:function(d,e){var c,a=kn(d,"a","less"),b=kn(e,"b","less");return a=(c=eP(a,b))[0],b=c[1],f5(a.shape,b.shape),ad.runKernelFunc(function(c){return c.less(a,b)},{a:a,b:b},null,"Less")}}),cp=a({lessEqual_:function(d,e){var c,a=kn(d,"a","lessEqual"),b=kn(e,"b","lessEqual");return a=(c=eP(a,b))[0],b=c[1],f5(a.shape,b.shape),ad.runKernelFunc(function(c,d){var e=c.lessEqual(a,b);return d([a,b]),e},{a:a,b:b},null,"LessEqual")}}),cq=a({lessEqualStrict_:function(c,d){var a=kn(c,"a","lessEqualStrict"),b=kn(d,"b","lessEqualStrict");return d9(a.shape,b.shape,"Error in lessEqualStrict: "),a.lessEqual(b)}}),cr=a({lessStrict_:function(c,d){var a=kn(c,"a","lessStrict"),b=kn(d,"b","lessStrict");return d9(a.shape,b.shape,"Error in lessStrict: "),a.less(b)}}),cs=a({notEqual_:function(d,e){var c,a=kn(d,"a","notEqual"),b=kn(e,"b","notEqual");return a=(c=eP(a,b))[0],b=c[1],f5(a.shape,b.shape),ad.runKernelFunc(function(c){return c.notEqual(a,b)},{$a:a,$b:b})}}),ct=a({notEqualStrict_:function(c,d){var a=kn(c,"a","notEqualStrict"),b=kn(d,"b","notEqualStrict");return d9(a.shape,b.shape,"Error in notEqualStrict: "),a.notEqual(b)}});function mV(c,d){for(var b=[],a=c;a<d;++a)b.push(a);return b}function mW(b){for(var d=[],a=0;a<b.length;++a)for(var c=0;c<b[a].length;++c)d.push(b[a][c]);return d}function cu(a,b,c){return jL(this,void 0,void 0,function(){var d,e,f,g,h,i,j,k,l,m,n,o,p;return jM(this,function(q){switch(q.label){case 0:for(d=kn(a,"tensor","boolMask"),e=kn(b,"mask","boolMask","bool"),f=null==c?0:c,g=e.rank,h=d.shape,d8(0<g,function(){return"mask cannot be scalar"}),d9(h.slice(f,f+g),e.shape,"mask's shape must match the first K dimensions of tensor's shape,"),i=1,j=f;j<f+g;j++)i*=h[j];return k=h.slice(0,f).concat([i],h.slice(f+g)),l=d.reshape(k),[4,bK(m=e.reshape([-1]))];case 1:return p=cv(l,o=(n=q.sent()).squeeze([1]),f),a!==d&&d.dispose(),b!==e&&e.dispose(),o.dispose(),l.dispose(),m.dispose(),n.dispose(),[2,p]}})})}var cv=a({gather_:function(d,e,a){void 0===a&&(a=0);var b=kn(d,"x","gather"),c=kn(e,"indices","gather","int32");a=ek(a,b.shape)[0];var f=function(b,e,d){for(var h=b.shape[d],c=[],f=1,g=1,a=0;a<d;a++)c.push(b.shape[a]),f*=b.shape[a];for(a=0;a<e.rank;a++)c.push(e.shape[a]);for(a=d+1;a<b.rank;a++)c.push(b.shape[a]),g*=b.shape[a];return{batchSize:f,sliceSize:g,dimSize:h,outputShape:c}}(b,c,a);return ad.runKernelFunc(function(d,e){var f=d.gather(b,c.flatten(),a);return e([c]),f},{x:b,indices:c},function(d,c){var e=c[0];return{x:function(){var f=b.shape,g=e.size,h=f.slice(0,a),c=h.length,i=f.slice(a,f.length).slice(1),k=i.length,l=mV(0,c),m=mV(c+1,c+1+k),n=mW([h,[g],i]),o=d.reshape(n),p=e.reshape([g]),j=mW([[c],l,m]),q=o.transpose(j),r=cw(q,p,b.shape[a]),s=fD(j);return r.transpose(s)},indices:function(){return e}}},"Gather",{axis:a}).reshape(f.outputShape)}}),cw=a({unsortedSegmentSum_:function(a,b,c){var d=kn(a,"x","unsortedSegmentSum"),e=kn(b,"segmentIds","unsortedSegmentSum","int32");return d8(ee(c),function(){return"numSegments must be of dtype int"}),ad.runKernelFunc(function(a,b){var f=a.unsortedSegmentSum(d,e,c);return b([e]),f},{$x:d},function(b,a){var c=a[0];return{$x:function(){return function(e,c){for(var f=b4(c,aA(c)),b=cv(e,f),a=cl(c,am(0,"int32")),g=b.rank-a.rank,d=0;d<g;++d)a=aQ(a,d+1);a=bT(a,au(b.shape,"bool"));var h=aA(b);return bX(a,b,h)}(b,c)}}})}});function gG(b,a,c,k,h,d,i){void 0===d&&(d="NHWC"),d8(b.length===a.rank,function(){return"Length of inShape ("+b.length+") and rank of dy ("+a.rank+") must match"});var e=b,f=a,j=!1;3===a.rank&&(j=!0,f=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]),e=[1,b[0],b[1],b[2]]),d8(4===e.length,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+e.length+"."}),d8(4===f.rank,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+f.rank}),d8(4===c.rank,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+c.rank});var l="NHWC"===d?e[3]:e[1],m="NHWC"===d?f.shape[3]:f.shape[1];d8(l===c.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+l+") must match input depth for filter "+c.shape[2]+"."}),d8(m===c.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+m+") must match output depth for filter "+c.shape[3]+"."}),null!=i&&d8(ee(h),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+h+"."});var n=gd(d),o=f8(e,c.shape,k,1,h,i,!1,n),g=ad.runKernelFunc(function(a,b){var d=a.conv2dDerInput(f,c,o);return b([c,f]),d},{dy4D:f,filter:c},function(b,a){var c=a[0],e=a[1];return{dy4D:function(){return cy(b,c,k,h,d,1,i)},filter:function(){return mZ(b,e,c.shape,k,h,d,i)}}});return j?g.as3D(g.shape[1],g.shape[2],g.shape[3]):g}function mX(c){var a,b="number"==typeof(a=c)?[a,a,a]:2===a.length?[a[0],a[1],1]:a,d=b[0],e=b[1],f=b[2];return 1===d&&1===e&&1===f}function mY(b,a,d,h,i){d8(b.length===a.rank,function(){return"Length of inShape ("+b.length+") and rank of dy ("+a.rank+") must match"});var e=b,f=a,g=!1;4===a.rank&&(g=!0,f=a.as5D(1,a.shape[0],a.shape[1],a.shape[2],a.shape[3]),e=[1,b[0],b[1],b[2],b[3]]);var j=e[4],k=f.shape[4];d8(5===e.length,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+e.length+"."}),d8(5===f.rank,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+f.rank}),d8(5===d.rank,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+d.rank}),d8(j===d.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+j+") must match input depth for filter "+d.shape[3]+"."}),d8(k===d.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+k+") must match output depth for filter "+d.shape[4]+"."});var l=f9(e,d.shape,h,1,i),c=ad.runKernelFunc(function(a){return a.conv3dDerInput(f,d,l)},{dy5D:f});return g?c.as4D(c.shape[1],c.shape[2],c.shape[3],c.shape[4]):c}var cx=a({conv1d_:function(k,l,g,h,f,e,i){void 0===f&&(f="NWC"),void 0===e&&(e=1);var d=kn(k,"x","conv1d"),c=kn(l,"filter","conv1d"),a=d,j=!1;2===d.rank&&(j=!0,a=d.as3D(1,d.shape[0],d.shape[1])),d8(3===a.rank,function(){return"Error in conv1d: input must be rank 3, but got rank "+a.rank+"."}),d8(3===c.rank,function(){return"Error in conv1d: filter must be rank 3, but got rank "+c.rank+"."}),null!=i&&d8(ee(h),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+h+"."}),d8(a.shape[2]===c.shape[1],function(){return"Error in conv1d: depth of input ("+a.shape[2]+") must match input depth for filter "+c.shape[1]+"."}),d8(gc(g,e),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+g+" and dilation '"+e+"'"}),d8("NWC"===f,function(){return"Error in conv1d: got dataFormat of "+f+" but only NWC is currently supported."});var m=c.as4D(1,c.shape[0],c.shape[1],c.shape[2]),b=cy(a.as4D(a.shape[0],1,a.shape[1],a.shape[2]),m,[1,g],h,"NHWC",[1,e],i);return j?b.as2D(b.shape[2],b.shape[3]):b.as3D(b.shape[0],b.shape[2],b.shape[3])}}),cy=a({conv2d_:function(k,l,g,h,e,f,i){void 0===e&&(e="NHWC"),void 0===f&&(f=[1,1]);var b=kn(k,"x","conv2d"),c=kn(l,"filter","conv2d"),a=b,j=!1;3===b.rank&&(j=!0,a=b.as4D(1,b.shape[0],b.shape[1],b.shape[2])),d8(4===a.rank,function(){return"Error in conv2d: input must be rank 4, but got rank "+a.rank+"."}),d8(4===c.rank,function(){return"Error in conv2d: filter must be rank 4, but got rank "+c.rank+"."}),null!=i&&d8(ee(h),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+h+"."});var m="NHWC"===e?a.shape[3]:a.shape[1];d8(m===c.shape[2],function(){return"Error in conv2d: depth of input ("+m+") must match input depth for filter "+c.shape[2]+"."}),d8(gc(g,f),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+g+" and dilations '"+f+"'"});var n=gd(e),o=f8(a.shape,c.shape,g,f,h,i,!1,n),p=[c,a],d=ad.runKernelFunc(function(b,d){var e=b.conv2d(a,c,o);return d([c,a]),e},{x:a,filter:c},function(c,b){var a=b,d=a[0],i=a[1];return d8(gb(f),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+f+"'"}),{x:function(){return m$(i.shape,c,d,g,h,e)},filter:function(){return mZ(i,c,d.shape,g,h,e)}}},"Conv2D",o,p);return j?d.as3D(d.shape[1],d.shape[2],d.shape[3]):d}}),cz=a({conv3d_:function(j,k,g,l,f,d){void 0===f&&(f="NDHWC"),void 0===d&&(d=[1,1,1]);var h,a=kn(j,"x","conv3d"),e=kn(k,"filter","conv3d"),c=a,i=!1;4===a.rank&&(i=!0,c=a.as5D(1,a.shape[0],a.shape[1],a.shape[2],a.shape[3])),d8(5===c.rank,function(){return"Error in conv3d: input must be rank 5, but got rank "+c.rank+"."}),d8(5===e.rank,function(){return"Error in conv3d: filter must be rank 5, but got rank "+e.rank+"."}),d8(c.shape[4]===e.shape[3],function(){return"Error in conv3d: depth of input ("+c.shape[4]+") must match input depth for filter "+e.shape[3]+"."}),d8((h=d,mX(g)||mX(h)),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+g+" and dilations '"+d+"'"}),d8("NDHWC"===f,function(){return"Error in conv3d: got dataFormat of "+f+" but only NDHWC is currently supported."});var m=f9(c.shape,e.shape,g,d,l),b=ad.runKernelFunc(function(a,b){var d=a.conv3d(c,e,m);return b([c,e]),d},{x:c,$filter:e},function(b,a){d8(mX(d),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+d+"'"});var c=a[0],e=a[1];return{x:function(){return mY(c.shape,b,e,g,l)},$filter:function(){var a,d,i,j,k,f,h,m;return a=c,d=b,i=e.shape,j=g,k=l,f=a,4===a.rank&&(f=a.as5D(1,a.shape[0],a.shape[1],a.shape[2],a.shape[3])),h=d,4===h.rank&&(h=d.as5D(1,d.shape[0],d.shape[1],d.shape[2],d.shape[3])),d8(5===f.rank,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+f.shape+"."}),d8(5===h.rank,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+h.shape+"."}),d8(5===i.length,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+i+"."}),d8(f.shape[4]===i[3],function(){return"Error in conv3dDerFilter: depth of input "+f.shape[4]+") must match input depth in filter ("+i[3]+"."}),d8(h.shape[4]===i[4],function(){return"Error in conv3dDerFilter: depth of dy ("+h.shape[4]+") must match output depth for filter ("+i[4]+")."}),m=f9(f.shape,i,j,1,k),ad.runKernelFunc(function(a){return a.conv3dDerFilter(f,h,m)},{x5D:f,dy5D:h})}}});return i?b.as4D(b.shape[1],b.shape[2],b.shape[3],b.shape[4]):b}}),mZ=a({conv2dDerFilter_:function(a,d,f,i,g,e,h){void 0===e&&(e="NHWC");var b=a;3===a.rank&&(b=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var c=d;3===c.rank&&(c=d.as4D(1,d.shape[0],d.shape[1],d.shape[2])),d8(4===b.rank,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+b.shape+"."}),d8(4===c.rank,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+c.shape+"."}),d8(4===f.length,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+f+"."});var j="NHWC"===e?b.shape[3]:b.shape[1],k="NHWC"===e?c.shape[3]:c.shape[1];d8(j===f[2],function(){return"Error in conv2dDerFilter: depth of input "+j+") must match input depth in filter ("+f[2]+"."}),d8(k===f[3],function(){return"Error in conv2dDerFilter: depth of dy ("+k+") must match output depth for filter ("+f[3]+")."}),null!=h&&d8(ee(g),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+h+" but got pad "+g+"."});var l=gd(e),m=f8(b.shape,f,i,1,g,h,!1,l);return ad.runKernelFunc(function(a){return a.conv2dDerFilter(b,c,m)},{x4D:b,dy4D:c})}}),m$=a({conv2dDerInput_:gG}),cA=a({depthwiseConv2d_:function(j,k,f,g,n,a,h){void 0===a&&(a=[1,1]);var b=kn(j,"x","depthwiseConv2d"),d=kn(k,"filter","depthwiseConv2d"),c=b,i=!1;3===b.rank&&(i=!0,c=b.as4D(1,b.shape[0],b.shape[1],b.shape[2])),d8(4===c.rank,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+c.rank+"."}),d8(4===d.rank,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+d.rank+"."}),d8(c.shape[3]===d.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+c.shape[3]+") must match the inChannels dimension in filter "+d.shape[2]+"."}),null==a&&(a=[1,1]),d8(gc(f,a),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+f+" and dilations '"+a+"'"}),null!=h&&d8(ee(g),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+h+" but got pad "+g+"."});var l=f8(c.shape,d.shape,f,a,g,h,!0),m=[c,d],e=ad.runKernelFunc(function(a,b){var e=a.depthwiseConv2D(c,d,l);return b([c,d]),e},{x:c,filter:d},function(c,b){d8(gb(a),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+a+"'"});var d=b[0],e=b[1];return{x:function(){return m_(d.shape,c,e,l)},filter:function(){return m0(d,c,e.shape,l)}}},"DepthwiseConv2dNative",l,m);return i?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}}),m_=a({depthwiseConv2dDerInput_:function(e,a,f,g){var c=a,d=!1;3===a.rank&&(d=!0,c=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var b=ad.runKernelFunc(function(a){return a.depthwiseConv2DDerInput(c,f,g)},{dy4D:c});return d?b.as3D(b.shape[1],b.shape[2],b.shape[3]):b}}),m0=a({depthwiseConv2dDerFilter_:function(a,b,e,f){var d=a;3===a.rank&&(d=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var c=b;return 3===c.rank&&(c=b.as4D(1,b.shape[0],b.shape[1],b.shape[2])),ad.runKernelFunc(function(a){return a.depthwiseConv2DDerFilter(d,c,f)},{x4D:d,dy4D:c})}}),cB=a({separableConv2d_:function(i,j,k,l,m,f,b){void 0===f&&(f=[1,1]),void 0===b&&(b="NHWC");var a=kn(i,"x","separableConv2d"),e=kn(j,"depthwiseFilter","separableConv2d"),c=kn(k,"pointwiseFilter","separableConv2d"),g=a,h=!1;if(3===a.rank&&(h=!0,g=a.as4D(1,a.shape[0],a.shape[1],a.shape[2])),"NCHW"===b)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");d8(4===g.rank,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+g.rank+"."}),d8(4===e.rank,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+e.rank+"."}),d8(4===c.rank,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+e.rank+"."}),d8(1===c.shape[0],function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+c.shape[0]+"."}),d8(1===c.shape[1],function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+c.shape[1]+"."});var n=e.shape[2],o=e.shape[3];d8(c.shape[2]===n*o,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+n*o+", but got "+c.shape[2]+"."});var p=cA(g,e,l,m,b,f),d=cy(p,c,1,"valid",b);return h?d.as3D(d.shape[1],d.shape[2],d.shape[3]):d}}),cC=a({conv2dTranspose_:function(a,b,c,d,e,f){return gG(c,kn(a,"x","conv2dTranspose"),kn(b,"filter","conv2dTranspose"),d,e,"NHWC",f)}}),cD=a({conv3dTranspose_:function(a,b,c,d,e){return mY(c,kn(a,"x","conv3dTranspose"),kn(b,"filter","conv3dTranspose"),d,e)}}),cE=a({matMul_:function(n,o,c,d){void 0===c&&(c=!1),void 0===d&&(d=!1);var i,a=kn(n,"a","matMul"),b=kn(o,"b","matMul");a=(i=eP(a,b))[0],b=i[1];var e=c?a.shape[a.rank-2]:a.shape[a.rank-1],f=d?b.shape[b.rank-1]:b.shape[b.rank-2],g=c?a.shape[a.rank-1]:a.shape[a.rank-2],h=d?b.shape[b.rank-2]:b.shape[b.rank-1],j=a.shape.slice(0,-2),k=b.shape.slice(0,-2),l=ec(j),m=ec(k);d8(2<=a.rank&&2<=b.rank&&a.rank===b.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+a.rank+" and "+b.rank+"."}),d8(ed(j,k),function(){return"Error in matMul: outer dimensions ("+j+") and ("+k+") of Tensors with shapes "+a.shape+" and "+b.shape+" must match."}),d8(e===f,function(){return"Error in matMul: inner shapes ("+e+") and ("+f+") of Tensors with shapes "+a.shape+" and "+b.shape+" and transposeA="+c+" and transposeB="+d+" must match."});var p=a.shape.slice(0,-2).concat([g,h]),q=c?a.as3D(l,e,g):a.as3D(l,g,e),r=d?b.as3D(m,h,f):b.as3D(m,f,h),s={transposeA:c,transposeB:d};return ad.runKernelFunc(function(a,b){var e=a.batchMatMul(q,r,c,d);return b([q,r]),e},{a:q,b:r},function(e,b){var a=b,f=a[0],g=a[1];return c||d?!c&&d?{a:function(){return e.matMul(g,!1,!1)},b:function(){return e.matMul(f,!0,!1)}}:c&&!d?{a:function(){return g.matMul(e,!1,!0)},b:function(){return f.matMul(e,!1,!1)}}:{a:function(){return g.matMul(e,!0,!0)},b:function(){return e.matMul(f,!0,!0)}}:{a:function(){return e.matMul(g,!1,!0)},b:function(){return f.matMul(e,!0,!1)}}},"BatchMatMul",s).reshape(p)}}),cF=a({dot_:function(c,d){var b=kn(c,"t1","dot"),a=kn(d,"t2","dot");d8(!(1!==b.rank&&2!==b.rank||1!==a.rank&&2!==a.rank),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+b.rank+" and "+a.rank+"."});var e=1===b.rank?b.size:b.shape[1],f=1===a.rank?a.size:a.shape[0];return d8(e===f,function(){return"Error in dot: inner dimensions of inputs must match, but got "+e+" and "+f+"."}),1===b.rank&&1===a.rank?b.as2D(1,-1).matMul(a.as2D(-1,1)).asScalar():1===b.rank&&2===a.rank?b.as2D(1,-1).matMul(a.as2D(a.shape[0],a.shape[1])).as1D():2===b.rank&&1===a.rank?b.matMul(a.as2D(-1,1)).as1D():b.matMul(a.as2D(a.shape[0],a.shape[1]))}}),cG=a({outerProduct_:function(c,d){var a=kn(c,"v1","outerProduct"),b=kn(d,"v2","outerProduct");return d8(1===a.rank&&1===b.rank,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+a.rank+" and "+b.rank+"."}),a.as2D(-1,1).matMul(b.as2D(1,-1))}}),cH=a({reverse_:function(b,c){var a=kn(b,"x","reverse");if(0===a.rank)return a.clone();var d=ek(c,a.shape);return ad.runKernelFunc(function(b){return b.reverse(a,d)},{$x:a},function(a){return{$x:function(){return a.reverse(d)}}}).reshapeAs(a)}}),cI=a({reverse1d_:function(b){var a=kn(b,"x","reverse");return d8(1===a.rank,function(){return"Error in reverse1D: x must be rank 1 but got rank "+a.rank+"."}),cH(a,0)}}),cJ=a({reverse2d_:function(b,c){var a=kn(b,"x","reverse");return d8(2===a.rank,function(){return"Error in reverse2D: x must be rank 2 but got rank "+a.rank+"."}),cH(a,c)}}),cK=a({reverse3d_:function(b,c){var a=kn(b,"x","reverse");return d8(3===a.rank,function(){return"Error in reverse3D: x must be rank 3 but got rank "+a.rank+"."}),cH(a,c)}}),cL=a({reverse4d_:function(b,c){var a=kn(b,"x","reverse");return d8(4===a.rank,function(){return"Error in reverse4D: x must be rank 4 but got rank "+a.rank+"."}),cH(a,c)}});function m1(j,k,f,e,g,h){var a=kn(j,"x","maxPool"),b=a,i=!1;3===a.rank&&(i=!0,b=a.as4D(1,a.shape[0],a.shape[1],a.shape[2])),null==e&&(e=[1,1]),d8(4===b.rank,function(){return"Error in maxPool: input must be rank 4 but got rank "+b.rank+"."}),d8(gc(f,e),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+f+" and dilations '"+e+"'"}),null!=h&&d8(ee(g),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+h+" but got pad "+g+"."});var c=f6(b.shape,k,f,e,g,h);if(1===c.filterWidth&&1===c.filterHeight&&ed(c.inShape,c.outShape))return a.clone();var l=[b],d=ad.runKernelFunc(function(d,e){var a=d.maxPool(b,c);return e([b,a]),a},{x:b},function(b,a){var c=a[0],d=a[1];return{x:function(){var l,m,n,j,a,o,i,h,p,q;return l=c,m=d,n=k,j=f,a=e,o=g,i=kn(b,"dy","maxPoolBackprop"),h=kn(l,"input","maxPoolBackprop"),p=kn(m,"output","maxPoolBackprop"),d8(h.rank===i.rank,function(){return"Rank of input ("+h.rank+") does not match rank of dy ("+i.rank+")"}),null==a&&(a=[1,1]),d8(gc(j,a),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+j+" and dilations '"+a+"'"}),d8(4===i.rank,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+i.rank+"."}),d8(4===h.rank,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+h.rank+"."}),q=f6(h.shape,n,j,a,o,void 0),ad.runKernelFunc(function(a){return a.maxPoolBackprop(i,h,p,q)},{$dy:i,$input:h})}}},"MaxPool",c,l);return i?d.as3D(d.shape[1],d.shape[2],d.shape[3]):d}function m2(j,k,f,d,g,h){var a=kn(j,"x","avgPool","float32");null==d&&(d=[1,1]),d8(gc(f,d),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+f+" and dilations '"+d+"'"});var e=a,i=!1;3===a.rank&&(i=!0,e=a.as4D(1,a.shape[0],a.shape[1],a.shape[2])),d8(4===e.rank,function(){return"Error in avgPool: x must be rank 4 but got rank "+e.rank+"."}),null!=h&&d8(ee(g),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+h+" but got pad "+g+"."});var c=f6(e.shape,k,f,d,g,h);if(1===c.filterWidth&&1===c.filterHeight&&ed(c.inShape,c.outShape))return a.clone();var b=ad.runKernelFunc(function(a){return a.avgPool(e,c)},{x:e},function(a){return{x:function(){var o,p,m,i,q,c,b,j,l,n,r,h;return o=e,p=k,m=f,i=d,q=g,c=kn(a,"dy","avgPoolBackprop"),b=kn(o,"input","avgPoolBackprop"),d8(b.rank===c.rank,function(){return"Rank of input ("+b.rank+") does not match rank of dy ("+c.rank+")"}),null==i&&(i=[1,1]),d8(gc(m,i),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+m+" and dilations '"+i+"'"}),j=b,l=c,n=!1,3===b.rank&&(n=!0,j=b.as4D(1,b.shape[0],b.shape[1],b.shape[2]),l=c.as4D(1,c.shape[0],c.shape[1],c.shape[2])),d8(4===l.rank,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+l.rank+"."}),d8(4===j.rank,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+j.rank+"."}),r=f6(j.shape,p,m,i,q),h=ad.runKernelFunc(function(a){return a.avgPoolBackprop(l,j,r)},{dy4D:l,input4D:j}),n?h.as3D(h.shape[1],h.shape[2],h.shape[3]):h}}},"AvgPool",c);return b=b.cast(a.dtype),i?b.as3D(b.shape[1],b.shape[2],b.shape[3]):b}var cM=a({maxPool_:function(a,b,c,d,e){return m1(a,b,c,1,d,e)}}),cN=a({avgPool_:function(a,b,c,d,e){return m2(a,b,c,1,d,e)}}),cO=a({pool_:function(u,v,w,d,f,g){null==f&&(f=[1,1]),null==g&&(g=1),0===d&&(d="valid");var a=kn(u,"x","maxPool"),h=a,m=!1;3===a.rank&&(m=!0,h=a.as4D(1,a.shape[0],a.shape[1],a.shape[2])),d8(gc(g,f),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+g+" and dilations '"+f+"'"});var n,o,x,j,y,z,b=f6(h.shape,v,g,f,d),c=[b.dilationHeight,b.dilationWidth];n="same"===d?(o=[b.filterHeight,b.filterWidth],x=c,y=(j=o.map(function(a,b){return a+(a-1)*(x[b]-1)}).map(function(a){return a-1})).map(function(a){return Math.floor(a/2)}),z=j.map(function(a,b){return a-y[b]}),j.map(function(b,a){return[y[a],z[a]]})):[[0,0],[0,0]];var p,i,q,r,k,A,B,_,l=1===c[0]&&1===c[1],s=(p=[b.inHeight,b.inWidth],i=c,r=(q=n).map(function(a){return a[0]}),k=q.map(function(a){return a[1]}),A=p.concat(r,k),B=i.map(function(a,b){return(a-A[b]%a)%a}),_=k.map(function(a,b){return a+B[b]}),[i.map(function(b,a){return[r[a],_[a]]}),i.map(function(b,a){return[0,B[a]]})]),C=s[1],D=l?d:"valid",E=l?h:a2(h,c,s[0]),t=("avg"===w?function(){return m2(E,v,g,1,D)}:function(){return m1(E,v,g,1,D)})(),e=l?t:aK(t,c,C);return m?e.as3D(e.shape[1],e.shape[2],e.shape[3]):e}}),cP=a({maxPool3d_:function(j,k,f,g,h,c,d){void 0===c&&(c="NDHWC");var a=kn(j,"x","maxPool3d"),e=a,i=!1;4===a.rank&&(i=!0,e=a.as5D(1,a.shape[0],a.shape[1],a.shape[2],a.shape[3])),null==d&&(d=[1,1,1]),d8(5===e.rank,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+e.rank+"."}),d8("NDHWC"===c,function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+c}),d8(gc(f,d),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+f+" and dilations '"+d+"'"}),null!=h&&d8(ee(g),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+h+" but got pad "+g+"."});var l=f7(e.shape,k,f,d,g,h,c),b=ad.runKernelFunc(function(b,c){var a=b.maxPool3d(e,l);return c([e,a]),a},{x:e},function(b,a){var c=a[0],e=a[1];return{x:function(){var u,v,w,p,m,q,r,i,a,j,o,n,s,t,x,l;return u=c,v=e,w=k,p=f,m=d,q=g,r=h,i=kn(b,"dy","maxPool3dBackprop"),a=kn(u,"input","maxPool3dBackprop"),j=kn(v,"output","maxPool3dBackprop"),o=i,n=a,s=j,t=!1,4===a.rank&&(t=!0,o=i.as5D(1,i.shape[0],i.shape[1],i.shape[2],i.shape[3]),n=a.as5D(1,a.shape[0],a.shape[1],a.shape[2],a.shape[3]),s=j.as5D(1,j.shape[0],j.shape[1],j.shape[2],j.shape[3])),d8(5===o.rank,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+o.rank+"."}),d8(5===n.rank,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+n.rank+"."}),d8(5===s.rank,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+s.rank+"."}),null==m&&(m=[1,1,1]),d8(gc(p,m),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+p+" and dilations '"+m+"'"}),null!=r&&d8(ee(q),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+r+" but got pad "+q+"."}),x=f7(n.shape,w,p,m,q,r),l=ad.runKernelFunc(function(a){return a.maxPool3dBackprop(o,n,s,x)},{dy5D:o,input5D:n}),t?l.as4D(l.shape[1],l.shape[2],l.shape[3],l.shape[4]):l}}});return i?b.as4D(b.shape[1],b.shape[2],b.shape[3],b.shape[4]):b}}),cQ=a({avgPool3d_:function(j,k,f,g,h,d,e){void 0===d&&(d="NDHWC");var b=kn(j,"x","avgPool3d","float32"),c=b,i=!1;4===b.rank&&(i=!0,c=b.as5D(1,b.shape[0],b.shape[1],b.shape[2],b.shape[3])),null==e&&(e=[1,1,1]),d8(5===c.rank,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+c.rank+"."}),d8("NDHWC"===d,function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+d}),d8(gc(f,e),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+f+" and dilations '"+e+"'"}),null!=h&&d8(ee(g),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+h+" but got pad "+g+"."});var l=f7(c.shape,k,f,e,g,h,d),a=ad.runKernelFunc(function(a){return a.avgPool3d(c,l)},{x:c},function(a){return{x:function(){var r,s,n,j,o,p,d,b,m,l,q,t,i;return r=c,s=k,n=f,j=e,o=g,p=h,d=kn(a,"dy","avgPool3dBackprop"),b=kn(r,"input","avgPool3dBackprop"),m=d,l=b,q=!1,4===b.rank&&(q=!0,m=d.as5D(1,d.shape[0],d.shape[1],d.shape[2],d.shape[3]),l=b.as5D(1,b.shape[0],b.shape[1],b.shape[2],b.shape[3])),d8(5===m.rank,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+m.rank+"."}),d8(5===l.rank,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+l.rank+"."}),null==j&&(j=[1,1,1]),d8(gc(n,j),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+j+"'"}),null!=p&&d8(ee(o),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+p+" but got pad "+o+"."}),t=f7(l.shape,s,n,j,o,p),i=ad.runKernelFunc(function(a){return a.avgPool3dBackprop(m,l,t)},{dy5D:m,input5D:l}),q?i.as4D(i.shape[1],i.shape[2],i.shape[3],i.shape[4]):i}}});return a=a.cast(c.dtype),i?a.as4D(a.shape[1],a.shape[2],a.shape[3],a.shape[4]):a}}),cR=a({slice_:function(f,c,b){var e,d,a=kn(f,"x","slice");if(0===a.rank)throw new Error("Slicing scalar is not possible");(e="number"==typeof c?[c].concat(new Array(a.rank-1).fill(0)):c.length<a.rank?c.concat(new Array(a.rank-c.length).fill(0)):c.slice()).forEach(function(a){d8(-1!==a,function(){return"slice() does not support negative begin indexing."})}),d=(d=null==b?new Array(a.rank).fill(-1):"number"==typeof b?[b].concat(new Array(a.rank-1).fill(-1)):b.length<a.rank?b.concat(new Array(a.rank-b.length).fill(-1)):b).map(function(b,c){return 0<=b?b:(d8(-1===b,function(){return"Negative size values should be exactly -1 but got "+b+" for the slice() size at index "+c+"."}),a.shape[c]-e[c])}),fU(a,e,d);var g=a.shape;return ad.runKernelFunc(function(b){return b.slice(a,e,d)},{x:a},function(b){for(var c=[],a=0;a<b.rank;a++)c.push([e[a],g[a]-e[a]-d[a]]);return{x:function(){return b.pad(c)}}},"Slice",{begin:e,size:d})}}),cS=a({slice1d_:function(b,c,d){var a=kn(b,"x","slice1d");return d8(1===a.rank,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+a.rank+" tensor"}),cR(a,[c],[d])}}),cT=a({slice2d_:function(b,c,d){var a=kn(b,"x","slice2d");return d8(2===a.rank,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+a.rank+" tensor"}),cR(a,c,d)}}),cU=a({slice3d_:function(b,c,d){var a=kn(b,"x","slice3d");return d8(3===a.rank,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+a.rank+" tensor"}),cR(a,c,d)}}),cV=a({slice4d_:function(b,c,d){var a=kn(b,"x","slice4d");return d8(4===a.rank,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+a.rank+" tensor"}),cR(a,c,d)}});function m3(a,b,c,d,e){return b.rank<c.rank&&(b=b.reshape(fA(b.shape,d))),a.rank<c.rank&&(a=a.reshape(fA(a.shape,d))),{x:function(){var d=a.mul(c.equal(b).cast(a.dtype));return null==e?d:d.transpose(e)}}}var cW=a({all_:function(h,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var a=kn(h,"x","all","bool"),f=ek(b,a.shape),d=f,g=fC(d,a.rank);null!=g&&(a=a.transpose(g),d=fE(d.length,a.rank));var e=ad.runKernelFunc(function(b){return b.all(a,d)},{$x:a});if(c){var i=fA(e.shape,f);return e.reshape(i)}return e}}),cX=a({any_:function(h,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var a=kn(h,"x","any","bool"),f=ek(b,a.shape),d=f,g=fC(d,a.rank);null!=g&&(a=a.transpose(g),d=fE(d.length,a.rank));var e=ad.runKernelFunc(function(b){return b.any(a,d)},{$x:a});if(c){var i=fA(e.shape,f);return e.reshape(i)}return e}}),cY=a({argMax_:function(e,b){void 0===b&&(b=0);var a=kn(e,"x","argMax");null==b&&(b=0);var c=ek(b,a.shape),d=fC(c,a.rank);null!=d&&(a=a.transpose(d),c=fE(c.length,a.rank));var f={axis:c[0]},g=[a];return ad.runKernelFunc(function(b,d){var e=b.argMax(a,c[0]);return d([a]),e},{x:a},function(b,a){var c=a[0];return{x:function(){return aA(c)}}},"ArgMax",f,g)}}),cZ=a({argMin_:function(e,b){void 0===b&&(b=0);var a=kn(e,"x","argMin");null==b&&(b=0);var c=ek(b,a.shape),d=fC(c,a.rank);return null!=d&&(a=a.transpose(d),c=fE(c.length,a.rank)),ad.runKernelFunc(function(b,d){var e=b.argMin(a,c[0]);return d([a]),e},{$x:a},function(b,a){var c=a[0];return{$x:function(){return aA(c)}}})}}),c$=a({logSumExp_:function(h,a,b){void 0===a&&(a=null),void 0===b&&(b=!1);var c=kn(h,"x","logSumExp"),d=ek(a,c.shape),f=c.max(d,!0),g=c.sub(f).exp().sum(d).log(),e=f.reshape(g.shape).add(g);if(b){var i=fA(e.shape,d);return e.reshape(i)}return e}}),c_=a({max_:function(h,d,e){void 0===d&&(d=null),void 0===e&&(e=!1);var a=kn(h,"x","max"),k=a,f=ek(d,a.shape),b=f,g=fC(b,a.rank);null!=g&&(a=a.transpose(g),b=fE(b.length,a.rank));var i=[a],c=ad.runKernelFunc(function(d,e){var c=d.max(a,b);return e([k,c]),c},{x:a},function(b,a){return m3(b,a[1],a[0],f,g)},"Max",{axes:b},i,[!0]);if(e){var j=fA(c.shape,f);c=c.reshape(j)}return c}}),c0=a({mean_:function(d,a,c){void 0===a&&(a=null),void 0===c&&(c=!1);var b=kn(d,"x","mean"),e=ek(a,b.shape),f=ec(fz(b.shape,e)[1]);return f1(function(b){var d=am(f);return{value:(d.dtype===b.dtype?b:b.cast(d.dtype)).div(d).sum(a,c),gradFunc:function(a){var c=b.shape.slice();return e.forEach(function(a){c[a]=1}),a.reshape(c).mul(au(b.shape,"float32")).div(f)}}})(b)}}),c1=a({min_:function(h,d,e){void 0===d&&(d=null),void 0===e&&(e=!1);var a=kn(h,"x","min"),k=a,f=ek(d,a.shape),b=f,g=fC(b,a.rank);null!=g&&(a=a.transpose(g),b=fE(b.length,a.rank));var i=[a],c=ad.runKernelFunc(function(d,e){var c=d.min(a,b);return e([k,c]),c},{x:a},function(b,a){return m3(b,a[1],a[0],f,g)},"Min",{axes:b},i,[!0]);if(e){var j=fA(c.shape,f);c=c.reshape(j)}return c}}),c2=a({moments_:function(b,d,a){void 0===d&&(d=null),void 0===a&&(a=!1);var e=ek(d,(b=kn(b,"x","moments")).shape),c=b.mean(e,a),f=c.shape;a||(f=fA(c.shape,e));var g=b.toFloat().sub(c.reshape(f)).square();return{mean:c,variance:g.mean(e,a)}}}),c3=a({sum_:function(d,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var a=kn(d,"x","sum");"bool"===a.dtype&&(a=a.toInt());var e=ek(b,a.shape);return f1(function(a){var f=fC(e,a.rank),d=e,g=a;function h(b){var c=a.shape.slice();return e.forEach(function(a){c[a]=1}),b.reshape(c).mul(au(a.shape,"float32"))}null!=f&&(g=a.transpose(f),d=fE(d.length,a.rank));var i={axes:d},b=ad.runKernelFunc(function(a){return a.sum(g,d)},{x:g},function(a){return{x:function(){return h(a)}}},"Sum",i);if(c){var j=fA(b.shape,e);b=b.reshape(j)}return{value:b,gradFunc:h}})(a)}}),c4=a({prod_:function(i,c,d){void 0===c&&(c=null),void 0===d&&(d=!1);var a=kn(i,"x","prod");"bool"===a.dtype&&(a=a.toInt());var e=ek(c,a.shape),f=fC(e,a.rank),g=e,h=a;null!=f&&(h=a.transpose(f),g=fE(g.length,a.rank));var b=ad.runKernelFunc(function(a){return a.prod(h,g)},{permutedX:h});if(d){var j=fA(b.shape,e);b=b.reshape(j)}return b}}),c5=a({elu_:function(a){var b=kn(a,"x","elu");return ad.runKernelFunc(function(c,d){var a=c.elu(b);return d([a]),a},{$x:b},function(b,a){var c=a[0];return{$x:function(){return ad.runKernelFunc(function(a){return a.eluDer(b,c)},{dy:b,y:c})}}})}}),c6=a({leakyRelu_:function(c,a){void 0===a&&(a=.2);var b=kn(c,"x","leakyRelu");return b4(am(a).mul(b),b)}}),c7=a({prelu_:function(a,b){var c=kn(a,"x","prelu"),d=kn(b,"alpha","prelu");return ad.runKernelFunc(function(a,b){var e=a.prelu(c,d);return b([c,d]),e},{x:c,alpha:d},function(c,a){var b=a[0],d=a[1],e=b.greater(0);return{x:function(){return bX(e,c,c.mul(d))},alpha:function(){var a=bX(e,aA(c),c.mul(b)),f=f4(d.shape,c.shape);return 0<f.length&&(a=a.sum(f)),a.reshape(d.shape)}}},"Prelu")}}),c8=a({relu_:function(b){var a=kn(b,"x","relu");return"bool"===a.dtype?a.toInt():ad.runKernelFunc(function(b,c){var d=b.relu(a);return c([a]),d},{x:a},function(b,a){var c=a[0];return{x:function(){return b.mulStrict(c.step().toFloat())}}},"Relu")}}),c9=a({relu6_:function(b){var a=kn(b,"x","relu6");return"bool"===a.dtype?a.toInt():ad.runKernelFunc(function(b,c){var d=b.relu6(a);return c([a]),d},{x:a},function(c,b){var a=b[0],d=a.lessEqual(6).mul(a.step());return{x:function(){return c.mulStrict(d.toFloat())}}},"Relu6")}}),da=a({selu_:function(a){var b=kn(a,"x","selu");return ad.runKernelFunc(function(a,c){var d=a.selu(b);return c([b]),d},{$x:b},function(b,a){var c=a[0];return{$x:function(){var a=c.greater(am(0)),d=am(mB),e=am(mC),f=b.mul(e),g=b.mul(d).mul(c.toFloat().exp());return bX(a,f,g)}}})}}),db=a({transpose_:function(c,a){var b=kn(c,"x","transpose");if(null==a&&(a=b.shape.map(function(b,a){return a}).reverse()),d8(b.rank===a.length,function(){return"Error in transpose: rank of input "+b.rank+" must match length of perm "+a+"."}),a.forEach(function(c){d8(0<=c&&c<b.rank,function(){return"All entries in 'perm' must be between 0 and "+(b.rank-1)+" but got "+a})}),b.rank<=1)return b.clone();var d={perm:a};return ad.runKernelFunc(function(c){return c.transpose(b,a)},{x:b},function(b){var c=fD(a);return{x:function(){return b.transpose(c)}}},"Transpose",d)}}),dc=a({localResponseNormalization_:function(i,c,d,e,f){void 0===c&&(c=5),void 0===d&&(d=1),void 0===e&&(e=1),void 0===f&&(f=.5);var a=kn(i,"x","localResponseNormalization");d8(4===a.rank||3===a.rank,function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+a.rank+"."}),d8(ee(c),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+c+"."});var g=a,h=!1;3===a.rank&&(h=!0,g=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var b=ad.runKernelFunc(function(b,h){var a=b.localResponseNormalization4D(g,c,d,e,f);return h([g,a]),a},{x4D:g},function(b,a){var g=a[0],h=a[1];return{x4D:function(){return ad.runKernelFunc(function(a){return a.LRNGrad(b,g,h,c,d,e,f)},{})}}});return h?b.as3D(b.shape[1],b.shape[2],b.shape[3]):b}}),dd=a({norm_:function(b,c,a,d){void 0===c&&(c="euclidean"),void 0===a&&(a=null),void 0===d&&(d=!1);var e=function d(b,c,a){if(void 0===a&&(a=null),0===b.rank)return b.abs();if(1!==b.rank&&null===a)return d(b.reshape([-1]),c,a);if(1===b.rank||"number"==typeof a||Array.isArray(a)&&1===a.length){if(1===c)return b.abs().sum(a);if(c===1/0)return b.abs().max(a);if(c=== -1/0)return b.abs().min(a);if("euclidean"===c||2===c)return b.abs().pow(am(2,"int32")).sum(a).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}if(Array.isArray(a)&&2===a.length){if(1===c)return b.abs().sum(a[0]).max(a[1]-1);if(c===1/0)return b.abs().sum(a[1]).max(a[0]);if(c=== -1/0)return b.abs().sum(a[1]).min(a[0]);if("fro"===c||"euclidean"===c)return b.square().sum(a).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}throw new Error("Error in norm: invalid axis: "+a)}(b=kn(b,"x","norm"),c,a),f=e.shape;if(d){var g=ek(a,b.shape);f=fA(e.shape,g)}return e.reshape(f)}}),de=a({basicLSTMCell_:function(e,f,g,h,i,j){var k=kn(e,"forgetBias","basicLSTMCell"),l=kn(f,"lstmKernel","basicLSTMCell"),m=kn(g,"lstmBias","basicLSTMCell"),n=kn(h,"data","basicLSTMCell"),o=kn(i,"c","basicLSTMCell"),p=kn(j,"h","basicLSTMCell"),a=n.concat(p,1).matMul(l).add(m),q=a.shape[0],b=a.shape[1]/4,c=[q,b],r=a.slice([0,0],c),s=a.slice([0,b],c),t=a.slice([0,2*b],c),u=a.slice([0,3*b],c),d=r.sigmoid().mulStrict(s.tanh()).addStrict(o.mulStrict(k.add(t).sigmoid())),v=d.tanh().mulStrict(u.sigmoid());return[d,v]}}),df=a({multiRNNCell_:function(d,h,i,j){for(var k=kn(h,"data","multiRNNCell"),l=ko(i,"c","multiRNNCell"),m=ko(j,"h","multiRNNCell"),e=k,b=[],a=0;a<d.length;a++){var c=d[a](e,l[a],m[a]);b.push(c[0]),b.push(c[1]),e=c[1]}var f=[],g=[];for(a=0;a<b.length;a+=2)f.push(b[a]),g.push(b[a+1]);return[f,g]}}),dg=a({movingAverage_:function(h,i,j,e,b){void 0===b&&(b=!0);var a=kn(h,"v","movingAverage"),c=kn(i,"x","movingAverage"),f=kn(j,"decay","movingAverage");eQ(a,c),d8(ed(a.shape,c.shape),function(){return"Shape mismatch in v and x"});var g=am(1),k=g.sub(f),d=c.sub(a).mul(k);if(b){d8(null!=e,function(){return"When using zeroDebias: true, step is required."});var l=kn(e,"step","movingAverage");d=d.div(g.sub(cc(f,l)))}return a.add(d)}}),dh=a({stridedSlice_:function(m,d,e,a,f,g,h,i,j){if(void 0===f&&(f=0),void 0===g&&(g=0),void 0===h&&(h=0),void 0===i&&(i=0),void 0===j&&(j=0),null==a&&(a=new Array(d.length)),0!==h)throw new Error("ellipsis mask is not yet supported");var b=kn(m,"x","stridedSlice"),n=fV(i),o=b.shape.slice();n.forEach(function(a){d[a]=0,e[a]=1,o.splice(a,0,1)}),b=b.reshape(o);for(var c=0;c<b.rank;c++)d[c]=fX(f,d,a,b.shape,c),e[c]=fY(g,e,a,b.shape,c),a[c]=a[c]||1;var p=fV(j);p.forEach(function(b){e[b]=d[b]+1,a[b]=1});var k=fW(d,e,a),l=k.filter(function(b,a){return -1===p.indexOf(a)});return a.every(function(a){return 1===a})?cR(b,d,k).reshape(l):ad.runKernelFunc(function(c){return c.stridedSlice(b,d,e,a)},{$x:b}).reshape(l)}}),di=a({topk_:function(f,a,c){void 0===a&&(a=1),void 0===c&&(c=!0);var b=kn(f,"x","topk");if(0===b.rank)throw new Error("topk() expects the input to be of rank 1 or higher");var d=b.shape[b.shape.length-1];if(d<a)throw new Error("'k' passed to topk() must be <= the last dimension ("+d+") but got "+a);var e=ad.runKernelFunc(function(d){return d.topk(b,a,c)},{$x:b});return{values:e[0],indices:e[1]}}}),dj=a({scatterND_:function(d,e,a){var b=kn(d,"indices","scatterND","int32"),c=kn(e,"updates","scatterND");return fR(c,b,a),ad.runKernelFunc(function(d){return d.scatterND(b,c,a)},{indices:b,updates:c},null,"ScatterNd",{shape:a})}}),L=a({fft_:function(a){d8("complex64"===a.dtype,function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+a.dtype+"."});var b=a.shape[a.shape.length-1],c=a.size/b,d=a.as2D(c,b);return ad.runKernelFunc(function(a){return a.fft(d)},{input:a}).reshape(a.shape)}}),M=a({ifft_:function(a){d8("complex64"===a.dtype,function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+a.dtype+"."});var b=a.shape[a.shape.length-1],c=a.size/b,d=a.as2D(c,b);return ad.runKernelFunc(function(a){return a.ifft(d)},{input:a}).reshape(a.shape)}}),N=a({rfft_:function(a,c){d8("float32"===a.dtype,function(){return"The dtype for rfft() must be real value but got "+a.dtype});var d,b=a.shape[a.shape.length-1],l=a.size/b;if(null!=c&&c<b){var m=a.shape.map(function(a){return 0}),f=a.shape.map(function(a){return a});f[a.shape.length-1]=c,d=a.slice(m,f),b=c}else if(null!=c&&b<c){var g=a.shape.map(function(a){return a});g[a.shape.length-1]=c-b,d=a.concat(av(g),a.shape.length-1),b=c}else d=a;var n=d.zerosLike(),o=ai(d,n).as2D(l,b),h=L(o),e=Math.floor(b/2)+1,i=aj(h),j=ak(h),p=i.split([e,b-e],i.shape.length-1),q=j.split([e,b-e],j.shape.length-1),k=d.shape.slice();return k[d.shape.length-1]=e,ai(p[0],q[0]).reshape(k)}}),O=a({irfft_:function(b){var a=b.shape[b.shape.length-1],c=b.size/a;if(a<=2){var d=b.as2D(c,a),e=M(d);return aj(e)}var f=[c,2*(a-1)],g=aj(b).as2D(c,a),h=ak(b).as2D(c,a),i=g.slice([0,1],[c,a-2]).reverse(1),j=h.slice([0,1],[c,a-2]).reverse(1).mul(am(-1)),k=g.concat(i,1),l=h.concat(j,1);return d=ai(k,l).as2D(f[0],f[1]),e=M(d),aj(e)}}),dk=Object.freeze({fft:L,ifft:M,rfft:N,irfft:O}),dl=a({sparseToDense_:function(e,f,g,a){void 0===a&&(a=0);var c=kn(e,"sparseIndices","sparseToDense","int32"),b=kn(f,"sparseValues","sparseToDense"),d=kn(a,"defaultValue","sparseToDense",b.dtype);return function(a,b,c,f){if("int32"!==a.dtype)throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+a.dtype+".");if(2<a.rank)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+a.shape+".");var d=0<a.rank?a.shape[0]:1,e=1<a.rank?a.shape[1]:1;if(c.length!==e)throw new Error("outputShape has incorrect number of elements:, "+c.length+", should be: "+e+".");var g=b.size;if(0!==b.rank&&(1!==b.rank||g!==d))throw new Error("sparseValues has incorrect shape "+b.shape+", should be [] or ["+d+"]");if(b.dtype!==f.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}(c,b,g,d),ad.runKernelFunc(function(a){return a.sparseToDense(c,b,g,d)},{$sparseIndices:c,$sparseValues:b,$defaultValue:d})}}),dm=a({gatherND_:function(a,b){var c=kn(b,"indices","gatherND","int32"),d=kn(a,"x","gatherND");return ad.runKernelFunc(function(a){return a.gatherND(d,c)},{x:d,indices:c},null,"GatherNd")}}),dn=a({diag_:function(a){var b=kn(a,"x","diag").flatten(),c=a.shape.concat(a.shape);return ad.runKernelFunc(function(a){return a.diag(b)},{$x:b}).reshape(c)}}),dp=a({dropout_:function(c,b,e,f){var a=kn(c,"x","dropout");if(d8("float32"===a.dtype,function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+a.dtype+" tensor instead."}),d8(0<=b&&b<1,function(){return"rate must be a float in the range [0, 1), but got "+b+"."}),0===b)return c instanceof E?a.clone():a;var g=function(a,b){if(null==b)return a.shape.slice();if(ed(a.shape,b)||a.shape.length!==b.length)return b;for(var d=[],c=0;c<a.shape.length;c++)null==b[c]&&null!=a.shape[c]?d.push(a.shape[c]):d.push(b[c]);return d}(a,e),d=1-b,h=a0(g,0,1,"float32",f).add(d).floor().div(d);return a.mul(h)}});function m4(a,d,e){for(var f=1-a%2,c=new Float32Array(a),b=0;b<a;++b){var g=2*Math.PI*b/(a+f-1);c[b]=d-e*Math.cos(g)}return an(c,"float32")}function dq(b,c,a){return void 0===a&&(a=1),jL(this,void 0,void 0,function(){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;return jM(this,function(r){switch(r.label){case 0:return d=kn(b,"predictions","inTopK"),e=kn(c,"targets","inTopK"),d8(1<d.rank,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+d.rank}),d8(d.rank-1===e.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+d.rank+" and targets rank "+e.rank}),d9(d.shape.slice(0,d.shape.length-1),e.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),f=d.shape[d.shape.length-1],d8(0<a&&a<=f,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+f+"), but got "+a}),[4,d.data()];case 1:return g=r.sent(),[4,e.data()];case 2:for(h=r.sent(),k=(i=[g.length/f,f])[1],l=em("bool",j=i[0]),m=0;m<j;m++){for(n=m*k,o=g.subarray(n,n+k),p=[],q=0;q<o.length;q++)p.push({value:o[q],index:q});for(p.sort(function(a,b){return b.value-a.value}),l[m]=0,q=0;q<a;q++)if(p[q].index===h[m]){l[m]=1;break}}return b!==d&&d.dispose(),c!==e&&e.dispose(),[2,al(l,e.shape,"bool")]}})})}var C,l,P=a({hannWindow_:function(a){return m4(a,.5,.5)}}),Q=a({hammingWindow_:function(a){return m4(a,.54,.46)}}),R=a({frame_:function(c,b,g,e,f){void 0===e&&(e=!1),void 0===f&&(f=0);for(var a=0,d=[];a+b<=c.size;)d.push(cR(c,a,b)),a+=g;if(e)for(;a<c.size;){var h=a+b-c.size,i=aB([cR(c,a,b-h),aw([h],f)]);d.push(i),a+=g}return 0===d.length?ao([],[0,b]):aB(d).as2D(d.length,b)}}),S=a({stft_:function(g,a,h,b,c){void 0===c&&(c=P),null==b&&(b=Math.floor(Math.pow(2,Math.ceil(Math.log(a)/Math.log(2)))));for(var e=R(g,a,h),i=ca(e,c(a)),f=[],d=0;d<e.shape[0];d++)f.push(N(i.slice([d,0],[1,a]),b));return aB(f)}}),dr=Object.freeze({hannWindow:P,hammingWindow:Q,frame:R,stft:S});(l=C=C||{})[l.NONE=0]="NONE",l[l.MEAN=1]="MEAN",l[l.SUM=2]="SUM",l[l.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS";var gH=a({absoluteDifference_:function(f,g,b,a){void 0===a&&(a=C.SUM_BY_NONZERO_WEIGHTS);var c=kn(f,"labels","absoluteDifference"),d=kn(g,"predictions","absoluteDifference"),e=null;null!=b&&(e=kn(b,"weights","absoluteDifference")),d9(c.shape,d.shape,"Error in absoluteDifference: ");var h=c.sub(d).abs();return gI(h,e,a)}}),gI=a({computeWeightedLoss_:function(h,e,b){void 0===b&&(b=C.SUM_BY_NONZERO_WEIGHTS);var d=kn(h,"losses","computeWeightedLoss"),a=null;null!=e&&(a=kn(e,"weights","computeWeightedLoss"));var c=null==a?d:d.mul(a);if(b===C.NONE)return c;if(b===C.SUM)return c.sum();if(b===C.MEAN){if(null==a)return c.mean();var f=d.size/a.size,g=c.sum().div(a.sum());return 1<f?g.div(am(f)):g}if(b!==C.SUM_BY_NONZERO_WEIGHTS)throw Error("Unknown reduction: "+b);if(null==a)return c.sum().div(am(d.size));var i=a.mul(au(d.shape)).notEqual(am(0)).sum().toFloat();return c.sum().div(i)}}),gJ=a({cosineDistance_:function(f,g,h,b,a){void 0===a&&(a=C.SUM_BY_NONZERO_WEIGHTS);var c=kn(f,"labels","cosineDistance"),d=kn(g,"predictions","cosineDistance"),e=null;null!=b&&(e=kn(b,"weights","cosineDistance")),d9(c.shape,d.shape,"Error in cosineDistance: ");var i=am(1).sub(c.mul(d).sum(h,!0));return gI(i,e,a)}}),gK=a({hingeLoss_:function(g,h,c,b){void 0===b&&(b=C.SUM_BY_NONZERO_WEIGHTS);var a=kn(g,"labels","hingeLoss"),d=kn(h,"predictions","hingeLoss"),e=null;null!=c&&(e=kn(c,"weights","hingeLoss")),d9(a.shape,d.shape,"Error in hingeLoss: ");var f=am(1);a=am(2).mul(a).sub(f);var i=f.sub(a.mul(d)).relu();return gI(i,e,b)}}),gL=a({huberLoss_:function(j,k,c,a,b){void 0===a&&(a=1),void 0===b&&(b=C.SUM_BY_NONZERO_WEIGHTS);var d=kn(j,"labels","huberLoss"),e=kn(k,"predictions","huberLoss"),f=null;null!=c&&(f=kn(c,"weights","huberLoss")),d9(d.shape,e.shape,"Error in huberLoss: ");var g=am(a),h=e.sub(d).abs(),i=b6(h,g),l=h.sub(i),m=am(.5).mul(i.square()).add(g.mul(l));return gI(m,f,b)}}),gM=a({logLoss_:function(i,j,e,a,b){void 0===a&&(a=1e-7),void 0===b&&(b=C.SUM_BY_NONZERO_WEIGHTS);var c=kn(i,"labels","logLoss"),d=kn(j,"predictions","logLoss"),f=null;null!=e&&(f=kn(e,"weights","logLoss")),d9(c.shape,d.shape,"Error in logLoss: ");var g=am(1),h=am(a),k=c.mul(d.add(h).log()).neg().sub(g.sub(c).mul(g.sub(d).add(h).log()));return gI(k,f,b)}}),gN=a({meanSquaredError_:function(f,g,b,a){void 0===a&&(a=C.SUM_BY_NONZERO_WEIGHTS);var c=kn(f,"labels","meanSquaredError"),d=kn(g,"predictions","meanSquaredError"),e=null;null!=b&&(e=kn(b,"weights","meanSquaredError")),d9(c.shape,d.shape,"Error in meanSquaredError: ");var h=c.squaredDifference(d);return gI(h,e,a)}}),gO=a({sigmoidCrossEntropy_:function(n,o,f,b,d){void 0===b&&(b=0),void 0===d&&(d=C.SUM_BY_NONZERO_WEIGHTS);var c=kn(n,"multiClassLabels","sigmoidCrossEntropy"),g=kn(o,"logits","sigmoidCrossEntropy"),h=null;if(null!=f&&(h=kn(f,"weights","sigmoidCrossEntropy")),d9(c.shape,g.shape,"Error in sigmoidCrossEntropy: "),0<b){var i=am(b),p=am(1),q=am(.5);c=c.mul(p.sub(i)).add(q.mul(i))}var j,e,a,k,l,m,r=(j=g,e=kn(c,"labels","sigmoidCrossEntropyWithLogits"),a=kn(j,"logits","sigmoidCrossEntropyWithLogits"),d9(e.shape,a.shape,"Error in sigmoidCrossEntropyWithLogits: "),k=a.relu(),l=a.mul(e),m=a.abs().neg().exp().log1p(),k.sub(l).add(m));return gI(r,h,d)}}),gP=a({softmaxCrossEntropy_:function(h,i,d,b,c){void 0===b&&(b=0),void 0===c&&(c=C.SUM_BY_NONZERO_WEIGHTS);var a=kn(h,"onehotLabels","softmaxCrossEntropy"),e=kn(i,"logits","softmaxCrossEntropy"),f=null;if(null!=d&&(f=kn(d,"weights","softmaxCrossEntropy")),d9(a.shape,e.shape,"Error in softmaxCrossEntropy: "),0<b){var g=am(b),j=am(1),k=am(a.shape[1]);a=a.mul(j.sub(g)).add(g.div(k))}var l=function(c,b,a){if(void 0===a&&(a=-1),-1===a&&(a=b.rank-1),a!==b.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+b.rank+" and dim was "+a);return f1(function(b,c,e){var f=c.logSumExp([a],!0),d=c.toFloat().sub(f);return e([b,d]),{value:d.mul(b).neg().sum([a]),gradFunc:function(b,c){var d=c[0],e=c[1],f=fA(b.shape,[a]);return[b.reshape(f).mul(d.toFloat().sub(e.exp())),b.reshape(f).mul(e.exp().sub(d.toFloat()))]}}})(c,b)}(a,e);return gI(l,f,c)}}),ds=Object.freeze({get Reduction(){return C},absoluteDifference:gH,computeWeightedLoss:gI,cosineDistance:gJ,hingeLoss:gK,huberLoss:gL,logLoss:gM,meanSquaredError:gN,sigmoidCrossEntropy:gO,softmaxCrossEntropy:gP});function m5(b,a){return void 0===a&&(a=!1),ad.tidy(function(){if(2!==b.shape.length)throw new Error("qr2d() requires a 2D Tensor, but got a "+b.shape.length+"D Tensor.");for(var d=b.shape[0],c=b.shape[1],e=aR(d),f=b.clone(),h=ao([[1]],[1,1]),k=h.clone(),i=c<=d?c:d,j=function(j){var a,b=f,g=k,i=e;k=(a=ad.tidy(function(){var l=f.slice([j,j],[d-j,1]),m=l.norm(),n=f.slice([j,j],[1,1]),o=ao([[-1]]).where(n.greater(0),ao([[1]])),p=n.sub(o.mul(m)),a=l.div(p);k=1===a.shape[0]?h.clone():h.concat(a.slice([1,0],[a.shape[0]-1,a.shape[1]]),0);var q=o.matMul(p).div(m).neg(),b=f.slice([j,0],[d-j,c]),g=q.mul(k);if(0===j)f=b.sub(g.matMul(k.transpose().matMul(b)));else{var r=b.sub(g.matMul(k.transpose().matMul(b)));f=f.slice([0,0],[j,c]).concat(r,0)}var i=e.slice([0,j],[d,e.shape[1]-j]);if(0===j)e=i.sub(i.matMul(k).matMul(g.transpose()));else{var s=i.sub(i.matMul(k).matMul(g.transpose()));e=e.slice([0,0],[d,j]).concat(s,1)}return[k,f,e]}))[0],f=a[1],e=a[2],fv([b,g,i])},g=0;g<i;++g)j(g);return!a&&c<d&&(e=e.slice([0,0],[d,c]),f=f.slice([0,0],[c,c])),[e,f]})}var gQ=a({bandPart_:function(h,a,b){if(a%1!=0)throw new Error("bandPart(): numLower must be an integer, got "+a+".");if(b%1!=0)throw new Error("bandPart(): numUpper must be an integer, got "+b+".");var c=kn(h,"a","bandPart");if(c.rank<2)throw new Error("bandPart(): Rank must be at least 2, got "+c.rank+".");var i=c.shape,f=c.shape.slice(-2),d=f[0],e=f[1];if(!(a<=d))throw new Error("bandPart(): numLower ("+a+") must not be greater than the number of rows ("+d+").");if(!(b<=e))throw new Error("bandPart(): numUpper ("+b+") must not be greater than the number of columns ("+e+").");a<0&&(a=d),b<0&&(b=e);var j=ay(0,d,1,"int32").reshape([-1,1]),k=ay(0,e,1,"int32"),g=cg(j,k),l=bT(g.lessEqual(am(+a,"int32")),g.greaterEqual(am(-b,"int32"))),m=av([d,e],c.dtype);return a4(a7(c.reshape([-1,d,e])).map(function(a){return bX(l,a,m)})).reshape(i)}}),gR=a({gramSchmidt_:function(a){if(Array.isArray(a)){c=!1,d8(null!=a&&0<a.length,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var c,g=a[0].shape[0],e=function(b){d8(a[b].shape[0]===g,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+a[b].shape[0]+" vs. "+g+")"})},b=1;b<a.length;++b)e(b)}else c=!0,a=aG(a,a.shape[0],0).map(function(a){return a3(a,[0])});function f(a){d.push(ad.tidy(function(){var b=h[a];if(0<a)for(var c=0;c<a;++c){var e=c3(d[c].mulStrict(b)).mul(d[c]);b=b.sub(e)}return b.div(dd(b,"euclidean"))}))}d8(a.length<=a[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+a.length+") exceeds number of dimensions ("+a[0].shape[0]+")."});var d=[],h=a;for(b=0;b<a.length;++b)f(b);return c?a4(d,0):d}}),gS=a({qr_:function(a,b){if(void 0===b&&(b=!1),a.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+a.rank);if(2===a.rank)return m5(a,b);var c=a.shape.slice(0,a.shape.length-2).reduce(function(a,b){return a*b}),d=a7(a.reshape([c,a.shape[a.shape.length-2],a.shape[a.shape.length-1]]),0),e=[],f=[];return d.forEach(function(c){var a=m5(c,b),d=a[0],g=a[1];e.push(d),f.push(g)}),[a4(e,0).reshape(a.shape),a4(f,0).reshape(a.shape)]}}),dt=Object.freeze({bandPart:gQ,gramSchmidt:gR,qr:gS});function m6(c,f,d,a,e,b){null==a&&(a=.5),null==e&&(e=Number.NEGATIVE_INFINITY),null==b&&(b=0);var g=c.shape[0];return d=Math.min(d,g),d8(0<=a&&a<=1,function(){return"iouThreshold must be in [0, 1], but was '"+a+"'"}),d8(2===c.rank,function(){return"boxes must be a 2D tensor, but was of rank '"+c.rank+"'"}),d8(4===c.shape[1],function(){return"boxes must have 4 columns, but 2nd dimension was "+c.shape[1]}),d8(1===f.rank,function(){return"scores must be a 1D tensor"}),d8(f.shape[0]===g,function(){return"scores has incompatible shape with boxes. Expected "+g+", but was "+f.shape[0]}),d8(0<=b&&b<=1,function(){return"softNmsSigma must be in [0, 1], but was '"+b+"'"}),{maxOutputSize:d,iouThreshold:a,scoreThreshold:e,softNmsSigma:b}}function m7(a,b){return!(0<a)||"linear"===b}function m8(b,c,a){if(null==a||"linear"===a)return b;if("relu"===a)return b.mul(c.step());throw new Error("Gradient for activation "+a+" has not been implemented yet.")}function m9(b,c){var a=c,d=f4(b.shape,c.shape);return 0<d.length&&(a=a.sum(d)),a.reshape(b.shape)}function na(b,a,c){if("linear"===a)return b;if("relu"===a)return c8(b);if("elu"===a)return c5(b);if("relu6"===a)return c9(b);if("prelu"===a)return c7(b,c);throw new Error("Unknown fused activation "+a+".")}var gT=a({resizeBilinear_:function(g,c,d){void 0===d&&(d=!1);var a=kn(g,"images","resizeBilinear");d8(3===a.rank||4===a.rank,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+a.rank+"."}),d8(2===c.length,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+c+"."});var e=a,f=!1;3===a.rank&&(f=!0,e=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var h=c[0],i=c[1],b=ad.runKernelFunc(function(a,b){return b([e]),a.resizeBilinear(e,h,i,d)},{x:e},function(a,b){return{x:function(){return ad.runKernelFunc(function(c){return c.resizeBilinearBackprop(a,b[0],d)},{})}}},"ResizeBilinear",{alignCorners:d,newHeight:h,newWidth:i});return f?b.as3D(b.shape[1],b.shape[2],b.shape[3]):b}}),gU=a({resizeNearestNeighbor_:function(g,c,d){void 0===d&&(d=!1);var a=kn(g,"images","resizeNearestNeighbor");d8(3===a.rank||4===a.rank,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+a.rank+"."}),d8(2===c.length,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+c+"."}),d8("float32"===a.dtype||"int32"===a.dtype,function(){return"`images` must have `int32` or `float32` as dtype"});var e=a,f=!1;3===a.rank&&(f=!0,e=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var h=c[0],i=c[1],b=ad.runKernelFunc(function(a,b){return b([e]),a.resizeNearestNeighbor(e,h,i,d)},{batchImages:e},function(a,b){return{batchImages:function(){return ad.runKernelFunc(function(c){return c.resizeNearestNeighborBackprop(a,b[0],d)},{})}}});return f?b.as3D(b.shape[1],b.shape[2],b.shape[3]):b}}),gV=a({nonMaxSuppression_:function(g,h,d,a,b){void 0===a&&(a=.5),void 0===b&&(b=Number.NEGATIVE_INFINITY);var e=kn(g,"boxes","nonMaxSuppression"),f=kn(h,"scores","nonMaxSuppression"),c=m6(e,f,d,a,b),i={maxOutputSize:d=c.maxOutputSize,iouThreshold:a=c.iouThreshold,scoreThreshold:b=c.scoreThreshold};return ad.runKernelFunc(function(c){return c.nonMaxSuppression(e,f,d,a,b)},{boxes:e,scores:f},null,"NonMaxSuppressionV3",i)}}),gW=a({nonMaxSuppressionWithScore_:function(i,j,e,a,b,c){void 0===a&&(a=.5),void 0===b&&(b=Number.NEGATIVE_INFINITY),void 0===c&&(c=0);var f=kn(i,"boxes","nonMaxSuppression"),g=kn(j,"scores","nonMaxSuppression"),d=m6(f,g,e,a,b,c),k={maxOutputSize:e=d.maxOutputSize,iouThreshold:a=d.iouThreshold,scoreThreshold:b=d.scoreThreshold,softNmsSigma:c=d.softNmsSigma},h=ad.runKernel("NonMaxSuppressionV5",{boxes:f,scores:g},k);return{selectedIndices:h[0],selectedScores:h[1]}}}),gX=a({cropAndResize_:function(g,h,i,b,a,d){var f=kn(g,"image","cropAndResize"),c=kn(h,"boxes","cropAndResize","float32"),e=kn(i,"boxInd","cropAndResize","int32");a=a||"bilinear",d=d||0;var j=c.shape[0];return d8(4===f.rank,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+f.rank+"."}),d8(2===c.rank&&4===c.shape[1],function(){return"Error in cropAndResize: boxes must be have size ["+j+",4] but had shape "+c.shape+"."}),d8(1===e.rank&&e.shape[0]===j,function(){return"Error in cropAndResize: boxInd must be have size ["+j+"] but had shape "+c.shape+"."}),d8(2===b.length,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+b.length+"."}),d8(1<=b[0]&&1<=b[1],function(){return"cropSize must be atleast [1,1], but was "+b}),d8("bilinear"===a||"nearest"===a,function(){return"method must be bilinear or nearest, but was "+a}),ad.runKernelFunc(function(g,h){return g.cropAndResize(f,c,e,b,a,d)},{images:f,boxes:c,boxInd:e},null,"CropAndResize",{method:a,extrapolationValue:d,cropSize:b})}}),du=Object.freeze({resizeBilinear:gT,resizeNearestNeighbor:gU,nonMaxSuppression:gV,nonMaxSuppressionAsync:function(c,d,e,a,b){return void 0===a&&(a=.5),void 0===b&&(b=Number.NEGATIVE_INFINITY),jL(this,void 0,void 0,function(){var f,g,h,i,j,k,l;return jM(this,function(m){switch(m.label){case 0:return f=kn(c,"boxes","nonMaxSuppressionAsync"),g=kn(d,"scores","nonMaxSuppressionAsync"),h=m6(f,g,e,a,b),e=h.maxOutputSize,a=h.iouThreshold,b=h.scoreThreshold,[4,Promise.all([f.data(),g.data()])];case 1:return j=(i=m.sent())[0],k=i[1],l=kN(j,k,e,a,b),f!==c&&f.dispose(),g!==d&&g.dispose(),[2,l]}})})},nonMaxSuppressionWithScore:gW,nonMaxSuppressionWithScoreAsync:function(d,e,f,a,b,c){return void 0===a&&(a=.5),void 0===b&&(b=Number.NEGATIVE_INFINITY),void 0===c&&(c=0),jL(this,void 0,void 0,function(){var g,h,i,j,k,l,m;return jM(this,function(n){switch(n.label){case 0:return g=kn(d,"boxes","nonMaxSuppressionAsync"),h=kn(e,"scores","nonMaxSuppressionAsync"),i=m6(g,h,f,a,b,c),f=i.maxOutputSize,a=i.iouThreshold,b=i.scoreThreshold,c=i.softNmsSigma,[4,Promise.all([g.data(),h.data()])];case 1:return k=(j=n.sent())[0],l=j[1],m=kO(k,l,f,a,b,c),g!==d&&g.dispose(),h!==e&&h.dispose(),[2,m]}})})},cropAndResize:gX}),gY=a({fusedMatMul_:function(c){var o,p=c.a,q=c.b,r=c.transposeA,e=void 0!==r&&r,s=c.transposeB,f=void 0!==s&&s,d=c.bias,t=c.activation,u=void 0===t?"linear":t,g=c.preluActivationWeights;if(!1===m7(ad.state.gradientDepth,u)){var h=cE(p,q,e,f);return null!=d&&(h=bY(h,d)),na(h,u,g)}var a=kn(p,"a","fused matMul"),b=kn(q,"b","fused matMul");a=(o=eP(a,b))[0],b=o[1];var i=e?a.shape[a.rank-2]:a.shape[a.rank-1],j=f?b.shape[b.rank-1]:b.shape[b.rank-2],k=e?a.shape[a.rank-1]:a.shape[a.rank-2],l=f?b.shape[b.rank-2]:b.shape[b.rank-1],v=a.shape.slice(0,-2),w=b.shape.slice(0,-2),x=ec(v),y=ec(w);d8(2<=a.rank&&2<=b.rank&&a.rank===b.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+a.rank+" and "+b.rank+"."}),d8(ed(v,w),function(){return"Error in fused matMul: outer dimensions ("+v+") and ("+w+") of Tensors with shapes "+a.shape+" and "+b.shape+" must match."}),d8(i===j,function(){return"Error in fused matMul: inner shapes ("+i+") and ("+j+") of Tensors with shapes "+a.shape+" and "+b.shape+" and transposeA="+e+" and transposeB="+f+" must match."});var m,_,z=a.shape.slice(0,-2).concat([k,l]),A=e?a.as3D(x,i,k):a.as3D(x,k,i),B=f?b.as3D(y,l,j):b.as3D(y,j,l);null!=d&&f5(z,(m=eP(m=kn(d,"bias","fused matMul"),a)[0]).shape),null!=g&&(_=kn(g,"prelu weights","fused matMul"));var n={$a:A,$b:B};return null!=d&&(n.$bias=m),null!=g&&(n.$preluActivationWeights=_),ad.runKernelFunc(function(b,c){var a=b.fusedBatchMatMul({a:A,b:B,transposeA:e,transposeB:f,bias:m,activation:u,preluActivationWeights:_});return c([A,B,a]),a},n,function(c,b){var g=b[0],h=b[1],i=m8(c,b[2],u),a={};return null!=d&&(a={$bias:function(){return m9(m,i)}}),e||f?!e&&f?Object.assign({$a:function(){return i.matMul(h,!1,!1)},$b:function(){return i.matMul(g,!0,!1)}},a):e&&!f?Object.assign({$a:function(){return h.matMul(i,!1,!0)},$b:function(){return g.matMul(i,!1,!1)}},a):Object.assign({$a:function(){return h.matMul(i,!0,!0)},$b:function(){return i.matMul(g,!0,!0)}},a):Object.assign({$a:function(){return i.matMul(h,!1,!0)},$b:function(){return g.matMul(i,!0,!1)}},a)}).reshape(z)}}),gZ=a({fusedConv2d_:function(a){var o=a.x,p=a.filter,i=a.strides,j=a.pad,q=a.dataFormat,r=void 0===q?"NHWC":q,s=a.dilations,k=void 0===s?[1,1]:s,l=a.dimRoundingMode,d=a.bias,t=a.activation,e=void 0===t?"linear":t,g=a.preluActivationWeights;if(e=e||"linear",!1===m7(ad.state.gradientDepth,e)){var m=cy(o,p,i,j,r,k,l);return null!=d&&(m=bY(m,d)),na(m,e,g)}var b=kn(o,"x","conv2d"),f=kn(p,"filter","conv2d"),c=b,u=!1;3===b.rank&&(u=!0,c=b.as4D(1,b.shape[0],b.shape[1],b.shape[2])),d8(4===c.rank,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+c.rank+"."}),d8(4===f.rank,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+f.rank+"."}),null!=l&&d8(ee(j),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+l+" but got pad "+j+"."}),d8(c.shape[3]===f.shape[2],function(){return"Error in conv2d: depth of input ("+c.shape[3]+") must match input depth for filter "+f.shape[2]+"."}),d8(gc(i,k),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+k+"'"}),d8("NHWC"===r,function(){return"Error in conv2d: got dataFormat of "+r+" but only NHWC is currently supported."});var h,v,w=f8(c.shape,f.shape,i,k,j,l);null!=d&&(h=eP(h=kn(d,"bias","fused conv2d"),b)[0],f5(w.outShape,h.shape)),null!=g&&(v=kn(g,"prelu weights","fused conv2d"));var n={x:c,filter:f};null!=d&&(n.bias=h),null!=g&&(n.preluActivationWeights=v);var x=[f,c],_=ad.runKernelFunc(function(b,d){var a=b.fusedConv2d({input:c,filter:f,convInfo:w,bias:h,activation:e,preluActivationWeights:v});return d([f,c,a]),a},n,function(c,f){var a=f,g=a[0],l=a[1],m=m8(c,a[2],e);d8(gb(k),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+k+"'"});var b={};return null!=d&&(b={bias:function(){return m9(h,m)}}),Object.assign({x:function(){return m$(l.shape,m,g,i,j)},filter:function(){return mZ(l,m,g.shape,i,j)}},b)},"FusedConv2D",{convInfo:w,activation:e},x,[!0]);return u?_.as3D(_.shape[1],_.shape[2],_.shape[3]):_}}),g$=a({fusedDepthwiseConv2d_:function(a){var o=a.x,p=a.filter,i=a.strides,j=a.pad,q=a.dataFormat,w=void 0===q?"NHWC":q,r=a.dilations,d=void 0===r?[1,1]:r,k=a.dimRoundingMode,e=a.bias,s=a.activation,l=void 0===s?"linear":s,g=a.preluActivationWeights;if(!1===m7(ad.state.gradientDepth,l)){var m=cA(o,p,i,j,w,d,k);return null!=e&&(m=bY(m,e)),na(m,l,g)}var b=kn(o,"x","depthwiseConv2d"),f=kn(p,"filter","depthwiseConv2d"),c=b,t=!1;3===b.rank&&(t=!0,c=b.as4D(1,b.shape[0],b.shape[1],b.shape[2])),d8(4===c.rank,function(){return"Error in fused depthwiseConv2d: input must be rank 4, but got rank "+c.rank+"."}),d8(4===f.rank,function(){return"Error in fused depthwiseConv2d: filter must be rank 4, but got rank "+f.rank+"."}),d8(c.shape[3]===f.shape[2],function(){return"Error in fused depthwiseConv2d: number of input channels ("+c.shape[3]+") must match the inChannels dimension in filter "+f.shape[2]+"."}),null==d&&(d=[1,1]),d8(gc(i,d),function(){return"Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides "+i+" and dilations '"+d+"'"}),null!=k&&d8(ee(j),function(){return"Error in fused depthwiseConv2d: pad must be an integer when using dimRoundingMode "+k+" but got pad "+j+"."});var h,u,v=f8(c.shape,f.shape,i,d,j,k,!0);null!=e&&(h=eP(h=kn(e,"bias","fused conv2d"),b)[0],f5(v.outShape,h.shape)),null!=g&&(u=kn(g,"prelu weights","fused depthwiseConv2d"));var n={x:c,filter:f};null!=e&&(n.bias=h),null!=g&&(n.preluActivationWeights=u);var x=[f,c],_=ad.runKernelFunc(function(b,d){var a=b.fusedDepthwiseConv2D({input:c,filter:f,convInfo:v,bias:h,activation:l,preluActivationWeights:u});return d([f,c,a]),a},n,function(c,a){d8(gb(d),function(){return"Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+d+"'"});var f=a[0],g=a[1],i=m8(c,a[2],l),b={};return null!=e&&(b={bias:function(){return m9(h,i)}}),Object.assign({x:function(){return m_(g.shape,i,f,v)},filter:function(){return m0(g,i,f.shape,v)}},b)},"FusedDepthwiseConv2D",{convInfo:v,activation:l},x,[!0]);return t?_.as3D(_.shape[1],_.shape[2],_.shape[3]):_}}),dv=Object.freeze({matMul:gY,conv2d:gZ,depthwiseConv2d:g$}),g_=Object.freeze({image:du,linalg:dt,losses:ds,spectral:dk,fused:dv,signal:dr,square:bb,conv1d:cx,conv2d:cy,conv3d:cz,depthwiseConv2d:cA,separableConv2d:cB,conv2dTranspose:cC,conv3dTranspose:cD,op:a,batchNormalization2d:bL,batchNormalization3d:bM,batchNormalization4d:bN,batchNormalization:bO,batchNorm:bP,batchNorm2d:bQ,batchNorm3d:bR,batchNorm4d:bS,booleanMaskAsync:cu,complex:ai,real:aj,imag:ak,concat:aB,concat1d:aC,concat2d:aD,concat3d:aE,concat4d:aF,split:aG,matMul:cE,dot:cF,outerProduct:cG,reverse:cH,reverse1d:cI,reverse2d:cJ,reverse3d:cK,reverse4d:cL,maxPool:cM,avgPool:cN,pool:cO,maxPool3d:cP,avgPool3d:cQ,slice:cR,slice1d:cS,slice2d:cT,slice3d:cU,slice4d:cV,abs:bc,acos:bd,acosh:be,asin:bf,asinh:bg,atan:bh,atanh:bi,ceil:bj,clipByValue:bk,cos:bl,cosh:bm,erf:bn,exp:bo,expm1:bp,floor:bq,log:br,log1p:bs,logSigmoid:bt,neg:bu,reciprocal:bv,round:bw,rsqrt:bx,sigmoid:by,sign:bz,isNaN:bA,isInf:bB,isFinite:bC,sin:bD,sinh:bE,softplus:bF,sqrt:bG,step:bH,tan:bI,tanh:bJ,all:cW,any:cX,argMax:cY,argMin:cZ,logSumExp:c$,max:c_,mean:c0,min:c1,moments:c2,sum:c3,prod:c4,equal:ci,equalStrict:cj,greater:ck,greaterEqual:cl,greaterEqualStrict:cm,greaterStrict:cn,less:co,lessEqual:cp,lessEqualStrict:cq,lessStrict:cr,notEqual:cs,notEqualStrict:ct,add:bY,addN:bZ,addStrict:b$,atan2:b_,div:b0,divNoNan:b1,divStrict:b2,floorDiv:b3,maximum:b4,maximumStrict:b5,minimum:b6,minimumStrict:b7,mod:b8,modStrict:b9,mul:ca,mulStrict:cb,pow:cc,powStrict:cd,squaredDifference:ce,squaredDifferenceStrict:cf,sub:cg,subStrict:ch,elu:c5,leakyRelu:c6,prelu:c7,relu:c8,relu6:c9,selu:da,logicalAnd:bT,logicalNot:bU,logicalOr:bV,logicalXor:bW,where:bX,whereAsync:bK,buffer:aH,print:aI,batchToSpaceND:aK,broadcastTo:aL,cast:aM,clone:aN,cumsum:aO,depthToSpace:aP,expandDims:aQ,eye:aR,multinomial:aS,oneHot:aT,pad:aU,pad1d:aV,pad2d:aW,pad3d:aX,pad4d:aY,rand:aZ,randomNormal:a$,randomGamma:a_,randomUniform:a0,reshape:a1,spaceToBatchND:a2,squeeze:a3,stack:a4,tile:a5,truncatedNormal:a6,unstack:a7,setdiff1dAsync:aJ,fill:aw,linspace:ax,ones:au,range:ay,scalar:am,tensor:al,tensor1d:an,tensor2d:ao,tensor3d:ap,tensor4d:aq,tensor5d:ar,tensor6d:as,variable:at,zeros:av,onesLike:az,zerosLike:aA,transpose:db,softmax:a8,logSoftmax:a9,localResponseNormalization:dc,norm:dd,gather:cv,unsortedSegmentSum:cw,basicLSTMCell:de,multiRNNCell:df,movingAverage:dg,stridedSlice:dh,topk:di,scatterND:dj,fft:L,ifft:M,rfft:N,irfft:O,sparseToDense:dl,gatherND:dm,diag:dn,dropout:dp,hannWindow:P,hammingWindow:Q,frame:R,stft:S,inTopKAsync:dq});function nb(a,b){Array.isArray(a)||(a=[a]),a.forEach(function(a){null!=a&&d8("complex64"!==a.dtype,function(){return b+" does not support complex64 tensors."})})}function nc(b,c,a,d){if("linear"===a)return b.linear(c);if("relu"===a)return b.relu(c);if("elu"===a)return b.elu(c);if("relu6"===a)return b.relu6(c);if("prelu"===a)return b.prelu(c,d);throw new Error("Activation "+a+" has not been implemented for the CPU backend.")}var g0,nd=(f(ne,g0=K),ne.prototype.write=function(b,d,c){this.firstUse&&(this.firstUse=!1,i.get("IS_NODE")&&kk("\n============================\nHi there \u{1F44B}. Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================"));var a={};return this.data.set(a,{values:b,dtype:c}),a},ne.prototype.move=function(a,b,d,c){this.data.set(a,{values:b,dtype:c})},ne.prototype.numDataIds=function(){return this.data.numDataIds()},ne.prototype.read=function(a){return jL(this,void 0,void 0,function(){return jM(this,function(b){return[2,this.readSync(a)]})})},ne.prototype.readSync=function(a){var b=this.data.get(a),d=b.dtype,c=b.complexTensors;return"complex64"===d?kK(this.readSync(c.real.dataId),this.readSync(c.imag.dataId)):this.data.get(a).values},ne.prototype.bufferSync=function(a){var b=this.readSync(a.dataId),c=b;if("string"===a.dtype)try{c=b.map(function(a){return eH(a)})}catch(d){throw new Error("Failed to decode encoded string bytes into utf-8")}return aH(a.shape,a.dtype,c)},ne.prototype.makeOutput=function(c,a,b){var d=this.write(c,a,b);return ad.makeTensorFromDataId(d,a,b,this)},ne.prototype.disposeData=function(a){if(this.data.has(a)){var b=this.data.get(a).complexTensors;null!=b&&(b.real.dispose(),b.imag.dispose()),this.data.delete(a)}},ne.prototype.time=function(a){return jL(this,void 0,void 0,function(){var b;return jM(this,function(c){return b=eE(),a(),[2,{kernelMs:eE()-b}]})})},ne.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},ne.prototype.complex=function(a,c){var b=this.makeOutput(null,a.shape,"complex64");return this.data.get(b.dataId).complexTensors={real:ad.keep(a.clone()),imag:ad.keep(c.clone())},b},ne.prototype.real=function(a){return this.data.get(a.dataId).complexTensors.real.clone()},ne.prototype.imag=function(a){return this.data.get(a.dataId).complexTensors.imag.clone()},ne.prototype.slice=function(a,e,b){if(nb(a,"slice"),fZ(a.shape,e,b)){var f=f$(e,a.strides),h=ec(b);return al(this.readSync(a.dataId).subarray(f,f+h),b,a.dtype)}for(var c=aH(b,a.dtype),g=this.bufferSync(a),d=0;d<c.size;++d){var i=c.indexToLoc(d).map(function(a,b){return a+e[b]});c.values[d]=g.get.apply(g,i)}return c.toTensor()},ne.prototype.stridedSlice=function(c,h,k,i){nb(c,"stridedSlice");var d=fW(h,k,i);if(d.some(function(a){return 0===a}))return al([],d);for(var b=aH(d,c.dtype),j=this.bufferSync(c),e=0;e<b.size;e++){for(var f=b.indexToLoc(e),g=new Array(f.length),a=0;a<g.length;a++)g[a]=f[a]*i[a]+h[a];b.set.apply(b,[j.get.apply(j,g)].concat(f))}return b.toTensor()},ne.prototype.diag=function(a){for(var c=this.readSync(a.dataId),d=aH([a.size,a.size],a.dtype),e=d.values,b=0;b<c.length;b++)e[b*a.size+b]=c[b];return d.toTensor()},ne.prototype.unstack=function(b,c){for(var h=b.shape[c],e=new Array(b.rank-1),i=0,a=0;a<b.rank;a++)a!==c&&(e[i++]=b.shape[a]);var f=new Array(b.rank).fill(0),g=b.shape.slice();g[c]=1;var d=new Array(h);for(a=0;a<d.length;a++)d[f[c]=a]=this.slice(b,f,g).reshape(e);return d},ne.prototype.reverse=function(a,e){nb(a,"reverse");for(var c=aH(a.shape,a.dtype),f=this.bufferSync(a),d=function(d){var b=c.indexToLoc(d),g=b.slice();e.forEach(function(b){return g[b]=a.shape[b]-1-g[b]}),c.set.apply(c,[f.get.apply(f,g)].concat(b))},b=0;b<c.size;b++)d(b);return c.toTensor()},ne.prototype.concat=function(a,c){var i=this;if("complex64"===a[0].dtype){var d=a.map(function(a){return aj(a)}),e=a.map(function(a){return ak(a)});return ai(this.concat(d,c),this.concat(e,c))}var b=a.map(function(a){var b=ec(a.shape.slice(c));return a.as2D(-1,b)}),f=fG(b.map(function(a){return a.shape}),1),g=aH(f,a[0].dtype).values;if(1===b[0].shape[0]){var j=0;b.forEach(function(a){g.set(i.readSync(a.dataId),j),j+=a.size})}else{var k=0;b.forEach(function(a){for(var d=i.readSync(a.dataId),e=0,b=0;b<a.shape[0];++b)for(var h=b*f[1]+k,c=0;c<a.shape[1];++c)g[h+c]=d[e++];k+=a.shape[1]})}var h=fG(a.map(function(a){return a.shape}),c);return al(g,h,a[0].dtype)},ne.prototype.neg=function(a){return nb(a,"neg"),this.multiply(am(-1),a)},ne.prototype.add=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(a,b,c,d){return{real:a+c,imag:b+d}}):this.broadcastedBinaryOp(a,b,eN(a.dtype,b.dtype),function(a,b){return a+b})},ne.prototype.addN=function(a){var h=this;nb(a,"addN");for(var f=a.map(function(a){return h.readSync(a.dataId)}),d=aH(a[0].shape,a[0].dtype),e=d.values,c=0;c<a.length;c++)for(var g=f[c],b=0;b<e.length;b++)e[b]+=g[b];return d.toTensor()},ne.prototype.subtract=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(a,b,c,d){return{real:a-c,imag:b-d}}):this.broadcastedBinaryOp(a,b,eN(a.dtype,b.dtype),function(a,b){return a-b})},ne.prototype.pow=function(a,b){return nb([a,b],"pow"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return Math.pow(a,b)})},ne.prototype.batchMatMul=function(a,b,l,o){nb([a,b],"matMul");for(var p=l?a.shape[1]:a.shape[2],f=l?a.shape[2]:a.shape[1],d=o?b.shape[1]:b.shape[2],q=a.shape[0],t=this.readSync(a.dataId),u=this.readSync(b.dataId),m=l?[a.strides[0],1,a.strides[1]]:[a.strides[0],a.strides[1],1],v=m[0],w=m[1],x=m[2],n=o?[1,b.strides[1],b.strides[0]]:[b.strides[1],1,b.strides[0]],y=n[0],z=n[1],A=n[2],B=f*d,r=aH([q,f,d],a.dtype),C=r.values,c=this.blockSize,e=0;e<q;e++)for(var g=0;g<f;g+=c)for(var _=0;_<d;_+=c)for(var h=0;h<p;h+=c)for(var D=Math.min(g+c,f),E=Math.min(_+c,d),F=Math.min(h+c,p),i=g;i<D;i++)for(var j=_;j<E;j++){for(var s=0,k=h;k<F;k++)s+=t[e*v+i*w+k*x]*u[k*y+j*z+e*A];C[e*B+(i*d+j)]+=s}return r.toTensor()},ne.prototype.fusedBatchMatMul=function(a){var e=a.a,f=a.b,g=a.transposeA,h=a.transposeB,c=a.bias,d=a.activation,i=a.preluActivationWeights,b=this.batchMatMul(e,f,g,h);return c&&(b=this.add(b,c)),d&&(b=nc(this,b,d,i)),b},ne.prototype.multiply=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(a,b,c,d){return{real:a*c-b*d,imag:a*d+b*c}}):this.broadcastedBinaryOp(a,b,eN(a.dtype,b.dtype),function(a,b){return a*b})},ne.prototype.realDivide=function(a,b){return nb([a,b],"realDivide"),this.broadcastedBinaryOp(a,b,"float32",function(a,b){return a/b})},ne.prototype.floorDiv=function(a,b){return nb([a,b],"floorDiv"),this.broadcastedBinaryOp(a,b,"int32",function(a,b){return Math.floor(a/b)})},ne.prototype.sum=function(a,d){nb(a,"sum"),fB("sum",d,a.rank);for(var e=fz(a.shape,d),j=e[0],k=e[1],f=av(j,eN(a.dtype,"int32")),g=ec(k),h=this.readSync(f.dataId),l=this.readSync(a.dataId),b=0;b<h.length;++b){for(var m=b*g,i=0,c=0;c<g;++c)i+=l[m+c];h[b]=i}return f},ne.prototype.prod=function(a,i){nb(a,"sum");for(var d=fz(a.shape,i),j=d[0],k=d[1],e=av(j,eN(a.dtype,"int32")),f=ec(k),g=this.readSync(e.dataId),l=this.readSync(a.dataId),b=0;b<g.length;++b){for(var m=b*f,h=1,c=0;c<f;++c)h*=l[m+c];g[b]=h}return e},ne.prototype.unsortedSegmentSum=function(c,b,e){nb(c,"unsortedSegmentSum");for(var d=[],f=c.rank-b.rank,a=0;a<f;++a)b=b.expandDims(a+1);for(a=0;a<e;++a){var g=am(a,"int32"),h=ci(g,b).asType("float32").mul(c).sum(0);d.push(h)}return a4(d)},ne.prototype.argMin=function(a,n){nb(a,"argMin");var d=[n];fB("argMin",d,a.rank);for(var e=fz(a.shape,d),o=e[0],p=e[1],f=av(o,"int32"),g=ec(p),h=this.readSync(f.dataId),i=this.readSync(a.dataId),b=0;b<h.length;++b){for(var j=b*g,k=i[j],l=0,c=0;c<g;++c){var m=i[j+c];m<k&&(k=m,l=c)}h[b]=l}return f},ne.prototype.argMax=function(a,n){nb(a,"argMax");var d=[n];fB("argMax",d,a.rank);for(var e=fz(a.shape,d),o=e[0],p=e[1],f=av(o,"int32"),g=ec(p),h=this.readSync(f.dataId),i=this.readSync(a.dataId),b=0;b<h.length;++b){for(var j=b*g,k=i[j],l=0,c=0;c<g;++c){var m=i[j+c];k<m&&(k=m,l=c)}h[b]=l}return f},ne.prototype.cumsum=function(a,h,i,m){if(nb(a,"cumsum"),h!==a.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(a.rank-1)+" but got axis="+h);for(var n=eN(a.dtype,"int32"),j=av(a.shape,n),c=this.readSync(j.dataId),d=this.readSync(a.dataId),k=a.shape[a.rank-1],l=m?function(a,b){return a+k-b-1}:function(a,b){return a+b},e=0;e<d.length;e+=k)for(var b=0;b<k;b++){var f=l(e,b);if(0===b)c[f]=i?0:d[f];else{var g=l(e,b-1);c[f]=i?d[g]+c[g]:d[f]+c[g]}}return j},ne.prototype.equal=function(a,b){return nb([a,b],"equal"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return a===b?1:0})},ne.prototype.notEqual=function(a,b){return nb([a,b],"notEqual"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return a!==b?1:0})},ne.prototype.less=function(a,b){return nb([a,b],"less"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return a<b?1:0})},ne.prototype.lessEqual=function(a,b){return nb([a,b],"lessEqual"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return a<=b?1:0})},ne.prototype.greater=function(a,b){return nb([a,b],"greater"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return b<a?1:0})},ne.prototype.greaterEqual=function(a,b){return nb([a,b],"greaterEqual"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return b<=a?1:0})},ne.prototype.logicalNot=function(b){nb(b,"logicalNot");for(var c=this.readSync(b.dataId),d=new Uint8Array(c.length),a=0;a<c.length;++a)d[a]=c[a]?0:1;return this.makeOutput(d,b.shape,"bool")},ne.prototype.logicalAnd=function(a,b){return nb([a,b],"logicalAnd"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return a&&b})},ne.prototype.logicalOr=function(a,b){return nb([a,b],"logicalOr"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return a||b})},ne.prototype.select=function(c,a,d){nb([c,a,d],"select");for(var e=this.readSync(c.dataId),j=this.readSync(a.dataId),k=this.readSync(d.dataId),f=av(a.shape,eN(a.dtype,d.dtype)),g=this.readSync(f.dataId),h=0,l=0===c.rank||1<c.rank||1===a.rank?1:ec(a.shape.slice(1)),b=0;b<e.length;b++)for(var i=0;i<l;i++)1===e[b]?g[h++]=j[b]:g[h++]=k[b];return f},ne.prototype.where=function(a){nb([a],"where");var b=this.readSync(a.dataId);return kV(a.shape,b)},ne.prototype.topk=function(a,b,c){return nb(a,"topk"),kU(this.readSync(a.dataId),a.shape,a.dtype,b)},ne.prototype.min=function(a,e){nb(a,"min"),fB("min",e,a.rank);for(var f=fz(a.shape,e),m=f[0],n=f[1],g=av(m,a.dtype),h=ec(n),i=this.readSync(g.dataId),j=this.readSync(a.dataId),b=0;b<i.length;++b){for(var k=b*h,c=j[k],d=0;d<h;++d){var l=j[k+d];l<c&&(c=l)}i[b]=c}return g},ne.prototype.minimum=function(a,b){return nb([a,b],"minimum"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return Math.min(a,b)})},ne.prototype.mod=function(a,b){return nb([a,b],"mod"),this.broadcastedBinaryOp(a,b,a.dtype,function(b,a){var c=b%a;return b<0&&a<0||0<=b&&0<=a?c:(c+a)%a})},ne.prototype.max=function(a,e){nb(a,"max"),fB("max",e,a.rank);for(var f=fz(a.shape,e),m=f[0],n=f[1],g=av(m,a.dtype),h=ec(n),i=this.readSync(g.dataId),j=this.readSync(a.dataId),b=0;b<i.length;++b){for(var k=b*h,c=j[k],d=0;d<h;++d){var l=j[k+d];c<l&&(c=l)}i[b]=c}return g},ne.prototype.maximum=function(a,b){return nb([a,b],"maximum"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return Math.max(a,b)})},ne.prototype.all=function(a,e){nb(a,"all"),fB("all",e,a.rank);for(var f=fz(a.shape,e),l=f[0],m=f[1],g=av(l,a.dtype),h=ec(m),i=this.readSync(g.dataId),j=this.readSync(a.dataId),b=0;b<i.length;++b){for(var k=b*h,c=j[k],d=0;d<h;++d){var n=j[k+d];c=c&&n}i[b]=c}return g},ne.prototype.any=function(a,e){nb(a,"any"),fB("any",e,a.rank);for(var f=fz(a.shape,e),l=f[0],m=f[1],g=av(l,a.dtype),h=ec(m),i=this.readSync(g.dataId),j=this.readSync(a.dataId),b=0;b<i.length;++b){for(var k=b*h,c=j[k],d=0;d<h;++d){var n=j[k+d];c=c||n}i[b]=c}return g},ne.prototype.squaredDifference=function(a,b){return nb([a,b],"squaredDifference"),this.broadcastedBinaryOp(a,b,a.dtype,function(b,c){var a=b-c;return a*a})},ne.prototype.ceil=function(b){nb(b,"ceil");for(var c=this.readSync(b.dataId),d=new Float32Array(c.length),a=0;a<c.length;++a)d[a]=Math.ceil(c[a]);return this.makeOutput(d,b.shape,"float32")},ne.prototype.floor=function(b){nb(b,"floor");for(var c=this.readSync(b.dataId),d=new Float32Array(c.length),a=0;a<c.length;++a)d[a]=Math.floor(c[a]);return this.makeOutput(d,b.shape,"float32")},ne.prototype.sign=function(d){nb(d,"x");for(var b=this.readSync(d.dataId),c=new Float32Array(b.length),a=0;a<b.length;++a)b[a]<0?c[a]=-1:0<b[a]?c[a]=1:c[a]=0;return this.makeOutput(c,d.shape,"float32")},ne.prototype.isNaN=function(b){nb(b,"x");for(var c=this.readSync(b.dataId),d=new Uint8Array(c.length),a=0;a<c.length;++a)Number.isNaN(c[a])&&(d[a]=1);return this.makeOutput(d,b.shape,"bool")},ne.prototype.isInf=function(b){nb(b,"x");for(var c=this.readSync(b.dataId),d=new Uint8Array(c.length),a=0;a<c.length;++a)Math.abs(c[a])===1/0&&(d[a]=1);return this.makeOutput(d,b.shape,"bool")},ne.prototype.isFinite=function(b){nb(b,"x");for(var c=this.readSync(b.dataId),d=new Uint8Array(c.length),a=0;a<c.length;++a)Number.isFinite(c[a])&&(d[a]=1);return this.makeOutput(d,b.shape,"bool")},ne.prototype.round=function(e){nb(e,"round");for(var b=this.readSync(e.dataId),d=new Float32Array(b.length),a=0;a<b.length;++a){var c=Math.floor(b[a]);b[a]-c<.5?d[a]=Math.floor(b[a]):.5<b[a]-c?d[a]=Math.ceil(b[a]):d[a]=c%2==0?c:c+1}return this.makeOutput(d,e.shape,"float32")},ne.prototype.exp=function(b){nb(b,"exp");for(var c=this.readSync(b.dataId),d=new Float32Array(c.length),a=0;a<c.length;++a)d[a]=Math.exp(c[a]);return this.makeOutput(d,b.shape,"float32")},ne.prototype.expm1=function(b){nb(b,"expm1");for(var c=this.readSync(b.dataId),d=new Float32Array(c.length),a=0;a<c.length;++a)d[a]=Math.expm1(c[a]);return this.makeOutput(d,b.shape,"float32")},ne.prototype.log=function(b){nb(b,"log");for(var c=this.readSync(b.dataId),d=new Float32Array(c.length),a=0;a<c.length;++a){var e=c[a];d[a]=Math.log(e)}return this.makeOutput(d,b.shape,"float32")},ne.prototype.log1p=function(b){nb(b,"log1p");for(var c=this.readSync(b.dataId),d=new Float32Array(c.length),a=0;a<c.length;++a){var e=c[a];d[a]=Math.log1p(e)}return this.makeOutput(d,b.shape,"float32")},ne.prototype.sqrt=function(b){nb(b,"sqrt");for(var c=this.readSync(b.dataId),d=new Float32Array(c.length),a=0;a<c.length;++a){var e=c[a];d[a]=Math.sqrt(e)}return this.makeOutput(d,b.shape,"float32")},ne.prototype.rsqrt=function(b){nb(b,"rsqrt");for(var c=this.readSync(b.dataId),d=new Float32Array(c.length),a=0;a<c.length;++a){var e=c[a];d[a]=1/Math.sqrt(e)}return this.makeOutput(d,b.shape,"float32")},ne.prototype.reciprocal=function(b){nb(b,"reciprocal");for(var c=this.readSync(b.dataId),d=new Float32Array(c.length),a=0;a<c.length;++a)d[a]=1/c[a];return this.makeOutput(d,b.shape,"float32")},ne.prototype.linear=function(a){return a},ne.prototype.relu=function(a){nb(a,"relu");for(var c=av(a.shape,a.dtype),e=this.readSync(c.dataId),d=this.readSync(a.dataId),b=0;b<d.length;++b)e[b]=Math.max(0,d[b]);return c},ne.prototype.relu6=function(a){nb(a,"relu");for(var c=av(a.shape,a.dtype),e=this.readSync(c.dataId),d=this.readSync(a.dataId),b=0;b<d.length;++b)e[b]=Math.min(Math.max(0,d[b]),6);return c},ne.prototype.prelu=function(a,b){return nb([a,b],"prelu"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return a<0?b*a:a})},ne.prototype.elu=function(a){nb(a,"elu");for(var d=new Float32Array(a.size),e=this.readSync(a.dataId),b=0;b<e.length;++b){var c=e[b];d[b]=0<=c?c:Math.exp(c)-1}return this.makeOutput(d,a.shape,"float32")},ne.prototype.eluDer=function(c,b){nb([c,b],"eluDer");for(var d=new Float32Array(b.size),e=this.readSync(b.dataId),f=this.readSync(c.dataId),a=0;a<e.length;++a){var g=e[a];d[a]=1<=g?f[a]:f[a]*(g+1)}return this.makeOutput(d,b.shape,"float32")},ne.prototype.selu=function(a){nb(a,"selu");for(var d=new Float32Array(a.size),e=this.readSync(a.dataId),b=0;b<e.length;++b){var c=e[b];d[b]=0<=c?1.0507009873554805*c:1.7580993408473768*(Math.exp(c)-1)}return this.makeOutput(d,a.shape,"float32")},ne.prototype.clip=function(a,d,e){nb(a,"clip");for(var f=new Float32Array(a.size),g=this.readSync(a.dataId),b=0;b<g.length;++b){var c=g[b];f[b]=e<c?e:c<d?d:c}return this.makeOutput(f,a.shape,"float32")},ne.prototype.abs=function(b){for(var c=new Float32Array(b.size),d=this.readSync(b.dataId),a=0;a<d.length;++a)c[a]=Math.abs(d[a]);return this.makeOutput(c,b.shape,"float32")},ne.prototype.complexAbs=function(b){for(var c=new Float32Array(b.size),d=this.readSync(b.dataId),a=0;a<b.size;++a){var e=d[2*a],f=d[2*a+1];c[a]=Math.hypot(e,f)}return this.makeOutput(c,b.shape,"float32")},ne.prototype.int=function(a){nb(a,"int");for(var c=new Int32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=d[b];return this.makeOutput(c,a.shape,"int32")},ne.prototype.sigmoid=function(a){nb(a,"sigmoid");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=1/(1+Math.exp(-d[b]));return this.makeOutput(c,a.shape,"float32")},ne.prototype.softplus=function(c){nb(c,"softplus");for(var d=Math.log(11920928955078125e-23)+2,e=new Float32Array(c.size),b=this.readSync(c.dataId),a=0;a<b.length;++a){var f,h=b[a]> -d,i=b[a]<d,g=Math.exp(b[a]);f=i?g:h?b[a]:Math.log(1+g),e[a]=f}return this.makeOutput(e,c.shape,"float32")},ne.prototype.sin=function(a){nb(a,"sin");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.sin(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.cos=function(a){nb(a,"cos");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.cos(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.tan=function(a){nb(a,"tan");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.tan(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.asin=function(a){nb(a,"asin");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.asin(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.acos=function(a){nb(a,"acos");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.acos(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.atan=function(a){nb(a,"atan");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.atan(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.atan2=function(a,b){return nb([a,b],"atan2"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return Math.atan2(a,b)})},ne.prototype.sinh=function(a){nb(a,"sinh");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.sinh(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.cosh=function(a){nb(a,"cosh");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.cosh(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.tanh=function(a){nb(a,"tanh");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=ef(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.asinh=function(a){nb(a,"asinh");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.asinh(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.acosh=function(a){nb(a,"acosh");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.acosh(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.atanh=function(a){nb(a,"atanh");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),b=0;b<d.length;++b)c[b]=Math.atanh(d[b]);return this.makeOutput(c,a.shape,"float32")},ne.prototype.erf=function(c){nb(c,"erf");for(var f=new Float32Array(c.size),d=this.readSync(c.dataId),a=0;a<d.length;++a){var g=Math.sign(d[a]),e=Math.abs(d[a]),b=1/(1+.3275911*e);f[a]=g*(1-((((1.061405429*b-1.453152027)*b+1.421413741)*b-.284496736)*b+.254829592)*b*Math.exp(-e*e))}return this.makeOutput(f,c.shape,"float32")},ne.prototype.step=function(b,c){void 0===c&&(c=0),nb(b,"step");for(var d=new Float32Array(b.size),e=this.readSync(b.dataId),a=0;a<e.length;++a){var f=e[a];isNaN(f)?d[a]=NaN:d[a]=0<f?1:c}return this.makeOutput(d,b.shape,"float32")},ne.prototype.fusedConv2d=function(a){var e=a.input,f=a.filter,g=a.convInfo,c=a.bias,d=a.activation,h=a.preluActivationWeights,b=this.conv2d(e,f,g);return c&&(b=this.add(b,c)),d&&(b=nc(this,b,d,h)),b},ne.prototype.conv2d=function(b,e,a){nb([b,e],"conv2d");for(var p=a.filterHeight,q=a.filterWidth,r=a.dilationHeight,s=a.dilationWidth,t=a.padInfo.left,u=a.padInfo.top,d="channelsLast"===a.dataFormat,c=aH(a.outShape,b.dtype),v=b.strides[0],w=d?b.strides[1]:b.strides[2],x=d?b.strides[2]:1,y=d?1:b.strides[1],z=c.strides[0],A=d?c.strides[1]:c.strides[2],B=d?c.strides[2]:1,C=d?1:c.strides[1],D=this.readSync(b.dataId),E=this.readSync(e.dataId),F=c.values,f=0;f<a.batchSize;++f)for(var G=f*v,_=f*z,g=0;g<a.outHeight;++g)for(var H=_+g*A,I=g*a.strideHeight-u,h=0;h<p;h++){var l=I+h*r;if(!(l<0||l>=a.inHeight))for(var J=h*e.strides[0],K=G+l*w,i=0;i<a.outWidth;++i)for(var L=H+i*B,M=i*a.strideWidth-t,j=0;j<q;j++){var m=M+j*s;if(!(m<0||m>=a.inWidth))for(var N=K+m*x,o=J+j*e.strides[1],n=0;n<a.inChannels;++n){for(var O=D[N+n*y],k=0;k<a.outChannels;++k)F[L+k*C]+=O*E[o+k];o+=a.outChannels}}}return c.toTensor()},ne.prototype.conv3d=function(b,d,a){for(var r=a.filterDepth,s=a.filterHeight,t=a.filterWidth,u=a.dilationDepth,v=a.dilationHeight,w=a.dilationWidth,x=a.padInfo.front,y=a.padInfo.left,z=a.padInfo.top,c=aH(a.outShape,b.dtype),A=this.readSync(b.dataId),B=this.readSync(d.dataId),C=c.values,e=0;e<a.batchSize;++e)for(var D=e*b.strides[0],E=e*c.strides[0],f=0;f<a.outDepth;++f)for(var F=E+f*c.strides[1],G=f*a.strideDepth-x,g=0;g<r;g++){var m=G+g*u;if(!(m<0||m>=a.inDepth))for(var _=g*d.strides[0],H=D+m*b.strides[1],h=0;h<a.outHeight;++h)for(var I=F+h*c.strides[2],J=h*a.strideHeight-z,i=0;i<s;i++){var n=J+i*v;if(!(n<0||n>=a.inHeight))for(var K=_+i*d.strides[1],L=H+n*b.strides[2],j=0;j<a.outWidth;++j)for(var M=I+j*a.outChannels,N=j*a.strideWidth-y,k=0;k<t;k++){var o=N+k*w;if(!(o<0||o>=a.inWidth))for(var O=K+k*d.strides[2],P=L+o*a.inChannels,q=O,p=0;p<a.inChannels;++p){for(var Q=A[P+p],l=0;l<a.outChannels;++l)C[M+l]+=Q*B[q+l];q+=a.outChannels}}}}return c.toTensor()},ne.prototype.conv2dDerInput=function(b,k,a){nb([b,k],"conv2dDerInput");for(var c=aH(a.inShape,"float32"),t=c.values,u=this.readSync(b.dataId),v=this.readSync(k.dataId),l=k.strides,w=l[0],x=l[1],y=l[2],z=a.batchSize,m=a.filterHeight,n=a.filterWidth,A=a.inChannels,B=a.inHeight,C=a.inWidth,D=a.outChannels,E=a.outHeight,F=a.outWidth,o=a.strideHeight,p=a.strideWidth,G=a.dataFormat,H=m-1-a.padInfo.top,_=n-1-a.padInfo.left,d="channelsLast"===G,I=c.strides[0],J=d?c.strides[1]:c.strides[2],K=d?c.strides[2]:1,L=d?1:c.strides[1],M=b.strides[0],N=d?b.strides[1]:b.strides[2],O=d?b.strides[2]:1,P=d?1:b.strides[1],e=0;e<z;++e)for(var f=0;f<A;++f)for(var g=0;g<B;++g)for(var q=g-H,Q=Math.max(0,Math.ceil(q/o)),R=Math.min(E,(m+q)/o),h=0;h<C;++h){for(var r=h-_,S=Math.max(0,Math.ceil(r/p)),T=Math.min(F,(n+r)/p),s=0,i=Q;i<R;++i)for(var U=i*o-q,j=S;j<T;++j)for(var V=M*e+N*i+O*j,W=w*(m-1-U)+x*(n-1-(j*p-r))+y*f,$=0;$<D;++$)s+=u[V+P*$]*v[W+$];t[I*e+J*g+K*h+L*f]=s}return c.toTensor()},ne.prototype.conv3dDerInput=function(v,w,a){for(var m=aH(a.inShape,"float32"),y=m.values,b=m.strides,z=b[0],A=b[1],B=b[2],C=b[3],D=this.readSync(v.dataId),c=v.strides,E=c[0],F=c[1],G=c[2],H=c[3],I=this.readSync(w.dataId),d=w.strides,J=d[0],K=d[1],L=d[2],M=d[3],N=a.batchSize,n=a.filterDepth,_=a.filterHeight,o=a.filterWidth,O=a.inChannels,P=a.inDepth,Q=a.inHeight,R=a.inWidth,S=a.outChannels,T=a.outDepth,U=a.outHeight,V=a.outWidth,p=a.strideDepth,q=a.strideHeight,r=a.strideWidth,W=n-1-a.padInfo.front,X=_-1-a.padInfo.top,Y=o-1-a.padInfo.left,e=0;e<N;++e)for(var f=0;f<O;++f)for(var g=0;g<P;++g)for(var s=g-W,Z=Math.max(0,Math.ceil(s/p)),aa=Math.min(T,(n+s)/p),h=0;h<Q;++h)for(var t=h-X,ab=Math.max(0,Math.ceil(t/q)),ac=Math.min(U,(_+t)/q),$=0;$<R;++$){for(var u=$-Y,ad=Math.max(0,Math.ceil(u/r)),ae=Math.min(V,(o+u)/r),x=0,i=Z;i<aa;++i)for(var af=i*p-s,j=ab;j<ac;++j)for(var ag=j*q-t,k=ad;k<ae;++k)for(var ah=E*e+F*i+G*j+H*k,ai=J*(n-1-af)+K*(_-1-ag)+L*(o-1-(k*r-u))+M*f,l=0;l<S;++l)x+=D[ah+l]*I[ai+l];y[z*e+A*g+B*h+C*$+f]=x}return m.toTensor()},ne.prototype.conv2dDerFilter=function(m,n,a){nb([m,n],"conv2dDerFilter");for(var i=a.strideHeight,j=a.strideWidth,t=a.filterHeight,u=a.filterWidth,v="channelsLast"===a.dataFormat,o=aH(a.filterShape,"float32"),k=a.padInfo.left,l=a.padInfo.top,p=this.bufferSync(m),q=this.bufferSync(n),b=0;b<t;++b)for(var w=Math.max(0,Math.ceil((l-b)/i)),x=Math.min(a.outHeight,(a.inHeight+l-b)/i),c=0;c<u;++c)for(var y=Math.max(0,Math.ceil((k-c)/j)),z=Math.min(a.outWidth,(a.inWidth+k-c)/j),e=0;e<a.inChannels;++e)for(var f=0;f<a.outChannels;++f){for(var r=0,d=0;d<a.batchSize;++d)for(var g=w;g<x;++g)for(var _=b+g*i-l,h=y;h<z;++h){var s=c+h*j-k;r+=v?p.get(d,_,s,e)*q.get(d,g,h,f):p.get(d,e,_,s)*q.get(d,f,g,h)}o.set(r,b,c,e,f)}return o.toTensor()},ne.prototype.conv3dDerFilter=function(t,u,a){for(var m=a.strideDepth,n=a.strideHeight,o=a.strideWidth,w=a.filterDepth,x=a.filterHeight,y=a.filterWidth,p=aH(a.filterShape,"float32"),z=p.values,e=p.strides,A=e[0],B=e[1],C=e[2],D=e[3],E=this.readSync(u.dataId),f=u.strides,F=f[0],G=f[1],H=f[2],I=f[3],J=this.readSync(t.dataId),g=t.strides,_=g[0],K=g[1],L=g[2],M=g[3],q=a.padInfo.front,r=a.padInfo.left,s=a.padInfo.top,b=0;b<w;++b)for(var N=Math.max(0,Math.ceil((q-b)/m)),O=Math.min(a.outDepth,(a.inDepth+q-b)/m),P=b*A,c=0;c<x;++c)for(var Q=Math.max(0,Math.ceil((s-c)/n)),R=Math.min(a.outHeight,(a.inHeight+s-c)/n),S=c*B+P,d=0;d<y;++d)for(var T=Math.max(0,Math.ceil((r-d)/o)),U=Math.min(a.outWidth,(a.inWidth+r-d)/o),V=d*C+S,h=0;h<a.inChannels;++h)for(var W=h*D+V,i=0;i<a.outChannels;++i){for(var v=0,j=0;j<a.batchSize;++j)for(var X=j*_,Y=j*F,$=N;$<O;++$)for(var Z=(b+$*m-q)*K+X,aa=$*G+Y,k=Q;k<R;++k)for(var ab=(c+k*n-s)*L+Z,ac=k*H+aa,l=T;l<U;++l){var ad=l*I+ac;v+=J[(d+l*o-r)*M+ab+h]*E[ad+i]}z[W+i]=v}return p.toTensor()},ne.prototype.fusedDepthwiseConv2D=function(a){var e=a.input,f=a.filter,g=a.convInfo,c=a.bias,d=a.activation,h=a.preluActivationWeights,b=this.depthwiseConv2D(e,f,g);return c&&(b=this.add(b,c)),d&&(b=nc(this,b,d,h)),b},ne.prototype.depthwiseConv2D=function(b,d,a){nb([b,d],"depthwiseConv2D");for(var p=a.filterHeight,q=a.filterWidth,r=a.dilationHeight,s=a.dilationWidth,t=a.padInfo.left,u=a.padInfo.top,j=a.outChannels/a.inChannels,c=aH(a.outShape,b.dtype),v=this.readSync(b.dataId),w=this.readSync(d.dataId),x=c.values,e=0;e<a.batchSize;++e)for(var y=e*b.strides[0],z=e*c.strides[0],f=0;f<a.outHeight;++f)for(var A=z+f*c.strides[1],B=f*a.strideHeight-t,g=0;g<p;++g){var k=B+g*r;if(!(k<0||k>=a.inHeight))for(var C=g*d.strides[0],D=y+k*b.strides[1],_=0;_<a.outWidth;++_)for(var E=A+_*c.strides[2],F=_*a.strideWidth-u,h=0;h<q;++h){var l=F+h*s;if(!(l<0||l>=a.inWidth))for(var G=C+h*d.strides[1],H=D+l*a.inChannels,n=E,o=G,m=0;m<a.inChannels;++m){for(var I=v[H+m],i=0;i<j;++i)x[n+i]+=I*w[o+i];n+=j,o+=j}}}return c.toTensor()},ne.prototype.depthwiseConv2DDerInput=function(i,j,a){nb([i,j],"depthwiseConv2DDerInput");for(var k=aH(a.inShape,"float32"),x=k.values,l=k.strides,y=l[0],z=l[1],A=l[2],B=this.readSync(i.dataId),m=i.strides,C=m[0],D=m[1],E=m[2],F=this.readSync(j.dataId),n=j.strides,G=n[0],H=n[1],I=n[2],J=a.batchSize,o=a.filterHeight,p=a.filterWidth,u=a.inChannels,K=a.inHeight,_=a.inWidth,L=a.outChannels,M=a.outHeight,N=a.outWidth,q=a.strideHeight,r=a.strideWidth,O=o-1-a.padInfo.top,P=p-1-a.padInfo.left,v=L/u,c=0;c<J;++c)for(var b=0;b<u;++b)for(var d=0;d<K;++d)for(var s=d-O,Q=Math.max(0,Math.ceil(s/q)),R=Math.min(M,(o+s)/q),e=0;e<_;++e){for(var t=e-P,S=Math.max(0,Math.ceil(t/r)),T=Math.min(N,(p+t)/r),w=0,f=Q;f<R;++f)for(var U=f*q-s,g=S;g<T;++g)for(var V=C*c+D*f+E*g,W=G*(o-1-U)+H*(p-1-(g*r-t))+I*b,h=0;h<v;++h)w+=B[V+(b*v+h)]*F[W+h];x[y*c+z*d+A*e+b]=w}return k.toTensor()},ne.prototype.depthwiseConv2DDerFilter=function(k,l,a){nb([k,l],"depthwiseConv2DDerFilter");for(var g=a.strideHeight,h=a.strideWidth,q=a.filterHeight,r=a.filterWidth,m=aH(a.filterShape,"float32"),i=a.padInfo.left,j=a.padInfo.top,n=a.outChannels/a.inChannels,s=this.bufferSync(k),t=this.bufferSync(l),b=0;b<q;++b)for(var u=Math.max(0,Math.ceil((j-b)/g)),v=Math.min(a.outHeight,(a.inHeight+j-b)/g),c=0;c<r;++c)for(var w=Math.max(0,Math.ceil((i-c)/h)),x=Math.min(a.outWidth,(a.inWidth+i-c)/h),d=0;d<a.outChannels;++d){for(var o=Math.trunc(d/n),y=d%n,p=0,e=0;e<a.batchSize;++e)for(var _=u;_<v;++_)for(var z=b+_*g-j,f=w;f<x;++f){var A=c+f*h-i;p+=s.get(e,z,A,o)*t.get(e,_,f,d)}m.set(p,b,c,o,y)}return m.toTensor()},ne.prototype.tile=function(a,b){return nb(a,"tile"),kT(this.bufferSync(a),b)},ne.prototype.pad=function(a,e,f){nb(a,"pad");var h=e.map(function(b,c){return b[0]+a.shape[c]+b[1]}),j=e.map(function(a){return a[0]}),c=this.bufferSync(a),b=aH(h,a.dtype);0!==f&&b.values.fill(f);for(var d=0;d<a.size;d++){var g=c.indexToLoc(d),i=g.map(function(a,b){return a+j[b]});b.set.apply(b,[c.get.apply(c,g)].concat(i))}return b.toTensor()},ne.prototype.transpose=function(b,g){nb(b,"transpose");for(var d=new Array(b.rank),a=0;a<d.length;a++)d[a]=b.shape[g[a]];var i=this.readSync(b.dataId),e=aH(d,b.dtype),j=this.bufferSync(b);for(a=0;a<b.size;++a){for(var h=j.indexToLoc(a),f=new Array(h.length),c=0;c<f.length;c++)f[c]=h[g[c]];var k=e.locToIndex(f);e.values[k]=i[a]}return e.toTensor()},ne.prototype.gather=function(a,e,d){nb([a,e],"gather");var f=a.shape.slice(),g=this.readSync(e.dataId);f[d]=g.length;for(var b=aH(f,a.dtype),h=this.bufferSync(a),c=0;c<b.size;++c){var i=b.indexToLoc(c),j=i.slice();j[d]=g[i[d]];var k=h.locToIndex(j);b.values[c]=h.values[k]}return b.toTensor()},ne.prototype.batchToSpaceND=function(b,a,c){nb([b],"batchToSpaceND");var d=a.reduce(function(a,b){return a*b}),e=kx(b.shape,a,d),g=ky(e.length,a.length),f=kz(b.shape,a,d),h=kA(c,a.length),i=kB(f,c,a.length);return b.reshape(e).transpose(g).reshape(f).slice(h,i)},ne.prototype.spaceToBatchND=function(c,a,h){nb([c],"spaceToBatchND");var e=a.reduce(function(a,b){return a*b}),b=[[0,0]];b.push.apply(b,h);for(var f=1+a.length;f<c.shape.length;++f)b.push([0,0]);var d=c.pad(b),g=kx(d.shape,a,e,!1),i=ky(g.length,a.length,!1),j=kz(d.shape,a,e,!1);return d.reshape(g).transpose(i).reshape(j)},ne.prototype.pool=function(b,a,c){nb(b,"pool");for(var q=a.strideHeight,r=a.strideWidth,s=a.dilationHeight,t=a.dilationWidth,u=a.effectiveFilterHeight,v=a.effectiveFilterWidth,w=a.padInfo.top,x=a.padInfo.left,y="max"===c?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,z=this.readSync(b.dataId),l=aH(a.outShape,b.dtype),A=l.values,B=a.outShape[1]*a.outShape[2]*a.outShape[3],C=a.outShape[2]*a.outShape[3],D=a.outShape[3],d=0;d<a.batchSize;++d)for(var E=d*B,F=d*b.strides[0],e=0;e<a.inChannels;++e)for(var f=0;f<a.outHeight;++f)for(var m=f*q-w,_=Math.max(0,m),G=Math.min(a.inHeight,u+m),H=E+f*C,g=0;g<a.outWidth;++g){for(var n=g*r-x,I=Math.max(0,n),J=Math.min(a.inWidth,v+n),h=y,o=0,p=0,i=_;i<G;i+=s){for(var K=F+i*b.strides[1],j=I;j<J;j+=t){var k=z[K+j*b.strides[2]+e];"max"===c&&h<k?h=k:"avg"===c&&(o+=k,p++)}if(isNaN(h))break}A[H+g*D+e]="avg"===c?o/p:h}return l.toTensor()},ne.prototype.maxPool=function(a,b){return this.pool(a,b,"max")},ne.prototype.maxPoolPositions=function(r,a){for(var k=aH(a.outShape,"int32"),s=a.strideHeight,t=a.strideWidth,l=a.dilationHeight,m=a.dilationWidth,u=a.effectiveFilterHeight,n=a.effectiveFilterWidth,v=a.padInfo.top,w=a.padInfo.left,x=this.bufferSync(r),b=0;b<a.batchSize;++b)for(var c=0;c<a.inChannels;++c)for(var d=0;d<a.outHeight;++d){for(var g=d*s-v,h=g;h<0;)h+=l;for(var y=Math.min(a.inHeight,u+g),e=0;e<a.outWidth;++e){for(var i=e*t-w,j=i;j<0;)j+=m;for(var z=Math.min(a.inWidth,n+i),o=Number.NEGATIVE_INFINITY,p=-1,_=h;_<y;_+=l)for(var A=_-g,f=j;f<z;f+=m){var B=f-i,q=x.get(b,_,f,c);o<q&&(o=q,p=A*n+B)}k.set(p,b,d,e,c)}}return k.toTensor()},ne.prototype.maxPoolBackprop=function(o,j,p,a){nb([j,p],"maxPoolBackprop");for(var q=this.maxPoolPositions(j,a),r=a.strideHeight,s=a.strideWidth,t=a.dilationHeight,u=a.dilationWidth,k=a.effectiveFilterHeight,e=a.effectiveFilterWidth,v=e-1-a.padInfo.left,w=k-1-a.padInfo.top,l=aH(j.shape,"float32"),x=this.bufferSync(q),y=this.bufferSync(o),c=0;c<a.batchSize;++c)for(var d=0;d<a.inChannels;++d)for(var f=0;f<a.inHeight;++f)for(var g=0;g<a.inWidth;++g){for(var z=f-w,A=g-v,m=0,h=0;h<k;h+=t){var _=(z+h)/r;if(!(_<0||_>=a.outHeight||Math.floor(_)!==_))for(var i=0;i<e;i+=u){var b=(A+i)/s;if(!(b<0||b>=a.outWidth||Math.floor(b)!==b)){var n=k*e-1-x.get(c,_,b,d)===h*e+i?1:0;0!=n&&(m+=y.get(c,_,b,d)*n)}}}l.set(m,c,f,g,d)}return l.toTensor()},ne.prototype.avgPoolBackprop=function(i,j,a){nb([i,j],"avgPoolBackprop");for(var o=a.strideHeight,p=a.strideWidth,q=a.filterHeight,r=a.filterWidth,s=a.dilationHeight,t=a.dilationWidth,k=a.effectiveFilterHeight,l=a.effectiveFilterWidth,u=l-1-a.padInfo.left,v=k-1-a.padInfo.top,m=aH(j.shape,"float32"),w=1/(q*r),x=this.bufferSync(i),c=0;c<a.batchSize;++c)for(var d=0;d<a.inChannels;++d)for(var e=0;e<a.inHeight;++e)for(var f=0;f<a.inWidth;++f){for(var y=e-v,z=f-u,n=0,g=0;g<k;g+=s){var _=(y+g)/o;if(!(_<0||_>=a.outHeight||Math.floor(_)!==_))for(var h=0;h<l;h+=t){var b=(z+h)/p;b<0||b>=a.outWidth||Math.floor(b)!==b||(n+=x.get(c,_,b,d))}}m.set(n*w,c,e,f,d)}return m.toTensor()},ne.prototype.pool3d=function(b,a,d){nb(b,"pool3d");for(var y=a.strideDepth,z=a.strideHeight,A=a.strideWidth,p=a.dilationDepth,q=a.dilationHeight,r=a.dilationWidth,B=a.effectiveFilterDepth,C=a.effectiveFilterHeight,D=a.effectiveFilterWidth,E=a.padInfo.front,F=a.padInfo.top,G=a.padInfo.left,H="max"===d?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,I=this.readSync(b.dataId),s=aH(a.outShape,b.dtype),J=s.values,K=a.outShape[1]*a.outShape[2]*a.outShape[3]*a.outShape[4],L=a.outShape[2]*a.outShape[3]*a.outShape[4],M=a.outShape[3]*a.outShape[4],N=a.outShape[4],e=0;e<a.batchSize;++e)for(var _=e*K,O=e*b.strides[0],f=0;f<a.inChannels;++f)for(var g=0;g<a.outDepth;++g){for(var t=g*y-E,j=t;j<0;)j+=p;for(var P=Math.min(a.inDepth,B+t),Q=_+g*L,h=0;h<a.outHeight;++h){for(var u=h*z-F,k=u;k<0;)k+=q;for(var R=Math.min(a.inHeight,C+u),S=Q+h*M,i=0;i<a.outWidth;++i){for(var v=i*A-G,l=v;l<0;)l+=r;for(var T=Math.min(a.inWidth,D+v),U=S+i*N,c=H,w=0,x=0,m=j;m<P;m+=p){for(var V=O+m*b.strides[1],n=k;n<R;n+=q){for(var W=V+n*b.strides[2],o=l;o<T;o+=r){var $=I[W+o*b.strides[3]+f];if("max"===d&&c<$?c=$:"avg"===d&&(w+=$,x++),isNaN(c))break}if(isNaN(c))break}if(isNaN(c))break}J[U+f]="avg"===d?w/x:c}}}return s.toTensor()},ne.prototype.avgPool3d=function(a,b){return nb(a,"avgPool3d"),this.pool3d(a,b,"avg").toFloat()},ne.prototype.avgPool3dBackprop=function(l,m,a){nb([l,m],"avgPool3dBackprop");for(var s=a.strideDepth,t=a.strideHeight,u=a.strideWidth,v=a.filterDepth,w=a.filterHeight,x=a.filterWidth,y=a.dilationDepth,z=a.dilationHeight,A=a.dilationWidth,n=a.effectiveFilterDepth,o=a.effectiveFilterHeight,p=a.effectiveFilterWidth,B=n-1-a.padInfo.front,C=p-1-a.padInfo.left,D=o-1-a.padInfo.top,q=aH(m.shape,"float32"),E=1/(v*w*x),F=this.bufferSync(l),e=0;e<a.batchSize;++e)for(var f=0;f<a.inChannels;++f)for(var g=0;g<a.inDepth;++g)for(var _=0;_<a.inHeight;++_)for(var h=0;h<a.inWidth;++h){for(var G=g-B,H=_-D,I=h-C,r=0,i=0;i<n;i+=y){var b=(G+i)/s;if(!(b<0||b>=a.outDepth||Math.floor(b)!==b))for(var j=0;j<o;j+=z){var c=(H+j)/t;if(!(c<0||c>=a.outHeight||Math.floor(c)!==c))for(var k=0;k<p;k+=A){var d=(I+k)/u;d<0||d>=a.outWidth||Math.floor(d)!==d||(r+=F.get(e,b,c,d,f))}}}q.set(r*E,e,g,_,h,f)}return q.toTensor()},ne.prototype.maxPool3d=function(a,b){return nb(a,"maxPool3d"),this.pool3d(a,b,"max").toFloat()},ne.prototype.maxPool3dPositions=function(x,a){for(var p=aH(a.outShape,"int32"),y=a.strideDepth,z=a.strideHeight,A=a.strideWidth,q=a.dilationDepth,r=a.dilationHeight,s=a.dilationWidth,B=a.effectiveFilterDepth,j=a.effectiveFilterHeight,t=a.effectiveFilterWidth,C=a.padInfo.front,D=a.padInfo.top,E=a.padInfo.left,F=this.bufferSync(x),b=0;b<a.batchSize;++b)for(var c=0;c<a.inChannels;++c)for(var d=0;d<a.outDepth;++d){for(var k=d*y-C,l=k;l<0;)l+=q;for(var G=Math.min(a.inDepth,B+k),e=0;e<a.outHeight;++e){for(var m=e*z-D,_=m;_<0;)_+=r;for(var H=Math.min(a.inHeight,j+m),f=0;f<a.outWidth;++f){for(var n=f*A-E,o=n;o<0;)o+=s;for(var I=Math.min(a.inWidth,t+n),u=Number.NEGATIVE_INFINITY,v=-1,g=l;g<G;g+=q)for(var J=g-k,h=_;h<H;h+=r)for(var K=h-m,i=o;i<I;i+=s){var L=i-n,w=F.get(b,g,h,i,c);u<=w&&(u=w,v=J*j*t+K*j+L)}p.set(v,b,d,e,f,c)}}}return p.toTensor()},ne.prototype.maxPool3dBackprop=function(s,n,t,a){nb([n,t],"maxPool3dBackprop");for(var u=this.maxPool3dPositions(n,a),v=a.strideDepth,w=a.strideHeight,x=a.strideWidth,y=a.dilationDepth,z=a.dilationHeight,A=a.dilationWidth,o=a.effectiveFilterDepth,h=a.effectiveFilterHeight,e=a.effectiveFilterWidth,B=o-1-a.padInfo.front,C=e-1-a.padInfo.left,D=h-1-a.padInfo.top,p=aH(n.shape,"float32"),E=this.bufferSync(u),F=this.bufferSync(s),f=0;f<a.batchSize;++f)for(var g=0;g<a.inChannels;++g)for(var i=0;i<a.inDepth;++i)for(var j=0;j<a.inHeight;++j)for(var _=0;_<a.inWidth;++_){for(var G=i-B,H=j-D,I=_-C,q=0,k=0;k<o;k+=y){var b=(G+k)/v;if(!(b<0||b>=a.outDepth||Math.floor(b)!==b))for(var l=0;l<h;l+=z){var c=(H+l)/w;if(!(c<0||c>=a.outHeight||Math.floor(c)!==c))for(var m=0;m<e;m+=A){var d=(I+m)/x;if(!(d<0||d>=a.outWidth||Math.floor(d)!==d)){var r=o*h*e-1-E.get(f,b,c,d,g)===k*h*e+l*e+m?1:0;0!=r&&(q+=F.get(f,b,c,d,g)*r)}}}}p.set(q,f,i,j,_,g)}return p.toTensor()},ne.prototype.cast=function(a,b){return ge(a,b,this)},ne.prototype.reshape=function(a,b){return gf(a,b)},ne.prototype.avgPool=function(a,b){return nb(a,"avgPool"),this.pool(a,b,"avg").toFloat()},ne.prototype.resizeBilinear=function(a,b,c,e){nb(a,"resizeBilinear");for(var f=a.shape,i=f[0],j=f[1],k=f[2],l=f[3],g=this.readSync(a.dataId),q=new Float32Array(ec([i,b,c,l])),r=[e&&1<b?j-1:j,e&&1<c?k-1:k],s=[e&&1<b?b-1:b,e&&1<c?c-1:c],B=0,C=r[0]/s[0],D=r[1]/s[1],h=0;h<i;h++)for(var m=0;m<b;m++)for(var n=C*m,t=Math.floor(n),E=n-t,F=Math.min(j-1,Math.ceil(n)),u=h*a.strides[0]+t*a.strides[1],v=h*a.strides[0]+F*a.strides[1],_=0;_<c;_++)for(var o=D*_,p=Math.floor(o),w=o-p,x=Math.min(k-1,Math.ceil(o)),G=u+p*a.strides[2],H=v+p*a.strides[2],I=u+x*a.strides[2],J=v+x*a.strides[2],d=0;d<l;d++){var y=g[G+d],z=g[H+d],A=y+(g[I+d]-y)*w,K=A+(z+(g[J+d]-z)*w-A)*E;q[B++]=K}return al(q,[i,b,c,l])},ne.prototype.resizeBilinearBackprop=function(k,a,h){nb([k,a],"resizeBilinearBackprop");for(var i=a.shape,l=i[0],c=i[1],d=i[2],m=i[3],v=k.shape,e=v[1],f=v[2],g=new Float32Array(l*c*d*m),w=[h&&1<e?c-1:c,h&&1<f?d-1:d],x=[h&&1<e?e-1:e,h&&1<f?f-1:f],E=w[0]/x[0],F=w[1]/x[1],G=this.readSync(k.dataId),H=0,n=0;n<l;n++)for(var y=n*a.strides[0],o=0;o<e;o++)for(var p=o*E,z=Math.floor(p),I=Math.min(Math.ceil(p),c-1),_=y+z*a.strides[1],A=y+I*a.strides[1],q=p-z,B=1-q,r=0;r<f;r++)for(var s=r*F,t=Math.floor(s),C=Math.min(Math.ceil(s),d-1),u=s-t,D=1-u,J=_+t*a.strides[2],K=_+C*a.strides[2],L=A+t*a.strides[2],M=A+C*a.strides[2],N=B*D,O=B*u,P=q*D,Q=q*u,b=0;b<m;b++){var j=G[H++];g[J+b]+=j*N,g[K+b]+=j*O,g[L+b]+=j*P,g[M+b]+=j*Q}return aq(g,[l,d,c,m],a.dtype)},ne.prototype.resizeNearestNeighbor=function(a,b,c,d){nb(a,"resizeNearestNeighbor");for(var e=a.shape,f=e[0],g=e[1],h=e[2],i=e[3],r=this.readSync(a.dataId),m=new Float32Array(f*b*c*i),n=[d&&1<b?g-1:g,d&&1<c?h-1:h],o=[d&&1<b?b-1:b,d&&1<c?c-1:c],s=n[0]/o[0],t=n[1]/o[1],u=0,j=0;j<f;j++)for(var v=j*a.strides[0],k=0;k<b;k++)for(var p=s*k,w=v+Math.min(g-1,d?Math.round(p):Math.floor(p))*a.strides[1],l=0;l<c;l++)for(var q=t*l,x=w+Math.min(h-1,d?Math.round(q):Math.floor(q))*a.strides[2],_=0;_<i;_++){var y=r[x+_];m[u++]=y}return al(m,[f,b,c,i],a.dtype)},ne.prototype.resizeNearestNeighborBackprop=function(c,a,b){nb([c,a],"resizeNearestNeighborBackprop");for(var j=a.shape,q=j[0],d=j[1],e=j[2],r=j[3],s=c.shape,f=s[1],g=s[2],t=new Float32Array(q*d*e*r),G=this.readSync(c.dataId),u=[b&&1<f?d-1:d,b&&1<g?e-1:e],v=[b&&1<f?f-1:f,b&&1<g?g-1:g],w=u[0]/v[0],x=u[1]/v[1],y=1/w,z=1/x,A=2*Math.ceil(y)+2,B=2*Math.ceil(z)+2,n=0;n<q;n++)for(var C=n*a.strides[0],h=0;h<d;h++)for(var _=C+h*a.strides[1],H=Math.floor(h*y),I=Math.floor(H-A/2),i=0;i<e;i++)for(var J=_+i*a.strides[2],K=Math.floor(i*z),L=Math.floor(K-B/2),k=0;k<r;k++){for(var D=0,o=0;o<A;o++){var l=o+I;if(!(l<0||f<=l)){var M=C+l*c.strides[1],E=l*w;if(h===Math.min(d-1,b?Math.round(E):Math.floor(E)))for(var p=0;p<B;p++){var m=p+L;if(!(m<0||g<=m)){var N=M+m*c.strides[2],F=m*x;i===Math.min(e-1,b?Math.round(F):Math.floor(F))&&(D+=G[N+k])}}}}t[J+k]=D}return aq(t,a.shape,a.dtype)},ne.prototype.batchNormalization=function(b,j,k,q,c,d){nb([b,j,k,c,d],"batchNorm");for(var e=this.readSync(b.dataId),l=this.readSync(j.dataId),m=this.readSync(k.dataId),n=c?this.readSync(c.dataId):new Float32Array([1]),o=d?this.readSync(d.dataId):new Float32Array([0]),p=new Float32Array(e.length),r=o.length,s=n.length,t=m.length,u=l.length,f=0,g=0,h=0,i=0,a=0;a<e.length;++a)p[a]=o[f++]+(e[a]-l[g++])*n[h++]/Math.sqrt(m[i++]+q),r<=f&&(f=0),u<=g&&(g=0),s<=h&&(h=0),t<=i&&(i=0);return aq(p,b.shape)},ne.prototype.localResponseNormalization4D=function(a,m,e,f,g){nb(a,"localResponseNormalization4D");var h=a.shape[3],n=h-1,i=this.readSync(a.dataId),c=a.size,d=new Float32Array(c);function j(b){for(var a=b%h,c=b-a+Math.max(0,a-m),f=b-a+Math.min(a+m,n),d=0;c<=f;c++){var e=i[c];d+=e*e}return d}for(var b=0;b<c;b++){var k=j(b),l=i[b]*Math.pow(e+f*k,-g);d[b]=l}return aq(d,a.shape)},ne.prototype.LRNGrad=function(c,o,p,g,q,h,i){nb(c,"LRNGrad");for(var j=c.shape[3],r=this.readSync(c.dataId),k=this.readSync(o.dataId),s=this.readSync(p.dataId),l=new Float32Array(c.size),t=c.size,b=0;b<t;b++){for(var e=b%j,m=b-e+Math.max(0,e-g),n=b-e+Math.min(j,e+g+1),d=0,a=m;a<n;a++)d+=Math.pow(k[a],2);for(d=h*d+q,a=m;a<n;a++){var f=-2*h*i*k[a]*s[b]/d;b===a&&(f+=Math.pow(d,-i)),f*=r[b],l[a]+=f}}return aq(l,c.shape)},ne.prototype.multinomial=function(f,p,g,q){nb(f,"multinomial");for(var h=p?f:a8(f),i=h.shape[0],j=h.shape[1],k=av([i,g],"int32"),l=this.readSync(k.dataId),m=this.readSync(h.dataId),c=0;c<i;++c){var n=c*j,a=new Float32Array(j-1);a[0]=m[n];for(var b=1;b<a.length;++b)a[b]=a[b-1]+m[n+b];for(var r=kq(q.toString()),o=c*g,d=0;d<g;++d){var s=r();l[o+d]=a.length;for(var e=0;e<a.length;e++)if(s<a[e]){l[o+d]=e;break}}}return k},ne.prototype.oneHot=function(b,c,f,g){nb(b,"oneHot");var d=new Float32Array(b.size*c);d.fill(g);for(var e=this.readSync(b.dataId),a=0;a<b.size;++a)0<=e[a]&&e[a]<c&&(d[a*c+e[a]]=f);return ao(d,[b.size,c],"int32")},ne.prototype.nonMaxSuppression=function(a,b,c,d,e){return nb(a,"nonMaxSuppression"),kN(this.readSync(a.dataId),this.readSync(b.dataId),c,d,e)},ne.prototype.fft=function(a){return this.fftBatch(a,!1)},ne.prototype.ifft=function(a){return this.fftBatch(a,!0)},ne.prototype.fftBatch=function(b,i){for(var e=b.shape[0],a=b.shape[1],f=aH(b.shape,"float32"),g=aH(b.shape,"float32"),j=aj(b).as2D(e,a),k=ak(b).as2D(e,a),c=0;c<e;c++)for(var l=j.slice([c,0],[1,a]),m=k.slice([c,0],[1,a]),n=ai(l,m),o=this.readSync(this.fftImpl(n,i).dataId),d=0;d<a;d++){var h=kL(o,d);f.values[c*a+d]=h.real,g.values[c*a+d]=h.imag}return ai(f.toTensor(),g.toTensor()).as2D(e,a)},ne.prototype.fftImpl=function(a,d){var e=a.as1D(),b=e.size;if(this.isExponentOf2(b)){var c=this.fftRadix2(e,b,d).as2D(a.shape[0],a.shape[1]);return d&&(c=ai(aj(c).div(am(b)),ak(c).div(am(b)))),c}var g=this.readSync(a.dataId),f=function(b){for(var c=new Float32Array(b.length/2),d=new Float32Array(b.length/2),a=0;a<b.length;a+=2)c[a/2]=b[a],d[a/2]=b[a+1];return{real:c,imag:d}}(this.fourierTransformByMatmul(g,b,d));return ai(f.real,f.imag).as2D(a.shape[0],a.shape[1])},ne.prototype.isExponentOf2=function(a){return 0==(a&a-1)},ne.prototype.fftRadix2=function(e,b,c){if(1===b)return e;var f=this.readSync(e.dataId),g=b/2,h=function(b){for(var c=Math.ceil(b.length/4),d=new Float32Array(c),e=new Float32Array(c),a=0;a<b.length;a+=4)d[Math.floor(a/4)]=b[a],e[Math.floor(a/4)]=b[a+1];return{real:d,imag:e}}(f),a=ai(h.real,h.imag).as1D(),i=function(b){for(var c=Math.floor(b.length/4),d=new Float32Array(c),e=new Float32Array(c),a=2;a<b.length;a+=4)d[Math.floor(a/4)]=b[a],e[Math.floor(a/4)]=b[a+1];return{real:d,imag:e}}(f),d=ai(i.real,i.imag).as1D();a=this.fftRadix2(a,g,c),d=this.fftRadix2(d,g,c);var j=function(b,f){for(var c=new Float32Array(b/2),d=new Float32Array(b/2),a=0;a<Math.ceil(b/2);a++){var e=(f?2:-2)*Math.PI*(a/b);c[a]=Math.cos(e),d[a]=Math.sin(e)}return{real:c,imag:d}}(b,c),k=ai(j.real,j.imag).mul(d),l=a.add(k),m=a.sub(k),n=aj(l).concat(aj(m)),o=ak(l).concat(ak(m));return ai(n,o).as1D()},ne.prototype.fourierTransformByMatmul=function(o,a,i){for(var j,k,l,m,p,f,n=new Float32Array(2*a),b=0;b<a;b++){for(var g=0,h=0,c=0;c<a;c++){var d=(f=(i?2:-2)*Math.PI*(b*c/a),{real:Math.cos(f),imag:Math.sin(f)}),e=kL(o,c);g+=e.real*d.real-e.imag*d.imag,h+=e.real*d.imag+e.imag*d.real}i&&(g/=a,h/=a),k=g,l=h,(j=n)[2*(m=b)]=k,j[2*m+1]=l}return n},ne.prototype.depthToSpace=function(b,a,o){d8("NHWC"===o,function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+o}),d8(1<a,function(){return"blockSize should be > 1 for depthToSpace, but was: "+a});for(var f=b.shape[0],k=b.shape[1],l=b.shape[2],m=b.shape[3],g=k*a,h=l*a,c=m/(a*a),p=this.readSync(b.dataId),n=new Float32Array(f*g*h*c),q=0,i=0;i<f;++i)for(var d=0;d<g;++d)for(var r=Math.floor(d/a),s=d%a,e=0;e<h;++e)for(var t=Math.floor(e/a),u=(s*a+e%a)*c,j=0;j<c;++j){var v=j+u+m*(t+l*(r+k*i));n[q++]=p[v]}return aq(n,[f,g,h,c])},ne.prototype.broadcastedBinaryOp=function(b,c,i,j){var d=f5(b.shape,c.shape),f=aH(d,i),g=this.readSync(b.dataId),h=this.readSync(c.dataId),k=f3(b.shape,d),l=f3(c.shape,d),e=f.values;if(k.length+l.length===0)for(var a=0;a<e.length;++a)e[a]=j(g[a%g.length],h[a%h.length]);else{var n=this.bufferSync(b),o=this.bufferSync(c),m=function(a){var d=f.indexToLoc(a),i=d.slice(-b.rank);k.forEach(function(a){return i[a]=0});var m=n.locToIndex(i),p=d.slice(-c.rank);l.forEach(function(a){return p[a]=0});var q=o.locToIndex(p);e[a]=j(g[m],h[q])};for(a=0;a<e.length;++a)m(a)}return f.toTensor()},ne.prototype.broadcastedBinaryComplexOp=function(b,c,m){var d=f5(b.shape,c.shape),h=aH(d,"float32"),i=aH(d,"float32"),e=this.readSync(b.dataId),f=this.readSync(c.dataId),n=f3(b.shape,d),o=f3(c.shape,d),g=h.values,p=i.values;if(n.length+o.length===0)for(var a=0;a<g.length;a++){var j=a%e.length,k=a%f.length,l=m(e[2*j],e[2*j+1],f[2*k],f[2*k+1]);g[a]=l.real,p[a]=l.imag}else{var r=this.bufferSync(this.data.get(b.dataId).complexTensors.real),s=this.bufferSync(this.data.get(c.dataId).complexTensors.real),q=function(a){var d=h.indexToLoc(a),l=d.slice(-b.rank);n.forEach(function(a){return l[a]=0});var i=r.locToIndex(l),q=d.slice(-c.rank);o.forEach(function(a){return q[a]=0});var j=s.locToIndex(q),k=m(e[2*i],e[2*i+1],f[2*j],f[2*j+1]);g[a]=k.real,p[a]=k.imag};for(a=0;a<g.length;a++)q(a)}return this.complex(h.toTensor(),i.toTensor())},ne.prototype.split=function(a,b,c){return kS(a,b,c)},ne.prototype.dispose=function(){},ne.prototype.floatPrecision=function(){return 32},ne.prototype.epsilon=function(){return 1e-7},ne.prototype.cropAndResize=function(v,B,L,C,M,w){for(var r=v.shape,N=r[0],s=r[1],j=r[2],l=r[3],D=B.shape[0],o=C[0],g=C[1],k=aH([D,o,g,l],"float32"),t=this.readSync(B.dataId),O=this.readSync(L.dataId),p=this.readSync(v.dataId),b=v.strides,c=k.strides,f=0;f<D;f++){var u=4*f,x=t[u],q=t[1+u],_=t[2+u],y=t[3+u],m=O[f];if(!(N<=m))for(var P=1<o?(_-x)*(s-1)/(o-1):0,E=1<g?(y-q)*(j-1)/(g-1):0,h=0;h<o;h++){var i,n=1<o?x*(s-1)+h*P:.5*(x+_)*(s-1);if(n<0||s-1<n)for(var d=0;d<g;d++)for(var a=0;a<l;a++){var e=a+d*c[2]+h*c[1]+f*c[0];k.values[e]=w}else if("bilinear"===M){var z=Math.floor(n),F=Math.ceil(n),Q=n-z;for(d=0;d<g;d++)if((i=1<g?q*(j-1)+d*E:.5*(q+y)*(j-1))<0||j-1<i)for(a=0;a<l;a++)e=a+d*c[2]+h*c[1]+f*c[0],k.values[e]=w;else{var A=Math.floor(i),G=Math.ceil(i),H=i-A;for(a=0;a<l;a++){var I=p[e=a+A*b[2]+z*b[1]+m*b[0]],R=p[e=a+G*b[2]+z*b[1]+m*b[0]],J=p[e=a+A*b[2]+F*b[1]+m*b[0]],K=I+(R-I)*H,S=J+(p[e=a+G*b[2]+F*b[1]+m*b[0]]-J)*H;e=a+d*c[2]+h*c[1]+f*c[0],k.values[e]=K+(S-K)*Q}}}else for(d=0;d<g;++d)if((i=1<g?q*(j-1)+d*E:.5*(q+y)*(j-1))<0||j-1<i)for(a=0;a<l;a++)e=a+d*c[2]+h*c[1]+f*c[0],k.values[e]=w;else{var T=Math.round(i),U=Math.round(n);for(a=0;a<l;a++){var V=a+T*b[2]+U*b[1]+m*b[0],W=a+d*c[2]+h*c[1]+f*c[0];k.values[W]=p[V]}}}}return k.toTensor()},ne.prototype.sparseToDense=function(b,d,c,e){var a=fS(0,b,c),f=a.sliceRank,g=a.numUpdates,h=a.sliceSize,i=a.strides,j=a.outputSize;return this.scatter(b,d,c,j,h,g,f,i,e,!1)},ne.prototype.gatherND=function(a,h){var j=h.shape,k=j[j.length-1],c=fN(a,h),l=c[0],i=c[1],b=c[2],p=c[3];if(0===i)return al([],l,a.dtype);for(var m=new eJ([i,b],a.dtype),q=this.readSync(h.dataId),r=this.readSync(a.dataId),d=0;d<i;d++){for(var n=[],e=0,f=0;f<k;f++){var o=q[d*k+f];e+=o*p[f],n.push(o)}if(e<0||e>=a.size/b)throw new Error("Invalid indices: "+n+" does not index into "+a.shape);for(var g=0;g<b;g++)m.values[d*b+g]=r[e*b+g]}return m.toTensor().reshape(l)},ne.prototype.scatterND=function(b,d,c){var a=fS(0,b,c),e=a.sliceRank,f=a.numUpdates,g=a.sliceSize,h=a.strides,i=a.outputSize,j=am(0);return this.scatter(b,d,c,i,g,f,e,h,j,!0)},ne.prototype.fill=function(b,c,a){var d=en(a=a||ex(c),ec(b));return d.fill(c),ad.makeTensor(d,b,a,this)},ne.prototype.onesLike=function(a){if("string"===a.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(a.shape,1,a.dtype)},ne.prototype.zerosLike=function(a){var b=en(a.dtype,ec(a.shape));return this.makeOutput(b,a.shape,a.dtype)},ne.prototype.linspace=function(a,b,c){return gg(a,b,c)},ne.prototype.scatter=function(n,e,h,i,a,o,k,p,q,r){var s=[i/a,a],t=this.readSync(n.dataId),j=this.readSync(e.dataId);if(0===i)return al([],h,e.dtype);var f=new eJ(s,e.dtype);f.values.fill(this.readSync(q.dataId)[0]);for(var c=0;c<o;c++){for(var l=[],d=0,g=0;g<k;g++){var m=t[c*k+g];l.push(m),d+=m*p[g]}if(d<0||i/a<=d)throw new Error("Invalid indices: "+l+" does not index into "+h);for(var b=0;b<a;b++)r?f.values[d*a+b]+=j[c*a+b]:f.values[d*a+b]=0===e.rank?j[0]:j[c*a+b]}return f.toTensor().reshape(h)},ne);function ne(){var a=g0.call(this)||this;return a.blockSize=48,a.firstUse=!0,a.data=new f2(a,ad),a}function nf(a){this.variableNames=["A"];var b=k_(),c=a[0],d=a[1];this.outputShape=a,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+d+".0, "+c+".0);\n\n        vec4 values = "+b.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "}function ng(a){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var b=k_(),c=a[0],d=a[1];this.outputShape=a,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) /\n                       vec2("+d+".0, "+c+".0);\n            vec4 values = "+b.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+b.output+" = result;\n      }\n    "}ad.registerBackend("cpu",function(){return new nd},1),u({kernelName:"Square",backendName:"cpu",kernelFunc:function(d){var h=d.inputs,i=d.backend,a=h.x,e=i;nb(a,"square");for(var c=e.data.get(a.dataId).values,f=new Float32Array(c.length),b=0;b<c.length;++b){var g=c[b];f[b]=g*g}return{dataId:e.write(f,a.shape,a.dtype),shape:a.shape,dtype:a.dtype}}}),u({kernelName:"NonMaxSuppressionV5",backendName:"cpu",kernelFunc:function(b){var g=b.inputs,h=b.backend,i=b.attrs,c=g,d=c.boxes,j=c.scores,a=i,k=a.maxOutputSize,l=a.iouThreshold,m=a.scoreThreshold,n=a.softNmsSigma,e=h;nb(d,"NonMaxSuppressionWithScore");var f=kO(e.data.get(d.dataId).values,e.data.get(j.dataId).values,k,l,m,n);return[f.selectedIndices,f.selectedScores]}}),u({kernelName:"Square",backendName:"webgl",kernelFunc:function(b){var c=b.inputs,d=b.backend,a=c.x,e=d,f=new my(a.shape,"return x * x;");return e.runWebGLProgram(f,[a],a.dtype)}}),u({kernelName:"FromPixels",backendName:"webgl",kernelFunc:function(f){var k=f.inputs,b=f.backend,l=f.attrs,a=k.pixels,m=l.numChannels,g="undefined"!=typeof HTMLVideoElement&&a instanceof HTMLVideoElement,n="undefined"!=typeof HTMLImageElement&&a instanceof HTMLImageElement,h=g?[a.videoWidth,a.videoHeight]:[a.width,a.height],c=h[0],d=h[1],o=[d,c],j=[d,c,m];(n||g)&&(null==ni&&(ni=document.createElement("canvas").getContext("2d")),ni.canvas.width=c,ni.canvas.height=d,ni.drawImage(a,0,0,c,d),a=ni.canvas);var e=b.makeTensorInfo(o,"int32");b.texData.get(e.dataId).usage=af.PIXELS,b.gpgpu.uploadPixelDataToTexture(b.getTexture(e.dataId),a);var p=i.getBool("WEBGL_PACK")?new ng(j):new nf(j),q=b.runWebGLProgram(p,[e],"int32");return b.disposeData(e.dataId),q}}),u({kernelName:"NonMaxSuppressionV5",backendName:"webgl",kernelFunc:function(b){var f=b.inputs,g=b.backend,h=b.attrs;kk("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var c=f,i=c.boxes,j=c.scores,a=h,k=a.maxOutputSize,l=a.iouThreshold,m=a.scoreThreshold,n=a.softNmsSigma,d=g,e=kO(d.readSync(i.dataId),d.readSync(j.dataId),k,l,m,n);return[e.selectedIndices,e.selectedScores]}});var g1=(nh.prototype.fetch=function(a,b){return fetch(a,b)},nh.prototype.now=function(){return performance.now()},nh.prototype.encode=function(b,a){if("utf-8"!==a&&"utf8"!==a)throw new Error("Browser's encoder only supports utf-8, but got "+a);return null==this.textEncoder&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(b)},nh.prototype.decode=function(a,b){return new TextDecoder(b).decode(a)},nh);function nh(){}i.get("IS_BROWSER")&&i.setPlatform("browser",new g1);var ni,nj,g2=(nk.prototype.fetch=function(a,b){return null!=i.global.fetch?i.global.fetch(a,b):(null==nj&&(nj=require("node-fetch")),nj(a,b))},nk.prototype.now=function(){var a=process.hrtime();return 1e3*a[0]+a[1]/1e6},nk.prototype.encode=function(b,a){if("utf-8"!==a&&"utf8"!==a)throw new Error("Node built-in encoder only supports utf-8, but got "+a);return this.textEncoder.encode(b)},nk.prototype.decode=function(a,b){return 0===a.length?"":new this.util.TextDecoder(b).decode(a)},nk);function nk(){this.util=require("util"),this.textEncoder=new this.util.TextEncoder}i.get("IS_NODE")&&i.setPlatform("node",new g2);var nl={float32:4,int32:4,uint16:2,uint8:1,bool:1},nm=4;function g3(f,c){for(var d={},g=0,e=function(c){var j=c.name,a=c.dtype,k=c.shape,i=ec(k),b=void 0;if(("quantization"in c)){var h=c.quantization;if("uint8"!==h.dtype&&"uint16"!==h.dtype)throw new Error("Weight "+c.name+" has unknown quantization dtype "+h.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var l=nl[h.dtype],e=f.slice(g,g+i*l),m="uint8"===h.dtype?new Uint8Array(e):new Uint16Array(e);if("float32"===a)b=Float32Array.from(m,function(a){return a*h.scale+h.min});else{if("int32"!==a)throw new Error("Unsupported dtype in weight '"+j+"': "+a);b=Int32Array.from(m,function(a){return Math.round(a*h.scale+h.min)})}g+=i*l}else if("string"===a){var q=ec(c.shape);b=[];for(var n=0;n<q;n++){var o=new Uint32Array(f.slice(g,g+nm))[0];g+=nm;var r=new Uint8Array(f.slice(g,g+o));b.push(r),g+=o}}else{var p=nl[a];if(e=f.slice(g,g+i*p),"float32"===a)b=new Float32Array(e);else if("int32"===a)b=new Int32Array(e);else{if("bool"!==a)throw new Error("Unsupported dtype in weight '"+j+"': "+a);b=new Uint8Array(e)}g+=i*p}d[j]=al(b,k,a)},a=0,b=c;a<b.length;a++)e(b[a]);return d}var nn="undefined"!=typeof Buffer&&("undefined"==typeof Blob||"undefined"==typeof atob||"undefined"==typeof btoa);function no(a){return nn?Buffer.byteLength(a):new Blob([a]).size}function g4(a){var b=0;a.forEach(function(a){b+=a.byteLength});var c=new Uint8Array(b),d=0;return a.forEach(function(a){c.set(new Uint8Array(a),d),d+=a.byteLength}),c.buffer}function np(a){for(a=a.trim();a.endsWith("/");)a=a.slice(0,a.length-1);var b=a.split("/");return b[b.length-1]}function g5(a){if(a.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==a.modelTopology?0:no(JSON.stringify(a.modelTopology)),weightSpecsBytes:null==a.weightSpecs?0:no(JSON.stringify(a.weightSpecs)),weightDataBytes:null==a.weightData?0:a.weightData.byteLength}}var s=(ns.getInstance=function(){return null==ns.instance&&(ns.instance=new ns),ns.instance},ns.registerSaveRouter=function(a){ns.getInstance().saveRouters.push(a)},ns.registerLoadRouter=function(a){ns.getInstance().loadRouters.push(a)},ns.getSaveHandlers=function(a){return ns.getHandlers(a,"save")},ns.getLoadHandlers=function(a,b){return ns.getHandlers(a,"load",b)},ns.getHandlers=function(c,a,d){var b=[];return("load"===a?ns.getInstance().loadRouters:ns.getInstance().saveRouters).forEach(function(e){var a=e(c,d);null!==a&&b.push(a)}),b},ns),nq="://",dw=(nr.getInstance=function(){return null==nr.instance&&(nr.instance=new nr),nr.instance},nr.registerManager=function(a,c){d8(null!=a,function(){return"scheme must not be undefined or null."}),a.endsWith(nq)&&(a=a.slice(0,a.indexOf(nq))),d8(0<a.length,function(){return"scheme must not be an empty string."});var b=nr.getInstance();d8(null==b.managers[a],function(){return"A model store manager is already registered for scheme '"+a+"'."}),b.managers[a]=c},nr.getManager=function(a){var b=this.getInstance().managers[a];if(null==b)throw new Error("Cannot find model manager for scheme '"+a+"'");return b},nr.getSchemes=function(){return Object.keys(this.getInstance().managers)},nr);function nr(){this.managers={}}function ns(){this.saveRouters=[],this.loadRouters=[]}function nt(a){if(-1===a.indexOf(nq))throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+dw.getSchemes().join(","));return{scheme:a.split(nq)[0],path:a.split(nq)[1]}}function nu(b,c,a){return void 0===a&&(a=!1),jL(this,void 0,void 0,function(){var d,e,f,g,h,i,j,k,l;return jM(this,function(m){switch(m.label){case 0:return d8(b!==c,function(){return"Old path and new path are the same: '"+b+"'"}),d8(0<(d=s.getLoadHandlers(b)).length,function(){return"Copying failed because no load handler is found for source URL "+b+"."}),d8(d.length<2,function(){return"Copying failed because more than one ("+d.length+") load handlers for source URL "+b+"."}),e=d[0],d8(0<(f=s.getSaveHandlers(c)).length,function(){return"Copying failed because no save handler is found for destination URL "+c+"."}),d8(f.length<2,function(){return"Copying failed because more than one ("+d.length+") save handlers for destination URL "+c+"."}),g=f[0],h=nt(b).scheme,i=nt(b).path,j=h===nt(b).scheme,[4,e.load()];case 1:return k=m.sent(),a&&j?[4,dw.getManager(h).removeModel(i)]:[3,3];case 2:m.sent(),m.label=3;case 3:return[4,g.save(k)];case 4:return l=m.sent(),!a||j?[3,6]:[4,dw.getManager(h).removeModel(i)];case 5:m.sent(),m.label=6;case 6:return[2,l.modelArtifactsInfo]}})})}var nv="models_store",nw="model_info_store";function nx(){if(!i.getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var a=window,b=a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB||a.shimIndexedDB;if(null==b)throw new Error("The current browser does not appear to support IndexedDB.");return b}function ny(b){var a=b.result;a.createObjectStore(nv,{keyPath:"modelPath"}),a.createObjectStore(nw,{keyPath:"modelPath"})}function dx(a){var b;return i.getBool("IS_BROWSER")&&!Array.isArray(a)&&a.startsWith(g6.URL_SCHEME)?(b=a.slice(g6.URL_SCHEME.length),new g6(b)):null}var g6=(nz.prototype.save=function(a){return jL(this,void 0,void 0,function(){return jM(this,function(b){if(a.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,a)]})})},nz.prototype.load=function(){return jL(this,void 0,void 0,function(){return jM(this,function(a){return[2,this.databaseAction(this.modelPath)]})})},nz.prototype.databaseAction=function(a,b){var c=this;return new Promise(function(d,e){var a=c.indexedDB.open("tensorflowjs",1);a.onupgradeneeded=function(){return ny(a)},a.onsuccess=function(){var f=a.result;if(null==b){var g=f.transaction(nv,"readonly"),h=g.objectStore(nv).get(c.modelPath);h.onsuccess=function(){if(null==h.result)return f.close(),e(new Error("Cannot find model with path '"+c.modelPath+"' in IndexedDB."));d(h.result.modelArtifacts)},h.onerror=function(a){return f.close(),e(h.error)},g.oncomplete=function(){return f.close()}}else{var m,k=g5(b),i=f.transaction(nw,"readwrite"),l=i.objectStore(nw),j=l.put({modelPath:c.modelPath,modelArtifactsInfo:k});j.onsuccess=function(){var a=(m=f.transaction(nv,"readwrite")).objectStore(nv).put({modelPath:c.modelPath,modelArtifacts:b,modelArtifactsInfo:k});a.onsuccess=function(){return d({modelArtifactsInfo:k})},a.onerror=function(d){var b=(l=i.objectStore(nw)).delete(c.modelPath);b.onsuccess=function(){return f.close(),e(a.error)},b.onerror=function(b){return f.close(),e(a.error)}}},j.onerror=function(a){return f.close(),e(j.error)},i.oncomplete=function(){null==m?f.close():m.oncomplete=function(){return f.close()}}}},a.onerror=function(b){return e(a.error)}})},nz.URL_SCHEME="indexeddb://",nz);function nz(a){if(this.indexedDB=nx(),null==a||!a)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=a}s.registerSaveRouter(dx),s.registerLoadRouter(dx);var g7=(nA.prototype.listModels=function(){return jL(this,void 0,void 0,function(){var a=this;return jM(this,function(b){return[2,new Promise(function(c,d){var b=a.indexedDB.open("tensorflowjs",1);b.onupgradeneeded=function(){return ny(b)},b.onsuccess=function(){var f=b.result,a=f.transaction(nw,"readonly"),e=a.objectStore(nw).getAll();e.onsuccess=function(){for(var b={},a=0,d=e.result;a<d.length;a++){var f=d[a];b[f.modelPath]=f.modelArtifactsInfo}c(b)},e.onerror=function(a){return f.close(),d(e.error)},a.oncomplete=function(){return f.close()}},b.onerror=function(a){return d(b.error)}})]})})},nA.prototype.removeModel=function(a){return jL(this,void 0,void 0,function(){var b=this;return jM(this,function(d){var c;return a=(c=a).startsWith(g6.URL_SCHEME)?c.slice(g6.URL_SCHEME.length):c,[2,new Promise(function(d,e){var c=b.indexedDB.open("tensorflowjs",1);c.onupgradeneeded=function(){return ny(c)},c.onsuccess=function(){var i,g=c.result,b=g.transaction(nw,"readwrite"),h=b.objectStore(nw),f=h.get(a);f.onsuccess=function(){if(null==f.result)return g.close(),e(new Error("Cannot find model with path '"+a+"' in IndexedDB."));function c(){var b=(i=g.transaction(nv,"readwrite")).objectStore(nv).delete(a);b.onsuccess=function(){return d(f.result.modelArtifactsInfo)},b.onerror=function(a){return e(f.error)}}var b=h.delete(a);b.onsuccess=c,b.onerror=function(a){return c(),g.close(),e(f.error)}},f.onerror=function(a){return g.close(),e(f.error)},b.oncomplete=function(){null==i?g.close():i.oncomplete=function(){return g.close()}}},c.onerror=function(a){return e(c.error)}})]})})},nA);function nA(){this.indexedDB=nx()}if(i.getBool("IS_BROWSER"))try{dw.registerManager(g6.URL_SCHEME,new g7)}catch(nB){}var nC="/",nD="tensorflowjs_models",nE="info",nF="model_topology",nG="weight_specs",nH="weight_data",nI="model_metadata";function nJ(a){return{info:[nD,a,nE].join(nC),topology:[nD,a,nF].join(nC),weightSpecs:[nD,a,nG].join(nC),weightData:[nD,a,nH].join(nC),modelMetadata:[nD,a,nI].join(nC)}}function nK(b){var a=b.split(nC);if(a.length<3)throw new Error("Invalid key format: "+b);return a.slice(1,a.length-1).join(nC)}function dy(a){var b;return i.getBool("IS_BROWSER")&&!Array.isArray(a)&&a.startsWith(g8.URL_SCHEME)?(b=a.slice(g8.URL_SCHEME.length),new g8(b)):null}var g8=(nL.prototype.save=function(a){return jL(this,void 0,void 0,function(){var b,c,d;return jM(this,function(e){if(a.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");b=JSON.stringify(a.modelTopology),c=JSON.stringify(a.weightSpecs),d=g5(a);try{return this.LS.setItem(this.keys.info,JSON.stringify(d)),this.LS.setItem(this.keys.topology,b),this.LS.setItem(this.keys.weightSpecs,c),this.LS.setItem(this.keys.weightData,function(b){if(nn)return Buffer.from(b).toString("base64");for(var c=new Uint8Array(b),d="",a=0,e=c.length;a<e;a++)d+=String.fromCharCode(c[a]);return btoa(d)}(a.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:a.format,generatedBy:a.generatedBy,convertedBy:a.convertedBy,userDefinedMetadata:a.userDefinedMetadata})),[2,{modelArtifactsInfo:d}]}catch(f){throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+d.modelTopologyBytes+", weightSpecsBytes="+d.weightSpecsBytes+", weightDataBytes="+d.weightDataBytes+".")}return[2]})})},nL.prototype.load=function(){return jL(this,void 0,void 0,function(){var a,b,c,d,e,f,g;return jM(this,function(h){if(null==(a=JSON.parse(this.LS.getItem(this.keys.info))))throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==a.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(b={},null==(c=JSON.parse(this.LS.getItem(this.keys.topology))))throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(b.modelTopology=c,null==(d=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(b.weightSpecs=d,null!=(e=this.LS.getItem(this.keys.modelMetadata))&&(f=JSON.parse(e),b.format=f.format,b.generatedBy=f.generatedBy,b.convertedBy=f.convertedBy,b.userDefinedMetadata=f.userDefinedMetadata),null==(g=this.LS.getItem(this.keys.weightData)))throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return b.weightData=function(d){if(nn){var a=Buffer.from(d,"base64");return a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength)}for(var c=atob(d),e=new Uint8Array(c.length),b=0;b<c.length;++b)e.set([c.charCodeAt(b)],b);return e.buffer}(g),[2,b]})})},nL.URL_SCHEME="localstorage://",nL);function nL(a){if(!i.getBool("IS_BROWSER")|| void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==a||!a)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=a,this.keys=nJ(this.modelPath)}s.registerSaveRouter(dy),s.registerLoadRouter(dy);var g9=(nM.prototype.listModels=function(){return jL(this,void 0,void 0,function(){var a,b,c,d,e,f;return jM(this,function(g){for(a={},b=nD+nC,c=nC+nE,d=0;d<this.LS.length;++d)(e=this.LS.key(d)).startsWith(b)&&e.endsWith(c)&&(a[f=nK(e)]=JSON.parse(this.LS.getItem(e)));return[2,a]})})},nM.prototype.removeModel=function(a){return jL(this,void 0,void 0,function(){var b,c;return jM(this,function(e){var d;if(b=nJ(a=(d=a).startsWith(g8.URL_SCHEME)?d.slice(g8.URL_SCHEME.length):d),null==this.LS.getItem(b.info))throw new Error("Cannot find model at path '"+a+"'");return c=JSON.parse(this.LS.getItem(b.info)),this.LS.removeItem(b.info),this.LS.removeItem(b.topology),this.LS.removeItem(b.weightSpecs),this.LS.removeItem(b.weightData),[2,c]})})},nM);function nM(){d8(i.getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),d8(void 0!==window.localStorage,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}if(i.getBool("IS_BROWSER"))try{dw.registerManager(g8.URL_SCHEME,new g9)}catch(nN){}function nO(a){return new Promise(function(a){return setTimeout(a)}).then(a)}var nP=(nS.prototype.save=function(a){return jL(this,void 0,void 0,function(){var b,c,d,e,f,g;return jM(this,function(h){switch(h.label){case 0:if("undefined"==typeof document)throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(b=window.URL.createObjectURL(new Blob([a.weightData],{type:"application/octet-stream"})),!(a.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return c=[{paths:["./"+this.weightDataFileName],weights:a.weightSpecs}],d={modelTopology:a.modelTopology,format:a.format,generatedBy:a.generatedBy,convertedBy:a.convertedBy,weightsManifest:c},e=window.URL.createObjectURL(new Blob([JSON.stringify(d)],{type:"application/json"})),(f=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,f.href=e,[4,nO(function(){return f.dispatchEvent(new MouseEvent("click"))})];case 2:return h.sent(),null==a.weightData?[3,4]:((g=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,g.href=b,[4,nO(function(){return g.dispatchEvent(new MouseEvent("click"))})]);case 3:h.sent(),h.label=4;case 4:return[2,{modelArtifactsInfo:g5(a)}]}})})},nS.URL_SCHEME="downloads://",nS),nQ=(nR.prototype.load=function(){return jL(this,void 0,void 0,function(){var a,b,c=this;return jM(this,function(d){return a=this.files[0],b=this.files.slice(1),[2,new Promise(function(e,f){var d=new FileReader;d.onload=function(i){var g=JSON.parse(i.target.result),h=g.modelTopology;if(null!=h){0===b.length&&e({modelTopology:h});var d=g.weightsManifest;if(null!=d){try{k=c.checkManifestAndWeightFiles(d,b)}catch(j){return void f(j)}var k,l=[],m=[],n=[];d.forEach(function(a){a.paths.forEach(function(a){m.push(a),n.push(null)}),l.push.apply(l,a.weights)}),d.forEach(function(a){a.paths.forEach(function(b){var a=new FileReader;a.onload=function(a){var c=a.target.result;n[m.indexOf(b)]=c,-1===n.indexOf(null)&&e({modelTopology:h,weightSpecs:l,weightData:g4(n),format:g.format,generatedBy:g.generatedBy,convertedBy:g.convertedBy,userDefinedMetadata:g.userDefinedMetadata})},a.onerror=function(a){return f("Failed to weights data from file of path '"+b+"'.")},a.readAsArrayBuffer(k[b])})})}else f(new Error("weightManifest field is missing from file "+a.name))}else f(new Error("modelTopology field is missing from file "+a.name))},d.onerror=function(b){return f("Failed to read model topology and weights manifest JSON from file '"+a.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},d.readAsText(a)})]})})},nR.prototype.checkManifestAndWeightFiles=function(e,a){for(var c=[],g=a.map(function(a){return np(a.name)}),f={},b=0,d=e;b<d.length;b++)d[b].paths.forEach(function(d){var b=np(d);if(-1!==c.indexOf(b))throw new Error("Duplicate file basename found in weights manifest: '"+b+"'");if(c.push(b),-1===g.indexOf(b))throw new Error("Weight file with basename '"+b+"' is not provided.");f[d]=a[g.indexOf(b)]});if(c.length!==a.length)throw new Error("Mismatch in the number of files in weights manifest ("+c.length+") and the number of weight files provided ("+a.length+").");return f},nR);function nR(a){if(null==a||a.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+a);this.files=a}function nS(a){if(!i.getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");a.startsWith(nS.URL_SCHEME)&&(a=a.slice(nS.URL_SCHEME.length)),null!=a&&0!==a.length||(a="model"),this.modelTopologyFileName=a+".json",this.weightDataFileName=a+".weights.bin"}function nT(c,d,a,b){d8(null!=(g=c)&&Array.isArray(g)&&0<g.length,function(){return"promises must be a none empty array"}),e=a=null==a?0:a,f=b=null==b?1:b,d8(0<=e&&e<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+e}),d8(0<=f&&f<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+f}),d8(e<=f,function(){return"startFraction must be no more than endFraction, but got startFraction "+e+" and endFraction "+f});var e,f,g,h=0;return Promise.all(c.map(function(e){return e.then(function(e){return d(a+ ++h/c.length*(b-a)),e}),e}))}function nU(a,b){return jL(this,void 0,void 0,function(){var c,d,e,f,g,h,j,k,l;return jM(this,function(m){switch(m.label){case 0:return null==b&&(b={}),c=null==b.fetchFunc?i.platform.fetch:b.fetchFunc,d=a.map(function(a){return c(a,b.requestInit,{isBinary:!0})}),e=0,f=.5,null!=b.onProgress?[3,2]:[4,Promise.all(d)];case 1:return g=m.sent(),[3,4];case 2:return[4,nT(d,b.onProgress,e,f)];case 3:g=m.sent(),m.label=4;case 4:return h=g.map(function(a){return a.arrayBuffer()}),j=.5,k=1,null!=b.onProgress?[3,6]:[4,Promise.all(h)];case 5:return l=m.sent(),[3,8];case 6:return[4,nT(h,b.onProgress,j,k)];case 7:l=m.sent(),m.label=8;case 8:return[2,l]}})})}function ha(a){var b=this;return function(d,c,e){return void 0===c&&(c=""),jL(b,void 0,void 0,function(){var b,f,g,h,i,j,k,l,m,n;return jM(this,function(o){switch(o.label){case 0:if(b=d.map(function(){return!1}),f={},g=null!=e?e.map(function(){return!1}):[],h=[],d.forEach(function(a,c){var d=0;a.weights.forEach(function(a){function i(){b[c]=!0,null==f[c]&&(f[c]=[]),f[c].push({manifestEntry:a,groupOffset:d,sizeBytes:j})}var j=nl["quantization"in a?a.quantization.dtype:a.dtype]*ec(a.shape);null!=e?e.forEach(function(b,c){b===a.name&&(i(),g[c]=!0)}):i(),h.push(a.name),d+=j})}),!g.every(function(a){return a}))throw i=e.filter(function(b,a){return!g[a]}),new Error("Could not find weights in manifest with names: "+i.join(", ")+". \nManifest JSON has weights with names: "+h.join(", ")+".");return j=b.reduce(function(a,b,c){return b&&a.push(c),a},[]),k=[],j.forEach(function(a){d[a].paths.forEach(function(a){var b=c+(c.endsWith("/")?"":"/")+a;k.push(b)})}),[4,a(k)];case 1:return l=o.sent(),m={},n=0,j.forEach(function(e){for(var a=d[e].paths.length,g=0,b=0;b<a;b++)g+=l[n+b].byteLength;for(var j=new ArrayBuffer(g),k=new Uint8Array(j),h=0,c=0;c<a;c++){var i=new Uint8Array(l[n+c]);k.set(i,h),h+=i.byteLength}f[e].forEach(function(a){var b=g3(j.slice(a.groupOffset,a.groupOffset+a.sizeBytes),[a.manifestEntry]);for(var c in b)m[c]=b[c]}),n+=a}),[2,m]}})})}}s.registerSaveRouter(function(a){var b;return i.getBool("IS_BROWSER")&&!Array.isArray(a)&&a.startsWith(nP.URL_SCHEME)?(void 0===(b=a.slice(nP.URL_SCHEME.length))&&(b="model"),new nP(b)):null});var nV=(nW.prototype.save=function(a){return jL(this,void 0,void 0,function(){var b,c,d,e;return jM(this,function(f){switch(f.label){case 0:if(a.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(b=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,c=[{paths:["./model.weights.bin"],weights:a.weightSpecs}],d={modelTopology:a.modelTopology,format:a.format,generatedBy:a.generatedBy,convertedBy:a.convertedBy,userDefinedMetadata:a.userDefinedMetadata,weightsManifest:c},b.body.append("model.json",new Blob([JSON.stringify(d)],{type:"application/json"}),"model.json"),null!=a.weightData&&b.body.append("model.weights.bin",new Blob([a.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,b)];case 1:if((e=f.sent()).ok)return[2,{modelArtifactsInfo:g5(a),responses:[e]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+e.status+".")}})})},nW.prototype.load=function(){return jL(this,void 0,void 0,function(){var a,b,c,d,e,f,g,h,i,j,k,l;return jM(this,function(m){switch(m.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(a=m.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+a.status+". Please verify this URL points to the model JSON of the model to load.");m.label=2;case 2:return m.trys.push([2,4,,5]),[4,a.json()];case 3:return b=m.sent(),[3,5];case 4:throw m.sent(),c="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?c+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":c+=" Please make sure the server is serving valid JSON for this request.",new Error(c);case 5:if(d=b.modelTopology,e=b.weightsManifest,f=b.generatedBy,g=b.convertedBy,h=b.format,i=b.userDefinedMetadata,null==d&&null==e)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==e?[3,7]:[4,this.loadWeights(e)];case 6:j=(l=m.sent())[0],k=l[1],m.label=7;case 7:return[2,{modelTopology:d,weightSpecs:j,weightData:k,userDefinedMetadata:i,generatedBy:f,convertedBy:g,format:h}]}})})},nW.prototype.loadWeights=function(a){return jL(this,void 0,void 0,function(){var b,c,d,e,f,g,h,i,j,k,l;return jM(this,function(p){var m,n,o;switch(p.label){case 0:for(n=(m=b=Array.isArray(this.path)?this.path[1]:this.path).lastIndexOf("/"),o=m.lastIndexOf("?"),c=[m.substring(0,n)+"/",n<o?m.substring(o):""],d=c[0],e=c[1],f=this.weightPathPrefix||d,g=[],h=0,i=a;h<i.length;h++)j=i[h],g.push.apply(g,j.weights);return k=[],a.forEach(function(a){a.paths.forEach(function(a){k.push(f+a+e)})}),[4,nU(k,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return[2,[g,g4(l=p.sent())]]}})})},nW.URL_SCHEME_REGEX=/^https?:\/\//,nW);function nW(b,a){if(this.DEFAULT_METHOD="POST",null==a&&(a={}),this.weightPathPrefix=a.weightPathPrefix,this.onProgress=a.onProgress,null!=a.fetchFunc?(d8("function"==typeof a.fetchFunc,function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=a.fetchFunc):this.fetch=i.platform.fetch,d8(null!=b&&0<b.length,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(b)&&d8(2===b.length,function(){return"URL paths for http must have a length of 2, (actual length is "+b.length+")."}),this.path=b,null!=a.requestInit&&null!=a.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=a.requestInit||{}}function hb(a){return null!=a.match(nV.URL_SCHEME_REGEX)}function dz(a,b){return"undefined"==typeof fetch?null:(Array.isArray(a)?a.every(function(a){return hb(a)}):hb(a))?hc(a,{onProgress:b}):null}function hc(a,b){return new nV(a,b)}s.registerSaveRouter(dz),s.registerLoadRouter(dz);var nX=(n$.prototype.load=function(){return jL(this,void 0,void 0,function(){return jM(this,function(a){return[2,this.modelArtifacts]})})},n$),nY=(nZ.prototype.save=function(a){return jL(this,void 0,void 0,function(){return jM(this,function(b){return[2,this.saveHandler(a)]})})},nZ);function nZ(a){this.saveHandler=a}function n$(a){this.modelArtifacts=a}var n_,hd=Object.freeze({browserFiles:function(a){return new nQ(a)},browserHTTPRequest:function(a,b){return hc(a,b)},concatenateArrayBuffers:g4,decodeWeights:g3,encodeWeights:function(a,b){return jL(this,void 0,void 0,function(){var c,d,e,f,g,h=this;return jM(this,function(i){switch(i.label){case 0:for(c=[],d=[],e=Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a),f=function(i){var g=e[i],f=Array.isArray(a)?a[i].tensor:a[g];if("float32"!==f.dtype&&"int32"!==f.dtype&&"bool"!==f.dtype&&"string"!==f.dtype)throw new Error("Unsupported dtype in weight '"+g+"': "+f.dtype);var j={name:g,shape:f.shape,dtype:f.dtype};if("string"===f.dtype){var k=new Promise(function(a){return jL(h,void 0,void 0,function(){var b,c,d,e,g,h,i;return jM(this,function(j){switch(j.label){case 0:return[4,f.bytes()];case 1:for(c=(b=j.sent()).reduce(function(a,b){return a+b.length},0)+nm*b.length,d=new Uint8Array(c),g=e=0;g<b.length;g++)h=b[g],i=new Uint8Array(new Uint32Array([h.length]).buffer),d.set(i,e),e+=nm,d.set(h,e),e+=h.length;return a(d),[2]}})})});d.push(k)}else d.push(f.data());null!=b&&(j.group=b),c.push(j)},g=0;g<e.length;++g)f(g);return[4,Promise.all(d)];case 1:return[2,{data:function(a){if(null===a)throw new Error("Invalid input value: "+JSON.stringify(a));var b=0,c=[];a.forEach(function(a){if(b+=a.byteLength,c.push(a.byteLength===a.buffer.byteLength?a:new a.constructor(a)),!(a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+a.constructor.name)});var d=new Uint8Array(b),e=0;return c.forEach(function(a){d.set(new Uint8Array(a.buffer),e),e+=a.byteLength}),d.buffer}(i.sent()),specs:c}]}})})},fromMemory:function(a,b,c,d){return 1===arguments.length?null!=a.modelTopology||null!=a.weightSpecs?new nX(a):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new nX({modelTopology:a})):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new nX({modelTopology:a,weightSpecs:b,weightData:c,trainingConfig:d}))},getLoadHandlers:function(a,b){return s.getLoadHandlers(a,b)},getModelArtifactsInfoForJSON:g5,getSaveHandlers:function(a){return s.getSaveHandlers(a)},http:hc,isHTTPScheme:hb,loadWeights:function(b,a,c,d){return void 0===a&&(a=""),jL(this,void 0,void 0,function(){return jM(this,function(e){return[2,ha(function(a){return nU(a,{requestInit:d})})(b,a,c)]})})},registerLoadRouter:function(a){return s.registerLoadRouter(a)},registerSaveRouter:function(a){return s.registerSaveRouter(a)},weightsLoaderFactory:ha,withSaveHandler:function(a){return new nY(a)},copyModel:function(a,b){return jL(this,void 0,void 0,function(){return jM(this,function(c){return[2,nu(a,b,!1)]})})},listModels:function(){return jL(this,void 0,void 0,function(){var a,b,c,d,e,f,g;return jM(this,function(h){switch(h.label){case 0:a=dw.getSchemes(),b={},c=0,d=a,h.label=1;case 1:return c<d.length?(e=d[c],[4,dw.getManager(e).listModels()]):[3,4];case 2:for(g in f=h.sent())b[e+nq+g]=f[g];h.label=3;case 3:return c++,[3,1];case 4:return[2,b]}})})},moveModel:function(a,b){return jL(this,void 0,void 0,function(){return jM(this,function(c){return[2,nu(a,b,!0)]})})},removeModel:function(a){return jL(this,void 0,void 0,function(){var b;return jM(this,function(c){return b=nt(a),[2,dw.getManager(b.scheme).removeModel(b.path)]})})}}),he=a({confusionMatrix_:function(d,e,a){var b=kn(d,"labels","confusionMatrix"),c=kn(e,"predictions","confusionMatrix");d8(null==a||0<a&&Number.isInteger(a),function(){return"If provided, numClasses must be a positive integer, but got "+a}),d8(1===b.rank,function(){return"Expected the rank of labels to be 1, but got "+b.rank}),d8(1===c.rank,function(){return"Expected the rank of predictions to be 1, but got "+c.rank}),d8(b.shape[0]===c.shape[0],function(){return"Mismatch in the number of examples: "+b.shape[0]+" vs. "+c.shape[0]+". Labels and predictions should have the same number of elements."}),d8(0<a&&Number.isInteger(a),function(){return"numClasses is required to be a positive integer, but got "+a});var f=aT(b.asType("int32"),a),g=aT(c.asType("int32"),a);return f.transpose().matMul(g).asType("int32")}}),hf=Object.freeze({confusionMatrix:he}),hg=a({fromPixels_:function(a,b){if(void 0===b&&(b=3),4<b)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");if(null==a)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var j=!1,k=!1,e=!1,l=!1,m=!1;if(a.data instanceof Uint8Array)j=!0;else if("undefined"!=typeof ImageData&&a instanceof ImageData)k=!0;else if("undefined"!=typeof HTMLVideoElement&&a instanceof HTMLVideoElement)e=!0;else if("undefined"!=typeof HTMLImageElement&&a instanceof HTMLImageElement)l=!0;else{if(null==a.getContext)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+a.constructor.name);m=!0}if(e&&e&&a.readyState<2)throw new Error("The video element has not loaded data yet. Please wait for `loadeddata` event on the <video> element.");if(null!=d1("FromPixels",ad.backendName))return ad.runKernel("FromPixels",{pixels:a},{numChannels:b});var f,g,n=e?[a.videoWidth,a.videoHeight]:[a.width,a.height],c=n[0],d=n[1];if(m?f=a.getContext("2d").getImageData(0,0,c,d).data:k||j?f=a.data:(l||e)&&(null==n_&&(n_=document.createElement("canvas").getContext("2d")),n_.canvas.width=c,n_.canvas.height=d,n_.drawImage(a,0,0,c,d),f=n_.getImageData(0,0,c,d).data),4===b)g=new Int32Array(f);else{var o=c*d;g=new Int32Array(o*b);for(var h=0;h<o;h++)for(var i=0;i<b;++i)g[h*b+i]=f[4*h+i]}return ap(g,[d,c,b],"int32")}}),hh=Object.freeze({toPixels:function(_,a){return jL(this,void 0,void 0,function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;return jM(this,function(y){switch(y.label){case 0:if(b=kn(_,"img","toPixels"),_ instanceof E||(b=b.toInt()),2!==b.rank&&3!==b.rank)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+b.rank+".");if(d=(c=b.shape.slice(0,2))[0],e=c[1],4<(f=2===b.rank?1:b.shape[2])||2===f)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+f);return[4,b.data()];case 1:return g=y.sent(),h=b.min(),i=b.max(),[4,Promise.all([h.data(),i.data()])];case 2:if(k=(j=y.sent())[0],l=j[1],m=k[0],n=l[0],h.dispose(),i.dispose(),"float32"===b.dtype){if(m<0||1<n)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+m+" - "+n+"].")}else{if("int32"!==b.dtype)throw new Error("Unsupported type for toPixels: "+b.dtype+". Please use float32 or int32 tensors.");if(m<0||255<n)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+m+" - "+n+"].")}for(o="float32"===b.dtype?255:1,p=new Uint8ClampedArray(e*d*4),q=0;q<d*e;++q)u=t=s=r=void 0,1===f?(r=g[q]*o,s=g[q]*o,t=g[q]*o,u=255):3===f?(r=g[3*q]*o,s=g[3*q+1]*o,t=g[3*q+2]*o,u=255):4===f&&(r=g[4*q]*o,s=g[4*q+1]*o,t=g[4*q+2]*o,u=g[4*q+3]*o),p[0+(v=4*q)]=Math.round(r),p[1+v]=Math.round(s),p[2+v]=Math.round(t),p[3+v]=Math.round(u);return null!=a&&(a.width=e,a.height=d,w=a.getContext("2d"),x=new ImageData(p,e,d),w.putImageData(x,0,0)),b!==_&&b.dispose(),[2,p]}})})},fromPixels:hg}),dA=(n1.prototype.getClassName=function(){return this.constructor.className},n1.fromConfig=function(a,b){return new a(b)},n1),hi=(n0.getMap=function(){return null==n0.instance&&(n0.instance=new n0),n0.instance},n0.register=function(a){n0.getMap().classNameMap[a.className]=[a,a.fromConfig]},n0);function n0(){this.classNameMap={}}function n1(){}function m(a){d8(null!=a.className,function(){return"Class being registered does not have the static className property defined."}),d8("string"==typeof a.className,function(){return"className is required to be a string, but got type "+typeof a.className}),d8(0<a.className.length,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),hi.register(a)}var hj=Object.freeze({Serializable:dA,SerializationMap:hi,registerClass:m});function hk(){return 32===ad.backend.floatPrecision()?.001:.1}function n2(a,b,m){var f=!0;if((er(a)||er(b))&&(f=!1),er(a)&&er(b)&&(f=!0),f){var g=a.constructor.name,h=b.constructor.name;if(g!==h)throw new Error("Arrays are of different type. Actual: "+g+". Expected: "+h)}if(Array.isArray(a)&&Array.isArray(b)){var i=kl(a),j=kl(b);if(!ed(i,j))throw new Error("Arrays have different shapes. Actual: ["+i+"]. Expected: ["+j+"]")}var e=er(a)?a:eb(a),c=er(b)?b:eb(b);if(e.length!==c.length)throw new Error("Arrays have different lengths actual: "+e.length+" vs expected: "+c.length+".\nActual:   "+e+".\nExpected: "+c+".");for(var d=0;d<c.length;++d){var k=e[d],l=c[d];if(!m(k,l))throw new Error("Arrays differ: actual["+d+"] = "+k+", expected["+d+"] = "+l+".\nActual:   "+e+".\nExpected: "+c+".")}}function n3(a,b,c){return!isFinite(a)&&!isFinite(b)||!(isNaN(a)||isNaN(b)||Math.abs(a-b)>c)}var hl,hm=Object.freeze({TEST_EPSILON_FLOAT16:.1,expectArraysClose:function(b,c,a){return null==a&&(a=hk()),n2(b,c,function(b,c){return n3(b,c,a)})},testEpsilon:hk,expectPromiseToFail:function(a,b){a().then(function(){return b.fail()},function(){return b()})},expectArraysEqual:function(b,a){return eu(b)||eu(b[0])||eu(a)||eu(a[0])?n2(b,"string"==typeof a||"number"==typeof a||"boolean"==typeof a?[a]:a,function(a,b){return a==b}):n2(b,a,function(a,b){return n3(a,b,0)})},expectNumbersClose:function(b,c,a){if(null==a&&(a=hk()),!n3(b,c,a))throw new Error("Numbers differ: actual === "+b+", expected === "+c)},expectValuesInRange:function(b,c,d){for(var a=0;a<b.length;a++)if(b[a]<c||b[a]>d)throw new Error("Value out of range:"+b[a]+" low: "+c+", high: "+d)},expectArrayBuffersEqual:function(a,b){expect(new Float32Array(a)).toEqual(new Float32Array(b))}}),hn=Object.freeze({gpgpu_util:gy,webgl_util:ft,forceHalfFloat:function(){i.set("WEBGL_FORCE_F16_TEXTURES",!0)},MathBackendWebGL:gB,setWebGLContext:eU,GPGPUContext:gz}),n=(f(n4,hl=dA),n4.prototype.minimize=function(f,a,b){void 0===a&&(a=!1);var c=this.computeGradients(f,b),d=c.value,e=c.grads;if(null!=b){var g=b.map(function(a){return{name:a.name,tensor:e[a.name]}});this.applyGradients(g)}else this.applyGradients(e);return fv(e),a?d:(d.dispose(),null)},Object.defineProperty(n4.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),n4.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},n4.prototype.computeGradients=function(a,b){return f0(a,b)},n4.prototype.dispose=function(){null!=this.iterations_&&fv(this.iterations_)},n4.prototype.saveIterations=function(){return jL(this,void 0,void 0,function(){return jM(this,function(a){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:am(this.iterations_,"int32")}]})})},n4.prototype.getWeights=function(){return jL(this,void 0,void 0,function(){return jM(this,function(a){throw new Error("getWeights() is not implemented for this optimizer yet.")})})},n4.prototype.setWeights=function(a){return jL(this,void 0,void 0,function(){return jM(this,function(a){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},n4.prototype.extractIterations=function(a){return jL(this,void 0,void 0,function(){var b;return jM(this,function(c){switch(c.label){case 0:return b=this,[4,a[0].tensor.data()];case 1:return b.iterations_=c.sent()[0],[2,a.slice(1)]}})})},n4);function n4(){return null!==hl&&hl.apply(this,arguments)||this}Object.defineProperty(n,Symbol.hasInstance,{value:function(a){return null!=a.minimize&&null!=a.computeGradients&&null!=a.applyGradients}});var ho,dB=(f(n5,ho=n),n5.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(d,c){var f=ad.registeredVariables[d];null==b.accumulatedGrads[c]&&(b.accumulatedGrads[c]={originalName:d+"/accum_grad",variable:fu(function(){return aA(f).variable(!1)})}),null==b.accumulatedUpdates[c]&&(b.accumulatedUpdates[c]={originalName:d+"/accum_var",variable:fu(function(){return aA(f).variable(!1)})});var e=Array.isArray(a)?a[c].tensor:a[d];if(null!=e){var g=b.accumulatedGrads[c].variable,h=b.accumulatedUpdates[c].variable;fu(function(){var c=g.mul(b.rho).add(e.square().mul(1-b.rho)),a=h.add(b.epsilon).sqrt().div(g.add(b.epsilon).sqrt()).mul(e),d=h.mul(b.rho).add(a.square().mul(1-b.rho));g.assign(c),h.assign(d);var i=a.mul(-b.learningRate).add(f);f.assign(i)})}}),this.incrementIterations()},n5.prototype.dispose=function(){null!=this.accumulatedUpdates&&(fv(this.accumulatedGrads.map(function(a){return a.variable})),fv(this.accumulatedUpdates.map(function(a){return a.variable})))},n5.prototype.getWeights=function(){return jL(this,void 0,void 0,function(){var a;return jM(this,function(b){switch(b.label){case 0:return a=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[b.sent()].concat(a.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},n5.prototype.setWeights=function(a){return jL(this,void 0,void 0,function(){var b;return jM(this,function(c){switch(c.label){case 0:return[4,this.extractIterations(a)];case 1:return b=(a=c.sent()).length/2,this.accumulatedGrads=a.slice(0,b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedUpdates=a.slice(b,2*b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},n5.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},n5.fromConfig=function(b,a){return new b(a.learningRate,a.rho,a.epsilon)},n5.className="Adadelta",n5);function n5(c,d,b){void 0===b&&(b=null);var a=ho.call(this)||this;return a.learningRate=c,a.rho=d,a.epsilon=b,a.accumulatedGrads=[],a.accumulatedUpdates=[],null==b&&(a.epsilon=ad.backend.epsilon()),a}m(dB);var hp,dC=(f(n6,hp=n),n6.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(d,c){var f=ad.registeredVariables[d];null==b.accumulatedGrads[c]&&(b.accumulatedGrads[c]={originalName:d+"/accumulator",variable:fu(function(){return aw(f.shape,b.initialAccumulatorValue).variable(!1)})});var e=Array.isArray(a)?a[c].tensor:a[d];if(null!=e){var g=b.accumulatedGrads[c].variable;fu(function(){var a=g.add(e.square());g.assign(a);var c=e.div(a.add(ad.backend.epsilon()).sqrt()).mul(-b.learningRate).add(f);f.assign(c)})}}),this.incrementIterations()},n6.prototype.dispose=function(){null!=this.accumulatedGrads&&fv(this.accumulatedGrads.map(function(a){return a.variable}))},n6.prototype.getWeights=function(){return jL(this,void 0,void 0,function(){return jM(this,function(a){switch(a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[a.sent()].concat(this.accumulatedGrads.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},n6.prototype.setWeights=function(a){return jL(this,void 0,void 0,function(){return jM(this,function(b){switch(b.label){case 0:return[4,this.extractIterations(a)];case 1:return a=b.sent(),this.accumulatedGrads=a.map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},n6.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},n6.fromConfig=function(b,a){return new b(a.learningRate,a.initialAccumulatorValue)},n6.className="Adagrad",n6);function n6(c,b){void 0===b&&(b=.1);var a=hp.call(this)||this;return a.learningRate=c,a.initialAccumulatorValue=b,a.accumulatedGrads=[],a}m(dC);var hq,dD=(f(n7,hq=n),n7.prototype.applyGradients=function(a){var b=this,c=Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a);fu(function(){var d=cg(1,b.accBeta1),e=cg(1,b.accBeta2);c.forEach(function(f,c){var h=ad.registeredVariables[f];null==b.accumulatedFirstMoment[c]&&(b.accumulatedFirstMoment[c]={originalName:f+"/m",variable:fu(function(){return aA(h).variable(!1)})}),null==b.accumulatedSecondMoment[c]&&(b.accumulatedSecondMoment[c]={originalName:f+"/v",variable:fu(function(){return aA(h).variable(!1)})});var g=Array.isArray(a)?a[c].tensor:a[f];if(null!=g){var i=b.accumulatedFirstMoment[c].variable,j=b.accumulatedSecondMoment[c].variable,k=i.mul(b.beta1).add(g.mul(1-b.beta1)),l=j.mul(b.beta2).add(g.square().mul(1-b.beta2)),m=k.div(d),n=l.div(e);i.assign(k),j.assign(l);var o=m.div(n.sqrt().add(b.epsilon)).mul(-b.learningRate).add(h);h.assign(o)}}),b.accBeta1.assign(b.accBeta1.mul(b.beta1)),b.accBeta2.assign(b.accBeta2.mul(b.beta2))}),this.incrementIterations()},n7.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&fv(this.accumulatedFirstMoment.map(function(a){return a.variable})),null!=this.accumulatedSecondMoment&&fv(this.accumulatedSecondMoment.map(function(a){return a.variable}))},n7.prototype.getWeights=function(){return jL(this,void 0,void 0,function(){var a;return jM(this,function(b){switch(b.label){case 0:return a=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[b.sent()].concat(a.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},n7.prototype.setWeights=function(a){return jL(this,void 0,void 0,function(){var b,c=this;return jM(this,function(d){switch(d.label){case 0:return[4,this.extractIterations(a)];case 1:return a=d.sent(),fu(function(){c.accBeta1.assign(cc(c.beta1,c.iterations_+1)),c.accBeta2.assign(cc(c.beta2,c.iterations_+1))}),b=a.length/2,this.accumulatedFirstMoment=a.slice(0,b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedSecondMoment=a.slice(b,2*b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},n7.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},n7.fromConfig=function(b,a){return new b(a.learningRate,a.beta1,a.beta2,a.epsilon)},n7.className="Adam",n7);function n7(c,d,e,b){void 0===b&&(b=null);var a=hq.call(this)||this;return a.learningRate=c,a.beta1=d,a.beta2=e,a.epsilon=b,a.accumulatedFirstMoment=[],a.accumulatedSecondMoment=[],fu(function(){a.accBeta1=am(d).variable(),a.accBeta2=am(e).variable()}),null==b&&(a.epsilon=ad.backend.epsilon()),a}m(dD);var hr,dE=(f(n8,hr=n),n8.prototype.applyGradients=function(a){var b=this,c=Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a);fu(function(){var d=cg(1,b.accBeta1),e=b0(-b.learningRate,b.iteration.mul(b.decay).add(1));c.forEach(function(f,c){var g=ad.registeredVariables[f];null==b.accumulatedFirstMoment[c]&&(b.accumulatedFirstMoment[c]={originalName:f+"/m",variable:aA(g).variable(!1)}),null==b.accumulatedWeightedInfNorm[c]&&(b.accumulatedWeightedInfNorm[c]={originalName:f+"/v",variable:aA(g).variable(!1)});var h=Array.isArray(a)?a[c].tensor:a[f];if(null!=h){var i=b.accumulatedFirstMoment[c].variable,j=b.accumulatedWeightedInfNorm[c].variable,k=i.mul(b.beta1).add(h.mul(1-b.beta1)),m=j.mul(b.beta2),n=h.abs(),l=m.maximum(n);i.assign(k),j.assign(l);var o=e.div(d).mul(k.div(l.add(b.epsilon))).add(g);g.assign(o)}}),b.iteration.assign(b.iteration.add(1)),b.accBeta1.assign(b.accBeta1.mul(b.beta1))}),this.incrementIterations()},n8.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&fv(this.accumulatedFirstMoment.map(function(a){return a.variable})),null!=this.accumulatedWeightedInfNorm&&fv(this.accumulatedWeightedInfNorm.map(function(a){return a.variable}))},n8.prototype.getWeights=function(){return jL(this,void 0,void 0,function(){return jM(this,function(a){throw new Error("getWeights() is not implemented for Adamax yet.")})})},n8.prototype.setWeights=function(a){return jL(this,void 0,void 0,function(){return jM(this,function(a){throw new Error("setWeights() is not implemented for Adamax yet.")})})},n8.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},n8.fromConfig=function(b,a){return new b(a.learningRate,a.beta1,a.beta2,a.epsilon,a.decay)},n8.className="Adamax",n8);function n8(d,e,f,b,c){void 0===b&&(b=null),void 0===c&&(c=0);var a=hr.call(this)||this;return a.learningRate=d,a.beta1=e,a.beta2=f,a.epsilon=b,a.decay=c,a.accumulatedFirstMoment=[],a.accumulatedWeightedInfNorm=[],fu(function(){a.iteration=am(0).variable(),a.accBeta1=am(e).variable()}),null==b&&(a.epsilon=ad.backend.epsilon()),a}m(dE);var hs,T=(f(n9,hs=n),n9.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(c,d){var e=Array.isArray(a)?a[d].tensor:a[c];if(null!=e){var f=ad.registeredVariables[c];fu(function(){var a=b.c.mul(e).add(f);f.assign(a)})}}),this.incrementIterations()},n9.prototype.setLearningRate=function(a){this.learningRate=a,null!=this.c&&this.c.dispose(),this.c=fw(am(-a))},n9.prototype.dispose=function(){this.c.dispose()},n9.prototype.getWeights=function(){return jL(this,void 0,void 0,function(){return jM(this,function(a){switch(a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[a.sent()]]}})})},n9.prototype.setWeights=function(a){return jL(this,void 0,void 0,function(){return jM(this,function(b){switch(b.label){case 0:return[4,this.extractIterations(a)];case 1:if(0!==(a=b.sent()).length)throw new Error("SGD optimizer does not have settable weights.");return[2]}})})},n9.prototype.getConfig=function(){return{learningRate:this.learningRate}},n9.fromConfig=function(a,b){return new a(b.learningRate)},n9.className="SGD",n9);function n9(b){var a=hs.call(this)||this;return a.learningRate=b,a.setLearningRate(b),a}m(T);var ht,dF=(f(oa,ht=T),oa.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(d,c){var f=ad.registeredVariables[d];null==b.accumulations[c]&&(b.accumulations[c]={originalName:d+"/momentum",variable:fu(function(){return aA(f).variable(!1)})});var g=b.accumulations[c].variable,e=Array.isArray(a)?a[c].tensor:a[d];null!=e&&fu(function(){var c,a=b.m.mul(g).add(e);c=b.useNesterov?b.c.mul(e.add(a.mul(b.m))).add(f):b.c.mul(a).add(f),g.assign(a),f.assign(c)})}),this.incrementIterations()},oa.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&fv(this.accumulations.map(function(a){return a.variable}))},oa.prototype.setMomentum=function(a){this.momentum=a},oa.prototype.getWeights=function(){return jL(this,void 0,void 0,function(){return jM(this,function(a){switch(a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[a.sent()].concat(this.accumulations.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},oa.prototype.setWeights=function(a){return jL(this,void 0,void 0,function(){return jM(this,function(b){switch(b.label){case 0:return[4,this.extractIterations(a)];case 1:return a=b.sent(),this.accumulations=a.map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},oa.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},oa.fromConfig=function(b,a){return new b(a.learningRate,a.momentum,a.useNesterov)},oa.className="Momentum",oa);function oa(c,d,b){void 0===b&&(b=!1);var a=ht.call(this,c)||this;return a.learningRate=c,a.momentum=d,a.useNesterov=b,a.accumulations=[],a.m=am(a.momentum),a}m(dF);var hu,dG=(f(ob,hu=n),ob.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(d,c){var f=ad.registeredVariables[d];null==b.accumulatedMeanSquares[c]&&(b.accumulatedMeanSquares[c]={originalName:d+"/rms",variable:fu(function(){return aA(f).variable(!1)})}),null==b.accumulatedMoments[c]&&(b.accumulatedMoments[c]={originalName:d+"/momentum",variable:fu(function(){return aA(f).variable(!1)})}),null==b.accumulatedMeanGrads[c]&&b.centered&&(b.accumulatedMeanGrads[c]={originalName:d+"/mg",variable:fu(function(){return aA(f).variable(!1)})});var e=Array.isArray(a)?a[c].tensor:a[d];if(null!=e){var g=b.accumulatedMeanSquares[c].variable,h=b.accumulatedMoments[c].variable;fu(function(){var i=g.mul(b.decay).add(e.square().mul(1-b.decay));if(b.centered){var j=b.accumulatedMeanGrads[c].variable,k=j.mul(b.decay).add(e.mul(1-b.decay)),a=h.mul(b.momentum).add(e.mul(b.learningRate).div(i.sub(k.square().add(b.epsilon)).sqrt()));g.assign(i),j.assign(k),h.assign(a);var d=f.sub(a);f.assign(d)}else{var l=g.mul(b.decay).add(e.square().mul(1-b.decay));a=h.mul(b.momentum).add(e.mul(b.learningRate).div(l.add(b.epsilon).sqrt())),g.assign(l),h.assign(a),d=f.sub(a),f.assign(d)}})}}),this.incrementIterations()},ob.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&fv(this.accumulatedMeanSquares.map(function(a){return a.variable})),null!=this.accumulatedMeanGrads&&this.centered&&fv(this.accumulatedMeanGrads.map(function(a){return a.variable})),null!=this.accumulatedMoments&&fv(this.accumulatedMoments.map(function(a){return a.variable}))},ob.prototype.getWeights=function(){return jL(this,void 0,void 0,function(){var a;return jM(this,function(b){switch(b.label){case 0:return a=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&a.push.apply(a,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[b.sent()].concat(a.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},ob.prototype.setWeights=function(a){return jL(this,void 0,void 0,function(){var b;return jM(this,function(c){switch(c.label){case 0:return[4,this.extractIterations(a)];case 1:return a=c.sent(),b=this.centered?a.length/3:a.length/2,this.accumulatedMeanSquares=a.slice(0,b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedMoments=a.slice(b,2*b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=a.slice(2*b,3*b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}})),[2]}})})},ob.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},ob.fromConfig=function(b,a){return new b(a.learningRate,a.decay,a.momentum,a.epsilon,a.centered)},ob.className="RMSProp",ob);function ob(f,c,d,b,e){void 0===c&&(c=.9),void 0===d&&(d=0),void 0===b&&(b=null),void 0===e&&(e=!1);var a=hu.call(this)||this;if(a.learningRate=f,a.decay=c,a.momentum=d,a.epsilon=b,a.accumulatedMeanSquares=[],a.accumulatedMoments=[],a.accumulatedMeanGrads=[],a.centered=e,null==b&&(a.epsilon=ad.backend.epsilon()),null==f)throw new Error("learningRate for RMSPropOptimizer must be defined.");return a}m(dG);var t=(od.sgd=function(a){return new T(a)},od.momentum=function(b,c,a){return void 0===a&&(a=!1),new dF(b,c,a)},od.rmsprop=function(e,a,b,c,d){return void 0===a&&(a=.9),void 0===b&&(b=0),void 0===c&&(c=null),void 0===d&&(d=!1),new dG(e,a,b,c,d)},od.adam=function(a,b,c,d){return void 0===a&&(a=.001),void 0===b&&(b=.9),void 0===c&&(c=.999),void 0===d&&(d=null),new dD(a,b,c,d)},od.adadelta=function(a,b,c){return void 0===a&&(a=.001),void 0===b&&(b=.95),void 0===c&&(c=null),new dB(a,b,c)},od.adamax=function(a,b,c,d,e){return void 0===a&&(a=.002),void 0===b&&(b=.9),void 0===c&&(c=.999),void 0===d&&(d=null),void 0===e&&(e=0),new dE(a,b,c,d,e)},od.adagrad=function(b,a){return void 0===a&&(a=.1),new dC(b,a)},od),hv={sgd:t.sgd,momentum:t.momentum,adadelta:t.adadelta,adagrad:t.adagrad,rmsprop:t.rmsprop,adamax:t.adamax,adam:t.adam},oc="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:"undefined"!=typeof setImmediate?setImmediate:function(a){return a()};function od(){}eK=g_;var hw=Object.freeze({__proto__:null,AdadeltaOptimizer:dB,AdagradOptimizer:dC,AdamOptimizer:dD,AdamaxOptimizer:dE,DataStorage:f2,get ENV(){return i},Environment:d0,KernelBackend:K,MomentumOptimizer:dF,Optimizer:n,RMSPropOptimizer:dG,get Rank(){return F},get Reduction(){return C},SGDOptimizer:T,Tensor:E,TensorBuffer:eJ,Variable:ac,abs:bc,acos:bd,acosh:be,add:bY,addN:bZ,addStrict:b$,all:cW,any:cX,argMax:cY,argMin:cZ,asin:bf,asinh:bg,atan:bh,atan2:b_,atanh:bi,avgPool:cN,avgPool3d:cQ,backend:function(){return ad.backend},backend_util:gh,basicLSTMCell:de,batchNorm:bP,batchNorm2d:bQ,batchNorm3d:bR,batchNorm4d:bS,batchNormalization:bO,batchNormalization2d:bL,batchNormalization3d:bM,batchNormalization4d:bN,batchToSpaceND:aK,booleanMaskAsync:cu,broadcastTo:aL,browser:hh,buffer:aH,cast:aM,ceil:bj,clipByValue:bk,clone:aN,complex:ai,concat:aB,concat1d:aC,concat2d:aD,concat3d:aE,concat4d:aF,conv1d:cx,conv2d:cy,conv2dTranspose:cC,conv3d:cz,conv3dTranspose:cD,cos:bl,cosh:bm,cumsum:aO,customGrad:f1,deprecationWarn:ah,depthToSpace:aP,depthwiseConv2d:cA,diag:dn,disableDeprecationWarnings:function(){i.set("DEPRECATION_WARNINGS_ENABLED",!1),console.warn("TensorFlow.js deprecation warnings have been disabled.")},dispose:fv,disposeVariables:function(){ad.disposeVariables()},div:b0,divNoNan:b1,divStrict:b2,dot:cF,dropout:dp,elu:c5,enableDebugMode:function(){i.set("DEBUG",!0)},enableProdMode:function(){i.set("PROD",!0)},engine:function(){return ad},env:_,equal:ci,equalStrict:cj,erf:bn,exp:bo,expandDims:aQ,expm1:bp,eye:aR,fft:L,fill:aw,findBackend:function(a){return ad.findBackend(a)},findBackendFactory:function(a){return ad.findBackendFactory(a)},floor:bq,floorDiv:b3,frame:R,fused:dv,gather:cv,gatherND:dm,gather_util:fO,getBackend:function(){return ad.backendName},getGradient:d2,getKernel:d1,getKernelsForBackend:d3,grad:function(a){return d8(ey(a),function(){return"The f passed in grad(f) must be a function"}),function(c,b){var d=kn(c,"x","tf.grad",null),e=null!=b?kn(b,"dy","tf.grad"):null;return ad.tidy(function(){var b=ad.gradients(function(){return a(d)},[d],e),f=b.value,c=b.grads;return null!=e&&d9(f.shape,e.shape,"The shape of dy passed in grad(f)(x, dy) must match the shape returned by f(x)"),kC(c),c[0]})}},grads:function(a){return d8(ey(a),function(){return"The f passed in grads(f) must be a function"}),function(b,c){d8(Array.isArray(b),function(){return"The args passed in grads(f)(args) must be an array of `Tensor`s or `TensorLike`s"});var d=ko(b,"args","tf.grads",null),e=null!=c?kn(c,"dy","tf.grads"):null;return ad.tidy(function(){var b=ad.gradients(function(){return a.apply(void 0,d)},d,e),f=b.value,c=b.grads;return null!=e&&d9(f.shape,e.shape,"The shape of dy passed in grads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),kC(c),c})}},greater:ck,greaterEqual:cl,greaterEqualStrict:cm,greaterStrict:cn,hammingWindow:Q,hannWindow:P,ifft:M,imag:ak,image:du,inTopKAsync:dq,io:hd,irfft:O,isFinite:bC,isInf:bB,isNaN:bA,keep:fw,leakyRelu:c6,less:co,lessEqual:cp,lessEqualStrict:cq,lessStrict:cr,linalg:dt,linspace:ax,localResponseNormalization:dc,log:br,log1p:bs,logSigmoid:bt,logSoftmax:a9,logSumExp:c$,logicalAnd:bT,logicalNot:bU,logicalOr:bV,logicalXor:bW,losses:ds,matMul:cE,math:hf,max:c_,maxPool:cM,maxPool3d:cP,maximum:b4,maximumStrict:b5,mean:c0,memory:function(){return ad.memory()},min:c1,minimum:b6,minimumStrict:b7,mod:b8,modStrict:b9,moments:c2,movingAverage:dg,mul:ca,mulStrict:cb,multiRNNCell:df,multinomial:aS,neg:bu,nextFrame:function(){return new Promise(function(a){return oc(function(){return a()})})},norm:dd,notEqual:cs,notEqualStrict:ct,oneHot:aT,ones:au,onesLike:az,op:a,outerProduct:cG,pad:aU,pad1d:aV,pad2d:aW,pad3d:aX,pad4d:aY,pool:cO,pow:cc,powStrict:cd,prelu:c7,print:aI,prod:c4,profile:function(a){return ad.profile(a)},rand:aZ,randomGamma:a_,randomNormal:a$,randomUniform:a0,range:ay,ready:function(){return ad.ready()},real:aj,reciprocal:bv,registerBackend:function(b,c,a){return void 0===a&&(a=1),ad.registerBackend(b,c,a)},registerGradient:ab,registerKernel:u,relu:c8,relu6:c9,removeBackend:function(a){ad.removeBackend(a)},reshape:a1,reverse:cH,reverse1d:cI,reverse2d:cJ,reverse3d:cK,reverse4d:cL,rfft:N,round:bw,rsqrt:bx,scalar:am,scatterND:dj,scatter_util:fT,selu:da,separableConv2d:cB,serialization:hj,setBackend:function(a){return ad.setBackend(a)},setPlatform:function(a,b){i.setPlatform(a,b)},setdiff1dAsync:aJ,sigmoid:by,sign:bz,signal:dr,sin:bD,sinh:bE,slice:cR,slice1d:cS,slice2d:cT,slice3d:cU,slice4d:cV,slice_util:f_,softmax:a8,softplus:bF,spaceToBatchND:a2,sparseToDense:dl,spectral:dk,split:aG,sqrt:bG,square:bb,squaredDifference:ce,squaredDifferenceStrict:cf,squeeze:a3,stack:a4,step:bH,stft:S,stridedSlice:dh,sub:cg,subStrict:ch,sum:c3,sumOutType:eO,tan:bI,tanh:bJ,tensor:al,tensor1d:an,tensor2d:ao,tensor3d:ap,tensor4d:aq,tensor5d:ar,tensor6d:as,tensor_util:eS,test_util:hm,tidy:fu,tile:a5,time:function(a){return ad.time(a)},topk:di,train:hv,transpose:db,truncatedNormal:a6,unregisterGradient:function(a){if(!jP.has(a))throw new Error("The gradient '"+a+"' for backend is not registered");jP.delete(a)},unregisterKernel:function(a,b){var d,e,c=b+"_"+(d=a);if(!jO.has(c))throw new Error("The kernel '"+a+"' for backend '"+b+"' is not registered");jO.delete(c)},unsortedSegmentSum:cw,unstack:a7,util:eI,valueAndGrad:function(a){return d8(ey(a),function(){return"The f passed in valueAndGrad(f) must be a function"}),function(c,b){d8(c instanceof E,function(){return"The x passed in valueAndGrad(f)(x) must be a tensor"}),d8(null==b||b instanceof E,function(){return"The dy passed in valueAndGrad(f)(x, dy) must be a tensor"});var d=ad.gradients(function(){return a(c)},[c],b),e=d.grads,f=d.value;return kC(e),{grad:e[0],value:f}}},valueAndGrads:function(a){return d8(ey(a),function(){return"The f passed in valueAndGrads(f) must be a function"}),function(c,b){d8(Array.isArray(c)&&c.every(function(a){return a instanceof E}),function(){return"The args passed in valueAndGrads(f)(args) must be array of tensors"}),d8(null==b||b instanceof E,function(){return"The dy passed in valueAndGrads(f)(args, dy) must be a tensor"});var d=ad.gradients(function(){return a.apply(void 0,c)},c,b);return null!=b&&d9(d.value.shape,b.shape,"The shape of dy passed in valueAndGrads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),kC(d.grads),d}},variable:at,variableGrads:f0,version_core:"1.5.2",webgl:hn,where:bX,whereAsync:bK,zeros:av,zerosLike:aA});function hx(a,b,c){if(void 0===c&&(c=!1),a.beginPath(),b.slice(1).forEach(function(c,e){var f=c.x,g=c.y,d=b[e];a.moveTo(d.x,d.y),a.lineTo(f,g)}),c){var d=b[b.length-1],e=b[0];if(!d||!e)return;a.moveTo(d.x,d.y),a.lineTo(e.x,e.y)}a.stroke()}var oe=function(a,b){return(oe=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(a,b){a.__proto__=b}||function(c,a){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b])})(a,b)};function c(b,a){function c(){this.constructor=b}oe(b,a),b.prototype=null===a?Object.create(a):(c.prototype=a.prototype,new c)}var of=function(){return(of=Object.assign||function(d){for(var a,b=1,e=arguments.length;b<e;b++)for(var c in a=arguments[b])Object.prototype.hasOwnProperty.call(a,c)&&(d[c]=a[c]);return d}).apply(this,arguments)};function og(b,c,a,d){return new(a=a||Promise)(function(f,g){function h(a){try{e(d.next(a))}catch(b){g(b)}}function i(a){try{e(d.throw(a))}catch(b){g(b)}}function e(b){b.done?f(b.value):new a(function(a){a(b.value)}).then(h,i)}e((d=d.apply(b,c||[])).next())})}function oh(b,c){var d,e,f,a,g={label:0,sent:function(){if(1&f[0])throw f[1];return f[1]},trys:[],ops:[]};return a={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function h(a){return function(h){return function(a){if(d)throw new TypeError("Generator is already executing.");for(;g;)try{if(d=1,e&&(f=2&a[0]?e.return:a[0]?e.throw||((f=e.return)&&f.call(e),0):e.next)&&!(f=f.call(e,a[1])).done)return f;switch(e=0,f&&(a=[2&a[0],f.value]),a[0]){case 0:case 1:f=a;break;case 4:return g.label++,{value:a[1],done:!1};case 5:g.label++,e=a[1],a=[0];continue;case 7:a=g.ops.pop(),g.trys.pop();continue;default:if(!(f=0<(f=g.trys).length&&f[f.length-1])&&(6===a[0]||2===a[0])){g=0;continue}if(3===a[0]&&(!f||a[1]>f[0]&&a[1]<f[3])){g.label=a[1];break}if(6===a[0]&&g.label<f[1]){g.label=f[1],f=a;break}if(f&&g.label<f[2]){g.label=f[2],g.ops.push(a);break}f[2]&&g.ops.pop(),g.trys.pop();continue}a=c.call(b,g)}catch(h){a=[6,h],e=0}finally{d=f=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,h])}}}function oi(){for(var c=0,a=0,d=arguments.length;a<d;a++)c+=arguments[a].length;var e=Array(c),f=0;for(a=0;a<d;a++)for(var g=arguments[a],b=0,h=g.length;b<h;b++,f++)e[f]=g[b];return e}var hy=(Object.defineProperty(oj.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(oj.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),oj.prototype.reverse=function(){return new oj(1/this.width,1/this.height)},oj);function oj(a,b){if(!hK(a)||!hK(b))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:a,height:b}));this._width=a,this._height=b}function hz(a,b){return a instanceof E&&a.shape.length===b}function hA(a){return hz(a,2)}function hB(a){return hz(a,3)}function hC(a){return hz(a,4)}function hD(a){return a%1!=0}function hE(a){return a%2==0}function hF(c,a){void 0===a&&(a=2);var b=Math.pow(10,a);return Math.floor(c*b)/b}function hG(a){return a&&a.width&&a.height}function hH(a,e){var b=a.width,c=a.height,d=e/Math.max(c,b);return new hy(Math.round(b*d),Math.round(c*d))}function hI(a){return a.reduce(function(a,b){return a.add(b)},new e(0,0)).div(new e(a.length,a.length))}function hJ(a,b,c){return Array(a).fill(0).map(function(d,a){return b+a*c})}function hK(a){return!!a&&a!==1/0&&a!== -1/0&&!isNaN(a)||0===a}function hL(a){return hK(a)&&0<=a&&a<=1}var hM=Object.freeze({__proto__:null,isTensor:hz,isTensor1D:function(a){return hz(a,1)},isTensor2D:hA,isTensor3D:hB,isTensor4D:hC,isFloat:hD,isEven:hE,round:hF,isDimensions:hG,computeReshapedDimensions:hH,getCenterPoint:hI,range:hJ,isValidNumber:hK,isValidProbablitiy:hL}),e=(Object.defineProperty(ok.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(ok.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),ok.prototype.add=function(a){return new ok(this.x+a.x,this.y+a.y)},ok.prototype.sub=function(a){return new ok(this.x-a.x,this.y-a.y)},ok.prototype.mul=function(a){return new ok(this.x*a.x,this.y*a.y)},ok.prototype.div=function(a){return new ok(this.x/a.x,this.y/a.y)},ok.prototype.abs=function(){return new ok(Math.abs(this.x),Math.abs(this.y))},ok.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},ok.prototype.floor=function(){return new ok(Math.floor(this.x),Math.floor(this.y))},ok);function ok(a,b){this._x=a,this._y=b}var w=(ol.isRect=function(a){return!!a&&[a.x,a.y,a.width,a.height].every(hK)},ol.assertIsValidBox=function(a,c,b){if(void 0===b&&(b=!1),!ol.isRect(a))throw new Error(c+" - invalid box: "+JSON.stringify(a)+", expected object with properties x, y, width, height");if(!b&&(a.width<0||a.height<0))throw new Error(c+" - width ("+a.width+") and height ("+a.height+") must be positive numbers")},Object.defineProperty(ol.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"topLeft",{get:function(){return new e(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"topRight",{get:function(){return new e(this.right,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"bottomLeft",{get:function(){return new e(this.left,this.bottom)},enumerable:!0,configurable:!0}),Object.defineProperty(ol.prototype,"bottomRight",{get:function(){return new e(this.right,this.bottom)},enumerable:!0,configurable:!0}),ol.prototype.round=function(){var a=[this.x,this.y,this.width,this.height].map(function(a){return Math.round(a)});return new ol({x:a[0],y:a[1],width:a[2],height:a[3]})},ol.prototype.floor=function(){var a=[this.x,this.y,this.width,this.height].map(function(a){return Math.floor(a)});return new ol({x:a[0],y:a[1],width:a[2],height:a[3]})},ol.prototype.toSquare=function(){var d=this.x,e=this.y,a=this.width,b=this.height,c=Math.abs(a-b);return a<b&&(d-=c/2,a+=c),b<a&&(e-=c/2,b+=c),new ol({x:d,y:e,width:a,height:b})},ol.prototype.rescale=function(a){var b=hG(a)?a.width:a,c=hG(a)?a.height:a;return new ol({x:this.x*b,y:this.y*c,width:this.width*b,height:this.height*c})},ol.prototype.pad=function(b,c){var a=[this.x-b/2,this.y-c/2,this.width+b,this.height+c];return new ol({x:a[0],y:a[1],width:a[2],height:a[3]})},ol.prototype.clipAtImageBorders=function(c,d){var e=this.x,f=this.y,g=this.right,h=this.bottom,a=Math.max(e,0),b=Math.max(f,0);return new ol({x:a,y:b,width:Math.min(g-a,c-a),height:Math.min(h-b,d-b)}).floor()},ol.prototype.shift=function(a,b){var c=this.width,d=this.height;return new ol({x:this.x+a,y:this.y+b,width:c,height:d})},ol.prototype.padAtBorders=function(f,g){var h=this.width+1,i=this.height+1,j=h,a=i,b=this.left,c=this.top,d=this.right,e=this.bottom;return g<d&&(j=-d+g+h,d=g),f<e&&(a=-e+f+i,e=f),b<1&&(a=2-b,b=1),c<1&&(a=2-c,c=1),{dy:1,edy:a,dx:1,edx:j,y:c,ey:e,x:b,ex:d,w:h,h:i}},ol.prototype.calibrate=function(a){return new ol({left:this.left+a.left*this.width,top:this.top+a.top*this.height,right:this.right+a.right*this.width,bottom:this.bottom+a.bottom*this.height}).toSquare().round()},ol);function ol(i,c){void 0===c&&(c=!0);var a=i||{},j=[a.left,a.top,a.right,a.bottom].every(hK),d=[a.x,a.y,a.width,a.height].every(hK);if(!d&&!j)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(a));var b=d?[a.x,a.y,a.width,a.height]:[a.left,a.top,a.right-a.left,a.bottom-a.top],e=b[0],f=b[1],g=b[2],h=b[3];ol.assertIsValidBox({x:e,y:f,width:g,height:h},"Box.constructor",c),this._x=e,this._y=f,this._width=g,this._height=h}var hN,hO=(c(om,hN=w),om);function om(b,c,d,e,a){return void 0===a&&(a=!1),hN.call(this,{left:b,top:c,right:d,bottom:e},a)||this}var dH=(Object.defineProperty(on.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(on.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(on.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(on.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(on.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(on.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(on.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(on.prototype,"relativeBox",{get:function(){return new w(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),on.prototype.forSize=function(a,b){return new on(this.score,this.classScore,this.className,this.relativeBox,{width:a,height:b})},on);function on(b,c,d,e,a){this._imageDims=new hy(a.width,a.height),this._score=b,this._classScore=c,this._className=d,this._box=new w(e).rescale(this._imageDims)}var hP,hQ=(c(oo,hP=dH),oo.prototype.forSize=function(b,c){var a=hP.prototype.forSize.call(this,b,c);return new oo(a.score,a.relativeBox,a.imageDims)},oo);function oo(a,b,c){return hP.call(this,a,a,"",b,c)||this}function hR(a,b,c){void 0===c&&(c=!0);var d=Math.max(0,Math.min(a.right,b.right)-Math.max(a.left,b.left))*Math.max(0,Math.min(a.bottom,b.bottom)-Math.max(a.top,b.top));return c?d/(a.area+b.area-d):d/Math.min(a.area,b.area)}function hS(a){var b=a.map(function(a){return a.x}),c=a.map(function(a){return a.y}),d=b.reduce(function(a,b){return b<a?b:a},1/0),e=c.reduce(function(a,b){return b<a?b:a},1/0),f=b.reduce(function(a,b){return a<b?b:a},0),g=c.reduce(function(a,b){return a<b?b:a},0);return new hO(d,e,f,g)}function hT(e,b,f,a){void 0===a&&(a=!0);for(var c=b.map(function(a,b){return{score:a,boxIndex:b}}).sort(function(a,b){return a.score-b.score}).map(function(a){return a.boxIndex}),d=[];0<c.length;)!function(){var g=c.pop();d.push(g);for(var h=c,i=[],b=0;b<h.length;b++){var j=h[b],k=e[g],l=e[j];i.push(hR(k,l,a))}c=c.filter(function(b,a){return i[a]<=f})}();return d}function hU(a,b){return fu(function(){var c=b[0],d=b[1],e=b[2],f=aw(oi(a.shape.slice(0,3),[1]),c),g=aw(oi(a.shape.slice(0,3),[1]),d),h=aw(oi(a.shape.slice(0,3),[1]),e),i=aB([f,g,h],3);return cg(a,i)})}function hV(b,a){return void 0===a&&(a=!1),fu(function(){var e=b.shape.slice(1),c=e[0],d=e[1];if(c===d)return b;function f(c){var a=b.shape.slice();return a[h]=c,aw(a,0)}var g=Math.abs(c-d),h=d<c?2:1,i=f(Math.round(g*(a?.5:1))),j=g-i.shape[h],k=[a&&j?f(j):null,b,i].filter(function(a){return!!a}).map(function(a){return a.toFloat()});return aB(k,h)})}function hW(a){return 1/(1+Math.exp(-a))}var hX,hY=(c(op,hX=w),op);function op(b,c,d,e,a){return void 0===a&&(a=!1),hX.call(this,{x:b,y:c,width:d,height:e},a)||this}var U=(Object.defineProperty(oq.prototype,"shift",{get:function(){return new e(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(oq.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(oq.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(oq.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(oq.prototype,"relativePositions",{get:function(){var a=this;return this._positions.map(function(b){return b.sub(a._shift).div(new e(a.imageWidth,a.imageHeight))})},enumerable:!0,configurable:!0}),oq.prototype.forSize=function(a,b){return new this.constructor(this.relativePositions,{width:a,height:b})},oq.prototype.shiftBy=function(a,b){return new this.constructor(this.relativePositions,this._imgDims,new e(a,b))},oq.prototype.shiftByPoint=function(a){return this.shiftBy(a.x,a.y)},oq.prototype.align=function(a,b){if(void 0===b&&(b={}),a){var c=a instanceof hQ?a.box.floor():new w(a);return this.shiftBy(c.x,c.y).align(null,b)}var d=Object.assign({},{useDlibAlignment:!1,minBoxPadding:.2},b),e=d.useDlibAlignment,f=d.minBoxPadding;return e?this.alignDlib():this.alignMinBbox(f)},oq.prototype.alignDlib=function(){function c(a){return j.sub(a).magnitude()}var a=this.getRefPointsForAlignment(),g=a[0],h=a[1],j=a[2],i=(c(g)+c(h))/2,b=Math.floor(i/.45),d=hI(a),e=Math.floor(Math.max(0,d.x-.5*b)),f=Math.floor(Math.max(0,d.y-.43*b));return new hY(e,f,Math.min(b,this.imageWidth+e),Math.min(b,this.imageHeight+f))},oq.prototype.alignMinBbox=function(b){var a=hS(this.positions);return a.pad(a.width*b,a.height*b)},oq.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")},oq);function oq(c,b,a){void 0===a&&(a=new e(0,0));var d=b.width,f=b.height;this._imgDims=new hy(d,f),this._shift=a,this._positions=c.map(function(b){return b.mul(new e(d,f)).add(a)})}var hZ,h$=(c(or,hZ=U),or.prototype.getRefPointsForAlignment=function(){var a=this.positions;return[a[0],a[1],hI([a[3],a[4]])]},or);function or(){return null!==hZ&&hZ.apply(this,arguments)||this}var h_,h0=(c(os,h_=U),os.prototype.getJawOutline=function(){return this.positions.slice(0,17)},os.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},os.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},os.prototype.getNose=function(){return this.positions.slice(27,36)},os.prototype.getLeftEye=function(){return this.positions.slice(36,42)},os.prototype.getRightEye=function(){return this.positions.slice(42,48)},os.prototype.getMouth=function(){return this.positions.slice(48,68)},os.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(hI)},os);function os(){return null!==h_&&h_.apply(this,arguments)||this}var h1=(Object.defineProperty(ot.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(ot.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),ot.prototype.toString=function(a){return void 0===a&&(a=!0),this.label+(a?" ("+hF(this.distance)+")":"")},ot);function ot(a,b){this._label=a,this._distance=b}var h2,dI=(c(ou,h2=w),ou.assertIsValidLabeledBox=function(a,b){if(w.assertIsValidBox(a,b),!hK(a.label))throw new Error(b+" - expected property label ("+a.label+") to be a number")},Object.defineProperty(ou.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),ou);function ou(b,c){var a=h2.call(this,b)||this;return a._label=c,a}var h3=(Object.defineProperty(ov.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(ov.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),ov.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map(function(a){return Array.from(a)})}},ov.fromJSON=function(a){var b=a.descriptors.map(function(a){return new Float32Array(a)});return new ov(a.label,b)},ov);function ov(b,a){if("string"!=typeof b)throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(a)||a.some(function(a){return!(a instanceof Float32Array)}))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=b,this._descriptors=a}var h4,ow,h5=(c(ox,h4=dI),ox.assertIsValidPredictedBox=function(a,b){if(dI.assertIsValidLabeledBox(a,b),!hL(a.score)||!hL(a.classScore))throw new Error(b+" - expected properties score ("+a.score+") and ("+a.classScore+") to be a number between [0, 1]")},Object.defineProperty(ox.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(ox.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),ox);function ox(b,c,d,e){var a=h4.call(this,b,c)||this;return a._score=d,a._classScore=e,a}function h6(a){return a.detection instanceof hQ}function h7(a,b){return Object.assign({},a,{detection:b})}function h8(){return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D:CanvasRenderingContext2D,Image:HTMLImageElement,ImageData:ImageData,Video:HTMLVideoElement,createCanvasElement:function(){return document.createElement("canvas")},createImageElement:function(){return document.createElement("img")},fetch:window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")},readFile:function(){throw new Error("readFile - filesystem not available for browser environment")}}}function h9(a){var b="";if(!a)try{a=require("fs")}catch(c){b=c.toString()}return{readFile:a?function(b){return new Promise(function(c,d){a.readFile(b,function(a,b){return a?d(a):c(b)})})}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+b)}}}function ia(){var a=global.Canvas||global.HTMLCanvasElement,b=global.Image||global.HTMLImageElement,c=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")},d=h9();return of({Canvas:a||function(){},CanvasRenderingContext2D:global.CanvasRenderingContext2D||function(){},Image:b||function(){},ImageData:global.ImageData||function(){},Video:global.HTMLVideoElement||function(){},createCanvasElement:function(){if(a)return new a;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:function(){if(b)return new b;throw new Error("createImageElement - missing Image implementation for nodejs environment")},fetch:c},d)}function ib(){return"object"==typeof window&&"undefined"!=typeof document&&"undefined"!=typeof HTMLImageElement&&"undefined"!=typeof HTMLCanvasElement&&"undefined"!=typeof HTMLVideoElement&&"undefined"!=typeof ImageData&&"undefined"!=typeof CanvasRenderingContext2D}function ic(){return"object"==typeof global&&"function"==typeof require&&"undefined"!=typeof module&&"undefined"!=typeof process&&!!process.version}function id(a){ow=a}function dJ(){var a,b;ib()&&(ow=h8()),ic()&&(ow=ia())}var V,D,ie={getEnv:function(){if(!ow)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return ow},setEnv:id,initialize:dJ,createBrowserEnv:h8,createFileSystem:h9,createNodejsEnv:ia,monkeyPatch:function(a){if(ow||dJ(),!ow)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var b=a.Canvas,d=void 0===b?ow.Canvas:b,c=a.Image,e=void 0===c?ow.Image:c;ow.Canvas=d,ow.Image=e,ow.createCanvasElement=a.createCanvasElement||function(){return new d},ow.createImageElement=a.createImageElement||function(){return new e},ow.ImageData=a.ImageData||ow.ImageData,ow.Video=a.Video||ow.Video,ow.fetch=a.fetch||ow.fetch,ow.readFile=a.readFile||ow.readFile},isBrowser:ib,isNodejs:ic};function ig(a){return ie.isNodejs()||"string"!=typeof a?a:document.getElementById(a)}function ih(a){var b=ie.getEnv(),e=b.Canvas;if(a instanceof b.CanvasRenderingContext2D)return a;var c=ig(a);if(!(c instanceof e))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");var d=c.getContext("2d");if(!d)throw new Error("resolveContext2d - canvas 2d context is null");return d}dJ(),(D=V=V||{}).TOP_LEFT="TOP_LEFT",D.TOP_RIGHT="TOP_RIGHT",D.BOTTOM_LEFT="BOTTOM_LEFT",D.BOTTOM_RIGHT="BOTTOM_RIGHT";var ii=function(a){void 0===a&&(a={});var b=a.anchorPosition,c=a.backgroundColor,d=a.fontColor,e=a.fontSize,f=a.fontStyle,g=a.padding;this.anchorPosition=b||V.TOP_LEFT,this.backgroundColor=c||"rgba(0, 0, 0, 0.5)",this.fontColor=d||"rgba(255, 255, 255, 1)",this.fontSize=e||14,this.fontStyle=f||"Georgia",this.padding=g||4},ij=(oy.prototype.measureWidth=function(b){var a=this.options.padding;return this.text.map(function(a){return b.measureText(a).width}).reduce(function(a,b){return a<b?b:a},0)+2*a},oy.prototype.measureHeight=function(){var a=this.options,b=a.fontSize,c=a.padding;return this.text.length*b+2*c},oy.prototype.getUpperLeft=function(g,b){var a=this.options.anchorPosition,h=a===V.BOTTOM_RIGHT||a===V.TOP_RIGHT,i=a===V.BOTTOM_LEFT||a===V.BOTTOM_RIGHT,c=this.measureWidth(g),d=this.measureHeight(),e=h?this.anchor.x-c:this.anchor.x,f=i?this.anchor.y-d:this.anchor.y;if(b){var j=b.width,k=b.height;return{x:Math.max(Math.min(e,j-c),0),y:Math.max(Math.min(f,k-d),0)}}return{x:e,y:f}},oy.prototype.draw=function(e){var c=ig(e),a=ih(c),b=this.options,f=b.backgroundColor,g=b.fontColor,h=b.fontSize,i=b.fontStyle,l=b.padding;a.font=h+"px "+i;var j=this.measureWidth(a),k=this.measureHeight();a.fillStyle=f;var d=this.getUpperLeft(a,c);a.fillRect(d.x,d.y,j,k),a.fillStyle=g,this.text.forEach(function(b,c){var e=l+d.x,f=l+d.y+(c+1)*h;a.fillText(b,e,f)})},oy);function oy(a,c,b){void 0===b&&(b={}),this.text="string"==typeof a?[a]:a instanceof oy?a.text:a,this.anchor=c,this.options=new ii(b)}var ik=function(a){void 0===a&&(a={});var b=a.boxColor,c=a.lineWidth,d=a.label,e=a.drawLabelOptions;this.boxColor=b||"rgba(0, 0, 255, 1)",this.lineWidth=c||2,this.label=d;var f={anchorPosition:V.BOTTOM_LEFT,backgroundColor:this.boxColor};this.drawLabelOptions=new ii(Object.assign({},f,e))},il=(oz.prototype.draw=function(c){var b=ih(c),d=this.options,i=d.boxColor,e=d.lineWidth,a=this.box,f=a.x,g=a.y,j=a.width,k=a.height;b.strokeStyle=i,b.lineWidth=e,b.strokeRect(f,g,j,k);var h=this.options.label;h&&new ij([h],{x:f-e/2,y:g},this.options.drawLabelOptions).draw(c)},oz);function oz(b,a){void 0===a&&(a={}),this.box=new w(b),this.options=new ik(a)}function im(a){var b=ie.getEnv(),c=b.Image,d=b.Video;return a instanceof c&&a.complete||a instanceof d&&3<=a.readyState}function io(a){return new Promise(function(b,e){if(a instanceof ie.getEnv().Canvas||im(a))return b();function c(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",c),a.currentTarget.removeEventListener("error",d),b(a))}function d(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",c),a.currentTarget.removeEventListener("error",d),e(a))}a.addEventListener("load",c),a.addEventListener("error",d)})}function ip(a){return new Promise(function(d,c){if(!(a instanceof Blob))return c("bufferToImage - expected buf to be of type: Blob");var b=new FileReader;b.onload=function(){if("string"!=typeof b.result)return c("bufferToImage - expected reader.result to be a string, in onload");var a=ie.getEnv().createImageElement();a.onload=function(){return d(a)},a.onerror=c,a.src=b.result},b.onerror=c,b.readAsDataURL(a)})}function iq(a){var b=ie.getEnv(),c=b.Image,d=b.Video;return a instanceof c?new hy(a.naturalWidth,a.naturalHeight):a instanceof d?new hy(a.videoWidth,a.videoHeight):new hy(a.width,a.height)}function ir(b){var c=b.width,d=b.height,a=(0,ie.getEnv().createCanvasElement)();return a.width=c,a.height=d,a}function is(a,g){var c=ie.getEnv().ImageData;if(!(a instanceof c||im(a)))throw new Error("createCanvasFromMedia - media has not finished loading yet");var d=g||iq(a),e=d.width,f=d.height,b=ir({width:e,height:f});return a instanceof c?ih(b).putImageData(a,0,0):ih(b).drawImage(a,0,0,e,f),b}function it(a,b){return og(this,void 0,void 0,function(){var c,d,e,f,g,h;return oh(this,function(i){switch(i.label){case 0:return c=b||ie.getEnv().createCanvasElement(),e=(d=a.shape.slice(hC(a)?1:0))[0],f=d[1],g=d[2],h=fu(function(){return a.as3D(e,f,g).toInt()}),[4,hh.toPixels(h,c)];case 1:return i.sent(),h.dispose(),[2,c]}})})}function iu(a){var b=ie.getEnv(),c=b.Image,d=b.Canvas,e=b.Video;return a instanceof c||a instanceof d||a instanceof e}function iv(a,f,b){void 0===b&&(b=!1);var g=ie.getEnv(),l=g.Image,h=g.Canvas;if(!(a instanceof l||a instanceof h))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var c=iq(a),i=f/Math.max(c.height,c.width),d=i*c.width,e=i*c.height,j=ir({width:f,height:f}),m=a instanceof h?a:is(a),k=Math.abs(d-e)/2;return ih(j).drawImage(m,b&&d<e?k:0,b&&e<d?k:0,d,e),j}var iw=(Object.defineProperty(oA.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(oA.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(oA.prototype,"isBatchInput",{get:function(){return 1<this.batchSize||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(oA.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(oA.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(oA.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(oA.prototype,"reshapedInputDimensions",{get:function(){var a=this;return hJ(this.batchSize,0,1).map(function(c,b){return a.getReshapedInputDimensions(b)})},enumerable:!0,configurable:!0}),oA.prototype.getInput=function(a){return this.canvases[a]||this.imageTensors[a]},oA.prototype.getInputDimensions=function(a){return this._inputDimensions[a]},oA.prototype.getInputHeight=function(a){return this._inputDimensions[a][0]},oA.prototype.getInputWidth=function(a){return this._inputDimensions[a][1]},oA.prototype.getReshapedInputDimensions=function(a){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return hH({width:this.getInputWidth(a),height:this.getInputHeight(a)},this.inputSize)},oA.prototype.toBatchTensor=function(b,a){var c=this;return void 0===a&&(a=!0),this._inputSize=b,fu(function(){var d=hJ(c.batchSize,0,1).map(function(f){var d=c.getInput(f);if(d instanceof E){var e=hC(d)?d:d.expandDims();return(e=hV(e,a)).shape[1]===b&&e.shape[2]===b||(e=du.resizeBilinear(e,[b,b])),e.as3D(b,b,3)}if(d instanceof ie.getEnv().Canvas)return hh.fromPixels(iv(d,b,a));throw new Error("toBatchTensor - at batchIdx "+f+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+d)});return a4(d.map(function(a){return a.toFloat()})).as4D(c.batchSize,b,b,3)})},oA);function oA(a,b){var c=this;if(void 0===b&&(b=!1),this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(a))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+a);this._treatAsBatchInput=b,this._batchSize=a.length,a.forEach(function(a,b){if(hB(a))return c._imageTensors[b]=a,void(c._inputDimensions[b]=a.shape);if(hC(a)){var e=a.shape[0];if(1!==e)throw new Error("NetInput - tf.Tensor4D with batchSize "+e+" passed, but not supported in input array");return c._imageTensors[b]=a,void(c._inputDimensions[b]=a.shape.slice(1))}var d=a instanceof ie.getEnv().Canvas?a:is(a);c._canvases[b]=d,c._inputDimensions[b]=[d.height,d.width,3]})}function ix(a){return og(this,void 0,void 0,function(){var b,c,d;return oh(this,function(e){switch(e.label){case 0:if(a instanceof iw)return[2,a];if(!(b=Array.isArray(a)?a:[a]).length)throw new Error("toNetInput - empty array passed as input");return c=function(b){return Array.isArray(a)?" at input index "+b+":":""},(d=b.map(ig)).forEach(function(a,d){if(!iu(a)&&!hB(a)&&!hC(a)){if("string"==typeof b[d])throw new Error("toNetInput -"+c(d)+" string passed, but could not resolve HTMLElement for element id "+b[d]);throw new Error("toNetInput -"+c(d)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id")}if(hC(a)){var e=a.shape[0];if(1!==e)throw new Error("toNetInput -"+c(d)+" tf.Tensor4D with batchSize "+e+" passed, but not supported in input array")}}),[4,Promise.all(d.map(function(a){return iu(a)&&io(a)}))];case 1:return e.sent(),[2,new iw(d,Array.isArray(a))]}})})}function iy(a,b){return og(this,void 0,void 0,function(){var c,d,e,f,g,h;return oh(this,function(i){switch(i.label){case 0:return c=ie.getEnv().Canvas,(d=a)instanceof c?[3,5]:[4,ix(a)];case 1:if(1<(e=i.sent()).batchSize)throw new Error("extractFaces - batchSize > 1 not supported");return(f=e.getInput(0))instanceof c?(g=f,[3,4]):[3,2];case 2:return[4,it(f)];case 3:g=i.sent(),i.label=4;case 4:d=g,i.label=5;case 5:return h=ih(d),[2,b.map(function(a){return a instanceof hQ?a.forSize(d.width,d.height).box.floor():a}).map(function(a){return a.clipAtImageBorders(d.width,d.height)}).map(function(a){var e=a.x,f=a.y,b=a.width,c=a.height,d=ir({width:b,height:c});return ih(d).putImageData(h.getImageData(e,f,b,c),0,0),d})]}})})}function iz(a,b){return og(this,void 0,void 0,function(){return oh(this,function(c){if(!hB(a)&&!hC(a))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(hC(a)&&1<a.shape[0])throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,fu(function(){var c=a.shape.slice(hC(a)?1:0),d=c[0],e=c[1],f=c[2];return b.map(function(a){return a instanceof hQ?a.forSize(e,d).box:a}).map(function(a){return a.clipAtImageBorders(e,d)}).map(function(b){var c=b.x,g=b.y,h=b.width,i=b.height;return cU(a.as3D(d,e,f),[g,c,0],[i,h,f])})})]})})}function iA(a,b){return og(this,void 0,void 0,function(){var c;return oh(this,function(d){switch(d.label){case 0:return[4,(0,ie.getEnv().fetch)(a,b)];case 1:if(!((c=d.sent()).status<400))throw new Error("failed to fetch: ("+c.status+") "+c.statusText+", from url: "+c.url);return[2,c]}})})}function iB(a){return og(this,void 0,void 0,function(){return oh(this,function(b){switch(b.label){case 0:return[4,iA(a)];case 1:return[2,b.sent().json()]}})})}function oB(a,g){var d=g+"-weights_manifest.json";if(!a)return{modelBaseUri:"",manifestUri:d};if("/"===a)return{modelBaseUri:"/",manifestUri:"/"+d};var e=a.startsWith("http://")?"http://":a.startsWith("https://")?"https://":"",b=(a=a.replace(e,"")).split("/").filter(function(a){return a}),f=a.endsWith(".json")?b[b.length-1]:d,c=e+(a.endsWith(".json")?b.slice(0,b.length-1):b).join("/");return{modelBaseUri:c=a.startsWith("/")?"/"+c:c,manifestUri:"/"===c?"/"+f:c+"/"+f}}function iC(a,b){return og(this,void 0,void 0,function(){var c,d,e,f;return oh(this,function(g){switch(g.label){case 0:return d=(c=oB(a,b)).manifestUri,e=c.modelBaseUri,[4,iB(d)];case 1:return f=g.sent(),[2,hd.loadWeights(f,e)]}})})}var h=(Object.defineProperty(oC.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(oC.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(oC.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),oC.prototype.getParamFromPath=function(b){var a=this.traversePropertyPath(b);return a.obj[a.objProp]},oC.prototype.reassignParamFromPath=function(d,e){var a=this.traversePropertyPath(d),b=a.obj,c=a.objProp;b[c].dispose(),b[c]=e},oC.prototype.getParamList=function(){var a=this;return this._paramMappings.map(function(c){var b=c.paramPath;return{path:b,tensor:a.getParamFromPath(b)}})},oC.prototype.getTrainableParams=function(){return this.getParamList().filter(function(a){return a.tensor instanceof ac})},oC.prototype.getFrozenParams=function(){return this.getParamList().filter(function(a){return!(a.tensor instanceof ac)})},oC.prototype.variable=function(){var a=this;this.getFrozenParams().forEach(function(b){var c=b.path,d=b.tensor;a.reassignParamFromPath(c,d.variable())})},oC.prototype.freeze=function(){var a=this;this.getTrainableParams().forEach(function(b){var d=b.path,c=b.tensor,e=al(c.dataSync());c.dispose(),a.reassignParamFromPath(d,e)})},oC.prototype.dispose=function(a){void 0===a&&(a=!0),this.getParamList().forEach(function(b){if(a&&b.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+b.path);b.tensor.dispose()}),this._params=void 0},oC.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map(function(a){var b=a.tensor;return Array.from(b.dataSync())}).reduce(function(a,b){return a.concat(b)}))},oC.prototype.load=function(a){return og(this,void 0,void 0,function(){return oh(this,function(b){switch(b.label){case 0:return a instanceof Float32Array?(this.extractWeights(a),[2]):[4,this.loadFromUri(a)];case 1:return b.sent(),[2]}})})},oC.prototype.loadFromUri=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:if(a&&"string"!=typeof a)throw new Error(this._name+".loadFromUri - expected model uri");return[4,iC(a,this.getDefaultModelName())];case 1:return b=c.sent(),this.loadFromWeightMap(b),[2]}})})},oC.prototype.loadFromDisk=function(a){return og(this,void 0,void 0,function(){var b,c,d,e,f,g,h,i,j,k;return oh(this,function(l){switch(l.label){case 0:if(a&&"string"!=typeof a)throw new Error(this._name+".loadFromDisk - expected model file path");return b=ie.getEnv().readFile,d=(c=oB(a,this.getDefaultModelName())).manifestUri,e=c.modelBaseUri,f=function(a){return Promise.all(a.map(function(a){return b(a).then(function(a){return a.buffer})}))},g=hd.weightsLoaderFactory(f),j=(i=JSON).parse,[4,b(d)];case 1:return[4,g(h=j.apply(i,[l.sent().toString()]),e)];case 2:return k=l.sent(),this.loadFromWeightMap(k),[2]}})})},oC.prototype.loadFromWeightMap=function(b){var a=this.extractParamsFromWeigthMap(b),c=a.paramMappings,d=a.params;this._paramMappings=c,this._params=d},oC.prototype.extractWeights=function(b){var a=this.extractParams(b),c=a.paramMappings,d=a.params;this._paramMappings=c,this._params=d},oC.prototype.traversePropertyPath=function(c){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var d=c.split("/").reduce(function(b,a){if(!b.nextObj.hasOwnProperty(a))throw new Error("traversePropertyPath - object does not have property "+a+", for path "+c);return{obj:b.nextObj,objProp:a,nextObj:b.nextObj[a]}},{nextObj:this.params}),a=d.obj,b=d.objProp;if(!(a&&b&&a[b]instanceof E))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+c);return{obj:a,objProp:b}},oC);function oC(a){this._name=a,this._params=void 0,this._paramMappings=[]}function oD(a,b,c){return fu(function(){var d=cB(a,b.depthwise_filter,b.pointwise_filter,c,"same");return bY(d,b.bias)})}function oE(b,c,a){return void 0===a&&(a=!1),fu(function(){var d=c8(a?bY(cy(b,c.conv0.filters,[2,2],"same"),c.conv0.bias):oD(b,c.conv0,[2,2])),e=oD(d,c.conv1,[1,1]),f=oD(c8(bY(d,e)),c.conv2,[1,1]);return c8(bY(d,bY(e,f)))})}function oF(c,d,a,b){return void 0===a&&(a=!1),void 0===b&&(b=!0),fu(function(){var e=c8(a?bY(cy(c,d.conv0.filters,b?[2,2]:[1,1],"same"),d.conv0.bias):oD(c,d.conv0,b?[2,2]:[1,1])),f=oD(e,d.conv1,[1,1]),g=oD(c8(bY(e,f)),d.conv2,[1,1]),h=oD(c8(bY(e,bY(f,g))),d.conv3,[1,1]);return c8(bY(e,bY(f,bY(g,h))))})}function oG(c,d,a,b){return void 0===a&&(a="same"),void 0===b&&(b=!1),fu(function(){var e=bY(cy(c,d.filters,[1,1],a),d.bias);return b?c8(e):e})}function oH(a,b){Object.keys(a).forEach(function(c){b.some(function(a){return a.originalPath===c})||a[c].dispose()})}function oI(a,b){return function(e,d,c,f){var g=aq(a(e*d*c*c),[c,c,e,d]),h=an(a(d));return b.push({paramPath:f+"/filters"},{paramPath:f+"/bias"}),{filters:g,bias:h}}}function oJ(a,b){return function(d,c,e){var f=ao(a(d*c),[d,c]),g=an(a(c));return b.push({paramPath:e+"/weights"},{paramPath:e+"/bias"}),{weights:f,bias:g}}}var oK=function(a,b,c){this.depthwise_filter=a,this.pointwise_filter=b,this.bias=c};function oL(a,b){return function(c,d,e){var f=aq(a(9*c),[3,3,c,1]),g=aq(a(c*d),[1,1,c,d]),h=an(a(d));return b.push({paramPath:e+"/depthwise_filter"},{paramPath:e+"/pointwise_filter"},{paramPath:e+"/bias"}),new oK(f,g,h)}}function oM(a){return function(b){var c=a(b+"/depthwise_filter",4),d=a(b+"/pointwise_filter",4),e=a(b+"/bias",1);return new oK(c,d,e)}}function oN(a,b){return function(c,e,f){var d=a[c];if(!hz(d,e))throw new Error("expected weightMap["+c+"] to be a Tensor"+e+"D, instead have "+d);return b.push({originalPath:c,paramPath:f||c}),d}}function oO(a){var b=a;return{extractWeights:function(a){var c=b.slice(0,a);return b=b.slice(a),c},getRemainingWeights:function(){return b}}}function oP(a,b){var d=oI(a,b),e=oL(a,b);function c(f,a,b,c){return void 0===c&&(c=!1),{conv0:c?d(f,a,3,b+"/conv0"):e(f,a,b+"/conv0"),conv1:e(a,a,b+"/conv1"),conv2:e(a,a,b+"/conv2")}}return{extractDenseBlock3Params:c,extractDenseBlock4Params:function(g,a,f,b){void 0===b&&(b=!1);var d=c(g,a,f,b);return{conv0:d.conv0,conv1:d.conv1,conv2:d.conv2,conv3:e(a,a,f+"/conv3")}}}}function oQ(a){return function(b){return{filters:a(b+"/filters",4),bias:a(b+"/bias",1)}}}function oR(b,c){var a=oN(b,c),d=oQ(a),e=oM(a);return{extractDenseBlock3Params:function(a,b){return void 0===b&&(b=!1),{conv0:b?d(a+"/conv0"):e(a+"/conv0"),conv1:e(a+"/conv1"),conv2:e(a+"/conv2")}},extractDenseBlock4Params:function(a,b){return void 0===b&&(b=!1),{conv0:b?d(a+"/conv0"):e(a+"/conv0"),conv1:e(a+"/conv1"),conv2:e(a+"/conv2"),conv3:e(a+"/conv3")}}}}var iD,oS=(c(oT,iD=h),oT.prototype.forwardInput=function(b){var a=this.params;if(!a)throw new Error("FaceFeatureExtractor - load model before inference");return fu(function(){var c=oF(hU(b.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(am(255)),a.dense0,!0);return c=oF(c=oF(c=oF(c,a.dense1),a.dense2),a.dense3),c=cN(c,[7,7],[2,2],"valid")})},oT.prototype.forward=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,ix(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},oT.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},oT.prototype.extractParamsFromWeigthMap=function(e){var c,a,b,d;return a=[],d={dense0:(b=oR(c=e,a).extractDenseBlock4Params)("dense0",!0),dense1:b("dense1"),dense2:b("dense2"),dense3:b("dense3")},oH(c,a),{params:d,paramMappings:a}},oT.prototype.extractParams=function(a){return function(e){var b=[],c=oO(e),f=c.extractWeights,d=c.getRemainingWeights,a=oP(f,b).extractDenseBlock4Params,g=a(3,32,"dense0",!0),h=a(32,64,"dense1"),i=a(64,128,"dense2"),j=a(128,256,"dense3");if(0!==d().length)throw new Error("weights remaing after extract: "+d().length);return{paramMappings:b,params:{dense0:g,dense1:h,dense2:i,dense3:j}}}(a)},oT);function oT(){return iD.call(this,"FaceFeatureExtractor")||this}function oU(a,b){return fu(function(){return bY(cE(a,b.weights),b.bias)})}function oV(a){var b={},c={};return Object.keys(a).forEach(function(d){(d.startsWith("fc")?c:b)[d]=a[d]}),{featureExtractorMap:b,classifierMap:c}}var iE,dK=(c(oW,iE=h),Object.defineProperty(oW.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),oW.prototype.runNet=function(b){var c=this,a=this.params;if(!a)throw new Error(this._name+" - load model before inference");return fu(function(){var d=b instanceof iw?c.faceFeatureExtractor.forwardInput(b):b;return oU(d.as2D(d.shape[0],-1),a.fc)})},oW.prototype.dispose=function(a){void 0===a&&(a=!0),this.faceFeatureExtractor.dispose(a),iE.prototype.dispose.call(this,a)},oW.prototype.loadClassifierParams=function(b){var a=this.extractClassifierParams(b),c=a.params,d=a.paramMappings;this._params=c,this._paramMappings=d},oW.prototype.extractClassifierParams=function(a){return function(d,e,f){var a=[],b=oO(d),g=b.extractWeights,c=b.getRemainingWeights,h=oJ(g,a)(e,f,"fc");if(0!==c().length)throw new Error("weights remaing after extract: "+c().length);return{paramMappings:a,params:{fc:h}}}(a,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},oW.prototype.extractParamsFromWeigthMap=function(g){var b,c,a,d,e,f=oV(g),h=f.featureExtractorMap,i=f.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(h),a=[],e={fc:{weights:(d=oN(b=i,a))((c="fc")+"/weights",2),bias:d(c+"/bias",1)}},oH(b,a),{params:e,paramMappings:a}},oW.prototype.extractParams=function(a){var d=this.getClassifierChannelsIn(),b=this.getClassifierChannelsOut(),c=b*d+b,e=a.slice(0,a.length-c),f=a.slice(a.length-c);return this.faceFeatureExtractor.extractWeights(e),this.extractClassifierParams(f)},oW);function oW(b,c){var a=iE.call(this,b)||this;return a._faceFeatureExtractor=c,a}var iF=["neutral","happy","sad","angry","fearful","disgusted","surprised"],iG=(oX.prototype.asSortedArray=function(){var a=this;return iF.map(function(b){return{expression:b,probability:a[b]}}).sort(function(a,b){return b.probability-a.probability})},oX);function oX(a){var b=this;if(7!==a.length)throw new Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+a.length);iF.forEach(function(c,d){b[c]=a[d]})}var iH,dL=(c(oY,iH=dK),oY.prototype.forwardInput=function(a){var b=this;return fu(function(){return a8(b.runNet(a))})},oY.prototype.forward=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,ix(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},oY.prototype.predictExpressions=function(a){return og(this,void 0,void 0,function(){var b,c,d,e,f=this;return oh(this,function(g){switch(g.label){case 0:return[4,ix(a)];case 1:return b=g.sent(),[4,this.forwardInput(b)];case 2:return c=g.sent(),[4,Promise.all(a7(c).map(function(a){return og(f,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return[4,a.data()];case 1:return b=c.sent(),a.dispose(),[2,b]}})})}))];case 3:return d=g.sent(),c.dispose(),e=d.map(function(a){return new iG(a)}),[2,b.isBatchInput?e:e[0]]}})})},oY.prototype.getDefaultModelName=function(){return"face_expression_model"},oY.prototype.getClassifierChannelsIn=function(){return 256},oY.prototype.getClassifierChannelsOut=function(){return 7},oY);function oY(a){return void 0===a&&(a=new oS),iH.call(this,"FaceExpressionNet",a)||this}function iI(a){return a.expressions instanceof iG}function iJ(a,b){return Object.assign({},a,{expressions:b})}function iK(a){return h6(a)&&a.landmarks instanceof U&&a.unshiftedLandmarks instanceof U&&a.alignedRect instanceof hQ}function iL(a,b){var c=a.detection.box,d=b.shiftBy(c.x,c.y),f=d.align(),e=a.detection.imageDims,g={landmarks:d,unshiftedLandmarks:b,alignedRect:new hQ(a.detection.score,f.rescale(e.reverse()),e)};return Object.assign({},a,g)}var iM=function(a){void 0===a&&(a={});var b=a.drawLines,c=a.drawPoints,d=a.lineWidth,e=a.lineColor,f=a.pointSize,g=a.pointColor;this.drawLines=void 0===b||b,this.drawPoints=void 0===c||c,this.lineWidth=d||1,this.pointSize=f||2,this.lineColor=e||"rgba(0, 255, 255, 1)",this.pointColor=g||"rgba(255, 0, 255, 1)"},iN=(oZ.prototype.draw=function(d){var a=ih(d),b=this.options,e=b.drawLines,f=b.drawPoints,g=b.lineWidth,h=b.lineColor,i=b.pointSize,c=b.pointColor;e&&this.faceLandmarks instanceof h0&&(a.strokeStyle=h,a.lineWidth=g,hx(a,this.faceLandmarks.getJawOutline()),hx(a,this.faceLandmarks.getLeftEyeBrow()),hx(a,this.faceLandmarks.getRightEyeBrow()),hx(a,this.faceLandmarks.getNose()),hx(a,this.faceLandmarks.getLeftEye(),!0),hx(a,this.faceLandmarks.getRightEye(),!0),hx(a,this.faceLandmarks.getMouth(),!0)),f&&(a.strokeStyle=c,a.fillStyle=c,this.faceLandmarks.positions.forEach(function(b){a.beginPath(),a.arc(b.x,b.y,i,0,2*Math.PI),a.fill()}))},oZ);function oZ(b,a){void 0===a&&(a={}),this.faceLandmarks=b,this.options=new iM(a)}var iO=Object.freeze({__proto__:null,drawContour:hx,drawDetections:function(b,a){(Array.isArray(a)?a:[a]).forEach(function(a){var c=a instanceof hQ?a.score:h6(a)?a.detection.score:void 0,d=a instanceof hQ?a.box:h6(a)?a.detection.box:new w(a),e=c?""+hF(c):void 0;new il(d,{label:e}).draw(b)})},drawFaceExpressions:function(c,a,b,d){void 0===b&&(b=.1),(Array.isArray(a)?a:[a]).forEach(function(a){var f=a instanceof iG?a:iI(a)?a.expressions:void 0;if(!f)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");var g=f.asSortedArray().filter(function(a){return a.probability>b}),h=h6(a)?a.detection.box.bottomLeft:d||new e(0,0);new ij(g.map(function(a){return a.expression+" ("+hF(a.probability)+")"}),h).draw(c)})},DrawBoxOptions:ik,DrawBox:il,DrawFaceLandmarksOptions:iM,DrawFaceLandmarks:iN,drawFaceLandmarks:function(b,a){(Array.isArray(a)?a:[a]).forEach(function(a){var c=a instanceof U?a:iK(a)?a.landmarks:void 0;if(!c)throw new Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new iN(c).draw(b)})},get AnchorPosition(){return V},DrawTextFieldOptions:ii,DrawTextField:ij});function o$(b,a,c){return bY(cy(b,a.filters,c,"same"),a.bias)}function o_(b,c,d){void 0===d&&(d=!0);var a=d?c8(b):b;return a=oD(a,c.separable_conv0,[1,1]),a=oD(c8(a),c.separable_conv1,[1,1]),a=cM(a,[3,3],[2,2],"same"),a=bY(a,o$(b,c.expansion_conv,[2,2]))}var iP,dM,o0=(c(o1,iP=h),o1.prototype.forwardInput=function(b){var c=this,a=this.params;if(!a)throw new Error("TinyXception - load model before inference");return fu(function(){var e=hU(b.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(am(256)),d=c8(o$(e,a.entry_flow.conv_in,[2,2]));return d=o_(d=o_(d,a.entry_flow.reduction_block_0,!1),a.entry_flow.reduction_block_1),hJ(c._numMainBlocks,0,1).forEach(function(f){var e,c,b;d=(e=d,c=a.middle_flow["main_block_"+f],b=oD(c8(e),c.separable_conv0,[1,1]),b=oD(c8(b),c.separable_conv1,[1,1]),b=oD(c8(b),c.separable_conv2,[1,1]),b=bY(b,e))}),d=o_(d,a.exit_flow.reduction_block),d=c8(oD(d,a.exit_flow.separable_conv,[1,1]))})},o1.prototype.forward=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,ix(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},o1.prototype.getDefaultModelName=function(){return"tiny_xception_model"},o1.prototype.extractParamsFromWeigthMap=function(a){return function(e,h){var i,o,b,f,g,c=[],a=(b=oN(i=e,c),f=oQ(b),g=oM(b),{extractConvParams:f,extractSeparableConvParams:g,extractReductionBlockParams:function(a){return{separable_conv0:g(a+"/separable_conv0"),separable_conv1:g(a+"/separable_conv1"),expansion_conv:f(a+"/expansion_conv")}},extractMainBlockParams:function(a){return{separable_conv0:g(a+"/separable_conv0"),separable_conv1:g(a+"/separable_conv1"),separable_conv2:g(a+"/separable_conv2")}}}),j=a.extractConvParams,k=a.extractSeparableConvParams,d=a.extractReductionBlockParams,p=a.extractMainBlockParams,l={conv_in:j("entry_flow/conv_in"),reduction_block_0:d("entry_flow/reduction_block_0"),reduction_block_1:d("entry_flow/reduction_block_1")},m={};hJ(h,0,1).forEach(function(a){m["main_block_"+a]=p("middle_flow/main_block_"+a)});var n={reduction_block:d("exit_flow/reduction_block"),separable_conv:k("exit_flow/separable_conv")};return oH(e,c),{params:{entry_flow:l,middle_flow:m,exit_flow:n},paramMappings:c}}(a,this._numMainBlocks)},o1.prototype.extractParams=function(a){return function(j,k){var c,d,e,f,g=[],h=oO(j),l=h.extractWeights,i=h.getRemainingWeights,a=(e=oI(c=l,d=g),f=oL(c,d),{extractConvParams:e,extractSeparableConvParams:f,extractReductionBlockParams:function(c,a,b){return{separable_conv0:f(c,a,b+"/separable_conv0"),separable_conv1:f(a,a,b+"/separable_conv1"),expansion_conv:e(c,a,1,b+"/expansion_conv")}},extractMainBlockParams:function(a,b){return{separable_conv0:f(a,a,b+"/separable_conv0"),separable_conv1:f(a,a,b+"/separable_conv1"),separable_conv2:f(a,a,b+"/separable_conv2")}}}),m=a.extractConvParams,n=a.extractSeparableConvParams,b=a.extractReductionBlockParams,r=a.extractMainBlockParams,o={conv_in:m(3,32,3,"entry_flow/conv_in"),reduction_block_0:b(32,64,"entry_flow/reduction_block_0"),reduction_block_1:b(64,128,"entry_flow/reduction_block_1")},p={};hJ(k,0,1).forEach(function(a){p["main_block_"+a]=r(128,"middle_flow/main_block_"+a)});var q={reduction_block:b(128,256,"exit_flow/reduction_block"),separable_conv:n(256,512,"exit_flow/separable_conv")};if(0!==i().length)throw new Error("weights remaing after extract: "+i().length);return{paramMappings:g,params:{entry_flow:o,middle_flow:p,exit_flow:q}}}(a,this._numMainBlocks)},o1);function o1(b){var a=iP.call(this,"TinyXception")||this;return a._numMainBlocks=b,a}(dM=b.Gender||(b.Gender={})).FEMALE="female",dM.MALE="male";var iQ,dN=(c(o2,iQ=h),Object.defineProperty(o2.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),o2.prototype.runNet=function(b){var c=this,a=this.params;if(!a)throw new Error(this._name+" - load model before inference");return fu(function(){var d=b instanceof iw?c.faceFeatureExtractor.forwardInput(b):b,e=cN(d,[7,7],[2,2],"valid").as2D(d.shape[0],-1);return{age:oU(e,a.fc.age).as1D(),gender:oU(e,a.fc.gender)}})},o2.prototype.forwardInput=function(a){var b=this;return fu(function(){var c=b.runNet(a),d=c.age,e=c.gender;return{age:d,gender:a8(e)}})},o2.prototype.forward=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,ix(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},o2.prototype.predictAgeAndGender=function(a){return og(this,void 0,void 0,function(){var c,d,e,f,g,h,i=this;return oh(this,function(j){switch(j.label){case 0:return[4,ix(a)];case 1:return c=j.sent(),[4,this.forwardInput(c)];case 2:return e=a7((d=j.sent()).age),f=a7(d.gender),g=e.map(function(a,b){return{ageTensor:a,genderTensor:f[b]}}),[4,Promise.all(g.map(function(a){var c=a.ageTensor,d=a.genderTensor;return og(i,void 0,void 0,function(){var a,e,f,g,h;return oh(this,function(i){switch(i.label){case 0:return[4,c.data()];case 1:return a=i.sent()[0],[4,d.data()];case 2:return g=(f=.5<(e=i.sent()[0]))?b.Gender.MALE:b.Gender.FEMALE,h=f?e:1-e,c.dispose(),d.dispose(),[2,{age:a,gender:g,genderProbability:h}]}})})}))];case 3:return h=j.sent(),d.age.dispose(),d.gender.dispose(),[2,c.isBatchInput?h:h[0]]}})})},o2.prototype.getDefaultModelName=function(){return"age_gender_model"},o2.prototype.dispose=function(a){void 0===a&&(a=!0),this.faceFeatureExtractor.dispose(a),iQ.prototype.dispose.call(this,a)},o2.prototype.loadClassifierParams=function(b){var a=this.extractClassifierParams(b),c=a.params,d=a.paramMappings;this._params=c,this._paramMappings=d},o2.prototype.extractClassifierParams=function(a){return function(e){var a=[],b=oO(e),f=b.extractWeights,c=b.getRemainingWeights,d=oJ(f,a),g=d(512,1,"fc/age"),h=d(512,2,"fc/gender");if(0!==c().length)throw new Error("weights remaing after extract: "+c().length);return{paramMappings:a,params:{fc:{age:g,gender:h}}}}(a)},o2.prototype.extractParamsFromWeigthMap=function(b){var a=oV(b),c=a.featureExtractorMap,d=a.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(c),function(b){var a=[],e=oN(b,a);function c(a){return{weights:e(a+"/weights",2),bias:e(a+"/bias",1)}}var d={fc:{age:c("fc/age"),gender:c("fc/gender")}};return oH(b,a),{params:d,paramMappings:a}}(d)},o2.prototype.extractParams=function(a){var b=a.slice(0,a.length-1539),c=a.slice(a.length-1539);return this.faceFeatureExtractor.extractWeights(b),this.extractClassifierParams(c)},o2);function o2(a){void 0===a&&(a=new o0(2));var b=iQ.call(this,"AgeGenderNet")||this;return b._faceFeatureExtractor=a,b}var iR,dO=(c(o3,iR=dK),o3.prototype.postProcess=function(c,d,a){var b=a.map(function(a){var b=a.width,c=a.height,e=d/Math.max(c,b);return{width:b*e,height:c*e}}),e=b.length;return fu(function(){function a(a,b){return a4([aw([68],a),aw([68],b)],1).as2D(1,136).as1D()}function f(e,f){var a=b[e],c=a.width,d=a.height;return f(c,d)?Math.abs(c-d)/2:0}return c.mul(aw([e,136],d)).sub(a4(Array.from(Array(e),function(c,b){var d,e;return a(f(b,function(a,b){return a<b}),f(b,function(a,b){return b<a}))}))).div(a4(Array.from(Array(e),function(d,c){return a(b[c].width,b[c].height)})))})},o3.prototype.forwardInput=function(a){var b=this;return fu(function(){var c=b.runNet(a);return b.postProcess(c,a.inputSize,a.inputDimensions.map(function(a){return{height:a[0],width:a[1]}}))})},o3.prototype.forward=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,ix(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},o3.prototype.detectLandmarks=function(a){return og(this,void 0,void 0,function(){var b,c,d,f=this;return oh(this,function(g){switch(g.label){case 0:return[4,ix(a)];case 1:return b=g.sent(),c=fu(function(){return a7(f.forwardInput(b))}),[4,Promise.all(c.map(function(a,c){return og(f,void 0,void 0,function(){var d,f,g,h,i;return oh(this,function(j){switch(j.label){case 0:return g=(f=Array).from,[4,a.data()];case 1:return h=(d=g.apply(f,[j.sent()])).filter(function(b,a){return hE(a)}),i=d.filter(function(b,a){return!hE(a)}),[2,new h0(Array(68).fill(0).map(function(b,a){return new e(h[a],i[a])}),{height:b.getInputHeight(c),width:b.getInputWidth(c)})]}})})}))];case 2:return d=g.sent(),c.forEach(function(a){return a.dispose()}),[2,b.isBatchInput?d:d[0]]}})})},o3.prototype.getClassifierChannelsOut=function(){return 136},o3);function o3(){return null!==iR&&iR.apply(this,arguments)||this}var iS,W=(c(o4,iS=dO),o4.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},o4.prototype.getClassifierChannelsIn=function(){return 256},o4);function o4(a){return void 0===a&&(a=new oS),iS.call(this,"FaceLandmark68Net",a)||this}var iT,o5=(c(o6,iT=h),o6.prototype.forwardInput=function(b){var a=this.params;if(!a)throw new Error("TinyFaceFeatureExtractor - load model before inference");return fu(function(){var c=oE(hU(b.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(am(255)),a.dense0,!0);return c=oE(c=oE(c,a.dense1),a.dense2),c=cN(c,[14,14],[2,2],"valid")})},o6.prototype.forward=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,ix(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},o6.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},o6.prototype.extractParamsFromWeigthMap=function(e){var c,a,b,d;return a=[],d={dense0:(b=oR(c=e,a).extractDenseBlock3Params)("dense0",!0),dense1:b("dense1"),dense2:b("dense2")},oH(c,a),{params:d,paramMappings:a}},o6.prototype.extractParams=function(a){return function(e){var b=[],c=oO(e),f=c.extractWeights,d=c.getRemainingWeights,a=oP(f,b).extractDenseBlock3Params,g=a(3,32,"dense0",!0),h=a(32,64,"dense1"),i=a(64,128,"dense2");if(0!==d().length)throw new Error("weights remaing after extract: "+d().length);return{paramMappings:b,params:{dense0:g,dense1:h,dense2:i}}}(a)},o6);function o6(){return iT.call(this,"TinyFaceFeatureExtractor")||this}var iU,dP=(c(o7,iU=dO),o7.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},o7.prototype.getClassifierChannelsIn=function(){return 128},o7);function o7(a){return void 0===a&&(a=new o5),iU.call(this,"FaceLandmark68TinyNet",a)||this}var iV,iW=(c(o8,iV=W),o8);function o8(){return null!==iV&&iV.apply(this,arguments)||this}function o9(g,c,h,i,b){void 0===b&&(b="same");var d,e,f=c.conv,j=f.filters,k=f.bias,a=cy(g,j,h,b);return a=(d=a=bY(a,k),bY(ca(d,(e=c.scale).weights),e.biases)),i?c8(a):a}function pa(a,b){return o9(a,b,[1,1],!1)}function pb(a,b){return o9(a,b,[2,2],!0,"valid")}function pc(b,c){var d,e,a=o9(d=b,c.conv1,[1,1],!0);return a=pa(a,c.conv2),a=bY(a,b),a=c8(a)}function pd(c,d){var a=pb(c,d.conv1);a=pa(a,d.conv2);var b=cN(c,2,2,"valid"),g=av(b.shape),h=b.shape[3]!==a.shape[3];if(b.shape[1]!==a.shape[1]||b.shape[2]!==a.shape[2]){var e=oi(a.shape);e[1]=1;var i=av(e),f=oi((a=aB([a,i],1)).shape);f[2]=1;var j=av(f);a=aB([a,j],2)}return b=h?aB([b,g],3):b,a=bY(b,a),a=c8(a)}var iX,dQ=(c(pe,iX=h),pe.prototype.forwardInput=function(b){var a=this.params;if(!a)throw new Error("FaceRecognitionNet - load model before inference");return fu(function(){var c=pb(hU(b.toBatchTensor(150,!0).toFloat(),[122.782,117.001,104.298]).div(am(256)),a.conv32_down),d=(c=pd(c=pc(c=pc(c=pd(c=pc(c=pc(c=pd(c=pc(c=pc(c=pc(c=pd(c=pc(c=pc(c=pc(c=cM(c,3,2,"valid"),a.conv32_1),a.conv32_2),a.conv32_3),a.conv64_down),a.conv64_1),a.conv64_2),a.conv64_3),a.conv128_down),a.conv128_1),a.conv128_2),a.conv256_down),a.conv256_1),a.conv256_2),a.conv256_down_out)).mean([1,2]);return cE(d,a.fc)})},pe.prototype.forward=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,ix(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},pe.prototype.computeFaceDescriptor=function(a){return og(this,void 0,void 0,function(){var b,c,d,e=this;return oh(this,function(f){switch(f.label){case 0:return[4,ix(a)];case 1:return b=f.sent(),c=fu(function(){return a7(e.forwardInput(b))}),[4,Promise.all(c.map(function(a){return a.data()}))];case 2:return d=f.sent(),c.forEach(function(a){return a.dispose()}),[2,b.isBatchInput?d:d[0]]}})})},pe.prototype.getDefaultModelName=function(){return"face_recognition_model"},pe.prototype.extractParamsFromWeigthMap=function(a){return function(c){var b=[],e=function(a,b){var d=oN(a,b);function c(a){var b;return{conv:{filters:d(a+"/conv/filters",4),bias:d(a+"/conv/bias",1)},scale:{weights:d((b=a)+"/scale/weights",1),biases:d(b+"/scale/biases",1)}}}return{extractConvLayerParams:c,extractResidualLayerParams:function(a){return{conv1:c(a+"/conv1"),conv2:c(a+"/conv2")}}}}(c,b),f=e.extractConvLayerParams,a=e.extractResidualLayerParams,g=f("conv32_down"),h=a("conv32_1"),i=a("conv32_2"),j=a("conv32_3"),k=a("conv64_down"),l=a("conv64_1"),m=a("conv64_2"),n=a("conv64_3"),o=a("conv128_down"),p=a("conv128_1"),q=a("conv128_2"),r=a("conv256_down"),s=a("conv256_1"),t=a("conv256_2"),u=a("conv256_down_out"),d=c.fc;if(b.push({originalPath:"fc",paramPath:"fc"}),!hA(d))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+d);return oH(c,b),{params:{conv32_down:g,conv32_1:h,conv32_2:i,conv32_3:j,conv64_down:k,conv64_1:l,conv64_2:m,conv64_3:n,conv128_down:o,conv128_1:p,conv128_2:q,conv256_down:r,conv256_1:s,conv256_2:t,conv256_down_out:u,fc:d},paramMappings:b}}(a)},pe.prototype.extractParams=function(a){return function(f){var c=oO(f),g=c.extractWeights,d=c.getRemainingWeights,b=[],e=function(b,c){function a(o,g,p,h){var i,a,j,d,k,l,e,f,m,n;return{conv:(i=o,a=g,j=p,d=h+"/conv",k=function(f,c,a){var d=b(f),e=d.length/(c*a*a);if(hD(e))throw new Error("depth has to be an integer: "+e+", weights.length: "+d.length+", numFilters: "+c+", filterSize: "+a);return fu(function(){return db(aq(d,[c,e,a,a]),[2,3,1,0])})}(i,a,j),l=an(b(a)),c.push({paramPath:d+"/filters"},{paramPath:d+"/bias"}),{filters:k,bias:l}),scale:(e=g,f=h+"/scale",m=an(b(e)),n=an(b(e)),c.push({paramPath:f+"/weights"},{paramPath:f+"/biases"}),{weights:m,biases:n})}}return{extractConvLayerParams:a,extractResidualLayerParams:function(c,d,e,f,b){return void 0===b&&(b=!1),{conv1:a((b?.5:1)*c,d,e,f+"/conv1"),conv2:a(c,d,e,f+"/conv2")}}}}(g,b),h=e.extractConvLayerParams,a=e.extractResidualLayerParams,i=h(4704,32,7,"conv32_down"),j=a(9216,32,3,"conv32_1"),k=a(9216,32,3,"conv32_2"),l=a(9216,32,3,"conv32_3"),m=a(36864,64,3,"conv64_down",!0),n=a(36864,64,3,"conv64_1"),o=a(36864,64,3,"conv64_2"),p=a(36864,64,3,"conv64_3"),q=a(147456,128,3,"conv128_down",!0),r=a(147456,128,3,"conv128_1"),s=a(147456,128,3,"conv128_2"),t=a(589824,256,3,"conv256_down",!0),u=a(589824,256,3,"conv256_1"),v=a(589824,256,3,"conv256_2"),w=a(589824,256,3,"conv256_down_out"),x=fu(function(){return db(ao(g(32768),[128,256]),[1,0])});if(b.push({paramPath:"fc"}),0!==d().length)throw new Error("weights remaing after extract: "+d().length);return{params:{conv32_down:i,conv32_1:j,conv32_2:k,conv32_3:l,conv64_down:m,conv64_1:n,conv64_2:o,conv64_3:p,conv128_down:q,conv128_1:r,conv128_2:s,conv256_down:t,conv256_1:u,conv256_2:v,conv256_down_out:w,fc:x},paramMappings:b}}(a)},pe);function pe(){return iX.call(this,"FaceRecognitionNet")||this}function iY(a,b){return Object.assign({},a,{descriptor:b})}function iZ(a,b){return Object.assign({},a,{age:b})}function i$(a,b,c){return Object.assign({},a,{gender:b,genderProbability:c})}var i_=(Object.defineProperty(pf.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(pf.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(pf.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(pf.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(pf.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),pf);function pf(b){var a=void 0===b?{}:b,c=a.minFaceSize,d=a.scaleFactor,e=a.maxNumScales,f=a.scoreThresholds,g=a.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=c||20,this._scaleFactor=d||.709,this._maxNumScales=e||10,this._scoreThresholds=f||[.6,.7,.7],this._scaleSteps=g,"number"!=typeof this._minFaceSize||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if("number"!=typeof this._scaleFactor||this._scaleFactor<=0||1<=this._scaleFactor)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if("number"!=typeof this._maxNumScales||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||3!==this._scoreThresholds.length||this._scoreThresholds.some(function(a){return"number"!=typeof a}))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some(function(a){return"number"!=typeof a})))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}function pg(a,b,c){return fu(function(){var d=cy(a,b.filters,c,"same");return d=bY(d,b.batch_norm_offset),bk(d,0,6)})}function ph(o,b,c){var a=o.arraySync(),d=Math.min(a[b][0],a[b][2]),e=Math.min(a[b][1],a[b][3]),f=Math.max(a[b][0],a[b][2]),g=Math.max(a[b][1],a[b][3]),h=Math.min(a[c][0],a[c][2]),i=Math.min(a[c][1],a[c][3]),j=Math.max(a[c][0],a[c][2]),k=Math.max(a[c][1],a[c][3]),l=(f-d)*(g-e),m=(j-h)*(k-i);if(l<=0||m<=0)return 0;var p=Math.max(d,h),q=Math.max(e,i),r=Math.min(f,j),s=Math.min(g,k),n=Math.max(r-p,0)*Math.max(s-q,0);return n/(l+m-n)}function pi(a,b){return fu(function(){var c=a.shape[0];return{boxPredictionEncoding:a1(oG(a,b.box_encoding_predictor),[c,-1,1,4]),classPrediction:a1(oG(a,b.class_predictor),[c,-1,3])}})}var i0=(Object.defineProperty(pj.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(pj.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),pj);function pj(a){var b=void 0===a?{}:a,c=b.minConfidence,d=b.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=c||.5,this._maxResults=d||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||1<=this._minConfidence)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if("number"!=typeof this._maxResults)throw new Error(this._name+" - expected maxResults to be a number")}var i1,X=(c(pk,i1=h),pk.prototype.forwardInput=function(b){var a=this.params;if(!a)throw new Error("SsdMobilenetv1 - load model before inference");return fu(function(){var e,f,g,h,i,j,k,l,c=(e=cg(ca(b.toBatchTensor(512,!1).toFloat(),am(.007843137718737125)),am(1)),f=a.mobilenetv1,fu(function(){var a=null,b=pg(e,f.conv_0,[2,2]);if([f.conv_1,f.conv_2,f.conv_3,f.conv_4,f.conv_5,f.conv_6,f.conv_7,f.conv_8,f.conv_9,f.conv_10,f.conv_11,f.conv_12,f.conv_13].forEach(function(c,e){var f,g,h,i,d=e+1,j=(f=d,[2,4,6,12].some(function(a){return a===f})?[2,2]:[1,1]);b=pg(b=(g=b,h=c.depthwise_conv,i=j,fu(function(){var a=cA(g,h.filters,i,"same");return a=bP(a,h.batch_norm_mean,h.batch_norm_variance,h.batch_norm_offset,h.batch_norm_scale,.0010000000474974513),bk(a,0,6)})),c.pointwise_conv,[1,1]),11===d&&(a=b)}),null===a)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:b,conv11:a}})),d=(g=c.out,h=c.conv11,i=a.prediction_layer,fu(function(){var a=pg(pg(g,i.conv_0,[1,1]),i.conv_1,[2,2]),b=pg(pg(a,i.conv_2,[1,1]),i.conv_3,[2,2]),c=pg(pg(b,i.conv_4,[1,1]),i.conv_5,[2,2]),m=pg(pg(c,i.conv_6,[1,1]),i.conv_7,[2,2]),d=pi(h,i.box_predictor_0),e=pi(g,i.box_predictor_1),f=pi(a,i.box_predictor_2),j=pi(b,i.box_predictor_3),k=pi(c,i.box_predictor_4),l=pi(m,i.box_predictor_5);return{boxPredictions:aB([d.boxPredictionEncoding,e.boxPredictionEncoding,f.boxPredictionEncoding,j.boxPredictionEncoding,k.boxPredictionEncoding,l.boxPredictionEncoding],1),classPredictions:aB([d.classPrediction,e.classPrediction,f.classPrediction,j.classPrediction,k.classPrediction,l.classPrediction],1)}}));return j=d.boxPredictions,k=d.classPredictions,l=a.output_layer,fu(function(){var q,r,t,a,g,h,b,i,c,m,n,o,p,d=j.shape[0],e=(q=a1(a5(l.extra_dim,[d,1,1]),[-1,4]),r=a1(j,[-1,4]),h=(a=a7(db(q,[1,0])),{sizes:g=[cg(a[2],a[0]),cg(a[3],a[1])],centers:[bY(a[0],b0(g[0],am(2))),bY(a[1],b0(g[1],am(2)))]}),b=h.sizes,i=h.centers,c=a7(db(r,[1,0])),m=b0(ca(bo(b0(c[2],am(5))),b[0]),am(2)),n=bY(ca(b0(c[0],am(10)),b[0]),i[0]),o=b0(ca(bo(b0(c[3],am(5))),b[1]),am(2)),p=bY(ca(b0(c[1],am(10)),b[1]),i[1]),db(a4([cg(n,m),cg(p,o),bY(n,m),bY(p,o)]),[1,0]));e=a1(e,[d,e.shape[0]/d,4]);var s=by(cR(k,[0,0,1],[-1,-1,-1])),f=cR(s,[0,0,0],[-1,-1,1]);return f=a1(f,[d,f.shape[1]]),{boxes:a7(e),scores:a7(f)}})})},pk.prototype.forward=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,ix(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},pk.prototype.locateFaces=function(b,a){return void 0===a&&(a={}),og(this,void 0,void 0,function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;return oh(this,function(w){switch(w.label){case 0:return d=(c=new i0(a)).maxResults,e=c.minConfidence,[4,ix(b)];case 1:for(f=w.sent(),h=(g=this.forwardInput(f)).boxes,i=g.scores,j=h[0],k=i[0],l=1;l<h.length;l++)h[l].dispose(),i[l].dispose();return o=(n=Array).from,[4,k.data()];case 2:var x,y,z,C,D,A,B;return m=o.apply(n,[w.sent()]),p=(x=j,y=m,z=d,C=e,D=Math.min(z,x.shape[0]),A=y.map(function(a,b){return{score:a,boxIndex:b}}).filter(function(a){return a.score>C}).sort(function(a,b){return b.score-a.score}),B=[],A.forEach(function(a){if(!(B.length>=D)){for(var d=a.score,b=B.length-1;0<=b;--b){var c=ph(x,a.boxIndex,B[b]);if(0!==c&&(a.score*=c<=.5?1:0,a.score<=C))break}d===a.score&&B.push(a.boxIndex)}}),B),q=f.getReshapedInputDimensions(0),r=f.inputSize,s=r/q.width,t=r/q.height,u=j.arraySync(),v=p.map(function(a){var b=[Math.max(0,u[a][0]),Math.min(1,u[a][2])].map(function(a){return a*t}),c=b[0],g=b[1],d=[Math.max(0,u[a][1]),Math.min(1,u[a][3])].map(function(a){return a*s}),e=d[0],h=d[1];return new hQ(m[a],new hY(e,c,h-e,g-c),{height:f.getInputHeight(0),width:f.getInputWidth(0)})}),j.dispose(),k.dispose(),[2,v]}})})},pk.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},pk.prototype.extractParamsFromWeigthMap=function(a){return function(b){var a=[],d=function(a,b){var c=oN(a,b);function d(a,b,d){return{filters:c(a+"/Conv2d_"+b+"_pointwise/weights",4,d+"/filters"),batch_norm_offset:c(a+"/Conv2d_"+b+"_pointwise/convolution_bn_offset",1,d+"/batch_norm_offset")}}function e(e){var f="mobilenetv1/conv_"+e,a="MobilenetV1/Conv2d_"+e+"_depthwise",b=f+"/depthwise_conv";return{depthwise_conv:{filters:c(a+"/depthwise_weights",4,b+"/filters"),batch_norm_scale:c(a+"/BatchNorm/gamma",1,b+"/batch_norm_scale"),batch_norm_offset:c(a+"/BatchNorm/beta",1,b+"/batch_norm_offset"),batch_norm_mean:c(a+"/BatchNorm/moving_mean",1,b+"/batch_norm_mean"),batch_norm_variance:c(a+"/BatchNorm/moving_variance",1,b+"/batch_norm_variance")},pointwise_conv:d("MobilenetV1",e,f+"/pointwise_conv")}}function f(a,b){return{filters:c(a+"/weights",4,b+"/filters"),bias:c(a+"/biases",1,b+"/bias")}}function g(a){return{box_encoding_predictor:f("Prediction/BoxPredictor_"+a+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+a+"/box_encoding_predictor"),class_predictor:f("Prediction/BoxPredictor_"+a+"/ClassPredictor","prediction_layer/box_predictor_"+a+"/class_predictor")}}return{extractMobilenetV1Params:function(){return{conv_0:d("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:e(1),conv_2:e(2),conv_3:e(3),conv_4:e(4),conv_5:e(5),conv_6:e(6),conv_7:e(7),conv_8:e(8),conv_9:e(9),conv_10:e(10),conv_11:e(11),conv_12:e(12),conv_13:e(13)}},extractPredictionLayerParams:function(){return{conv_0:d("Prediction",0,"prediction_layer/conv_0"),conv_1:d("Prediction",1,"prediction_layer/conv_1"),conv_2:d("Prediction",2,"prediction_layer/conv_2"),conv_3:d("Prediction",3,"prediction_layer/conv_3"),conv_4:d("Prediction",4,"prediction_layer/conv_4"),conv_5:d("Prediction",5,"prediction_layer/conv_5"),conv_6:d("Prediction",6,"prediction_layer/conv_6"),conv_7:d("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:g(0),box_predictor_1:g(1),box_predictor_2:g(2),box_predictor_3:g(3),box_predictor_4:g(4),box_predictor_5:g(5)}}}}(b,a),e=d.extractMobilenetV1Params,f=d.extractPredictionLayerParams,c=b["Output/extra_dim"];if(a.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!hB(c))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+c);var g={mobilenetv1:e(),prediction_layer:f(),output_layer:{extra_dim:c}};return oH(b,a),{params:g,paramMappings:a}}(a)},pk.prototype.extractParams=function(a){return function(f){var a=[],b=oO(f),c=b.extractWeights,d=b.getRemainingWeights,e=function(a,b){function c(e,d,c,f,g){var h=aq(a(e*d*c*c),[c,c,e,d]),i=an(a(d));return b.push({paramPath:f+"/filters"},{paramPath:f+"/"+(g?"batch_norm_offset":"bias")}),{filters:h,bias:i}}function d(b,d,e,f){var a=c(b,d,e,f,!0);return{filters:a.filters,batch_norm_offset:a.bias}}function e(f,m,g){var c,e,h,i,j,k,l;return{depthwise_conv:(c=f,e=g+"/depthwise_conv",h=aq(a(9*c),[3,3,c,1]),i=an(a(c)),j=an(a(c)),k=an(a(c)),l=an(a(c)),b.push({paramPath:e+"/filters"},{paramPath:e+"/batch_norm_scale"},{paramPath:e+"/batch_norm_offset"},{paramPath:e+"/batch_norm_mean"},{paramPath:e+"/batch_norm_variance"}),{filters:h,batch_norm_scale:i,batch_norm_offset:j,batch_norm_mean:k,batch_norm_variance:l}),pointwise_conv:d(f,m,1,g+"/pointwise_conv")}}return{extractMobilenetV1Params:function(){return{conv_0:d(3,32,3,"mobilenetv1/conv_0"),conv_1:e(32,64,"mobilenetv1/conv_1"),conv_2:e(64,128,"mobilenetv1/conv_2"),conv_3:e(128,128,"mobilenetv1/conv_3"),conv_4:e(128,256,"mobilenetv1/conv_4"),conv_5:e(256,256,"mobilenetv1/conv_5"),conv_6:e(256,512,"mobilenetv1/conv_6"),conv_7:e(512,512,"mobilenetv1/conv_7"),conv_8:e(512,512,"mobilenetv1/conv_8"),conv_9:e(512,512,"mobilenetv1/conv_9"),conv_10:e(512,512,"mobilenetv1/conv_10"),conv_11:e(512,512,"mobilenetv1/conv_11"),conv_12:e(512,1024,"mobilenetv1/conv_12"),conv_13:e(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function(){return{conv_0:d(1024,256,1,"prediction_layer/conv_0"),conv_1:d(256,512,3,"prediction_layer/conv_1"),conv_2:d(512,128,1,"prediction_layer/conv_2"),conv_3:d(128,256,3,"prediction_layer/conv_3"),conv_4:d(256,128,1,"prediction_layer/conv_4"),conv_5:d(128,256,3,"prediction_layer/conv_5"),conv_6:d(256,64,1,"prediction_layer/conv_6"),conv_7:d(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:c(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:c(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:c(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:c(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:c(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:c(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:c(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:c(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:c(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:c(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:c(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:c(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}(c,a),g=e.extractMobilenetV1Params,h=e.extractPredictionLayerParams,i=g(),j=h(),k={extra_dim:ap(c(20472),[1,5118,4])};if(a.push({paramPath:"output_layer/extra_dim"}),0!==d().length)throw new Error("weights remaing after extract: "+d().length);return{params:{mobilenetv1:i,prediction_layer:j,output_layer:k},paramMappings:a}}(a)},pk);function pk(){return i1.call(this,"SsdMobilenetv1")||this}function i2(b){var a=new X;return a.extractWeights(b),a}var i3,i4=(c(pl,i3=X),pl);function pl(){return null!==i3&&i3.apply(this,arguments)||this}var o,pm=[new e(.738768,.874946),new e(2.42204,2.65704),new e(4.30971,7.04493),new e(10.246,4.59428),new e(12.6868,11.8741)],pn=[new e(1.603231,2.094468),new e(6.041143,7.080126),new e(2.882459,3.518061),new e(4.266906,5.178857),new e(9.041765,10.66308)],po=[117.001,114.697,97.404],pp=function(a){return"number"==typeof a};function i5(a){if(!a)throw new Error("invalid config: "+a);if("boolean"!=typeof a.withSeparableConvs)throw new Error("config.withSeparableConvs has to be a boolean, have: "+a.withSeparableConvs);if(!pp(a.iouThreshold)||a.iouThreshold<0||1<a.iouThreshold)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+a.iouThreshold);if(!Array.isArray(a.classes)||!a.classes.length||!a.classes.every(function(a){return"string"==typeof a}))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(a.classes));if(!Array.isArray(a.anchors)||!a.anchors.length||!a.anchors.map(function(a){return a||{}}).every(function(a){return pp(a.x)&&pp(a.y)}))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(a.anchors));if(a.meanRgb&&(!Array.isArray(a.meanRgb)||3!==a.meanRgb.length||!a.meanRgb.every(pp)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(a.meanRgb))}function pq(a){return fu(function(){var b=ca(a,am(.10000000149011612));return bY(c8(cg(a,b)),b)})}function pr(a,b){return fu(function(){var c=aU(a,[[0,0],[1,1],[1,1],[0,0]]);return c=cy(c,b.conv.filters,[1,1],"valid"),c=cg(c,b.bn.sub),c=ca(c,b.bn.truediv),pq(c=bY(c,b.conv.bias))})}function ps(a,b){return fu(function(){var c=aU(a,[[0,0],[1,1],[1,1],[0,0]]);return c=cB(c,b.depthwise_filter,b.pointwise_filter,[1,1],"valid"),pq(c=bY(c,b.bias))})}(o=b.TinyYolov2SizeType||(b.TinyYolov2SizeType={}))[o.XS=224]="XS",o[o.SM=320]="SM",o[o.MD=416]="MD",o[o.LG=608]="LG";var dR=(Object.defineProperty(pt.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(pt.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),pt);function pt(a){var b=void 0===a?{}:a,c=b.inputSize,d=b.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=c||416,this._scoreThreshold=d||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||1<=this._scoreThreshold)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}var i6,dS=(c(pu,i6=h),Object.defineProperty(pu.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(pu.prototype,"withClassScores",{get:function(){return this.config.withClassScores||1<this.config.classes.length},enumerable:!0,configurable:!0}),Object.defineProperty(pu.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),pu.prototype.runTinyYolov2=function(c,b){var a=pr(c,b.conv0);return a=pr(a=cM(a,[2,2],[2,2],"same"),b.conv1),a=pr(a=cM(a,[2,2],[2,2],"same"),b.conv2),a=pr(a=cM(a,[2,2],[2,2],"same"),b.conv3),a=pr(a=cM(a,[2,2],[2,2],"same"),b.conv4),a=pr(a=cM(a,[2,2],[2,2],"same"),b.conv5),oG(a=pr(a=pr(a=cM(a,[2,2],[1,1],"same"),b.conv6),b.conv7),b.conv8,"valid",!1)},pu.prototype.runMobilenet=function(c,b){var a=this.config.isFirstLayerConv2d?pq(oG(c,b.conv0,"valid",!1)):ps(c,b.conv0);return a=ps(a=cM(a,[2,2],[2,2],"same"),b.conv1),a=ps(a=cM(a,[2,2],[2,2],"same"),b.conv2),a=ps(a=cM(a,[2,2],[2,2],"same"),b.conv3),a=ps(a=cM(a,[2,2],[2,2],"same"),b.conv4),a=ps(a=cM(a,[2,2],[2,2],"same"),b.conv5),a=cM(a,[2,2],[1,1],"same"),a=b.conv6?ps(a,b.conv6):a,oG(a=b.conv7?ps(a,b.conv7):a,b.conv8,"valid",!1)},pu.prototype.forwardInput=function(b,c){var d=this,a=this.params;if(!a)throw new Error("TinyYolov2 - load model before inference");return fu(function(){var e=b.toBatchTensor(c,!1).toFloat();return e=(e=d.config.meanRgb?hU(e,d.config.meanRgb):e).div(am(256)),d.config.withSeparableConvs?d.runMobilenet(e,a):d.runTinyYolov2(e,a)})},pu.prototype.forward=function(a,b){return og(this,void 0,void 0,function(){var c;return oh(this,function(d){switch(d.label){case 0:return c=this.forwardInput,[4,ix(a)];case 1:return[4,c.apply(this,[d.sent(),b])];case 2:return[2,d.sent()]}})})},pu.prototype.detect=function(b,a){return void 0===a&&(a={}),og(this,void 0,void 0,function(){var c,d,e,f,g,h,i,j,k,l,m,n,o=this;return oh(this,function(p){switch(p.label){case 0:return d=(c=new dR(a)).inputSize,e=c.scoreThreshold,[4,ix(b)];case 1:return f=p.sent(),[4,this.forwardInput(f,d)];case 2:return g=p.sent(),h=fu(function(){return a7(g)[0].expandDims()}),i={width:f.getInputWidth(0),height:f.getInputHeight(0)},[4,this.extractBoxes(h,f.getReshapedInputDimensions(0),e)];case 3:return j=p.sent(),g.dispose(),h.dispose(),k=j.map(function(a){return a.box}),l=j.map(function(a){return a.score}),m=j.map(function(a){return a.classScore}),n=j.map(function(a){return o.config.classes[a.label]}),[2,hT(k.map(function(a){return a.rescale(d)}),l,this.config.iouThreshold,!0).map(function(a){return new dH(l[a],m[a],n[a],k[a],i)})]}})})},pu.prototype.getDefaultModelName=function(){return""},pu.prototype.extractParamsFromWeigthMap=function(a){return function(h,c){var d,e=[],f=function(a,b){var c=oN(a,b);function d(a){return{filters:c(a+"/filters",4),bias:c(a+"/bias",1)}}return{extractConvParams:d,extractConvWithBatchNormParams:function(a){var b;return{conv:d(a+"/conv"),bn:{sub:c((b=a+"/bn")+"/sub",1),truediv:c(b+"/truediv",1)}}},extractSeparableConvParams:oM(c)}}(h,e),g=f.extractConvParams,a=f.extractConvWithBatchNormParams,b=f.extractSeparableConvParams;if(c.withSeparableConvs){var i=c.filterSizes&&c.filterSizes.length||9;d={conv0:c.isFirstLayerConv2d?g("conv0"):b("conv0"),conv1:b("conv1"),conv2:b("conv2"),conv3:b("conv3"),conv4:b("conv4"),conv5:b("conv5"),conv6:7<i?b("conv6"):void 0,conv7:8<i?b("conv7"):void 0,conv8:g("conv8")}}else d={conv0:a("conv0"),conv1:a("conv1"),conv2:a("conv2"),conv3:a("conv3"),conv4:a("conv4"),conv5:a("conv5"),conv6:a("conv6"),conv7:a("conv7"),conv8:g("conv8")};return oH(h,e),{params:d,paramMappings:e}}(a,this.config)},pu.prototype.extractParams=function(c){var b=this.config.filterSizes||pu.DEFAULT_FILTER_SIZES,a=b?b.length:void 0;if(7!==a&&8!==a&&9!==a)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+a+" filterSizes in config");return function(y,p,q,a){var r,s,t,u,m,v=oO(y),z=v.extractWeights,w=v.getRemainingWeights,x=[],n=(t=oI(r=z,s=x),u=oL(r,s),{extractConvParams:t,extractConvWithBatchNormParams:function(g,c,d){var a,b,e,f;return{conv:t(g,c,3,d+"/conv"),bn:(a=c,b=d+"/bn",e=an(r(a)),f=an(r(a)),s.push({paramPath:b+"/sub"},{paramPath:b+"/truediv"}),{sub:e,truediv:f})}},extractSeparableConvParams:u}),o=n.extractConvParams,b=n.extractConvWithBatchNormParams,c=n.extractSeparableConvParams;if(p.withSeparableConvs){var l=a[0],e=a[1],h=a[2],i=a[3],j=a[4],k=a[5],f=a[6],d=a[7],g=a[8];m={conv0:p.isFirstLayerConv2d?o(l,e,3,"conv0"):c(l,e,"conv0"),conv1:c(e,h,"conv1"),conv2:c(h,i,"conv2"),conv3:c(i,j,"conv3"),conv4:c(j,k,"conv4"),conv5:c(k,f,"conv5"),conv6:d?c(f,d,"conv6"):void 0,conv7:g?c(d,g,"conv7"):void 0,conv8:o(g||d||f,5*q,1,"conv8")}}else l=a[0],e=a[1],h=a[2],i=a[3],j=a[4],k=a[5],f=a[6],d=a[7],g=a[8],m={conv0:b(l,e,"conv0"),conv1:b(e,h,"conv1"),conv2:b(h,i,"conv2"),conv3:b(i,j,"conv3"),conv4:b(j,k,"conv4"),conv5:b(k,f,"conv5"),conv6:b(f,d,"conv6"),conv7:b(d,g,"conv7"),conv8:o(g,5*q,1,"conv8")};if(0!==w().length)throw new Error("weights remaing after extract: "+w().length);return{params:m,paramMappings:x}}(c,this.config,this.boxEncodingSize,b)},pu.prototype.extractBoxes=function(a,b,c){return og(this,void 0,void 0,function(){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,_,A,B,C,D,E,F=this;return oh(this,function(G){switch(G.label){case 0:return d=b.width,e=b.height,f=Math.max(d,e),g=f/d,h=f/e,i=a.shape[1],j=this.config.anchors.length,k=fu(function(){var b=a.reshape([i,i,j,F.boxEncodingSize]);return[b.slice([0,0,0,0],[i,i,j,4]),b.slice([0,0,0,4],[i,i,j,1]),F.withClassScores?a8(b.slice([0,0,0,5],[i,i,j,F.config.classes.length]),3):am(0)]}),l=k[0],m=k[1],n=k[2],o=[],[4,m.array()];case 1:return p=G.sent(),[4,l.array()];case 2:q=G.sent(),r=0,G.label=3;case 3:if(!(r<i))return[3,12];s=0,G.label=4;case 4:if(!(s<i))return[3,11];t=0,G.label=5;case 5:return t<j?(u=hW(p[r][s][t][0]),!c||c<u?(v=(s+hW(q[r][s][t][0]))/i*g,w=(r+hW(q[r][s][t][1]))/i*h,x=Math.exp(q[r][s][t][2])*this.config.anchors[t].x/i*g,y=Math.exp(q[r][s][t][3])*this.config.anchors[t].y/i*h,z=v-x/2,_=w-y/2,A={row:r,col:s,anchor:t},this.withClassScores?[4,this.extractPredictedClass(n,A)]:[3,7]):[3,9]):[3,10];case 6:return E=G.sent(),[3,8];case 7:E={classScore:1,label:0},G.label=8;case 8:C=(B=E).classScore,D=B.label,o.push(of({box:new hO(z,_,z+x,_+y),score:u,classScore:u*C,label:D},A)),G.label=9;case 9:return t++,[3,5];case 10:return s++,[3,4];case 11:return r++,[3,3];case 12:return l.dispose(),m.dispose(),n.dispose(),[2,o]}})})},pu.prototype.extractPredictedClass=function(a,b){return og(this,void 0,void 0,function(){var c,d,e,f;return oh(this,function(g){switch(g.label){case 0:return c=b.row,d=b.col,e=b.anchor,[4,a.array()];case 1:return f=g.sent(),[2,Array(this.config.classes.length).fill(0).map(function(b,a){return f[c][d][e][a]}).map(function(a,b){return{classScore:a,label:b}}).reduce(function(a,b){return a.classScore>b.classScore?a:b})]}})})},pu.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],pu);function pu(a){var b=i6.call(this,"TinyYolov2")||this;return i5(a),b._config=a,b}var i7,dT=(c(pv,i7=dS),Object.defineProperty(pv.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(pv.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),pv.prototype.locateFaces=function(a,b){return og(this,void 0,void 0,function(){return oh(this,function(c){switch(c.label){case 0:return[4,this.detect(a,b)];case 1:return[2,c.sent().map(function(a){return new hQ(a.score,a.relativeBox,{width:a.imageWidth,height:a.imageHeight})})]}})})},pv.prototype.getDefaultModelName=function(){return this.withSeparableConvs?"tiny_yolov2_separable_conv_model":"tiny_yolov2_model"},pv.prototype.extractParamsFromWeigthMap=function(a){return i7.prototype.extractParamsFromWeigthMap.call(this,a)},pv);function pv(a){void 0===a&&(a=!0);var b=Object.assign({},{withSeparableConvs:a,iouThreshold:.4,classes:["face"]},a?{anchors:pn,meanRgb:po}:{anchors:pm,withClassScores:!0});return i7.call(this,b)||this}var i8,i9=(c(pw,i8=dR),pw);function pw(){var a=null!==i8&&i8.apply(this,arguments)||this;return a._name="TinyFaceDetectorOptions",a}var v=(px.prototype.then=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=a,[4,this.run()];case 1:return[2,b.apply(void 0,[c.sent()])]}})})},px.prototype.run=function(){return og(this,void 0,void 0,function(){return oh(this,function(a){throw new Error("ComposableTask - run is not implemented")})})},px);function px(){}function py(b,c,d,e,a){return void 0===a&&(a=function(a){return a.alignedRect}),og(this,void 0,void 0,function(){var f,g,h,i,j;return oh(this,function(k){switch(k.label){case 0:return f=b.map(function(b){return iK(b)?a(b):b.detection}),(h=e)?[3,5]:c instanceof E?[4,iz(c,f)]:[3,2];case 1:return i=k.sent(),[3,4];case 2:return[4,iy(c,f)];case 3:i=k.sent(),k.label=4;case 4:h=i,k.label=5;case 5:return[4,d(g=h)];case 6:return j=k.sent(),g.forEach(function(a){return a instanceof E&&a.dispose()}),[2,j]}})})}function pz(a,b,c,d,e){return og(this,void 0,void 0,function(){var f=this;return oh(this,function(g){return[2,py([a],b,function(a){return og(f,void 0,void 0,function(){return oh(this,function(b){return[2,c(a[0])]})})},d,e)]})})}var pA=12;function pB(a,b){var c=b[0],d=b[1];return{height:Math.floor(c*a),width:Math.floor(d*a)}}var ja,pC=(c(pD,ja=w),pD);function pD(a,b,c,d){return ja.call(this,{left:a,top:b,right:c,bottom:d},!0)||this}function pE(a){return fu(function(){return ca(cg(a,am(127.5)),am(.0078125))})}function pF(a,b){return fu(function(){return bY(c8(a),ca(b,bu(c8(bu(a)))))})}function pG(b,c,a){return void 0===a&&(a=!1),fu(function(){var d=oG(b,c.conv1,"valid");return d=pF(d,c.prelu1_alpha),d=pF(d=oG(d=cM(d,a?[2,2]:[3,3],[2,2],"same"),c.conv2,"valid"),c.prelu2_alpha),d=pF(d=oG(d=a?d:cM(d,[3,3],[2,2],"valid"),c.conv3,"valid"),c.prelu3_alpha)})}function pH(b,c,a){var d=a.width,e=a.height;return og(this,void 0,void 0,function(){var a,f,g,h=this;return oh(this,function(i){switch(i.label){case 0:return a=ih(b),[4,Promise.all(c.map(function(c){return og(h,void 0,void 0,function(){var d,e,f,g,h,i,j,k;return oh(this,function(l){return e=(d=c.padAtBorders(b.height,b.width)).y,f=d.ey,g=d.x,h=d.ex,i=g-1,j=e-1,k=a.getImageData(i,j,h-i,f-j),[2,ie.isNodejs()?is(k):createImageBitmap(k)]})})}))];case 1:return f=i.sent(),g=[],f.forEach(function(h){var f=ih(ir({width:d,height:e}));f.drawImage(h,0,0,d,e);for(var b=f.getImageData(0,0,d,e).data,c=[],a=0;a<b.length;a+=4)c.push(b[a+2]),c.push(b[a+1]),c.push(b[a]);g.push(c)}),[2,g.map(function(a){return fu(function(){return pE(db(aq(a,[1,d,e,3]),[0,2,1,3]).toFloat())})})]}})})}var jb,dU=(c(pI,jb=h),pI.prototype.load=function(a){return og(this,void 0,void 0,function(){return oh(this,function(b){return console.warn("mtcnn is deprecated and will be removed soon"),[2,jb.prototype.load.call(this,a)]})})},pI.prototype.loadFromDisk=function(a){return og(this,void 0,void 0,function(){return oh(this,function(b){return console.warn("mtcnn is deprecated and will be removed soon"),[2,jb.prototype.loadFromDisk.call(this,a)]})})},pI.prototype.forwardInput=function(b,a){return void 0===a&&(a={}),og(this,void 0,void 0,function(){var c,d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;return oh(this,function(y){switch(y.label){case 0:if(!(c=this.params))throw new Error("Mtcnn - load model before inference");if(!(d=b.canvases[0]))throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return f={},g=Date.now(),h=fu(function(){var a;return a=aQ(hh.fromPixels(d)).toFloat(),fu(function(){return a4(a7(a,3).reverse(),3)})}),i=function(a){return h.dispose(),f.total=Date.now()-g,a},k=(j=h.shape.slice(1))[0],l=j[1],m=new i_(a),n=m.minFaceSize,o=m.scaleFactor,p=m.maxNumScales,q=m.scoreThresholds,r=m.scaleSteps,s=(r||function(g,a,b){for(var h=b[0],i=b[1],c=pA/g,d=[],e=Math.min(h,i)*c,f=0;12<=e;)d.push(c*Math.pow(a,f)),e*=a,f+=1;return d}(n,o,[k,l])).filter(function(b){var a=pB(b,[k,l]);return Math.min(a.width,a.height)>pA}).slice(0,p),f.scales=s,f.pyramid=s.map(function(a){return pB(a,[k,l])}),t=Date.now(),[4,function(i,g,j,k,b){b.stage1=[];var a=g.map(function(a){return fu(function(){var d,e,f,g,b={scale:a},h=(d=i,e=a,fu(function(){var a=pB(e,d.shape.slice(1)),b=a.height,c=a.width,f=pE(du.resizeBilinear(d,[b,c]));return db(f,[0,2,1,3])})),j=Date.now(),c=(f=h,g=k,fu(function(){var a=pG(f,g,!0),b=oG(a,g.conv4_1,"valid"),c=aQ(c_(b,3),3);return{prob:a8(cg(b,c),3),regions:oG(a,g.conv4_2,"valid")}})),l=c.prob,m=c.regions;return b.pnet=Date.now()-j,{scoresTensor:a7(a7(l,3)[1])[0],regionsTensor:a7(m)[0],scale:a,statsForScale:b}})}).map(function(a){var f=a.scoresTensor,g=a.regionsTensor,i=a.scale,c=a.statsForScale,d=function(c,h,i,f){for(var d=[],g=c.arraySync(),a=0;a<c.shape[0];a++)for(var b=0;b<c.shape[1];b++)g[a][b]>=f&&d.push(new e(b,a));return d.map(function(a){var c=new hO(Math.round((2*a.y+1)/i),Math.round((2*a.x+1)/i),Math.round((2*a.y+pA)/i),Math.round((2*a.x+pA)/i)),d=g[a.y][a.x],b=h.arraySync();return{cell:c,score:d,region:new pC(b[a.y][a.x][0],b[a.y][a.x][1],b[a.y][a.x][2],b[a.y][a.x][3])}})}(f,g,i,j);if(f.dispose(),g.dispose(),!d.length)return b.stage1.push(c),[];var k=Date.now(),h=hT(d.map(function(a){return a.cell}),d.map(function(a){return a.score}),.5);return c.nms=Date.now()-k,c.numBoxes=h.length,b.stage1.push(c),h.map(function(a){return d[a]})}).reduce(function(a,b){return a.concat(b)},[]),c=[],d=[];if(0<a.length){var h=Date.now(),f=hT(a.map(function(a){return a.cell}),a.map(function(a){return a.score}),.7);b.stage1_nms=Date.now()-h,d=f.map(function(b){return a[b].score}),c=f.map(function(b){return a[b]}).map(function(c){var a=c.cell,b=c.region;return new hO(a.left+b.left*a.width,a.top+b.top*a.height,a.right+b.right*a.width,a.bottom+b.bottom*a.height).toSquare().round()})}return{boxes:c,scores:d}}(h,s,q[0],c.pnet,f)];case 1:return u=y.sent(),f.total_stage1=Date.now()-t,u.boxes.length?(f.stage2_numInputBoxes=u.boxes.length,t=Date.now(),[4,function(a,b,c,d,e){return og(this,void 0,void 0,function(){var f,g,h,i,j,k,l,m,n,o,p,q,r,s;return oh(this,function(t){switch(t.label){case 0:return f=Date.now(),[4,pH(a,b,{width:24,height:24})];case 1:return g=t.sent(),e.stage2_extractImagePatches=Date.now()-f,f=Date.now(),h=g.map(function(a){var b,c,e=(b=a,c=d,fu(function(){var a=pG(b,c),d=pF(oU(a1(a,[a.shape[0],c.fc1.weights.shape[0]]),c.fc1),c.prelu4_alpha),e=oU(d,c.fc2_1),f=aQ(c_(e,1),1),g=a8(cg(e,f),1),h=oU(d,c.fc2_2);return{scores:a7(g,1)[1],regions:h}}));return a.dispose(),e}),e.stage2_rnet=Date.now()-f,i=1<h.length?aB(h.map(function(a){return a.scores})):h[0].scores,l=(k=Array).from,[4,i.data()];case 2:return j=l.apply(k,[t.sent()]),i.dispose(),n=(m=j.map(function(a,b){return{score:a,idx:b}}).filter(function(a){return a.score>c}).map(function(a){return a.idx})).map(function(a){return b[a]}),o=m.map(function(a){return j[a]}),p=[],q=[],0<n.length&&(f=Date.now(),r=hT(n,o,.7),e.stage2_nms=Date.now()-f,s=r.map(function(b){var a=h[m[b]].regions.arraySync();return new pC(a[0][0],a[0][1],a[0][2],a[0][3])}),q=r.map(function(a){return o[a]}),p=r.map(function(a,b){return n[a].calibrate(s[b])})),h.forEach(function(a){a.regions.dispose(),a.scores.dispose()}),[2,{boxes:p,scores:q}]}})})}(d,u.boxes,q[1],c.rnet,f)]):[2,i({results:[],stats:f})];case 2:return v=y.sent(),f.total_stage2=Date.now()-t,v.boxes.length?(f.stage3_numInputBoxes=v.boxes.length,t=Date.now(),[4,function(a,b,c,d,f){return og(this,void 0,void 0,function(){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;return oh(this,function(v){switch(v.label){case 0:return g=Date.now(),[4,pH(a,b,{width:48,height:48})];case 1:return h=v.sent(),f.stage3_extractImagePatches=Date.now()-g,g=Date.now(),i=h.map(function(a){var b,c,e=(b=a,c=d,fu(function(){var a=pG(b,c);a=pF(a=oG(a=cM(a,[2,2],[2,2],"same"),c.conv4,"valid"),c.prelu4_alpha);var d=pF(oU(a1(a,[a.shape[0],c.fc1.weights.shape[0]]),c.fc1),c.prelu5_alpha),e=oU(d,c.fc2_1),f=aQ(c_(e,1),1),g=a8(cg(e,f),1),h=oU(d,c.fc2_2),i=oU(d,c.fc2_3);return{scores:a7(g,1)[1],regions:h,points:i}}));return a.dispose(),e}),f.stage3_onet=Date.now()-g,j=1<i.length?aB(i.map(function(a){return a.scores})):i[0].scores,m=(l=Array).from,[4,j.data()];case 2:return k=m.apply(l,[v.sent()]),j.dispose(),o=(n=k.map(function(a,b){return{score:a,idx:b}}).filter(function(a){return a.score>c}).map(function(a){return a.idx})).map(function(b){var a=i[b].regions.arraySync();return new pC(a[0][0],a[0][1],a[0][2],a[0][3])}),p=n.map(function(a,c){return b[a].calibrate(o[c])}),q=n.map(function(a){return k[a]}),r=[],s=[],t=[],0<p.length&&(g=Date.now(),u=hT(p,q,.7,!1),f.stage3_nms=Date.now()-g,r=u.map(function(a){return p[a]}),s=u.map(function(a){return q[a]}),t=u.map(function(a,b){return Array(5).fill(0).map(function(f,c){var d=i[a].points.arraySync();return new e(d[0][c]*(r[b].width+1)+r[b].left,d[0][c+5]*(r[b].height+1)+r[b].top)})})),i.forEach(function(a){a.regions.dispose(),a.scores.dispose(),a.points.dispose()}),[2,{boxes:r,scores:s,points:t}]}})})}(d,v.boxes,q[2],c.onet,f)]):[2,i({results:[],stats:f})];case 3:return w=y.sent(),f.total_stage3=Date.now()-t,x=w.boxes.map(function(a,b){return iL(h7({},new hQ(w.scores[b],new hY(a.left/l,a.top/k,a.width/l,a.height/k),{height:k,width:l})),new h$(w.points[b].map(function(b){return b.sub(new e(a.left,a.top)).div(new e(a.width,a.height))}),{width:a.width,height:a.height}))}),[2,i({results:x,stats:f})]}})})},pI.prototype.forward=function(b,a){return void 0===a&&(a={}),og(this,void 0,void 0,function(){var c;return oh(this,function(d){switch(d.label){case 0:return c=this.forwardInput,[4,ix(b)];case 1:return[4,c.apply(this,[d.sent(),a])];case 2:return[2,d.sent().results]}})})},pI.prototype.forwardWithStats=function(b,a){return void 0===a&&(a={}),og(this,void 0,void 0,function(){var c;return oh(this,function(d){switch(d.label){case 0:return c=this.forwardInput,[4,ix(b)];case 1:return[2,c.apply(this,[d.sent(),a])]}})})},pI.prototype.getDefaultModelName=function(){return"mtcnn_model"},pI.prototype.extractParamsFromWeigthMap=function(j){var c,a,b,d,e,f,g,h,i;return a=[],d=(b=function(a,b){var c=oN(a,b);function d(a){return{filters:c(a+"/weights",4,a+"/filters"),bias:c(a+"/bias",1)}}function e(a){return{weights:c(a+"/weights",2),bias:c(a+"/bias",1)}}function f(a){return c(a,1)}function g(a){return{conv1:d(a+"/conv1"),prelu1_alpha:f(a+"/prelu1_alpha"),conv2:d(a+"/conv2"),prelu2_alpha:f(a+"/prelu2_alpha"),conv3:d(a+"/conv3"),prelu3_alpha:f(a+"/prelu3_alpha")}}return{extractPNetParams:function(){var a=g("pnet"),b=d("pnet/conv4_1"),c=d("pnet/conv4_2");return of(of({},a),{conv4_1:b,conv4_2:c})},extractRNetParams:function(){var a=g("rnet"),b=e("rnet/fc1"),c=f("rnet/prelu4_alpha"),d=e("rnet/fc2_1"),h=e("rnet/fc2_2");return of(of({},a),{fc1:b,prelu4_alpha:c,fc2_1:d,fc2_2:h})},extractONetParams:function(){var a=g("onet"),b=d("onet/conv4"),c=f("onet/prelu4_alpha"),h=e("onet/fc1"),i=f("onet/prelu5_alpha"),j=e("onet/fc2_1"),k=e("onet/fc2_2"),l=e("onet/fc2_3");return of(of({},a),{conv4:b,prelu4_alpha:c,fc1:h,prelu5_alpha:i,fc2_1:j,fc2_2:k,fc2_3:l})}}}(c=j,a)).extractPNetParams,e=b.extractRNetParams,f=b.extractONetParams,g=d(),h=e(),i=f(),oH(c,a),{params:{pnet:g,rnet:h,onet:i},paramMappings:a}},pI.prototype.extractParams=function(a){return function(e){var b=oO(e),f=b.extractWeights,c=b.getRemainingWeights,d=[],a=function(a,b){var c=oI(a,b),d=oJ(a,b);function e(c,d){var e=an(a(c));return b.push({paramPath:d}),e}function f(a,b,d){return void 0===d&&(d=!1),{conv1:c(a[0],a[1],3,b+"/conv1"),prelu1_alpha:e(a[1],b+"/prelu1_alpha"),conv2:c(a[1],a[2],3,b+"/conv2"),prelu2_alpha:e(a[2],b+"/prelu2_alpha"),conv3:c(a[2],a[3],d?2:3,b+"/conv3"),prelu3_alpha:e(a[3],b+"/prelu3_alpha")}}return{extractPNetParams:function(){var a=f([3,10,16,32],"pnet"),b=c(32,2,1,"pnet/conv4_1"),d=c(32,4,1,"pnet/conv4_2");return of(of({},a),{conv4_1:b,conv4_2:d})},extractRNetParams:function(){var a=f([3,28,48,64],"rnet",!0),b=d(576,128,"rnet/fc1"),c=e(128,"rnet/prelu4_alpha"),g=d(128,2,"rnet/fc2_1"),h=d(128,4,"rnet/fc2_2");return of(of({},a),{fc1:b,prelu4_alpha:c,fc2_1:g,fc2_2:h})},extractONetParams:function(){var a=f([3,32,64,64],"onet"),b=c(64,128,2,"onet/conv4"),g=e(128,"onet/prelu4_alpha"),h=d(1152,256,"onet/fc1"),i=e(256,"onet/prelu5_alpha"),j=d(256,2,"onet/fc2_1"),k=d(256,4,"onet/fc2_2"),l=d(256,10,"onet/fc2_3");return of(of({},a),{conv4:b,prelu4_alpha:g,fc1:h,prelu5_alpha:i,fc2_1:j,fc2_2:k,fc2_3:l})}}}(f,d),g=a.extractPNetParams,h=a.extractRNetParams,i=a.extractONetParams,j=g(),k=h(),l=i();if(0!==c().length)throw new Error("weights remaing after extract: "+c().length);return{params:{pnet:j,rnet:k,onet:l},paramMappings:d}}(a)},pI);function pI(){return jb.call(this,"Mtcnn")||this}var jc,pJ=[new e(1.603231,2.094468),new e(6.041143,7.080126),new e(2.882459,3.518061),new e(4.266906,5.178857),new e(9.041765,10.66308)],pK=[117.001,114.697,97.404],dV=(c(pL,jc=dS),Object.defineProperty(pL.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),pL.prototype.locateFaces=function(a,b){return og(this,void 0,void 0,function(){return oh(this,function(c){switch(c.label){case 0:return[4,this.detect(a,b)];case 1:return[2,c.sent().map(function(a){return new hQ(a.score,a.relativeBox,{width:a.imageWidth,height:a.imageHeight})})]}})})},pL.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},pL.prototype.extractParamsFromWeigthMap=function(a){return jc.prototype.extractParamsFromWeigthMap.call(this,a)},pL);function pL(){return jc.call(this,{withSeparableConvs:!0,iouThreshold:.4,classes:["face"],anchors:pJ,meanRgb:pK,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]})||this}function dW(a,b){return je.ssdMobilenetv1.locateFaces(a,b)}function dX(a){return je.faceLandmark68Net.detectLandmarks(a)}function dY(a){return je.ssdMobilenetv1.load(a)}var jd,je={ssdMobilenetv1:new X,tinyFaceDetector:new dV,tinyYolov2:new dT,mtcnn:new dU,faceLandmark68Net:new W,faceLandmark68TinyNet:new dP,faceRecognitionNet:new dQ,faceExpressionNet:new dL,ageGenderNet:new dN},dZ=(c(pM,jd=v),pM);function pM(b,c,d){var a=jd.call(this)||this;return a.parentTask=b,a.input=c,a.extractedFaces=d,a}var jf,jg=(c(pN,jf=dZ),pN.prototype.run=function(){return og(this,void 0,void 0,function(){var a,b,c=this;return oh(this,function(d){switch(d.label){case 0:return[4,this.parentTask];case 1:return[4,py(a=d.sent(),this.input,function(a){return og(c,void 0,void 0,function(){return oh(this,function(b){switch(b.label){case 0:return[4,Promise.all(a.map(function(a){return je.faceExpressionNet.predictExpressions(a)}))];case 1:return[2,b.sent()]}})})},this.extractedFaces)];case 2:return b=d.sent(),[2,a.map(function(a,c){return iJ(a,b[c])})]}})})},pN.prototype.withAgeAndGender=function(){return new jn(this,this.input)},pN);function pN(){return null!==jf&&jf.apply(this,arguments)||this}var jh,ji=(c(pO,jh=dZ),pO.prototype.run=function(){return og(this,void 0,void 0,function(){var a,b;return oh(this,function(c){switch(c.label){case 0:return[4,this.parentTask];case 1:return(a=c.sent())?[4,pz(a,this.input,function(a){return je.faceExpressionNet.predictExpressions(a)},this.extractedFaces)]:[2];case 2:return[2,iJ(a,b=c.sent())]}})})},pO.prototype.withAgeAndGender=function(){return new jp(this,this.input)},pO);function pO(){return null!==jh&&jh.apply(this,arguments)||this}var jj,pP=(c(pQ,jj=jg),pQ.prototype.withAgeAndGender=function(){return new pW(this,this.input)},pQ.prototype.withFaceDescriptors=function(){return new ju(this,this.input)},pQ);function pQ(){return null!==jj&&jj.apply(this,arguments)||this}var jk,pR=(c(pS,jk=ji),pS.prototype.withAgeAndGender=function(){return new pY(this,this.input)},pS.prototype.withFaceDescriptor=function(){return new jw(this,this.input)},pS);function pS(){return null!==jk&&jk.apply(this,arguments)||this}var jl,d$=(c(pT,jl=v),pT);function pT(b,c,d){var a=jl.call(this)||this;return a.parentTask=b,a.input=c,a.extractedFaces=d,a}var jm,jn=(c(pU,jm=d$),pU.prototype.run=function(){return og(this,void 0,void 0,function(){var a,b,c=this;return oh(this,function(d){switch(d.label){case 0:return[4,this.parentTask];case 1:return[4,py(a=d.sent(),this.input,function(a){return og(c,void 0,void 0,function(){return oh(this,function(b){switch(b.label){case 0:return[4,Promise.all(a.map(function(a){return je.ageGenderNet.predictAgeAndGender(a)}))];case 1:return[2,b.sent()]}})})},this.extractedFaces)];case 2:return b=d.sent(),[2,a.map(function(c,d){var a=b[d],e=a.age;return iZ(i$(c,a.gender,a.genderProbability),e)})]}})})},pU.prototype.withFaceExpressions=function(){return new jg(this,this.input)},pU);function pU(){return null!==jm&&jm.apply(this,arguments)||this}var jo,jp=(c(pV,jo=d$),pV.prototype.run=function(){return og(this,void 0,void 0,function(){var a,b,c,d,e;return oh(this,function(f){switch(f.label){case 0:return[4,this.parentTask];case 1:return(a=f.sent())?[4,pz(a,this.input,function(a){return je.ageGenderNet.predictAgeAndGender(a)},this.extractedFaces)]:[2];case 2:return c=(b=f.sent()).age,d=b.gender,e=b.genderProbability,[2,iZ(i$(a,d,e),c)]}})})},pV.prototype.withFaceExpressions=function(){return new ji(this,this.input)},pV);function pV(){return null!==jo&&jo.apply(this,arguments)||this}var jq,pW=(c(pX,jq=jn),pX.prototype.withFaceExpressions=function(){return new pP(this,this.input)},pX.prototype.withFaceDescriptors=function(){return new ju(this,this.input)},pX);function pX(){return null!==jq&&jq.apply(this,arguments)||this}var jr,pY=(c(pZ,jr=jp),pZ.prototype.withFaceExpressions=function(){return new pR(this,this.input)},pZ.prototype.withFaceDescriptor=function(){return new jw(this,this.input)},pZ);function pZ(){return null!==jr&&jr.apply(this,arguments)||this}var js,Y=(c(p$,js=v),p$);function p$(b,c){var a=js.call(this)||this;return a.parentTask=b,a.input=c,a}var jt,ju=(c(p_,jt=Y),p_.prototype.run=function(){return og(this,void 0,void 0,function(){var a;return oh(this,function(b){switch(b.label){case 0:return[4,this.parentTask];case 1:return[4,py(a=b.sent(),this.input,function(a){return Promise.all(a.map(function(a){return je.faceRecognitionNet.computeFaceDescriptor(a)}))},null,function(a){return a.landmarks.align(null,{useDlibAlignment:!0})})];case 2:return[2,b.sent().map(function(b,c){return iY(a[c],b)})]}})})},p_.prototype.withFaceExpressions=function(){return new pP(this,this.input)},p_.prototype.withAgeAndGender=function(){return new pW(this,this.input)},p_);function p_(){return null!==jt&&jt.apply(this,arguments)||this}var jv,jw=(c(p0,jv=Y),p0.prototype.run=function(){return og(this,void 0,void 0,function(){var a,b;return oh(this,function(c){switch(c.label){case 0:return[4,this.parentTask];case 1:return(a=c.sent())?[4,pz(a,this.input,function(a){return je.faceRecognitionNet.computeFaceDescriptor(a)},null,function(a){return a.landmarks.align(null,{useDlibAlignment:!0})})]:[2];case 2:return[2,iY(a,b=c.sent())]}})})},p0.prototype.withFaceExpressions=function(){return new pR(this,this.input)},p0.prototype.withAgeAndGender=function(){return new pY(this,this.input)},p0);function p0(){return null!==jv&&jv.apply(this,arguments)||this}var jx,Z=(c(p1,jx=v),Object.defineProperty(p1.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?je.faceLandmark68TinyNet:je.faceLandmark68Net},enumerable:!0,configurable:!0}),p1);function p1(b,c,d){var a=jx.call(this)||this;return a.parentTask=b,a.input=c,a.useTinyLandmarkNet=d,a}var jy,jz=(c(p2,jy=Z),p2.prototype.run=function(){return og(this,void 0,void 0,function(){var a,b,c,d,e,f=this;return oh(this,function(g){switch(g.label){case 0:return[4,this.parentTask];case 1:return b=(a=g.sent()).map(function(a){return a.detection}),this.input instanceof E?[4,iz(this.input,b)]:[3,3];case 2:return d=g.sent(),[3,5];case 3:return[4,iy(this.input,b)];case 4:d=g.sent(),g.label=5;case 5:return c=d,[4,Promise.all(c.map(function(a){return f.landmarkNet.detectLandmarks(a)}))];case 6:return e=g.sent(),c.forEach(function(a){return a instanceof E&&a.dispose()}),[2,a.map(function(a,b){return iL(a,e[b])})]}})})},p2.prototype.withFaceExpressions=function(){return new pP(this,this.input)},p2.prototype.withAgeAndGender=function(){return new pW(this,this.input)},p2.prototype.withFaceDescriptors=function(){return new ju(this,this.input)},p2);function p2(){return null!==jy&&jy.apply(this,arguments)||this}var jA,jB=(c(p3,jA=Z),p3.prototype.run=function(){return og(this,void 0,void 0,function(){var a,b,c,d,e;return oh(this,function(f){switch(f.label){case 0:return[4,this.parentTask];case 1:return(a=f.sent())?(b=a.detection,this.input instanceof E?[4,iz(this.input,[b])]:[3,3]):[2];case 2:return d=f.sent(),[3,5];case 3:return[4,iy(this.input,[b])];case 4:d=f.sent(),f.label=5;case 5:return c=d,[4,this.landmarkNet.detectLandmarks(c[0])];case 6:return e=f.sent(),c.forEach(function(a){return a instanceof E&&a.dispose()}),[2,iL(a,e)]}})})},p3.prototype.withFaceExpressions=function(){return new pR(this,this.input)},p3.prototype.withAgeAndGender=function(){return new pY(this,this.input)},p3.prototype.withFaceDescriptor=function(){return new jw(this,this.input)},p3);function p3(){return null!==jA&&jA.apply(this,arguments)||this}var jC,aa=(c(p4,jC=v),p4);function p4(c,a){void 0===a&&(a=new i0);var b=jC.call(this)||this;return b.input=c,b.options=a,b}var jD,jE=(c(p5,jD=aa),p5.prototype.run=function(){return og(this,void 0,void 0,function(){var a,b,c,d;return oh(this,function(e){switch(e.label){case 0:return b=(a=this).input,(c=a.options)instanceof i_?[4,je.mtcnn.forward(b,c)]:[3,2];case 1:return[2,e.sent().map(function(a){return a.detection})];case 2:if(!(d=c instanceof i9?function(a){return je.tinyFaceDetector.locateFaces(a,c)}:c instanceof i0?function(a){return je.ssdMobilenetv1.locateFaces(a,c)}:c instanceof dR?function(a){return je.tinyYolov2.locateFaces(a,c)}:null))throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,d(b)]}})})},p5.prototype.runAndExtendWithFaceDetections=function(){var a=this;return new Promise(function(b){return og(a,void 0,void 0,function(){var a;return oh(this,function(c){switch(c.label){case 0:return[4,this.run()];case 1:return[2,b((a=c.sent()).map(function(a){return h7({},a)}))]}})})})},p5.prototype.withFaceLandmarks=function(a){return void 0===a&&(a=!1),new jz(this.runAndExtendWithFaceDetections(),this.input,a)},p5.prototype.withFaceExpressions=function(){return new jg(this.runAndExtendWithFaceDetections(),this.input)},p5.prototype.withAgeAndGender=function(){return new jn(this.runAndExtendWithFaceDetections(),this.input)},p5);function p5(){return null!==jD&&jD.apply(this,arguments)||this}var jF,jG=(c(p6,jF=aa),p6.prototype.run=function(){return og(this,void 0,void 0,function(){var a,b;return oh(this,function(c){switch(c.label){case 0:return[4,new jE(this.input,this.options)];case 1:return b=(a=c.sent())[0],a.forEach(function(a){a.score>b.score&&(b=a)}),[2,b]}})})},p6.prototype.runAndExtendWithFaceDetection=function(){var a=this;return new Promise(function(b){return og(a,void 0,void 0,function(){var a;return oh(this,function(c){switch(c.label){case 0:return[4,this.run()];case 1:return[2,b((a=c.sent())?h7({},a):void 0)]}})})})},p6.prototype.withFaceLandmarks=function(a){return void 0===a&&(a=!1),new jB(this.runAndExtendWithFaceDetection(),this.input,a)},p6.prototype.withFaceExpressions=function(){return new ji(this.runAndExtendWithFaceDetection(),this.input)},p6.prototype.withAgeAndGender=function(){return new jp(this.runAndExtendWithFaceDetection(),this.input)},p6);function p6(){return null!==jF&&jF.apply(this,arguments)||this}function jH(b,a){return void 0===a&&(a=new i0),new jE(b,a)}function d_(a,b){return og(this,void 0,void 0,function(){return oh(this,function(c){switch(c.label){case 0:return console.warn("allFacesSsdMobilenetv1 is deprecated and will be removed soon, use the high level api instead"),[4,jH(a,new i0(b?{minConfidence:b}:{})).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,c.sent()]}})})}function jI(a,b){if(a.length!==b.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var c=Array.from(a),d=Array.from(b);return Math.sqrt(c.map(function(a,b){return a-d[b]}).reduce(function(a,b){return a+Math.pow(b,2)},0))}var jJ=(Object.defineProperty(p7.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(p7.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),p7.prototype.computeMeanDistance=function(b,a){return a.map(function(a){return jI(a,b)}).reduce(function(a,b){return a+b},0)/(a.length||1)},p7.prototype.matchDescriptor=function(a){var b=this;return this.labeledDescriptors.map(function(c){var d=c.descriptors,e=c.label;return new h1(e,b.computeMeanDistance(a,d))}).reduce(function(a,b){return a.distance<b.distance?a:b})},p7.prototype.findBestMatch=function(b){var a=this.matchDescriptor(b);return a.distance<this.distanceThreshold?a:new h1("unknown",a.distance)},p7.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(function(a){return a.toJSON()})}},p7.fromJSON=function(a){return new p7(a.labeledDescriptors.map(function(a){return h3.fromJSON(a)}),a.distanceThreshold)},p7);function p7(a,b){void 0===b&&(b=.6),this._distanceThreshold=b;var c=Array.isArray(a)?a:[a];if(!c.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");function d(){return"person "+e++}var e=1;this._labeledDescriptors=c.map(function(a){if(a instanceof h3)return a;if(a instanceof Float32Array)return new h3(d(),[a]);if(a.descriptor&&a.descriptor instanceof Float32Array)return new h3(d(),[a.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}b.AgeGenderNet=dN,b.BoundingBox=hO,b.Box=w,b.ComposableTask=v,b.ComputeAllFaceDescriptorsTask=ju,b.ComputeFaceDescriptorsTaskBase=Y,b.ComputeSingleFaceDescriptorTask=jw,b.DetectAllFaceLandmarksTask=jz,b.DetectAllFacesTask=jE,b.DetectFaceLandmarksTaskBase=Z,b.DetectFacesTaskBase=aa,b.DetectSingleFaceLandmarksTask=jB,b.DetectSingleFaceTask=jG,b.Dimensions=hy,b.FACE_EXPRESSION_LABELS=iF,b.FaceDetection=hQ,b.FaceDetectionNet=i4,b.FaceExpressionNet=dL,b.FaceExpressions=iG,b.FaceLandmark68Net=W,b.FaceLandmark68TinyNet=dP,b.FaceLandmarkNet=iW,b.FaceLandmarks=U,b.FaceLandmarks5=h$,b.FaceLandmarks68=h0,b.FaceMatch=h1,b.FaceMatcher=jJ,b.FaceRecognitionNet=dQ,b.LabeledBox=dI,b.LabeledFaceDescriptors=h3,b.Mtcnn=dU,b.MtcnnOptions=i_,b.NetInput=iw,b.NeuralNetwork=h,b.ObjectDetection=dH,b.Point=e,b.PredictedBox=h5,b.Rect=hY,b.SsdMobilenetv1=X,b.SsdMobilenetv1Options=i0,b.TinyFaceDetector=dV,b.TinyFaceDetectorOptions=i9,b.TinyYolov2=dT,b.TinyYolov2Options=dR,b.allFaces=d_,b.allFacesMtcnn=function(b,a){return void 0===a&&(a={}),og(this,void 0,void 0,function(){return oh(this,function(c){switch(c.label){case 0:return console.warn("allFacesMtcnn is deprecated and will be removed soon, use the high level api instead"),[4,jH(b,new i_(a)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,c.sent()]}})})},b.allFacesSsdMobilenetv1=d_,b.allFacesTinyYolov2=function(b,a){return void 0===a&&(a={}),og(this,void 0,void 0,function(){return oh(this,function(c){switch(c.label){case 0:return console.warn("allFacesTinyYolov2 is deprecated and will be removed soon, use the high level api instead"),[4,jH(b,new dR(a)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,c.sent()]}})})},b.awaitMediaLoaded=io,b.bufferToImage=ip,b.computeFaceDescriptor=function(a){return je.faceRecognitionNet.computeFaceDescriptor(a)},b.createCanvas=ir,b.createCanvasFromMedia=is,b.createFaceDetectionNet=function(a){return i2(a)},b.createFaceRecognitionNet=function(b){var a=new dQ;return a.extractWeights(b),a},b.createMtcnn=function(b){var a=new dU;return a.extractWeights(b),a},b.createSsdMobilenetv1=i2,b.createTinyFaceDetector=function(b){var a=new dV;return a.extractWeights(b),a},b.createTinyYolov2=function(c,a){void 0===a&&(a=!0);var b=new dT(a);return b.extractWeights(c),b},b.detectAllFaces=jH,b.detectFaceLandmarks=dX,b.detectFaceLandmarksTiny=function(a){return je.faceLandmark68TinyNet.detectLandmarks(a)},b.detectLandmarks=dX,b.detectSingleFace=function(b,a){return void 0===a&&(a=new i0),new jG(b,a)},b.draw=iO,b.env=ie,b.euclideanDistance=jI,b.extendWithAge=iZ,b.extendWithFaceDescriptor=iY,b.extendWithFaceDetection=h7,b.extendWithFaceExpressions=iJ,b.extendWithFaceLandmarks=iL,b.extendWithGender=i$,b.extractFaceTensors=iz,b.extractFaces=iy,b.fetchImage=function(a){return og(this,void 0,void 0,function(){var b,c;return oh(this,function(d){switch(d.label){case 0:return[4,iA(a)];case 1:return[4,(b=d.sent()).blob()];case 2:if(!(c=d.sent()).type.startsWith("image/"))throw new Error("fetchImage - expected blob type to be of type image/*, instead have: "+c.type+", for url: "+b.url);return[2,ip(c)]}})})},b.fetchJson=iB,b.fetchNetWeights=function(a){return og(this,void 0,void 0,function(){var b;return oh(this,function(c){switch(c.label){case 0:return b=Float32Array.bind,[4,iA(a)];case 1:return[4,c.sent().arrayBuffer()];case 2:return[2,new(b.apply(Float32Array,[void 0,c.sent()]))]}})})},b.fetchOrThrow=iA,b.getContext2dOrThrow=ih,b.getMediaDimensions=iq,b.imageTensorToCanvas=it,b.imageToSquare=iv,b.inverseSigmoid=function(a){return Math.log(a/(1-a))},b.iou=hR,b.isMediaElement=iu,b.isMediaLoaded=im,b.isWithAge=function(a){return"number"==typeof a.age},b.isWithFaceDetection=h6,b.isWithFaceExpressions=iI,b.isWithFaceLandmarks=iK,b.isWithGender=function(a){return(a.gender===b.Gender.MALE||a.gender===b.Gender.FEMALE)&&hL(a.genderProbability)},b.loadAgeGenderModel=function(a){return je.ageGenderNet.load(a)},b.loadFaceDetectionModel=dY,b.loadFaceExpressionModel=function(a){return je.faceExpressionNet.load(a)},b.loadFaceLandmarkModel=function(a){return je.faceLandmark68Net.load(a)},b.loadFaceLandmarkTinyModel=function(a){return je.faceLandmark68TinyNet.load(a)},b.loadFaceRecognitionModel=function(a){return je.faceRecognitionNet.load(a)},b.loadMtcnnModel=function(a){return je.mtcnn.load(a)},b.loadSsdMobilenetv1Model=dY,b.loadTinyFaceDetectorModel=function(a){return je.tinyFaceDetector.load(a)},b.loadTinyYolov2Model=function(a){return je.tinyYolov2.load(a)},b.loadWeightMap=iC,b.locateFaces=dW,b.matchDimensions=function(b,c,a){void 0===a&&(a=!1);var d=a?iq(c):c,e=d.width,f=d.height;return{width:b.width=e,height:b.height=f}},b.minBbox=hS,b.mtcnn=function(a,b){return je.mtcnn.forward(a,b)},b.nets=je,b.nonMaxSuppression=hT,b.normalize=hU,b.padToSquare=hV,b.predictAgeAndGender=function(a){return je.ageGenderNet.predictAgeAndGender(a)},b.recognizeFaceExpressions=function(a){return je.faceExpressionNet.predictExpressions(a)},b.resizeResults=function h(a,e){var f=new hy(e.width,e.height),b=f.width,c=f.height;if(b<=0||c<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:b,height:c}));if(Array.isArray(a))return a.map(function(a){return h(a,{width:b,height:c})});if(iK(a)){var d=a.detection.forSize(b,c),g=a.unshiftedLandmarks.forSize(d.box.width,d.box.height);return iL(h7(a,d),g)}return h6(a)?h7(a,a.detection.forSize(b,c)):a instanceof U||a instanceof hQ?a.forSize(b,c):a},b.resolveInput=ig,b.shuffleArray=function(d){for(var a=d.slice(),b=a.length-1;0<b;b--){var c=Math.floor(Math.random()*(b+1)),e=a[b];a[b]=a[c],a[c]=e}return a},b.sigmoid=hW,b.ssdMobilenetv1=dW,b.tf=hw,b.tinyFaceDetector=function(a,b){return je.tinyFaceDetector.locateFaces(a,b)},b.tinyYolov2=function(a,b){return je.tinyYolov2.locateFaces(a,b)},b.toNetInput=ix,b.utils=hM,b.validateConfig=i5,Object.defineProperty(b,"__esModule",{value:!0})})

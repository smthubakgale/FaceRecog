<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Detection and Landmark Extraction</title>
    <style>
        #canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <input type="file" id="imageInput" accept="image/*">
    <canvas id="canvas"></canvas>
    <script>
        const imageInput = document.getElementById('imageInput');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files;
            const reader = new FileReader();

            reader.addEventListener('load', () => {
                const imageData = reader.result;
                const img = new Image();

                img.addEventListener('load', () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    // Preprocess image
                    const blurredCanvas = document.createElement('canvas');
                    const blurredCtx = blurredCanvas.getContext('2d');
                    blurredCanvas.width = canvas.width;
                    blurredCanvas.height = canvas.height;
                    blurredCtx.filter = 'blur(2px)';
                    blurredCtx.drawImage(canvas, 0, 0);

                    const grayCanvas = document.createElement('canvas');
                    const grayCtx = grayCanvas.getContext('2d');
                    grayCanvas.width = blurredCanvas.width;
                    grayCanvas.height = blurredCanvas.height;
                    grayCtx.drawImage(blurredCanvas, 0, 0);

                    const pixels = grayCtx.getImageData(0, 0, grayCanvas.width, grayCanvas.height).data;

                    // Edge detection (Sobel filter)
                    const edges = new Uint8ClampedArray(pixels.length);
                    for (let i = 0; i < pixels.length; i += 4) {
                        const lightness = (pixels + pixels + pixels) / 3;
                        pixels = pixels = pixels = lightness;
                    }

                    const sobelKernelX = [
                        -1, 0, 1,
                        -2, 0, 2,
                        -1, 0, 1
                    ];

                    const sobelKernelY = [
                        -1, -2, -1,
                        0, 0, 0,
                        1, 2, 1
                    ];

                    for (let y = 1; y < grayCanvas.height - 1; y++) {
                        for (let x = 1; x < grayCanvas.width - 1; x++) {
                            let edge = 0;
                            for (let ky = -1; ky <= 1; ky++) {
                                for (let kx = -1; kx <= 1; kx++) {
                                    const pixelIndex = (y + ky) * grayCanvas.width * 4 + (x + kx) * 4;
                                    edge += (pixels * sobelKernelX +
                                             pixels * sobelKernelY);
                                }
                            }
                            edges = Math.abs(edge);
                        }
                    }

                    // Face detection and landmark extraction
                    const faceRegions = [];
                    for (let y = 0; y < grayCanvas.height; y++) {
                        for (let x = 0; x < grayCanvas.width; x++) {
                            const edgeIndex = y * grayCanvas.width * 4 + x * 4;
                            if (edges > 100) {
                                faceRegions.push({ x, y });
                            }
                        }
                    }

                    const landmarks = [];
                    faceRegions.forEach(region => {
                        landmarks.push({ x: region.x, y: region.y, type: 'face_center' });
                    });

                    console.log(landmarks);

                    // Draw landmarks on canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    ctx.fillStyle = 'red';
                    landmarks.forEach(landmark => {
                        ctx.beginPath();
                        ctx.arc(landmark.x, landmark.y, 2, 0, 2 * Math.PI);
                        ctx.fill();
                    });
                });

                img.src = imageData;
            });

            reader.readAsDataURL(file);
        });
    </script>
</body>
</html>

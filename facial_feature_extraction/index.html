<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
    }

    #stats {
      position: relative;
      width: 100%;
      height: 80px;
    }

    #main {
      position: relative;
      margin: 0;
    }

    #canvas-wrapper {
      position: relative;
    }
  </style>
</head>

<body>
  <div id="stats"></div>
  <div id="main">
    <div class="container">
      <div class="canvas-wrapper">
        <canvas id="output"></canvas>
        <video id="video" playsinline style="
          -webkit-transform: scaleX(-1);
          transform: scaleX(-1);
          visibility: hidden;
          width: auto;
          height: auto;
          ">
        </video>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>

  <script>
    // Constants
    const VIDEO_SIZE = {
      '360p': {width: 640, height: 360},
      '480p': {width: 640, height: 480},
      '720p': {width: 1280, height: 720},
    };

    const STATE = {
      camera: {
        targetFPS: 30,
        sizeOption: '480p',
      },
      isTargetFPSChanged: false,
      isSizeOptionChanged: false,
    };

    // Variables
    let detector, camera, stats;
    let startInferenceTime, numInferences = 0;
    let inferenceTimeSum = 0, lastPanelUpdate = 0;
    let rafId;

    // Function to check for GUI updates
    async function checkGuiUpdate() {
      if (STATE.isTargetFPSChanged || STATE.isSizeOptionChanged) {
        camera = await Camera.setupCamera(STATE.camera);
        STATE.isTargetFPSChanged = false;
        STATE.isSizeOptionChanged = false;
      }
    }

    // Function to begin estimating face stats
    function beginEstimateFaceStats() {
      startInferenceTime = performance.now();
    }

    // Function to end estimating face stats
    function endEstimateFaceStats() {
      const endInferenceTime = performance.now();
      inferenceTimeSum += endInferenceTime - startInferenceTime;
      ++numInferences;

      const panelUpdateMilliseconds = 1000;
      if (endInferenceTime - lastPanelUpdate >= panelUpdateMilliseconds) {
        const averageInferenceTime = inferenceTimeSum / numInferences;
        inferenceTimeSum = 0;
        numInferences = 0;
        stats.customFpsPanel.update(
            1000.0 / averageInferenceTime, 120 /* maxValue */);
        lastPanelUpdate = endInferenceTime;
      }
    }

    // Function to render result
    async function renderResult() {
      if (camera.video.readyState < 2) {
        await new Promise((resolve) => {
          camera.video.onloadeddata = () => {
            resolve(video);
          };
        });
      }

      let faces = null;

      if (detector != null) {
        beginEstimateFaceStats();

        try {
          faces = await detector.estimateFaces(camera.video, {flipHorizontal: false});
        } catch (error) {
          detector.dispose();
          detector = null;
          alert(error);
        }

        endEstimateFaceStats();
      }

      camera.drawCtx();

      if (faces && faces.length > 0) {
        camera.drawResults(faces);
      }
    }

    // Function to render prediction
    async function renderPrediction() {
      await checkGuiUpdate();

      await renderResult();

      rafId = requestAnimationFrame(renderPrediction);
    }

    // Camera class
    class Camera {
      constructor() {
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('output');
        this.ctx = this.canvas.getContext('2d');
      }

      static async setupCamera(cameraParam) {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error(
              'Browser API navigator.mediaDevices.getUserMedia not available');
        }

        const $size = VIDEO_SIZE;
        const videoConfig = {
          'audio': false,
          'video': {
            facingMode: 'user',
            width: $size.width,
            height: $size.height,
            frameRate: {
              ideal: cameraParam.targetFPS,
            },
          },
        };

        const stream = await navigator.mediaDevices.getUserMedia(videoConfig);

        const camera = new Camera();
        camera.video.srcObject = stream;

        await new Promise((resolve) => {
          camera.video.onloadedmetadata = () => {
            resolve(video);
          };
        });

        camera.video.play();

        const videoWidth = camera.video.videoWidth;
        const videoHeight = camera.video.videoHeight;
        camera.video.width = videoWidth;
        camera.video.height = videoHeight;

        camera.canvas.width = videoWidth;
        camera.canvas.height = videoHeight;

        return camera;
      }

      drawCtx() {
        this.ctx.drawImage(
            this.video, 0, 0, this.video.videoWidth, this.video.videoHeight);
      }

      drawResults(faces) {
        this.ctx.beginPath();
        this.ctx.lineWidth = 2;
        this.ctx.strokeStyle = 'red';

        faces.forEach((face) => {
          const {topLeft, bottomRight} = face.boundingBox;
          this.ctx.rect(topLeft, topLeft, bottomRight - topLeft, bottomRight - topLeft);
        });

        this.ctx.stroke();
      }
    }

    // Function to create detector
    async function createDetector() {
      const detector = await faceDetection.SupportedModels.MediaPipeFaceDetection.create({
        model: faceDetection.SupportedModels.MediaPipeFaceDetection.Models.full,
      });

      return detector;
    }

    // Initialize the app
    async function app() {
      // Setup GUI
      const gui = new dat.GUI({width: 300});
      gui.domElement.id = 'gui';

      const cameraFolder = gui.addFolder('Camera');
      const fpsController = cameraFolder.add(STATE.camera, 'targetFPS');
      fpsController.onFinishChange((_) => {
        STATE.isTargetFPSChanged = true;
      });
      const sizeController = cameraFolder.add(
          STATE.camera, 'sizeOption', Object.keys(VIDEO_SIZE));
      sizeController.onChange(_ => {
        STATE.isSizeOptionChanged = true;
      });
      cameraFolder.open();

      // Setup stats
      stats = new Stats();
      stats.showPanel(0);
      //document.getElementById('stats').appendChild(stats.dom);

      // Setup camera
      camera = await Camera.setupCamera(STATE.camera);

      // Setup detector
      detector = await createDetector();

      // Start rendering
      renderPrediction();
    }

    // Initialize the app
    app();
  </script>
</body>
</html>
